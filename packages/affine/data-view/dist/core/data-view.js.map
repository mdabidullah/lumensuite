{"version":3,"file":"data-view.js","sourceRoot":"","sources":["../../src/core/data-view.ts"],"names":[],"mappings":"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","sourcesContent":["import type { BlockStdScope } from '@blocksuite/block-std';\nimport type { ReferenceElement } from '@floating-ui/dom';\n\nimport {\n  ShadowlessElement,\n  SignalWatcher,\n  WithDisposable,\n} from '@blocksuite/block-std';\nimport { computed, type ReadonlySignal } from '@lit-labs/preact-signals';\nimport { css, type TemplateResult, unsafeCSS } from 'lit';\nimport { customElement, property, state } from 'lit/decorators.js';\nimport { classMap } from 'lit/directives/class-map.js';\nimport { keyed } from 'lit/directives/keyed.js';\nimport { createRef, ref } from 'lit/directives/ref.js';\nimport { html } from 'lit/static-html.js';\n\nimport type { DataSource } from './common/data-source/base.js';\nimport type { DataViewSelection, DataViewSelectionState } from './types.js';\nimport type { DataViewExpose, DataViewProps } from './view/data-view.js';\nimport type { DataViewBase } from './view/data-view-base.js';\nimport type { SingleView } from './view-manager/single-view.js';\n\nimport { dataViewCommonStyle } from './common/css-variable.js';\nimport { createRecordDetail, popSideDetail } from './common/detail/layout.js';\nimport './common/group-by/define.js';\nimport { renderUniLit } from './utils/uni-component/index.js';\n\ntype ViewProps = {\n  view: SingleView;\n  selection$: ReadonlySignal<DataViewSelectionState>;\n  setSelection: (selection?: DataViewSelectionState) => void;\n  bindHotkey: DataViewBase['bindHotkey'];\n  handleEvent: DataViewBase['handleEvent'];\n};\n\nexport type DataViewRendererConfig = {\n  bindHotkey: DataViewProps['bindHotkey'];\n  handleEvent: DataViewProps['handleEvent'];\n  selection$: ReadonlySignal<DataViewSelection | undefined>;\n  setSelection: (selection: DataViewSelection | undefined) => void;\n  dataSource: DataSource;\n  detailPanelConfig?: {\n    openDetailPanel?: (\n      target: HTMLElement,\n      template: TemplateResult\n    ) => Promise<void>;\n    target?: () => ReferenceElement;\n  };\n  headerWidget: DataViewProps['headerWidget'];\n  onDrag?: DataViewProps['onDrag'];\n  std: BlockStdScope;\n};\n\n@customElement('affine-data-view-renderer')\nexport class DataViewRenderer extends SignalWatcher(\n  WithDisposable(ShadowlessElement)\n) {\n  static override styles = css`\n    ${unsafeCSS(dataViewCommonStyle('affine-data-view-renderer'))}\n    affine-data-view-renderer {\n      background-color: var(--affine-background-primary-color);\n      display: contents;\n    }\n  `;\n\n  private _view = createRef<DataViewExpose>();\n\n  private currentViewId$ = computed(() => {\n    return this.config.dataSource.viewManager.currentViewId$.value;\n  });\n\n  currentViewConfig$ = computed<ViewProps | undefined>(() => {\n    const currentViewId = this.currentViewId$.value;\n    if (!currentViewId) {\n      return;\n    }\n    const view = this.viewMap$.value[currentViewId];\n    return {\n      view: view,\n      selection$: computed(() => {\n        const selection$ = this.config.selection$;\n        if (selection$.value?.viewId === currentViewId) {\n          return selection$.value;\n        }\n        return;\n      }),\n      setSelection: selection => {\n        this.config.setSelection(selection);\n      },\n      handleEvent: (name, handler) =>\n        this.config.handleEvent(name, context => {\n          return handler(context);\n        }),\n      bindHotkey: hotkeys =>\n        this.config.bindHotkey(\n          Object.fromEntries(\n            Object.entries(hotkeys).map(([key, fn]) => [\n              key,\n              ctx => {\n                return fn(ctx);\n              },\n            ])\n          )\n        ),\n    };\n  });\n\n  focusFirstCell = () => {\n    this._view.value?.focusFirstCell();\n  };\n\n  openDetailPanel = (ops: {\n    view: SingleView;\n    rowId: string;\n    onClose?: () => void;\n  }) => {\n    const openDetailPanel = this.config.detailPanelConfig?.openDetailPanel;\n    if (openDetailPanel) {\n      openDetailPanel(\n        this,\n        createRecordDetail({\n          view: ops.view,\n          rowId: ops.rowId,\n        })\n      )\n        .catch(console.error)\n        .finally(ops.onClose);\n    } else {\n      popSideDetail({\n        target: this.config.detailPanelConfig?.target?.() ?? document.body,\n        view: ops.view,\n        rowId: ops.rowId,\n        onClose: ops.onClose,\n      });\n    }\n  };\n\n  viewMap$ = computed(() => {\n    const manager = this.config.dataSource.viewManager;\n    return Object.fromEntries(\n      manager.views$.value.map(view => [view, manager.viewGet(view)])\n    );\n  });\n\n  get expose() {\n    return this._view.value;\n  }\n\n  private renderView(viewData?: ViewProps) {\n    if (!viewData) {\n      return;\n    }\n    const props: DataViewProps = {\n      dataViewEle: this,\n      view: viewData.view,\n      headerWidget: this.config.headerWidget,\n      selection$: viewData.selection$,\n      setSelection: viewData.setSelection,\n      bindHotkey: viewData.bindHotkey,\n      handleEvent: viewData.handleEvent,\n      onDrag: this.config.onDrag,\n      std: this.config.std,\n      dataSource: this.config.dataSource,\n    };\n    return keyed(\n      viewData.view.id,\n      renderUniLit(viewData.view.viewMeta.renderer.view, props, {\n        ref: this._view,\n      })\n    );\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    let preId: string | undefined = undefined;\n    this.disposables.add(\n      this.currentViewId$.subscribe(current => {\n        if (current !== preId) {\n          this.config.setSelection(undefined);\n        }\n        preId = current;\n      })\n    );\n  }\n\n  override render() {\n    const containerClass = classMap({\n      'toolbar-hover-container': true,\n      'data-view-root': true,\n      'prevent-reference-popup': true,\n    });\n    return html`\n      <div style=\"display: contents\" class=\"${containerClass}\">\n        ${this.renderView(this.currentViewConfig$.value)}\n      </div>\n    `;\n  }\n\n  @property({ attribute: false })\n  accessor config!: DataViewRendererConfig;\n\n  @state()\n  accessor currentView: string | undefined = undefined;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-data-view-renderer': DataViewRenderer;\n  }\n}\n\nexport class DataView {\n  private _ref = createRef<DataViewRenderer>();\n\n  get expose() {\n    return this._ref.value?.expose;\n  }\n\n  render(props: DataViewRendererConfig) {\n    return html` <affine-data-view-renderer\n      ${ref(this._ref)}\n      .config=\"${props}\"\n    ></affine-data-view-renderer>`;\n  }\n}\n"]}