{"version":3,"file":"add-row.js","sourceRoot":"","sources":["../../../../../src/widget-presets/tools/presets/table-add-row/add-row.ts"],"names":[],"mappings":"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","sourcesContent":["import type { InsertToPosition } from '@lumensuite/affine-shared/utils';\n\nimport { PlusIcon } from '@blocksuite/icons/lit';\nimport { css, html } from 'lit';\nimport { customElement, state } from 'lit/decorators.js';\n\nimport { startDrag } from '../../../../core/utils/drag.js';\nimport { WidgetBase } from '../../../../core/widget/widget-base.js';\nimport { NewRecordPreview } from './new-record-preview.js';\n\nconst styles = css`\n  .affine-database-toolbar-item.new-record {\n    margin-left: 12px;\n    display: flex;\n    align-items: center;\n    gap: 4px;\n    width: 120px;\n    height: 32px;\n    padding: 6px 8px;\n    border-radius: 8px;\n    font-size: 14px;\n    background: var(--affine-white);\n    box-shadow: 0px 0px 0px 0.5px rgba(0, 0, 0, 0.1);\n    cursor: grab;\n  }\n\n  .new-record svg {\n    width: 16px;\n    height: 16px;\n    fill: var(--affine-icon-color);\n  }\n`;\n\n@customElement('data-view-header-tools-add-row')\nexport class DataViewHeaderToolsAddRow extends WidgetBase {\n  static override styles = styles;\n\n  private _onAddNewRecord = () => {\n    if (this.readonly) return;\n    const selection = this.viewMethods.getSelection?.();\n    if (!selection) {\n      this.addRow('start');\n    } else if (\n      selection.type === 'table' &&\n      selection.selectionType === 'area'\n    ) {\n      const { rowsSelection, columnsSelection, focus } = selection;\n      let index = 0;\n      if (rowsSelection && !columnsSelection) {\n        // rows\n        index = rowsSelection.end;\n      } else if (rowsSelection && columnsSelection) {\n        // multiple cells\n        index = rowsSelection.end;\n      } else if (!rowsSelection && !columnsSelection && focus) {\n        // single cell\n        index = focus.rowIndex;\n      }\n\n      this.addRow(index + 1);\n    }\n  };\n\n  _dragStart = (e: MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    const container = this.closest('affine-data-view-renderer');\n    const tableRect = container\n      ?.querySelector('affine-database-table')\n      ?.getBoundingClientRect();\n    const rows: NodeListOf<HTMLElement> | undefined =\n      container?.querySelectorAll('.affine-database-block-row');\n    if (!rows || !tableRect) {\n      return;\n    }\n    const rects = Array.from(rows).map(v => {\n      const rect = v.getBoundingClientRect();\n      return {\n        id: v.dataset.rowId as string,\n        top: rect.top,\n        bottom: rect.bottom,\n        mid: (rect.top + rect.bottom) / 2,\n        width: rect.width,\n        left: rect.left,\n      };\n    });\n\n    const getPosition = (\n      y: number\n    ):\n      | { position: InsertToPosition; y: number; x: number; width: number }\n      | undefined => {\n      const data = rects.find(v => y < v.bottom);\n      if (!data || y < data.top) {\n        return;\n      }\n      return {\n        position: {\n          id: data.id,\n          before: y < data.mid,\n        },\n        y: y < data.mid ? data.top : data.bottom,\n        width: data.width,\n        x: data.left,\n      };\n    };\n\n    const dropPreview = createDropPreview();\n    const dragPreview = createDragPreview();\n    startDrag<{ position?: InsertToPosition }, MouseEvent>(e, {\n      transform: e => e,\n      onDrag: () => {\n        return {};\n      },\n      onMove: e => {\n        dragPreview.display(e.x, e.y);\n        const p = getPosition(e.y);\n        if (p) {\n          dropPreview.display(tableRect.left, p.y, tableRect.width);\n        } else {\n          dropPreview.remove();\n        }\n        return {\n          position: p?.position,\n        };\n      },\n      onDrop: data => {\n        if (data.position) {\n          this.viewMethods.addRow?.(data.position);\n        }\n      },\n      onClear: () => {\n        dropPreview.remove();\n        dragPreview.remove();\n      },\n    });\n  };\n\n  addRow = (position: InsertToPosition | number) => {\n    this.viewMethods.addRow?.(position);\n  };\n\n  private get readonly() {\n    return this.view.readonly$.value;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    if (!this.readonly) {\n      this.disposables.addFromEvent(this, 'pointerdown', e => {\n        this._dragStart(e);\n      });\n    }\n  }\n\n  override render() {\n    if (this.readonly) {\n      return;\n    }\n    return html` <div\n      class=\"affine-database-toolbar-item new-record\"\n      draggable=\"true\"\n      @click=\"${this._onAddNewRecord}\"\n    >\n      ${PlusIcon()}<span>New Record</span>\n    </div>`;\n  }\n\n  @state()\n  accessor showToolBar = false;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'data-view-header-tools-add-row': DataViewHeaderToolsAddRow;\n  }\n}\nconst createDropPreview = () => {\n  const div = document.createElement('div');\n  div.dataset.isDropPreview = 'true';\n  div.style.pointerEvents = 'none';\n  div.style.position = 'fixed';\n  div.style.zIndex = '9999';\n  div.style.height = '4px';\n  div.style.borderRadius = '2px';\n  div.style.backgroundColor = 'var(--affine-primary-color)';\n  div.style.boxShadow = '0px 0px 8px 0px rgba(30, 150, 235, 0.35)';\n  return {\n    display(x: number, y: number, width: number) {\n      document.body.append(div);\n      div.style.left = `${x}px`;\n      div.style.top = `${y - 2}px`;\n      div.style.width = `${width}px`;\n    },\n    remove() {\n      div.remove();\n    },\n  };\n};\n\nconst createDragPreview = () => {\n  const preview = new NewRecordPreview();\n  document.body.append(preview);\n  return {\n    display(x: number, y: number) {\n      preview.style.left = `${x}px`;\n      preview.style.top = `${y}px`;\n    },\n    remove() {\n      preview.remove();\n    },\n  };\n};\n"]}