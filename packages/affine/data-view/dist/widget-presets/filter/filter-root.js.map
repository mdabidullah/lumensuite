{"version":3,"file":"filter-root.js","sourceRoot":"","sources":["../../../src/widget-presets/filter/filter-root.ts"],"names":[],"mappings":"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","sourcesContent":["import { popFilterableSimpleMenu } from '@lumensuite/affine-components/context-menu';\nimport { ShadowlessElement, WithDisposable } from '@lumensuite/block-std';\nimport {\n  ArrowDownSmallIcon,\n  ConvertIcon,\n  DeleteIcon,\n  DuplicateIcon,\n  MoreHorizontalIcon,\n  PlusIcon,\n} from '@blocksuite/icons/lit';\nimport { css, html, nothing } from 'lit';\nimport { customElement, property, state } from 'lit/decorators.js';\nimport { classMap } from 'lit/directives/class-map.js';\nimport { repeat } from 'lit/directives/repeat.js';\n\nimport type { Filter, FilterGroup, Variable } from '../../core/common/ast.js';\nimport type { FilterGroupView } from './filter-group.js';\n\nimport { menuTitle } from '../../core/utils/menu-title.js';\nimport { popAddNewFilter } from './condition.js';\nimport { getDepth } from './filter-group.js';\n\n@customElement('filter-root-view')\nexport class FilterRootView extends WithDisposable(ShadowlessElement) {\n  static override styles = css`\n    filter-root-view {\n      border-radius: 4px;\n      display: flex;\n      flex-direction: column;\n      user-select: none;\n    }\n\n    .filter-root-title {\n      padding: 12px;\n      font-size: 14px;\n      font-weight: 600;\n      line-height: 22px;\n      color: var(--affine-text-primary-color);\n    }\n\n    .filter-root-op {\n      width: 60px;\n      display: flex;\n      justify-content: end;\n      padding: 4px;\n      height: 34px;\n      align-items: center;\n    }\n\n    .filter-root-op-clickable {\n      border-radius: 4px;\n      cursor: pointer;\n    }\n\n    .filter-root-op-clickable:hover {\n      background-color: var(--affine-hover-color);\n    }\n\n    .filter-root-container {\n      display: flex;\n      flex-direction: column;\n      gap: 4px;\n      max-height: 400px;\n      overflow: auto;\n      padding: 0 12px 0 8px;\n    }\n\n    .filter-root-button {\n      margin: 4px 8px 8px;\n      padding: 8px 12px;\n      display: flex;\n      align-items: center;\n      gap: 6px;\n      font-size: 14px;\n      line-height: 22px;\n      border-radius: 4px;\n      cursor: pointer;\n      color: var(--affine-text-secondary-color);\n    }\n\n    .filter-root-button svg {\n      fill: var(--affine-text-secondary-color);\n      color: var(--affine-text-secondary-color);\n      width: 20px;\n      height: 20px;\n    }\n\n    .filter-root-button:hover {\n      background-color: var(--affine-hover-color);\n      color: var(--affine-text-primary-color);\n    }\n    .filter-root-button:hover svg {\n      fill: var(--affine-text-primary-color);\n      color: var(--affine-text-primary-color);\n    }\n\n    .filter-root-item {\n      padding: 4px 0;\n      display: flex;\n      align-items: start;\n      gap: 8px;\n    }\n\n    .filter-group-title {\n      font-size: 14px;\n      font-style: normal;\n      font-weight: 500;\n      line-height: 22px;\n      display: flex;\n      align-items: center;\n      color: var(--affine-text-primary-color);\n      gap: 6px;\n    }\n\n    .filter-root-item-ops {\n      margin-top: 2px;\n      padding: 4px;\n      border-radius: 4px;\n      height: max-content;\n      display: flex;\n      cursor: pointer;\n    }\n\n    .filter-root-item-ops:hover {\n      background-color: var(--affine-hover-color);\n    }\n\n    .filter-root-item-ops svg {\n      fill: var(--affine-text-secondary-color);\n      color: var(--affine-text-secondary-color);\n      width: 18px;\n      height: 18px;\n    }\n    .filter-root-item-ops:hover svg {\n      fill: var(--affine-text-primary-color);\n      color: var(--affine-text-primary-color);\n    }\n\n    .filter-root-grabber {\n      cursor: grab;\n      width: 4px;\n      height: 12px;\n      background-color: var(--affine-placeholder-color);\n      border-radius: 1px;\n    }\n\n    .divider {\n      height: 1px;\n      background-color: var(--affine-divider-color);\n      flex-shrink: 0;\n      margin: 8px 0;\n    }\n  `;\n\n  private _addNew = (e: MouseEvent) => {\n    popAddNewFilter(e.target as HTMLElement, {\n      value: this.data,\n      onChange: this.setData,\n      vars: this.vars,\n    });\n  };\n\n  private _setFilter = (index: number, filter: Filter) => {\n    this.setData({\n      ...this.data,\n      conditions: this.data.conditions.map((v, i) =>\n        index === i ? filter : v\n      ),\n    });\n  };\n\n  private _clickConditionOps(target: HTMLElement, i: number) {\n    const filter = this.data.conditions[i];\n    popFilterableSimpleMenu(target, [\n      {\n        type: 'action',\n        name: filter.type === 'filter' ? 'Turn into group' : 'Wrap in group',\n        icon: ConvertIcon(),\n        onHover: hover => {\n          this.containerClass = hover\n            ? { index: i, class: 'hover-style' }\n            : undefined;\n        },\n        hide: () => getDepth(filter) > 3,\n        select: () => {\n          this.setData({ type: 'group', op: 'and', conditions: [this.data] });\n        },\n      },\n      {\n        type: 'action',\n        name: 'Duplicate',\n        icon: DuplicateIcon(),\n        onHover: hover => {\n          this.containerClass = hover\n            ? { index: i, class: 'hover-style' }\n            : undefined;\n        },\n        select: () => {\n          const conditions = [...this.data.conditions];\n          conditions.splice(\n            i + 1,\n            0,\n            JSON.parse(JSON.stringify(conditions[i]))\n          );\n          this.setData({ ...this.data, conditions: conditions });\n        },\n      },\n      {\n        type: 'group',\n        name: '',\n        children: () => [\n          {\n            type: 'action',\n            name: 'Delete',\n            icon: DeleteIcon(),\n            class: 'delete-item',\n            onHover: hover => {\n              this.containerClass = hover\n                ? { index: i, class: 'delete-style' }\n                : undefined;\n            },\n            select: () => {\n              const conditions = [...this.data.conditions];\n              conditions.splice(i, 1);\n              this.setData({\n                ...this.data,\n                conditions,\n              });\n            },\n          },\n        ],\n      },\n    ]);\n  }\n\n  override render() {\n    const data = this.data;\n    return html`\n      <div style=\"padding: 15px 20px\">\n        ${menuTitle('FILTER', () => {\n          this.onBack?.();\n        })}\n      </div>\n      <div class=\"filter-root-container\">\n        ${repeat(data.conditions, (filter, i) => {\n          const clickOps = (e: MouseEvent) => {\n            e.stopPropagation();\n            e.preventDefault();\n            this._clickConditionOps(e.target as HTMLElement, i);\n          };\n          const ops = html`\n            <div class=\"filter-root-item-ops\" @click=\"${clickOps}\">\n              ${MoreHorizontalIcon()}\n            </div>\n          `;\n          const content =\n            filter.type === 'filter'\n              ? html`\n                  <div\n                    style=\"display:flex;align-items:center;justify-content: space-between;width: 100%;gap:8px;\"\n                  >\n                    <div style=\"display:flex;align-items:center;gap:6px;\">\n                      <div class=\"filter-root-grabber\"></div>\n                      <filter-condition-view\n                        .setData=\"${(v: Filter) => this._setFilter(i, v)}\"\n                        .vars=\"${this.vars}\"\n                        .data=\"${filter}\"\n                      ></filter-condition-view>\n                    </div>\n                    ${ops}\n                  </div>\n                `\n              : html`\n                  <div style=\"width: 100%;\">\n                    <div\n                      style=\"display:flex;align-items:center;justify-content: space-between;gap:8px;padding: 4px 4px 0 4px;\"\n                    >\n                      <div class=\"filter-group-title\">\n                        <div class=\"filter-root-grabber\"></div>\n                        Filter group\n                      </div>\n                      ${ops}\n                    </div>\n                    <div style=\"width: 100%;padding: 12px 0 0;\">\n                      <filter-group-view\n                        style=\"padding: 0\"\n                        .setData=\"${(v: Filter) => this._setFilter(i, v)}\"\n                        .vars=\"${this.vars}\"\n                        .data=\"${filter}\"\n                      ></filter-group-view>\n                    </div>\n                  </div>\n                `;\n          const classList = classMap({\n            'filter-root-item': true,\n            'filter-exactly-hover-container': true,\n            'dv-pd-4 dv-round-4': true,\n            [this.containerClass?.class ?? '']:\n              this.containerClass?.index === i,\n          });\n          return html` ${data.conditions[i - 1]?.type === 'group' ||\n            filter.type === 'group'\n              ? html`<div class=\"divider\"></div>`\n              : nothing}\n            <div @contextmenu=${clickOps} class=\"${classList}\">\n              ${content}\n            </div>`;\n        })}\n      </div>\n      <div class=\"filter-root-button add-new\" @click=\"${this._addNew}\">\n        ${PlusIcon()} Add ${ArrowDownSmallIcon()}\n      </div>\n    `;\n  }\n\n  @state()\n  accessor containerClass:\n    | {\n        index: number;\n        class: string;\n      }\n    | undefined = undefined;\n\n  @property({ attribute: false })\n  accessor data!: FilterGroup;\n\n  @property({ attribute: false })\n  accessor onBack!: () => void;\n\n  @property({ attribute: false })\n  accessor setData!: (filter: FilterGroup) => void;\n\n  @property({ attribute: false })\n  accessor vars!: Variable[];\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'filter-root-view': FilterGroupView;\n  }\n}\n"]}