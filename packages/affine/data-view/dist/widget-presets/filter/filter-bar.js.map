{"version":3,"file":"filter-bar.js","sourceRoot":"","sources":["../../../src/widget-presets/filter/filter-bar.ts"],"names":[],"mappings":"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","sourcesContent":["import { createPopup } from '@blocksuite/affine-components/context-menu';\nimport { ShadowlessElement, WithDisposable } from '@blocksuite/block-std';\nimport { CloseIcon, FilterIcon, PlusIcon } from '@blocksuite/icons/lit';\nimport { css, html, type TemplateResult } from 'lit';\nimport { customElement, property } from 'lit/decorators.js';\nimport { repeat } from 'lit/directives/repeat.js';\n\nimport type { Filter, FilterGroup, Variable } from '../../core/common/ast.js';\n\nimport { popCreateFilter } from '../../core/common/ref/ref.js';\nimport { renderTemplate } from '../../core/utils/uni-component/render-template.js';\nimport { popFilterModal } from './filter-modal.js';\n\n@customElement('filter-bar')\nexport class FilterBar extends WithDisposable(ShadowlessElement) {\n  static override styles = css`\n    filter-bar {\n      margin-top: 8px;\n      display: flex;\n      gap: 8px;\n    }\n\n    .filter-group-tag {\n      font-size: 12px;\n      font-style: normal;\n      font-weight: 600;\n      line-height: 20px;\n      display: flex;\n      align-items: center;\n      padding: 4px;\n      background-color: var(--affine-white);\n    }\n\n    .filter-bar-add-filter {\n      color: var(--affine-text-secondary-color);\n      padding: 4px 8px;\n      display: flex;\n      align-items: center;\n      gap: 6px;\n      font-size: 14px;\n      font-style: normal;\n      font-weight: 400;\n      line-height: 22px;\n    }\n  `;\n\n  private _setFilter = (index: number, filter: Filter) => {\n    this.setData({\n      ...this.data,\n      conditions: this.data.conditions.map((v, i) =>\n        index === i ? filter : v\n      ),\n    });\n  };\n\n  private addFilter = (e: MouseEvent) => {\n    const element = e.target as HTMLElement;\n    popCreateFilter(element, {\n      vars: this.vars,\n      onSelect: filter => {\n        const index = this.data.conditions.length;\n        this.setData({\n          ...this.data,\n          conditions: [...this.data.conditions, filter],\n        });\n        requestAnimationFrame(() => {\n          this.expandGroup(element, index);\n        });\n      },\n    });\n  };\n\n  private expandGroup = (position: HTMLElement, i: number) => {\n    const value = this.data.conditions[i];\n    if (value.type !== 'group') {\n      return;\n    }\n    popFilterModal(position, {\n      isRoot: false,\n      vars: this.vars,\n      value: value,\n      onBack: () => {\n        // do nothing\n      },\n      onChange: filter => this._setFilter(i, filter),\n      onDelete: () => {\n        this.deleteFilter(i);\n      },\n    });\n  };\n\n  renderAddFilter = () => {\n    return html` <div\n      style=\"height: 100%;\"\n      class=\"filter-bar-add-filter dv-icon-16 dv-round-4 dv-hover\"\n      @click=\"${this.addFilter}\"\n    >\n      ${PlusIcon()} Add filter\n    </div>`;\n  };\n\n  renderMore = (count: number) => {\n    const max = this.data.conditions.length;\n    if (count === max) {\n      return this.renderAddFilter();\n    }\n    const showMore = (e: MouseEvent) => {\n      this.showMoreFilter(e, count);\n    };\n    return html` <div\n      class=\"filter-bar-add-filter dv-icon-16 dv-round-4 dv-hover\"\n      style=\"height: 100%;\"\n      @click=\"${showMore}\"\n    >\n      ${max - count} More\n    </div>`;\n  };\n\n  renderMoreFilter = (count: number): TemplateResult => {\n    return html` <div\n      class=\"dv-shadow-2 dv-round-8\"\n      style=\"padding: 8px;background-color: var(--affine-background-overlay-panel-color);display:flex;flex-direction: column;gap: 8px;\"\n    >\n      ${repeat(\n        this.data.conditions.slice(count),\n        (_, i) =>\n          html` <div style=\"width: max-content;\">\n            ${this.renderCondition(i + count)}\n          </div>`\n      )}\n      <div class=\"dv-divider-h\"></div>\n      ${this.renderAddFilter()}\n    </div>`;\n  };\n\n  showMoreFilter = (e: MouseEvent, count: number) => {\n    const ins = renderTemplate(() => this.renderMoreFilter(count));\n    ins.style.position = 'absolute';\n    this.updateMoreFilterPanel = () => {\n      const max = this.data.conditions.length;\n      if (count === max) {\n        close();\n        this.updateMoreFilterPanel = undefined;\n        return;\n      }\n      ins.requestUpdate();\n    };\n    const close = createPopup(e.target as HTMLElement, ins, {\n      onClose: () => {\n        this.updateMoreFilterPanel = undefined;\n      },\n    });\n  };\n\n  updateMoreFilterPanel?: () => void;\n\n  private deleteFilter(i: number) {\n    this.setData({\n      ...this.data,\n      conditions: this.data.conditions.filter((_, index) => index !== i),\n    });\n  }\n\n  override render() {\n    return html`\n      <component-overflow\n        .renderItem=\"${this.renderFilters()}\"\n        .renderMore=\"${this.renderMore}\"\n      ></component-overflow>\n    `;\n  }\n\n  renderCondition(i: number) {\n    const condition = this.data.conditions[i];\n    const deleteFilter = () => {\n      this.deleteFilter(i);\n    };\n    if (condition.type === 'filter') {\n      return html` <filter-condition-view\n        style=\"margin-right: 8px;\"\n        .vars=\"${this.vars}\"\n        .data=\"${condition}\"\n        .setData=\"${(v: Filter) => this._setFilter(i, v)}\"\n        .onDelete=\"${deleteFilter}\"\n      ></filter-condition-view>`;\n    }\n    const expandGroup = (e: MouseEvent) => {\n      this.expandGroup(e.target as HTMLElement, i);\n    };\n    const length = condition.conditions.length;\n    const text = length > 1 ? `${length} rules` : `${length} rule`;\n    return html` <div\n      style=\"margin-right: 8px;\"\n      class=\"filter-group-tag dv-icon-16 dv-border dv-round-8\"\n    >\n      <div\n        class=\"dv-round-4 dv-hover\"\n        @click=\"${expandGroup}\"\n        style=\"display:flex;gap: 6px;padding: 0 4px;align-items:center;height: 100%;\"\n      >\n        ${FilterIcon()} ${text}\n      </div>\n      <div\n        class=\"dv-icon-16 dv-round-4 dv-pd-4 dv-hover\"\n        style=\"display:flex;align-items:center;margin-left: 16px;\"\n        @click=\"${deleteFilter}\"\n      >\n        ${CloseIcon()}\n      </div>\n    </div>`;\n  }\n\n  renderFilters() {\n    return this.data.conditions.map((_, i) => () => this.renderCondition(i));\n  }\n\n  override updated() {\n    this.updateMoreFilterPanel?.();\n  }\n\n  @property({ attribute: false })\n  accessor data!: FilterGroup;\n\n  @property({ attribute: false })\n  accessor setData!: (filter: FilterGroup) => void;\n\n  @property({ attribute: false })\n  accessor vars!: Variable[];\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'filter-bar': FilterBar;\n  }\n}\n"]}