{"version":3,"file":"condition.js","sourceRoot":"","sources":["../../../src/widget-presets/filter/condition.ts"],"names":[],"mappings":"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","sourcesContent":["import { popFilterableSimpleMenu } from '@lumensuite/affine-components/context-menu';\nimport { ShadowlessElement, WithDisposable } from '@lumensuite/block-std';\nimport { CloseIcon } from '@blocksuite/icons/lit';\nimport { css, html, nothing } from 'lit';\nimport { customElement, property } from 'lit/decorators.js';\nimport { repeat } from 'lit/directives/repeat.js';\n\nimport {\n  type FilterGroup,\n  firstFilter,\n  firstFilterByRef,\n  firstFilterInGroup,\n  getRefType,\n  type SingleFilter,\n  type Variable,\n  type VariableOrProperty,\n} from '../../core/common/ast.js';\nimport '../../core/common/literal/define.js';\nimport {\n  popLiteralEdit,\n  renderLiteral,\n} from '../../core/common/literal/matcher.js';\nimport '../../core/common/ref/ref.js';\nimport { tBoolean } from '../../core/logical/data-type.js';\nimport { typesystem } from '../../core/logical/typesystem.js';\nimport { filterMatcher } from './matcher/matcher.js';\n\n@customElement('filter-condition-view')\nexport class FilterConditionView extends WithDisposable(ShadowlessElement) {\n  static override styles = css`\n    filter-condition-view {\n      display: flex;\n      align-items: center;\n      padding: 4px;\n      gap: 16px;\n      border: 1px solid var(--affine-border-color);\n      border-radius: 8px;\n      background-color: var(--affine-white);\n    }\n\n    .filter-condition-expression {\n      display: flex;\n      align-items: center;\n      gap: 4px;\n    }\n\n    .filter-condition-delete {\n      border-radius: 4px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      height: max-content;\n      cursor: pointer;\n    }\n\n    .filter-condition-delete:hover {\n      background-color: var(--affine-hover-color);\n    }\n\n    .filter-condition-delete svg {\n      width: 16px;\n      height: 16px;\n    }\n\n    .filter-condition-function-name {\n      font-size: 12px;\n      line-height: 20px;\n      color: var(--affine-text-secondary-color);\n      padding: 2px 8px;\n      border-radius: 4px;\n      cursor: pointer;\n    }\n\n    .filter-condition-function-name:hover {\n      background-color: var(--affine-hover-color);\n    }\n\n    .filter-condition-arg {\n      font-size: 12px;\n      font-style: normal;\n      font-weight: 600;\n      padding: 0 4px;\n      height: 100%;\n      display: flex;\n      align-items: center;\n    }\n  `;\n\n  private _setRef = (ref: VariableOrProperty) => {\n    this.setData(firstFilterByRef(this.vars, ref));\n  };\n\n  private _args() {\n    const fn = filterMatcher.find(v => v.data.name === this.data.function);\n    if (!fn) {\n      return [];\n    }\n    const refType = getRefType(this.vars, this.data.left);\n    if (!refType) {\n      return [];\n    }\n    const type = typesystem.instance({}, [refType], tBoolean.create(), fn.type);\n    return type.args.slice(1);\n  }\n\n  private _filterLabel() {\n    return filterMatcher.find(v => v.data.name === this.data.function)?.data\n      .label;\n  }\n\n  private _filterList() {\n    const type = getRefType(this.vars, this.data.left);\n    if (!type) {\n      return [];\n    }\n    return filterMatcher.allMatchedData(type);\n  }\n\n  private _selectFilter(e: MouseEvent) {\n    const target = e.currentTarget as HTMLElement;\n    const list = this._filterList();\n    popFilterableSimpleMenu(\n      target,\n      list.map(v => {\n        const selected = v.name === this.data.function;\n        return {\n          type: 'action',\n          name: v.label,\n          isSelected: selected,\n          select: () => {\n            this.setData({\n              ...this.data,\n              function: v.name,\n            });\n          },\n        };\n      })\n    );\n  }\n\n  override render() {\n    const data = this.data;\n\n    return html`\n      <div class=\"filter-condition-expression\">\n        <variable-ref-view\n          .data=\"${data.left}\"\n          .setData=\"${this._setRef}\"\n          .vars=\"${this.vars}\"\n          style=\"height: 24px\"\n        ></variable-ref-view>\n        <div\n          class=\"filter-condition-function-name\"\n          @click=\"${this._selectFilter}\"\n        >\n          ${this._filterLabel()}\n        </div>\n        ${repeat(this._args(), (v, i) => {\n          const value = this.data.args[i];\n          const onChange = (value: unknown) => {\n            const newArr = this.data.args.slice();\n            newArr[i] = { type: 'literal', value };\n            this.setData({\n              ...this.data,\n              args: newArr,\n            });\n          };\n          const click = (e: MouseEvent) => {\n            popLiteralEdit(\n              e.currentTarget as HTMLElement,\n              v,\n              value?.value,\n              onChange\n            );\n          };\n          return html` <div\n            class=\"dv-hover dv-round-4 filter-condition-arg\"\n            @click=\"${click}\"\n          >\n            ${renderLiteral(v, value?.value, onChange)}\n          </div>`;\n        })}\n      </div>\n      ${this.onDelete\n        ? html` <div\n            @click=\"${this.onDelete}\"\n            class=\"dv-icon-16 dv-round-4 dv-pd-4 dv-hover\"\n            style=\"display:flex;align-items:center;\"\n          >\n            ${CloseIcon()}\n          </div>`\n        : nothing}\n    `;\n  }\n\n  @property({ attribute: false })\n  accessor data!: SingleFilter;\n\n  @property({ attribute: false })\n  accessor onDelete: (() => void) | undefined = undefined;\n\n  @property({ attribute: false })\n  accessor setData!: (filter: SingleFilter) => void;\n\n  @property({ attribute: false })\n  accessor vars!: Variable[];\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'filter-condition-view': FilterConditionView;\n  }\n}\nexport const popAddNewFilter = (\n  target: HTMLElement,\n  props: {\n    value: FilterGroup;\n    onChange: (value: FilterGroup) => void;\n    vars: Variable[];\n  }\n) => {\n  popFilterableSimpleMenu(target, [\n    {\n      type: 'action',\n      name: 'Add filter',\n      select: () => {\n        props.onChange({\n          ...props.value,\n          conditions: [...props.value.conditions, firstFilter(props.vars)],\n        });\n      },\n    },\n    {\n      type: 'action',\n      name: 'Add filter group',\n      select: () => {\n        props.onChange({\n          ...props.value,\n          conditions: [\n            ...props.value.conditions,\n            firstFilterInGroup(props.vars),\n          ],\n        });\n      },\n    },\n  ]);\n};\n"]}