{"version":3,"file":"drag.js","sourceRoot":"","sources":["../../../../src/view-presets/kanban/controller/drag.ts"],"names":[],"mappings":"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","sourcesContent":["import type { InsertToPosition } from '@blocksuite/affine-shared/utils';\nimport type { ReactiveController } from 'lit';\n\nimport { assertExists, Point, Rect } from '@blocksuite/global/utils';\n\nimport type { DataViewKanban } from '../kanban-view.js';\n\nimport { startDrag } from '../../../core/utils/drag.js';\nimport { autoScrollOnBoundary } from '../../../core/utils/frame-loop.js';\nimport { KanbanCard } from '../card.js';\nimport { KanbanGroup } from '../group.js';\n\nexport class KanbanDragController implements ReactiveController {\n  dragStart = (ele: KanbanCard, evt: PointerEvent) => {\n    const eleRect = ele.getBoundingClientRect();\n    const offsetLeft = evt.x - eleRect.left;\n    const offsetTop = evt.y - eleRect.top;\n    const preview = createDragPreview(\n      ele,\n      evt.x - offsetLeft,\n      evt.y - offsetTop\n    );\n    const currentGroup = ele.closest('affine-data-view-kanban-group');\n    const cancelScroll = autoScrollOnBoundary(this.scrollContainer);\n    startDrag<\n      | { type: 'out'; callback: () => void }\n      | {\n          type: 'self';\n          key: string;\n          position: InsertToPosition;\n        }\n      | undefined,\n      PointerEvent\n    >(evt, {\n      onDrag: () => undefined,\n      onMove: evt => {\n        if (!(evt.target instanceof HTMLElement)) {\n          return;\n        }\n        preview.display(evt.x - offsetLeft, evt.y - offsetTop);\n        if (!Rect.fromDOM(this.host).isPointIn(Point.from(evt))) {\n          const callback = this.host.onDrag;\n          if (callback) {\n            this.dropPreview.remove();\n            return {\n              type: 'out',\n              callback: callback(evt, ele.cardId),\n            };\n          }\n          return;\n        }\n        const result = this.shooIndicator(evt, ele);\n        if (result) {\n          return {\n            type: 'self',\n            key: result.group.group.key,\n            position: result.position,\n          };\n        }\n        return;\n      },\n      onClear: () => {\n        preview.remove();\n        this.dropPreview.remove();\n        cancelScroll();\n      },\n      onDrop: result => {\n        if (!result) {\n          return;\n        }\n        if (result.type === 'out') {\n          result.callback();\n          return;\n        }\n        if (result && currentGroup) {\n          currentGroup.group.manager.moveCardTo(\n            ele.cardId,\n            currentGroup.group.key,\n            result.key,\n            result.position\n          );\n        }\n      },\n    });\n  };\n\n  dropPreview = createDropPreview();\n\n  getInsertPosition = (\n    evt: MouseEvent\n  ):\n    | { group: KanbanGroup; card?: KanbanCard; position: InsertToPosition }\n    | undefined => {\n    const eles = document.elementsFromPoint(evt.x, evt.y);\n    const target = eles.find(v => v instanceof KanbanGroup) as KanbanGroup;\n    if (target) {\n      const card = getCardByPoint(target, evt.y);\n      return {\n        group: target,\n        card,\n        position: card\n          ? {\n              before: true,\n              id: card.cardId,\n            }\n          : 'end',\n      };\n    } else {\n      return;\n    }\n  };\n\n  shooIndicator = (\n    evt: MouseEvent,\n    self: KanbanCard | undefined\n  ): { group: KanbanGroup; position: InsertToPosition } | undefined => {\n    const position = this.getInsertPosition(evt);\n    if (position) {\n      this.dropPreview.display(position.group, self, position.card);\n    } else {\n      this.dropPreview.remove();\n    }\n    return position;\n  };\n\n  get scrollContainer() {\n    const scrollContainer = this.host.querySelector(\n      '.affine-data-view-kanban-groups'\n    ) as HTMLElement;\n    assertExists(scrollContainer);\n    return scrollContainer;\n  }\n\n  constructor(private host: DataViewKanban) {\n    this.host.addController(this);\n  }\n\n  hostConnected() {\n    if (this.host.view.readonly$.value) {\n      return;\n    }\n    this.host.disposables.add(\n      this.host.handleEvent('dragStart', context => {\n        const event = context.get('pointerState').raw;\n        const target = event.target;\n        if (target instanceof Element) {\n          const cell = target.closest('affine-data-view-kanban-cell');\n          if (cell?.editing) {\n            return;\n          }\n          cell?.selectCurrentCell(false);\n          const card = target.closest('affine-data-view-kanban-card');\n          if (card) {\n            this.dragStart(card, event);\n          }\n        }\n        return true;\n      })\n    );\n  }\n}\n\nconst createDragPreview = (card: KanbanCard, x: number, y: number) => {\n  const preOpacity = card.style.opacity;\n  card.style.opacity = '0.5';\n  const div = document.createElement('div');\n  const kanbanCard = new KanbanCard();\n  kanbanCard.cardId = card.cardId;\n  kanbanCard.view = card.view;\n  kanbanCard.isFocus = true;\n  kanbanCard.style.backgroundColor = 'var(--affine-background-primary-color)';\n  div.append(kanbanCard);\n  div.className = 'with-data-view-css-variable';\n  div.style.width = `${card.getBoundingClientRect().width}px`;\n  div.style.position = 'fixed';\n  // div.style.pointerEvents = 'none';\n  div.style.transform = 'rotate(-3deg)';\n  div.style.left = `${x}px`;\n  div.style.top = `${y}px`;\n  div.style.zIndex = '9999';\n  document.body.append(div);\n  return {\n    display(x: number, y: number) {\n      div.style.left = `${Math.round(x)}px`;\n      div.style.top = `${Math.round(y)}px`;\n    },\n    remove() {\n      card.style.opacity = preOpacity;\n      div.remove();\n    },\n  };\n};\nconst createDropPreview = () => {\n  const div = document.createElement('div');\n  div.style.height = '2px';\n  div.style.borderRadius = '1px';\n  div.style.backgroundColor = 'var(--affine-primary-color)';\n  div.style.boxShadow = '0px 0px 8px 0px rgba(30, 150, 235, 0.35)';\n  return {\n    display(\n      group: KanbanGroup,\n      self: KanbanCard | undefined,\n      card?: KanbanCard\n    ) {\n      const target = card ?? group.querySelector('.add-card');\n      assertExists(target);\n      if (target.previousElementSibling === self || target === self) {\n        div.remove();\n        return;\n      }\n      if (target.previousElementSibling === div) {\n        return;\n      }\n      target.insertAdjacentElement('beforebegin', div);\n    },\n    remove() {\n      div.remove();\n    },\n  };\n};\n\nconst getCardByPoint = (\n  group: KanbanGroup,\n  y: number\n): KanbanCard | undefined => {\n  const cards = Array.from(\n    group.querySelectorAll('affine-data-view-kanban-card')\n  );\n  const positions = cards.map(v => {\n    const rect = v.getBoundingClientRect();\n    return (rect.top + rect.bottom) / 2;\n  });\n  const index = positions.findIndex(v => v > y);\n  return cards[index];\n};\n"]}