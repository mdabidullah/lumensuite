{"version":3,"file":"kanban-view.js","sourceRoot":"","sources":["../../../src/view-presets/kanban/kanban-view.ts"],"names":[],"mappings":"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","sourcesContent":["import { popMenu } from '@blocksuite/affine-components/context-menu';\nimport { AddCursorIcon } from '@blocksuite/icons/lit';\nimport { css } from 'lit';\nimport { customElement, query } from 'lit/decorators.js';\nimport { repeat } from 'lit/directives/repeat.js';\nimport { html } from 'lit/static-html.js';\nimport Sortable from 'sortablejs';\n\nimport type { KanbanSingleView } from './kanban-view-manager.js';\nimport type { KanbanViewSelectionWithType } from './types.js';\n\nimport '../../core/common/group-by/define.js';\nimport { renderUniLit } from '../../core/index.js';\nimport { DataViewBase } from '../../core/view/data-view-base.js';\nimport { KanbanClipboardController } from './controller/clipboard.js';\nimport { KanbanDragController } from './controller/drag.js';\nimport { KanbanHotkeysController } from './controller/hotkeys.js';\nimport { KanbanSelectionController } from './controller/selection.js';\nimport { KanbanGroup } from './group.js';\nimport './header.js';\n\nconst styles = css`\n  affine-data-view-kanban {\n    user-select: none;\n    overflow: hidden;\n    display: flex;\n    flex-direction: column;\n  }\n\n  .affine-data-view-kanban-groups {\n    position: relative;\n    z-index: 1;\n    display: flex;\n    gap: 20px;\n    width: 100%;\n    padding-bottom: 4px;\n    overflow-x: scroll;\n    overflow-y: hidden;\n  }\n\n  .affine-data-view-kanban-groups:hover {\n    padding-bottom: 0px;\n  }\n\n  .affine-data-view-kanban-groups::-webkit-scrollbar {\n    -webkit-appearance: none;\n    display: block;\n  }\n\n  .affine-data-view-kanban-groups::-webkit-scrollbar:horizontal {\n    height: 4px;\n  }\n\n  .affine-data-view-kanban-groups::-webkit-scrollbar-thumb {\n    border-radius: 2px;\n    background-color: transparent;\n  }\n\n  .affine-data-view-kanban-groups:hover::-webkit-scrollbar:horizontal {\n    height: 8px;\n  }\n\n  .affine-data-view-kanban-groups:hover::-webkit-scrollbar-thumb {\n    border-radius: 16px;\n    background-color: var(--affine-black-30);\n  }\n\n  .affine-data-view-kanban-groups:hover::-webkit-scrollbar-track {\n    background-color: var(--affine-hover-color);\n  }\n\n  .add-group-icon {\n    padding: 4px;\n    border-radius: 4px;\n    display: flex;\n    align-items: center;\n    cursor: pointer;\n  }\n\n  .add-group-icon:hover {\n    background-color: var(--affine-hover-color);\n  }\n\n  .add-group-icon svg {\n    width: 16px;\n    height: 16px;\n    fill: var(--affine-icon-color);\n    color: var(--affine-icon-color);\n  }\n`;\n\n@customElement('affine-data-view-kanban')\nexport class DataViewKanban extends DataViewBase<\n  KanbanSingleView,\n  KanbanViewSelectionWithType\n> {\n  static override styles = styles;\n\n  private dragController = new KanbanDragController(this);\n\n  clipboardController = new KanbanClipboardController(this);\n\n  hotkeysController = new KanbanHotkeysController(this);\n\n  onWheel = (event: WheelEvent) => {\n    if (event.metaKey || event.ctrlKey) {\n      return;\n    }\n    const ele = event.currentTarget;\n    if (ele instanceof HTMLElement) {\n      if (ele.scrollWidth === ele.clientWidth) {\n        return;\n      }\n      event.stopPropagation();\n    }\n  };\n\n  renderAddGroup = () => {\n    const addGroup = this.groupManager.addGroup;\n    if (!addGroup) {\n      return;\n    }\n    const add = (e: MouseEvent) => {\n      const ele = e.currentTarget as HTMLElement;\n      popMenu(ele, {\n        options: {\n          input: {\n            onComplete: text => {\n              const column = this.groupManager.column$.value;\n              if (column) {\n                column.updateData(\n                  () => addGroup(text, column.data$.value) as never\n                );\n              }\n            },\n          },\n          items: [],\n        },\n      });\n    };\n    return html` <div\n      style=\"height: 32px;width: 100px;flex-shrink:0;display:flex;align-items:center;\"\n      @click=\"${add}\"\n    >\n      <div class=\"add-group-icon\">${AddCursorIcon()}</div>\n    </div>`;\n  };\n\n  selectionController = new KanbanSelectionController(this);\n\n  get groupManager() {\n    return this.view.groupManager;\n  }\n\n  override firstUpdated() {\n    const sortable = Sortable.create(this.groups, {\n      group: `kanban-group-drag-${this.view.id}`,\n      handle: '.group-header',\n      draggable: 'affine-data-view-kanban-group',\n      animation: 100,\n      onEnd: evt => {\n        if (evt.item instanceof KanbanGroup) {\n          const groups = Array.from(\n            this.groups.querySelectorAll('affine-data-view-kanban-group')\n          );\n\n          const key =\n            evt.newIndex != null\n              ? groups[evt.newIndex - 1]?.group.key\n              : undefined;\n          this.groupManager?.moveGroupTo(\n            evt.item.group.key,\n            key\n              ? {\n                  before: false,\n                  id: key,\n                }\n              : 'start'\n          );\n        }\n      },\n    });\n    this._disposables.add({\n      dispose: () => {\n        sortable.destroy();\n      },\n    });\n  }\n\n  focusFirstCell(): void {\n    this.selectionController.focusFirstCell();\n  }\n\n  getSelection() {\n    return this.selectionController.selection;\n  }\n\n  hideIndicator(): void {\n    this.dragController.dropPreview.remove();\n  }\n\n  moveTo(id: string, evt: MouseEvent): void {\n    const position = this.dragController.getInsertPosition(evt);\n    if (position) {\n      position.group.group.manager.moveCardTo(\n        id,\n        '',\n        position.group.group.key,\n        position.position\n      );\n    }\n  }\n\n  override render() {\n    const groups = this.groupManager.groupsDataList$.value;\n    if (!groups) {\n      return html``;\n    }\n\n    return html`\n      ${renderUniLit(this.headerWidget, {\n        view: this.view,\n        viewMethods: this,\n      })}\n      <div class=\"affine-data-view-kanban-groups\" @wheel=\"${this.onWheel}\">\n        ${repeat(\n          groups,\n          group => group.key,\n          group => {\n            return html` <affine-data-view-kanban-group\n              data-key=\"${group.key}\"\n              .dataViewEle=\"${this.dataViewEle}\"\n              .view=\"${this.view}\"\n              .group=\"${group}\"\n            ></affine-data-view-kanban-group>`;\n          }\n        )}\n        ${this.renderAddGroup()}\n      </div>\n    `;\n  }\n\n  showIndicator(evt: MouseEvent): boolean {\n    return this.dragController.shooIndicator(evt, undefined) != null;\n  }\n\n  @query('.affine-data-view-kanban-groups')\n  accessor groups!: HTMLElement;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-data-view-kanban': DataViewKanban;\n  }\n}\n"]}