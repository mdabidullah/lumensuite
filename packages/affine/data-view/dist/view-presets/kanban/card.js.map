{"version":3,"file":"card.js","sourceRoot":"","sources":["../../../src/view-presets/kanban/card.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  ShadowlessElement,\n  SignalWatcher,\n  WithDisposable,\n} from '@lumensuite/block-std';\nimport { CenterPeekIcon, MoreHorizontalIcon } from '@blocksuite/icons/lit';\nimport { css } from 'lit';\nimport { customElement, property, state } from 'lit/decorators.js';\nimport { classMap } from 'lit/directives/class-map.js';\nimport { repeat } from 'lit/directives/repeat.js';\nimport { html } from 'lit/static-html.js';\n\nimport type { DataViewRenderer } from '../../core/data-view.js';\nimport type { KanbanColumn, KanbanSingleView } from './kanban-view-manager.js';\n\nimport './cell.js';\nimport { openDetail, popCardMenu } from './menu.js';\n\nconst styles = css`\n  affine-data-view-kanban-card {\n    display: flex;\n    position: relative;\n    flex-direction: column;\n    border: 1px solid var(--affine-border-color);\n    box-shadow: 0px 2px 3px 0px rgba(0, 0, 0, 0.05);\n    border-radius: 8px;\n    transition: background-color 100ms ease-in-out;\n    background-color: var(--affine-background-kanban-card-color);\n  }\n\n  affine-data-view-kanban-card:hover {\n    background-color: var(--affine-hover-color);\n  }\n\n  affine-data-view-kanban-card .card-header {\n    padding: 8px;\n    display: flex;\n    flex-direction: column;\n    gap: 8px;\n  }\n\n  affine-data-view-kanban-card .card-header-title uni-lit {\n    width: 100%;\n  }\n\n  .card-header.has-divider {\n    border-bottom: 0.5px solid var(--affine-border-color);\n  }\n\n  affine-data-view-kanban-card .card-header-title {\n    font-size: var(--data-view-cell-text-size);\n    line-height: var(--data-view-cell-text-line-height);\n  }\n\n  affine-data-view-kanban-card .card-header-icon {\n    padding: 4px;\n    background-color: var(--affine-background-secondary-color);\n    display: flex;\n    align-items: center;\n    border-radius: 4px;\n    width: max-content;\n  }\n\n  affine-data-view-kanban-card .card-header-icon svg {\n    width: 16px;\n    height: 16px;\n    fill: var(--affine-icon-color);\n    color: var(--affine-icon-color);\n  }\n\n  affine-data-view-kanban-card .card-body {\n    display: flex;\n    flex-direction: column;\n    padding: 8px;\n    gap: 4px;\n  }\n\n  affine-data-view-kanban-card:hover .card-ops {\n    visibility: visible;\n  }\n\n  .card-ops {\n    position: absolute;\n    right: 8px;\n    top: 8px;\n    visibility: hidden;\n    display: flex;\n    gap: 4px;\n    cursor: pointer;\n  }\n\n  .card-op {\n    display: flex;\n    position: relative;\n    padding: 4px;\n    border-radius: 4px;\n    box-shadow: 0px 0px 4px 0px rgba(66, 65, 73, 0.14);\n    background-color: var(--affine-background-primary-color);\n  }\n\n  .card-op:hover:before {\n    content: '';\n    border-radius: 4px;\n    position: absolute;\n    left: 0;\n    right: 0;\n    top: 0;\n    bottom: 0;\n    background-color: var(--affine-hover-color);\n  }\n\n  .card-op svg {\n    fill: var(--affine-icon-color);\n    color: var(--affine-icon-color);\n    width: 16px;\n    height: 16px;\n  }\n`;\n\n@customElement('affine-data-view-kanban-card')\nexport class KanbanCard extends SignalWatcher(\n  WithDisposable(ShadowlessElement)\n) {\n  static override styles = styles;\n\n  private clickEdit = (e: MouseEvent) => {\n    e.stopPropagation();\n    const selection = this.getSelection();\n    if (selection) {\n      openDetail(this.dataViewEle, this.cardId, selection);\n    }\n  };\n\n  private clickMore = (e: MouseEvent) => {\n    e.stopPropagation();\n    const selection = this.getSelection();\n    const ele = e.currentTarget as HTMLElement;\n    if (selection) {\n      selection.selection = {\n        selectionType: 'card',\n        cards: [\n          {\n            groupKey: this.groupKey,\n            cardId: this.cardId,\n          },\n        ],\n      };\n      popCardMenu(this.dataViewEle, ele, this.cardId, selection);\n    }\n  };\n\n  private contextMenu = (e: MouseEvent) => {\n    e.stopPropagation();\n    e.preventDefault();\n    const selection = this.getSelection();\n    if (selection) {\n      selection.selection = {\n        selectionType: 'card',\n        cards: [\n          {\n            groupKey: this.groupKey,\n            cardId: this.cardId,\n          },\n        ],\n      };\n      const target = e.target as HTMLElement;\n      const ref = target.closest('affine-data-view-kanban-cell') ?? this;\n      popCardMenu(this.dataViewEle, ref, this.cardId, selection);\n    }\n  };\n\n  private getSelection() {\n    return this.closest('affine-data-view-kanban')?.selectionController;\n  }\n\n  private renderBody(columns: KanbanColumn[]) {\n    if (columns.length === 0) {\n      return '';\n    }\n    return html` <div class=\"card-body\">\n      ${repeat(\n        columns,\n        v => v.id,\n        column => {\n          if (this.view.isInHeader(column.id)) {\n            return '';\n          }\n          return html` <affine-data-view-kanban-cell\n            .contentOnly=\"${false}\"\n            data-column-id=\"${column.id}\"\n            .view=\"${this.view}\"\n            .groupKey=\"${this.groupKey}\"\n            .column=\"${column}\"\n            .cardId=\"${this.cardId}\"\n          ></affine-data-view-kanban-cell>`;\n        }\n      )}\n    </div>`;\n  }\n\n  private renderHeader(columns: KanbanColumn[]) {\n    if (!this.view.hasHeader(this.cardId)) {\n      return '';\n    }\n    const classList = classMap({\n      'card-header': true,\n      'has-divider': columns.length > 0,\n    });\n    return html`\n      <div class=\"${classList}\">${this.renderTitle()} ${this.renderIcon()}</div>\n    `;\n  }\n\n  private renderIcon() {\n    const icon = this.view.getHeaderIcon(this.cardId);\n    if (!icon) {\n      return;\n    }\n    return html` <div class=\"card-header-icon\">\n      ${icon.cellGet(this.cardId).value$.value}\n    </div>`;\n  }\n\n  private renderOps() {\n    if (this.view.readonly$.value) {\n      return;\n    }\n    return html`\n      <div class=\"card-ops\">\n        <div class=\"card-op\" @click=\"${this.clickEdit}\">\n          ${CenterPeekIcon()}\n        </div>\n        <div class=\"card-op\" @click=\"${this.clickMore}\">\n          ${MoreHorizontalIcon()}\n        </div>\n      </div>\n    `;\n  }\n\n  private renderTitle() {\n    const title = this.view.getHeaderTitle(this.cardId);\n    if (!title) {\n      return;\n    }\n    return html` <div class=\"card-header-title\">\n      <affine-data-view-kanban-cell\n        .contentOnly=\"${true}\"\n        data-column-id=\"${title.id}\"\n        .view=\"${this.view}\"\n        .groupKey=\"${this.groupKey}\"\n        .column=\"${title}\"\n        .cardId=\"${this.cardId}\"\n      ></affine-data-view-kanban-cell>\n    </div>`;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    if (this.view.readonly$.value) {\n      return;\n    }\n    this._disposables.addFromEvent(this, 'contextmenu', e => {\n      this.contextMenu(e);\n    });\n    this._disposables.addFromEvent(this, 'click', e => {\n      if (e.shiftKey) {\n        this.getSelection()?.shiftClickCard(e);\n        return;\n      }\n      const selection = this.getSelection();\n      const preSelection = selection?.selection;\n\n      if (preSelection?.selectionType !== 'card') return;\n\n      if (selection) {\n        selection.selection = undefined;\n      }\n      this.dataViewEle.openDetailPanel({\n        view: this.view,\n        rowId: this.cardId,\n        onClose: () => {\n          if (selection) {\n            selection.selection = preSelection;\n          }\n        },\n      });\n    });\n  }\n\n  override render() {\n    const columns = this.view.columnManagerList$.value.filter(\n      v => !this.view.isInHeader(v.id)\n    );\n    this.style.border = this.isFocus\n      ? '1px solid var(--affine-primary-color)'\n      : '';\n    return html`\n      ${this.renderHeader(columns)} ${this.renderBody(columns)}\n      ${this.renderOps()}\n    `;\n  }\n\n  @property({ attribute: false })\n  accessor cardId!: string;\n\n  @property({ attribute: false })\n  accessor dataViewEle!: DataViewRenderer;\n\n  @property({ attribute: false })\n  accessor groupKey!: string;\n\n  @state()\n  accessor isFocus = false;\n\n  @property({ attribute: false })\n  accessor view!: KanbanSingleView;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-data-view-kanban-card': KanbanCard;\n  }\n}\n"]}