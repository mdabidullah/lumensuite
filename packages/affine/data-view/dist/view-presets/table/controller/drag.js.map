{"version":3,"file":"drag.js","sourceRoot":"","sources":["../../../../src/view-presets/table/controller/drag.ts"],"names":[],"mappings":"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","sourcesContent":["// related component\n\nimport type { InsertToPosition } from '@lumensuite/affine-shared/utils';\nimport type { ReactiveController } from 'lit';\n\nimport type { DataViewTable } from '../table-view.js';\n\nimport { startDrag } from '../../../core/utils/drag.js';\nimport { TableRow } from '../row/row.js';\n\nexport class TableDragController implements ReactiveController {\n  dragStart = (row: TableRow, evt: PointerEvent) => {\n    const eleRect = row.getBoundingClientRect();\n    const offsetLeft = evt.x - eleRect.left;\n    const offsetTop = evt.y - eleRect.top;\n    const preview = createDragPreview(\n      row,\n      evt.x - offsetLeft,\n      evt.y - offsetTop\n    );\n    const fromGroup = row.groupKey;\n\n    startDrag<\n      | undefined\n      | {\n          type: 'self';\n          groupKey?: string;\n          position: InsertToPosition;\n        }\n      | { type: 'out'; callback: () => void },\n      PointerEvent\n    >(evt, {\n      onDrag: () => undefined,\n      onMove: evt => {\n        preview.display(evt.x - offsetLeft, evt.y - offsetTop);\n        if (!this.host.contains(evt.target as Node)) {\n          const callback = this.host.onDrag;\n          if (callback) {\n            this.dropPreview.remove();\n            return {\n              type: 'out',\n              callback: callback(evt, row.rowId),\n            };\n          }\n          return;\n        }\n        const result = this.showIndicator(evt);\n        if (result) {\n          return {\n            type: 'self',\n            groupKey: result.groupKey,\n            position: result.position,\n          };\n        }\n        return;\n      },\n      onClear: () => {\n        preview.remove();\n        this.dropPreview.remove();\n      },\n      onDrop: result => {\n        if (!result) {\n          return;\n        }\n        if (result.type === 'out') {\n          result.callback();\n          return;\n        }\n        if (result.type === 'self') {\n          this.host.view.rowMove(\n            row.rowId,\n            result.position,\n            fromGroup,\n            result.groupKey\n          );\n        }\n      },\n    });\n  };\n\n  dropPreview = createDropPreview();\n\n  getInsertPosition = (\n    evt: MouseEvent\n  ):\n    | {\n        groupKey: string | undefined;\n        position: InsertToPosition;\n        y: number;\n        width: number;\n        x: number;\n      }\n    | undefined => {\n    const y = evt.y;\n    const tableRect = this.host.getBoundingClientRect();\n    const rows = this.host.querySelectorAll('data-view-table-row');\n    if (!rows || !tableRect || y < tableRect.top) {\n      return;\n    }\n    for (let i = 0; i < rows.length; i++) {\n      const row = rows.item(i);\n      const rect = row.getBoundingClientRect();\n      const mid = (rect.top + rect.bottom) / 2;\n      if (y < rect.bottom) {\n        return {\n          groupKey: row.groupKey,\n          position: {\n            id: row.dataset.rowId as string,\n            before: y < mid,\n          },\n          y: y < mid ? rect.top : rect.bottom,\n          width: tableRect.width,\n          x: tableRect.left,\n        };\n      }\n    }\n    return;\n  };\n\n  showIndicator = (evt: MouseEvent) => {\n    const position = this.getInsertPosition(evt);\n    if (position) {\n      this.dropPreview.display(position.x, position.y, position.width);\n    } else {\n      this.dropPreview.remove();\n    }\n    return position;\n  };\n\n  constructor(private host: DataViewTable) {\n    this.host.addController(this);\n  }\n\n  hostConnected() {\n    if (this.host.view.readonly$.value) {\n      return;\n    }\n    this.host.disposables.add(\n      this.host.handleEvent('dragStart', context => {\n        const event = context.get('pointerState').raw;\n        const target = event.target;\n        if (\n          target instanceof Element &&\n          this.host.contains(target) &&\n          target.closest('.data-view-table-view-drag-handler')\n        ) {\n          event.preventDefault();\n          const row = target.closest('data-view-table-row');\n          if (row) {\n            getSelection()?.removeAllRanges();\n            this.dragStart(row, event);\n          }\n          return true;\n        }\n        return false;\n      })\n    );\n  }\n}\n\nconst createDragPreview = (row: TableRow, x: number, y: number) => {\n  const div = document.createElement('div');\n  const cloneRow = new TableRow();\n  cloneRow.view = row.view;\n  cloneRow.rowIndex = row.rowIndex;\n  cloneRow.rowId = row.rowId;\n  cloneRow.dataViewEle = row.dataViewEle;\n  div.append(cloneRow);\n  div.className = 'with-data-view-css-variable';\n  div.style.width = `${row.getBoundingClientRect().width}px`;\n  div.style.position = 'fixed';\n  div.style.pointerEvents = 'none';\n  div.style.backgroundColor = 'var(--affine-background-primary-color)';\n  div.style.boxShadow = 'var(--affine-shadow-2)';\n  div.style.left = `${x}px`;\n  div.style.top = `${y}px`;\n  div.style.zIndex = '9999';\n  document.body.append(div);\n  return {\n    display(x: number, y: number) {\n      div.style.left = `${Math.round(x)}px`;\n      div.style.top = `${Math.round(y)}px`;\n    },\n    remove() {\n      div.remove();\n    },\n  };\n};\nconst createDropPreview = () => {\n  const div = document.createElement('div');\n  div.dataset.isDropPreview = 'true';\n  div.style.pointerEvents = 'none';\n  div.style.position = 'fixed';\n  div.style.zIndex = '9999';\n  div.style.height = '2px';\n  div.style.borderRadius = '1px';\n  div.style.backgroundColor = 'var(--affine-primary-color)';\n  div.style.boxShadow = '0px 0px 8px 0px rgba(30, 150, 235, 0.35)';\n  return {\n    display(x: number, y: number, width: number) {\n      document.body.append(div);\n      div.style.left = `${x}px`;\n      div.style.top = `${y - 2}px`;\n      div.style.width = `${width}px`;\n    },\n    remove() {\n      div.remove();\n    },\n  };\n};\n"]}