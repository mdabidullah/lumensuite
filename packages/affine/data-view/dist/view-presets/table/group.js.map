{"version":3,"file":"group.js","sourceRoot":"","sources":["../../../src/view-presets/table/group.ts"],"names":[],"mappings":"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","sourcesContent":["import { popFilterableSimpleMenu } from '@lumensuite/affine-components/context-menu';\nimport {\n  ShadowlessElement,\n  SignalWatcher,\n  WithDisposable,\n} from '@lumensuite/block-std';\nimport { PlusIcon } from '@blocksuite/icons/lit';\nimport { css, html, type PropertyValues } from 'lit';\nimport { customElement, property } from 'lit/decorators.js';\nimport { repeat } from 'lit/directives/repeat.js';\n\nimport type { GroupData } from '../../core/common/group-by/helper.js';\nimport type { DataViewRenderer } from '../../core/data-view.js';\nimport type { DataViewTable } from './table-view.js';\nimport type { TableSingleView } from './table-view-manager.js';\n\nimport { GroupTitle } from '../../core/common/group-by/group-title.js';\nimport { LEFT_TOOL_BAR_WIDTH } from './consts.js';\nimport './stats/column-stats-bar.js';\nimport './stats/column-stats-column.js';\nimport { TableAreaSelection } from './types.js';\n\nconst styles = css`\n  affine-data-view-table-group:hover .group-header-op {\n    visibility: visible;\n    opacity: 1;\n  }\n  .data-view-table-group-add-row {\n    display: flex;\n    width: 100%;\n    height: 28px;\n    position: relative;\n    z-index: 0;\n    cursor: pointer;\n    transition: opacity 0.2s ease-in-out;\n    padding: 4px 8px;\n    border-bottom: 1px solid var(--affine-border-color);\n  }\n\n  @media print {\n    .data-view-table-group-add-row {\n      display: none;\n    }\n  }\n\n  .data-view-table-group-add-row-button {\n    position: sticky;\n    left: ${8 + LEFT_TOOL_BAR_WIDTH}px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 10px;\n    user-select: none;\n    font-size: 12px;\n    line-height: 20px;\n    color: var(--affine-text-secondary-color);\n  }\n`;\n\n@customElement('affine-data-view-table-group')\nexport class TableGroup extends SignalWatcher(\n  WithDisposable(ShadowlessElement)\n) {\n  static override styles = styles;\n\n  private clickAddRow = () => {\n    this.view.rowAdd('end', this.group?.key);\n    requestAnimationFrame(() => {\n      const selectionController = this.viewEle.selectionController;\n      const index = this.view.columnManagerList$.value.findIndex(\n        v => v.type$.value === 'title'\n      );\n      selectionController.selection = TableAreaSelection.create({\n        groupKey: this.group?.key,\n        focus: {\n          rowIndex: this.rows.length - 1,\n          columnIndex: index,\n        },\n        isEditing: true,\n      });\n    });\n  };\n\n  private clickAddRowInStart = () => {\n    this.view.rowAdd('start', this.group?.key);\n    requestAnimationFrame(() => {\n      const selectionController = this.viewEle.selectionController;\n      const index = this.view.columnManagerList$.value.findIndex(\n        v => v.type$.value === 'title'\n      );\n      selectionController.selection = TableAreaSelection.create({\n        groupKey: this.group?.key,\n        focus: {\n          rowIndex: 0,\n          columnIndex: index,\n        },\n        isEditing: true,\n      });\n    });\n  };\n\n  private clickGroupOptions = (e: MouseEvent) => {\n    const group = this.group;\n    if (!group) {\n      return;\n    }\n    const ele = e.currentTarget as HTMLElement;\n    popFilterableSimpleMenu(ele, [\n      {\n        type: 'action',\n        name: 'Ungroup',\n        hide: () => group.value == null,\n        select: () => {\n          group.rows.forEach(id => {\n            group.manager.removeFromGroup(id, group.key);\n          });\n        },\n      },\n      {\n        type: 'action',\n        name: 'Delete Cards',\n        select: () => {\n          this.view.rowDelete(group.rows);\n        },\n      },\n    ]);\n  };\n\n  private renderGroupHeader = () => {\n    if (!this.group) {\n      return null;\n    }\n    return html`\n      <div\n        style=\"position: sticky;left: 0;width: max-content;padding: 6px 0;margin-bottom: 4px;display:flex;align-items:center;gap: 12px;max-width: 400px\"\n      >\n        ${GroupTitle(this.group, {\n          readonly: this.view.readonly$.value,\n          clickAdd: this.clickAddRowInStart,\n          clickOps: this.clickGroupOptions,\n        })}\n      </div>\n    `;\n  };\n\n  get rows() {\n    return this.group?.rows ?? this.view.rows$.value;\n  }\n\n  private renderRows(ids: string[]) {\n    return html`\n      <affine-database-column-header\n        .renderGroupHeader=\"${this.renderGroupHeader}\"\n        .tableViewManager=\"${this.view}\"\n      ></affine-database-column-header>\n      <div class=\"affine-database-block-rows\">\n        ${repeat(\n          ids,\n          id => id,\n          (id, idx) => {\n            return html`<data-view-table-row\n              data-row-index=\"${idx}\"\n              data-row-id=\"${id}\"\n              .dataViewEle=\"${this.dataViewEle}\"\n              .view=\"${this.view}\"\n              .rowId=\"${id}\"\n              .rowIndex=\"${idx}\"\n            ></data-view-table-row>`;\n          }\n        )}\n      </div>\n      ${this.view.readonly$.value\n        ? null\n        : html` <div\n            class=\"data-view-table-group-add-row dv-hover\"\n            @click=\"${this.clickAddRow}\"\n          >\n            <div\n              class=\"data-view-table-group-add-row-button dv-icon-16\"\n              data-test-id=\"affine-database-add-row-button\"\n              role=\"button\"\n            >\n              ${PlusIcon()}<span>New Record</span>\n            </div>\n          </div>`}\n      <affine-database-column-stats .view=\"${this.view}\" .group=${this.group}>\n      </affine-database-column-stats>\n    `;\n  }\n\n  override render() {\n    return this.renderRows(this.rows);\n  }\n\n  protected override updated(_changedProperties: PropertyValues) {\n    super.updated(_changedProperties);\n    this.querySelectorAll('data-view-table-row').forEach(ele => {\n      ele.requestUpdate();\n    });\n  }\n\n  @property({ attribute: false })\n  accessor dataViewEle!: DataViewRenderer;\n\n  @property({ attribute: false })\n  accessor group: GroupData | undefined = undefined;\n\n  @property({ attribute: false })\n  accessor view!: TableSingleView;\n\n  @property({ attribute: false })\n  accessor viewEle!: DataViewTable;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-data-view-table-group': TableGroup;\n  }\n}\n"]}