{"version":3,"file":"vertical-indicator.js","sourceRoot":"","sources":["../../../../src/view-presets/table/header/vertical-indicator.ts"],"names":[],"mappings":"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","sourcesContent":["import { ShadowlessElement, WithDisposable } from '@lumensuite/block-std';\nimport { css, html } from 'lit';\nimport { customElement, property } from 'lit/decorators.js';\nimport { classMap } from 'lit/directives/class-map.js';\nimport { repeat } from 'lit/directives/repeat.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport type { TableColumn } from '../table-view-manager.js';\n\nimport { startDrag } from '../../../core/utils/drag.js';\nimport { getResultInRange } from '../../../core/utils/utils.js';\nimport { DEFAULT_COLUMN_MIN_WIDTH } from '../consts.js';\n\ntype GroupRectList = {\n  top: number;\n  bottom: number;\n}[];\n\n@customElement('data-view-table-vertical-indicator')\nexport class TableVerticalIndicator extends WithDisposable(ShadowlessElement) {\n  static override styles = css`\n    data-view-table-vertical-indicator {\n      position: fixed;\n      left: 0;\n      top: 0;\n      z-index: 1;\n      pointer-events: none;\n    }\n\n    .vertical-indicator-container {\n      position: absolute;\n      pointer-events: none;\n    }\n\n    .vertical-indicator-group {\n      position: absolute;\n      z-index: 1;\n      width: 100%;\n      background-color: var(--affine-hover-color);\n      pointer-events: none;\n    }\n    .vertical-indicator-group::after {\n      position: absolute;\n      z-index: 1;\n      width: 2px;\n      height: 100%;\n      content: '';\n      right: 0;\n      background-color: var(--affine-primary-color);\n      border-radius: 1px;\n    }\n    .with-shadow.vertical-indicator-group::after {\n      box-shadow: 0px 0px 8px 0px rgba(30, 150, 235, 0.35);\n    }\n  `;\n\n  protected override render(): unknown {\n    const containerStyle = styleMap({\n      top: `${this.top}px`,\n      left: `${this.left}px`,\n      width: `${Math.max(this.width, 1)}px`,\n    });\n    return html`\n      <div class=\"vertical-indicator-container\" style=${containerStyle}>\n        ${repeat(this.lines, ({ top, bottom }) => {\n          const groupStyle = styleMap({\n            top: `${top}px`,\n            height: `${bottom - top}px`,\n          });\n          const groupClass = classMap({\n            'with-shadow': this.shadow,\n            'vertical-indicator-group': true,\n          });\n          return html`<div class=\"${groupClass}\" style=${groupStyle}></div>`;\n        })}\n      </div>\n    `;\n  }\n\n  @property({ attribute: false })\n  accessor left!: number;\n\n  @property({ attribute: false })\n  accessor lines!: GroupRectList;\n\n  @property({ attribute: false })\n  accessor shadow = false;\n\n  @property({ attribute: false })\n  accessor top!: number;\n\n  @property({ attribute: false })\n  accessor width!: number;\n}\n\nexport const getTableGroupRects = (tableContainer: HTMLElement) => {\n  const tableRect = tableContainer.getBoundingClientRect();\n  const groups = tableContainer.querySelectorAll(\n    'affine-data-view-table-group'\n  );\n  return Array.from(groups).map(group => {\n    const groupRect = group.getBoundingClientRect();\n    const top =\n      group\n        .querySelector('.affine-database-column-header')\n        ?.getBoundingClientRect().top ?? groupRect.top;\n    const bottom =\n      group\n        .querySelector('.affine-database-block-rows')\n        ?.getBoundingClientRect().bottom ?? groupRect.bottom;\n    return {\n      top: top - tableRect.top,\n      bottom: bottom - tableRect.top,\n    };\n  });\n};\nexport const startDragWidthAdjustmentBar = (\n  evt: PointerEvent,\n  tableContainer: HTMLElement,\n  width: number,\n  column: TableColumn\n) => {\n  const scale = width / column.width$.value;\n  const tableRect = tableContainer.getBoundingClientRect();\n  const left =\n    tableContainer\n      .querySelector(\n        `affine-database-header-column[data-column-id='${column.id}']`\n      )\n      ?.getBoundingClientRect().left ?? 0;\n  const rectList = getTableGroupRects(tableContainer);\n  const preview = getVerticalIndicator();\n  preview.display(column.width$.value * scale, tableRect.top, rectList, left);\n  tableContainer.style.pointerEvents = 'none';\n  startDrag<{ width: number }>(evt, {\n    onDrag: () => ({ width: column.width$.value }),\n    onMove: ({ x }) => {\n      const width = Math.round(\n        getResultInRange((x - left) / scale, DEFAULT_COLUMN_MIN_WIDTH, Infinity)\n      );\n      preview.display(width * scale, tableRect.top, rectList, left);\n      return {\n        width,\n      };\n    },\n    onDrop: ({ width }) => {\n      column.updateWidth(width);\n    },\n    onClear: () => {\n      tableContainer.style.pointerEvents = 'auto';\n      preview.remove();\n    },\n  });\n};\nlet preview: VerticalIndicator | null = null;\ntype VerticalIndicator = {\n  display: (\n    width: number,\n    top: number,\n    lines: GroupRectList,\n    left: number,\n    shadow?: boolean\n  ) => void;\n  remove: () => void;\n};\nexport const getVerticalIndicator = (): VerticalIndicator => {\n  if (!preview) {\n    const dragBar = new TableVerticalIndicator();\n    preview = {\n      display(\n        width: number,\n        top: number,\n        lines: GroupRectList,\n        left: number,\n        shadow = false\n      ) {\n        document.body.append(dragBar);\n        dragBar.left = left;\n        dragBar.lines = lines;\n        dragBar.top = top;\n        dragBar.width = width;\n        dragBar.shadow = shadow;\n      },\n      remove() {\n        dragBar.remove();\n      },\n    };\n  }\n\n  return preview;\n};\n"]}