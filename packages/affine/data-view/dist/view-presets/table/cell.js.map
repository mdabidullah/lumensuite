{"version":3,"file":"cell.js","sourceRoot":"","sources":["../../../src/view-presets/table/cell.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  ShadowlessElement,\n  SignalWatcher,\n  WithDisposable,\n} from '@blocksuite/block-std';\nimport { assertExists } from '@blocksuite/global/utils';\nimport { computed } from '@lit-labs/preact-signals';\nimport { css } from 'lit';\nimport { customElement, property, state } from 'lit/decorators.js';\nimport { createRef } from 'lit/directives/ref.js';\n\nimport type {\n  CellRenderProps,\n  DataViewCellLifeCycle,\n} from '../../core/column/index.js';\nimport type { SingleView } from '../../core/view-manager/single-view.js';\nimport type { TableColumn } from './table-view-manager.js';\n\nimport { renderUniLit } from '../../core/index.js';\nimport {\n  TableAreaSelection,\n  type TableViewSelectionWithType,\n} from './types.js';\n\n@customElement('affine-database-cell-container')\nexport class DatabaseCellContainer extends SignalWatcher(\n  WithDisposable(ShadowlessElement)\n) {\n  static override styles = css`\n    affine-database-cell-container {\n      display: flex;\n      align-items: start;\n      width: 100%;\n      height: 100%;\n      border: none;\n      outline: none;\n    }\n\n    affine-database-cell-container * {\n      box-sizing: border-box;\n    }\n\n    affine-database-cell-container uni-lit > *:first-child {\n      padding: 8px;\n    }\n  `;\n\n  private _cell = createRef<DataViewCellLifeCycle>();\n\n  cell$ = computed(() => {\n    return this.column.cellGet(this.rowId);\n  });\n\n  selectCurrentCell = (editing: boolean) => {\n    if (this.view.readonly$.value) {\n      return;\n    }\n    const selectionView = this.selectionView;\n    if (selectionView) {\n      const selection = selectionView.selection;\n      if (selection && this.isSelected(selection) && editing) {\n        selectionView.selection = TableAreaSelection.create({\n          groupKey: this.groupKey,\n          focus: {\n            rowIndex: this.rowIndex,\n            columnIndex: this.columnIndex,\n          },\n          isEditing: true,\n        });\n      } else {\n        selectionView.selection = TableAreaSelection.create({\n          groupKey: this.groupKey,\n          focus: {\n            rowIndex: this.rowIndex,\n            columnIndex: this.columnIndex,\n          },\n          isEditing: false,\n        });\n      }\n    }\n  };\n\n  get cell(): DataViewCellLifeCycle | undefined {\n    return this._cell.value;\n  }\n\n  private get groupKey() {\n    return this.closest('affine-data-view-table-group')?.group?.key;\n  }\n\n  private get readonly() {\n    return this.column.readonly$.value;\n  }\n\n  private get selectionView() {\n    return this.closest('affine-database-table')?.selectionController;\n  }\n\n  get table() {\n    const table = this.closest('affine-database-table');\n    assertExists(table);\n    return table;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    this._disposables.addFromEvent(this, 'click', () => {\n      if (!this.isEditing) {\n        this.selectCurrentCell(!this.column.readonly$.value);\n      }\n    });\n  }\n\n  isSelected(selection: TableViewSelectionWithType) {\n    if (selection.selectionType !== 'area') {\n      return false;\n    }\n    if (selection.groupKey !== this.groupKey) {\n      return;\n    }\n    if (selection.focus.columnIndex !== this.columnIndex) {\n      return;\n    }\n    return selection.focus.rowIndex === this.rowIndex;\n  }\n\n  override render() {\n    const renderer = this.column.renderer$.value;\n    if (!renderer) {\n      return;\n    }\n    const { edit, view } = renderer;\n    const uni = !this.readonly && this.isEditing && edit != null ? edit : view;\n    const props: CellRenderProps = {\n      cell: this.cell$.value,\n      isEditing: this.isEditing,\n      selectCurrentCell: this.selectCurrentCell,\n    };\n\n    return renderUniLit(uni, props, {\n      ref: this._cell,\n      style: {\n        display: 'contents',\n      },\n    });\n  }\n\n  @property({ attribute: false })\n  accessor column!: TableColumn;\n\n  @property({ attribute: false })\n  accessor columnId!: string;\n\n  @property({ attribute: false })\n  accessor columnIndex!: number;\n\n  @state()\n  accessor isEditing = false;\n\n  @property({ attribute: false })\n  accessor rowId!: string;\n\n  @property({ attribute: false })\n  accessor rowIndex!: number;\n\n  @property({ attribute: false })\n  accessor view!: SingleView;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-database-cell-container': DatabaseCellContainer;\n  }\n}\n"]}