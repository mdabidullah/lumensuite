{"version":3,"file":"cell-renderer.js","sourceRoot":"","sources":["../../../src/column-presets/date/cell-renderer.ts"],"names":[],"mappings":"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","sourcesContent":["import { DatePicker } from '@blocksuite/affine-components/date-picker';\nimport { createLitPortal } from '@blocksuite/affine-components/portal';\nimport { flip, offset } from '@floating-ui/dom';\nimport { baseTheme } from '@toeverything/theme';\nimport { format } from 'date-fns/format';\nimport { css, html, unsafeCSS } from 'lit';\nimport { customElement, state } from 'lit/decorators.js';\n\nimport { BaseCellRenderer } from '../../core/column/index.js';\nimport { createFromBaseCellRenderer } from '../../core/column/renderer.js';\nimport { createIcon } from '../../core/utils/uni-icon.js';\nimport { dateColumnModelConfig } from './define.js';\n\n@customElement('affine-database-date-cell')\nexport class DateCell extends BaseCellRenderer<number> {\n  static override styles = css`\n    affine-database-date-cell {\n      width: 100%;\n    }\n\n    .affine-database-date {\n      display: flex;\n      align-items: center;\n      width: 100%;\n      padding: 0;\n      border: none;\n      font-family: ${unsafeCSS(baseTheme.fontSansFamily)};\n      color: var(--affine-text-primary-color);\n      font-weight: 400;\n      background-color: transparent;\n      font-size: var(--data-view-cell-text-size);\n      line-height: var(--data-view-cell-text-line-height);\n      height: var(--data-view-cell-text-line-height);\n    }\n\n    input.affine-database-date[type='date']::-webkit-calendar-picker-indicator {\n      display: none;\n    }\n  `;\n\n  override render() {\n    const value = this.value ? format(this.value, 'yyyy/MM/dd') : '';\n    if (!value) {\n      return '';\n    }\n    return html` <div class=\"affine-database-date date\">${value}</div>`;\n  }\n}\n\n@customElement('affine-database-date-cell-editing')\nexport class DateCellEditing extends BaseCellRenderer<number> {\n  static override styles = css`\n    affine-database-date-cell-editing {\n      width: 100%;\n      cursor: text;\n    }\n\n    .affine-database-date:focus {\n      outline: none;\n    }\n  `;\n\n  private _prevPortalAbortController: AbortController | null = null;\n\n  private openDatePicker = () => {\n    if (\n      this._prevPortalAbortController &&\n      !this._prevPortalAbortController.signal.aborted\n    )\n      return;\n\n    this._prevPortalAbortController?.abort();\n    const abortController = new AbortController();\n    abortController.signal.addEventListener(\n      'abort',\n      () => {\n        this.selectCurrentCell(false);\n      },\n      { once: true }\n    );\n    this._prevPortalAbortController = abortController;\n    const root = createLitPortal({\n      abortController,\n      closeOnClickAway: true,\n      computePosition: {\n        referenceElement: this,\n        placement: 'bottom',\n        middleware: [offset(10), flip()],\n      },\n      template: () => {\n        const datePicker = new DatePicker();\n        datePicker.value = this.value ?? Date.now();\n        datePicker.onChange = (date: Date) => {\n          this.tempValue = date;\n        };\n        datePicker.onEscape = () => {\n          abortController.abort();\n        };\n        requestAnimationFrame(() => datePicker.focusDateCell());\n        return datePicker;\n      },\n    });\n    // TODO: use z-index from variable,\n    //       for now the slide-layout-modal's z-index is `1001`\n    //       the z-index of popover should be higher than it\n    // root.style.zIndex = 'var(--affine-z-index-popover)';\n    root.style.zIndex = '1002';\n  };\n\n  private updateValue = () => {\n    const tempValue = this.tempValue;\n    if (!tempValue) {\n      return;\n    }\n\n    this.onChange(tempValue.getTime());\n    this.tempValue = undefined;\n  };\n\n  get dateString() {\n    const value = this.tempValue ?? this.value;\n    return value ? format(value, 'yyyy/MM/dd') : '';\n  }\n\n  override firstUpdated() {\n    this.openDatePicker();\n  }\n\n  override onExitEditMode() {\n    this.updateValue();\n    this._prevPortalAbortController?.abort();\n  }\n\n  override render() {\n    return html` <div\n      class=\"affine-database-date date\"\n      @click=\"${this.openDatePicker}\"\n    >\n      ${this.dateString}\n    </div>`;\n  }\n\n  @state()\n  accessor tempValue: Date | undefined = undefined;\n}\n\nexport const dateColumnConfig = dateColumnModelConfig.createColumnMeta({\n  icon: createIcon('DateTimeIcon'),\n  cellRenderer: {\n    view: createFromBaseCellRenderer(DateCell),\n    edit: createFromBaseCellRenderer(DateCellEditing),\n  },\n});\n"]}