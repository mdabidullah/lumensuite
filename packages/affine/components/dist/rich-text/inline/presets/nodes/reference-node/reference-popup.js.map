{"version":3,"file":"reference-popup.js","sourceRoot":"","sources":["../../../../../../src/rich-text/inline/presets/nodes/reference-node/reference-popup.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ReferenceInfo } from '@blocksuite/affine-model';\nimport type { InlineRange } from '@blocksuite/inline';\n\nimport { isInsideBlockByFlavour } from '@blocksuite/affine-shared/utils';\nimport { BLOCK_ID_ATTR, type BlockComponent } from '@blocksuite/block-std';\nimport { WithDisposable } from '@blocksuite/block-std';\nimport { assertExists } from '@blocksuite/global/utils';\nimport { computePosition, inline, offset, shift } from '@floating-ui/dom';\nimport { effect } from '@lit-labs/preact-signals';\nimport { html, LitElement, nothing } from 'lit';\nimport { customElement, property, query } from 'lit/decorators.js';\nimport { ifDefined } from 'lit/directives/if-defined.js';\nimport { join } from 'lit/directives/join.js';\nimport { repeat } from 'lit/directives/repeat.js';\n\nimport type { AffineInlineEditor } from '../../affine-inline-specs.js';\nimport type { RefNodeSlots } from './types.js';\n\nimport {\n  CenterPeekIcon,\n  DeleteIcon,\n  ExpandFullSmallIcon,\n  MoreVerticalIcon,\n  OpenIcon,\n  SmallArrowDownIcon,\n} from '../../../../../icons/index.js';\nimport { isPeekable, peek } from '../../../../../peek/index.js';\nimport {\n  type MenuItem,\n  renderActions,\n  renderToolbarSeparator,\n} from '../../../../../toolbar/index.js';\nimport { styles } from './styles.js';\n\n@customElement('reference-popup')\nexport class ReferencePopup extends WithDisposable(LitElement) {\n  static override styles = styles;\n\n  get _embedViewButtonDisabled() {\n    if (\n      this.block.doc.readonly ||\n      isInsideBlockByFlavour(\n        this.block.doc,\n        this.block.model,\n        'affine:edgeless-text'\n      )\n    ) {\n      return true;\n    }\n    return (\n      !!this.block.closest('affine-embed-synced-doc-block') ||\n      this.referenceDocId === this.doc.id\n    );\n  }\n\n  get _openButtonDisabled() {\n    return this.referenceDocId === this.doc.id;\n  }\n\n  get block() {\n    const block = this.inlineEditor.rootElement.closest<BlockComponent>(\n      `[${BLOCK_ID_ATTR}]`\n    );\n    assertExists(block);\n    return block;\n  }\n\n  get doc() {\n    const doc = this.block.doc;\n    assertExists(doc);\n    return doc;\n  }\n\n  get referenceDocId() {\n    const docId = this.inlineEditor.getFormat(this.targetInlineRange).reference\n      ?.pageId;\n    assertExists(docId);\n    return docId;\n  }\n\n  get std() {\n    const std = this.block.std;\n    assertExists(std);\n    return std;\n  }\n\n  private _convertToCardView() {\n    const block = this.block;\n    const doc = block.host.doc;\n    const parent = doc.getParent(block.model);\n    assertExists(parent);\n\n    const index = parent.children.indexOf(block.model);\n\n    doc.addBlock(\n      'affine:embed-linked-doc',\n      this.referenceInfo,\n      parent,\n      index + 1\n    );\n\n    const totalTextLength = this.inlineEditor.yTextLength;\n    const inlineTextLength = this.targetInlineRange.length;\n    if (totalTextLength === inlineTextLength) {\n      doc.deleteBlock(block.model);\n    } else {\n      this.inlineEditor.insertText(this.targetInlineRange, this.docTitle);\n    }\n\n    this.abortController.abort();\n  }\n\n  private _convertToEmbedView() {\n    const block = this.block;\n    const doc = block.host.doc;\n    const parent = doc.getParent(block.model);\n    assertExists(parent);\n\n    const index = parent.children.indexOf(block.model);\n    const docId = this.referenceDocId;\n    doc.addBlock(\n      'affine:embed-synced-doc',\n      { pageId: docId },\n      parent,\n      index + 1\n    );\n\n    const totalTextLength = this.inlineEditor.yTextLength;\n    const inlineTextLength = this.targetInlineRange.length;\n    if (totalTextLength === inlineTextLength) {\n      doc.deleteBlock(block.model);\n    } else {\n      this.inlineEditor.insertText(this.targetInlineRange, this.docTitle);\n    }\n\n    this.abortController.abort();\n  }\n\n  private _delete() {\n    if (this.inlineEditor.isValidInlineRange(this.targetInlineRange)) {\n      this.inlineEditor.deleteText(this.targetInlineRange);\n    }\n    this.abortController.abort();\n  }\n\n  private _moreActions() {\n    return renderActions([\n      [\n        {\n          type: 'delete',\n          label: 'Delete',\n          icon: DeleteIcon,\n          disabled: this.doc.readonly,\n          action: () => this._delete(),\n        },\n      ],\n    ]);\n  }\n\n  private _openDoc() {\n    const pageId = this.referenceDocId;\n    const block = this.block;\n    if (pageId === block.doc.id) return;\n    const rootId = block.doc.root?.id;\n    if (!rootId) return;\n\n    const rootComponent = this.std.view.getBlock(rootId) as BlockComponent & {\n      slots: RefNodeSlots;\n    };\n    if (!rootComponent) return;\n\n    rootComponent.slots.docLinkClicked.emit(this.referenceInfo);\n  }\n\n  private _openMenuButton() {\n    const buttons: MenuItem[] = [\n      {\n        label: 'Open this doc',\n        type: 'open-this-doc',\n        icon: ExpandFullSmallIcon,\n        action: () => this._openDoc(),\n        disabled: this._openButtonDisabled,\n      },\n    ];\n\n    // open in new tab\n\n    if (isPeekable(this.target)) {\n      buttons.push({\n        label: 'Open in center peek',\n        type: 'open-in-center-peek',\n        icon: CenterPeekIcon,\n        action: () => peek(this.target),\n      });\n    }\n\n    // open in split view\n\n    if (buttons.length === 0) {\n      return nothing;\n    }\n\n    return html`\n      <editor-menu-button\n        .contentPadding=${'8px'}\n        .button=${html`\n          <editor-icon-button\n            aria-label=\"Open doc\"\n            .justify=${'space-between'}\n            .labelHeight=${'20px'}\n          >\n            ${OpenIcon}${SmallArrowDownIcon}\n          </editor-icon-button>\n        `}\n      >\n        <div data-size=\"large\" data-orientation=\"vertical\">\n          ${repeat(\n            buttons,\n            button => button.label,\n            ({ label, icon, action, disabled }) => html`\n              <editor-menu-action\n                aria-label=${ifDefined(label)}\n                ?disabled=${disabled}\n                @click=${action}\n              >\n                ${icon}<span class=\"label\">${label}</span>\n              </editor-menu-action>\n            `\n          )}\n        </div>\n      </editor-menu-button>\n    `;\n  }\n\n  private _viewMenuButton() {\n    // synced doc entry controlled by awareness flag\n    const isSyncedDocEnabled = this.doc.awarenessStore.getFlag(\n      'enable_synced_doc_block'\n    );\n    const buttons = [];\n\n    buttons.push({\n      type: 'inline',\n      label: 'Inline view',\n    });\n\n    buttons.push({\n      type: 'card',\n      label: 'Card view',\n      action: () => this._convertToCardView(),\n      disabled: this.doc.readonly,\n    });\n\n    if (isSyncedDocEnabled) {\n      buttons.push({\n        type: 'embed',\n        label: 'Embed view',\n        action: () => this._convertToEmbedView(),\n        disabled:\n          this.doc.readonly ||\n          this.isLinkedNode ||\n          this._embedViewButtonDisabled,\n      });\n    }\n\n    return html`\n      <editor-menu-button\n        .contentPadding=${'8px'}\n        .button=${html`\n          <editor-icon-button\n            aria-label=\"Switch view\"\n            .justify=${'space-between'}\n            .labelHeight=${'20px'}\n            .iconContainerWidth=${'110px'}\n          >\n            <span class=\"label\">Inline view</span>\n            ${SmallArrowDownIcon}\n          </editor-icon-button>\n        `}\n      >\n        <div data-size=\"small\" data-orientation=\"vertical\">\n          ${repeat(\n            buttons,\n            button => button.type,\n            ({ type, label, action, disabled }) => html`\n              <editor-menu-action\n                aria-label=${label}\n                data-testid=${`link-to-${type}`}\n                ?data-selected=${type === 'inline'}\n                ?disabled=${disabled}\n                @click=${action}\n              >\n                ${label}\n              </editor-menu-action>\n            `\n          )}\n        </div>\n      </editor-menu-button>\n    `;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    if (this.targetInlineRange.length === 0) {\n      return;\n    }\n\n    const parent = this.block.host.doc.getParent(this.block.model);\n    assertExists(parent);\n\n    this.disposables.add(\n      effect(() => {\n        const children = parent.children;\n        if (children.includes(this.block.model)) return;\n        this.abortController.abort();\n      })\n    );\n  }\n\n  override render() {\n    const buttons = [\n      this._openMenuButton(),\n\n      this._viewMenuButton(),\n\n      html`\n        <editor-menu-button\n          .contentPadding=${'8px'}\n          .button=${html`\n            <editor-icon-button aria-label=\"More\" .tooltip=${'More'}>\n              ${MoreVerticalIcon}\n            </editor-icon-button>\n          `}\n        >\n          <div data-size=\"large\" data-orientation=\"vertical\">\n            ${this._moreActions()}\n          </div>\n        </editor-menu-button>\n      `,\n    ];\n\n    return html`\n      <div class=\"overlay-root\">\n        <div class=\"affine-reference-popover-container\">\n          <editor-toolbar class=\"affine-reference-popover view\">\n            ${join(\n              buttons.filter(button => button !== nothing),\n              renderToolbarSeparator\n            )}\n          </editor-toolbar>\n        </div>\n      </div>\n    `;\n  }\n\n  override updated() {\n    assertExists(this.popupContainer);\n    const range = this.inlineEditor.toDomRange(this.targetInlineRange);\n    assertExists(range);\n\n    const visualElement = {\n      getBoundingClientRect: () => range.getBoundingClientRect(),\n      getClientRects: () => range.getClientRects(),\n    };\n    computePosition(visualElement, this.popupContainer, {\n      middleware: [\n        offset(10),\n        inline(),\n        shift({\n          padding: 6,\n        }),\n      ],\n    })\n      .then(({ x, y }) => {\n        const popupContainer = this.popupContainer;\n        if (!popupContainer) return;\n        popupContainer.style.left = `${x}px`;\n        popupContainer.style.top = `${y}px`;\n      })\n      .catch(console.error);\n  }\n\n  @property({ attribute: false })\n  accessor abortController!: AbortController;\n\n  @property({ attribute: false })\n  accessor docTitle!: string;\n\n  @property({ attribute: false })\n  accessor inlineEditor!: AffineInlineEditor;\n\n  @property({ attribute: false })\n  accessor isLinkedNode!: boolean;\n\n  @query('.affine-reference-popover-container')\n  accessor popupContainer!: HTMLDivElement;\n\n  @property({ type: Object })\n  accessor referenceInfo!: ReferenceInfo;\n\n  @property({ attribute: false })\n  accessor target!: LitElement;\n\n  @property({ attribute: false })\n  accessor targetInlineRange!: InlineRange;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'reference-popup': ReferencePopup;\n  }\n}\n\nexport function toggleReferencePopup(\n  target: LitElement,\n  isLinkedNode: boolean,\n  referenceInfo: ReferenceInfo,\n  inlineEditor: AffineInlineEditor,\n  targetInlineRange: InlineRange,\n  docTitle: string,\n  abortController: AbortController\n): ReferencePopup {\n  const popup = new ReferencePopup();\n  popup.target = target;\n  popup.isLinkedNode = isLinkedNode;\n  popup.referenceInfo = referenceInfo;\n  popup.inlineEditor = inlineEditor;\n  popup.targetInlineRange = targetInlineRange;\n  popup.docTitle = docTitle;\n  popup.abortController = abortController;\n\n  document.body.append(popup);\n\n  return popup;\n}\n"]}