{"version":3,"file":"reference-node.js","sourceRoot":"","sources":["../../../../../../src/rich-text/inline/presets/nodes/reference-node/reference-node.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ReferenceInfo, RootBlockModel } from '@blocksuite/affine-model';\nimport type { Doc, DocMeta } from '@blocksuite/store';\n\nimport {\n  getModelByElement,\n  getRootByElement,\n} from '@blocksuite/affine-shared/utils';\nimport { BLOCK_ID_ATTR, type BlockComponent } from '@blocksuite/block-std';\nimport { ShadowlessElement, WithDisposable } from '@blocksuite/block-std';\nimport { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport {\n  type DeltaInsert,\n  INLINE_ROOT_ATTR,\n  type InlineRootElement,\n  ZERO_WIDTH_NON_JOINER,\n  ZERO_WIDTH_SPACE,\n} from '@blocksuite/inline';\nimport { css, html, nothing } from 'lit';\nimport { customElement, property, state } from 'lit/decorators.js';\nimport { choose } from 'lit/directives/choose.js';\nimport { ref } from 'lit/directives/ref.js';\n\nimport type { AffineTextAttributes } from '../../../../extension/index.js';\nimport type { ReferenceNodeConfig } from './reference-config.js';\nimport type { RefNodeSlots } from './types.js';\n\nimport { HoverController } from '../../../../../hover/index.js';\nimport {\n  BlockLinkIcon,\n  FontDocIcon,\n  FontLinkedDocIcon,\n} from '../../../../../icons/index.js';\nimport { Peekable } from '../../../../../peek/index.js';\nimport { affineTextStyles } from '../affine-text.js';\nimport { DEFAULT_DOC_NAME, REFERENCE_NODE } from '../consts.js';\nimport { toggleReferencePopup } from './reference-popup.js';\n\n@customElement('affine-reference')\n@Peekable({ action: false })\nexport class AffineReference extends WithDisposable(ShadowlessElement) {\n  static override styles = css`\n    .affine-reference {\n      white-space: normal;\n      word-break: break-word;\n      color: var(--affine-text-primary-color);\n      fill: var(--affine-icon-color);\n      border-radius: 4px;\n      text-decoration: none;\n      cursor: pointer;\n      user-select: none;\n      padding: 1px 2px 1px 0;\n    }\n    .affine-reference:hover {\n      background: var(--affine-hover-color);\n    }\n\n    .affine-reference[data-selected='true'] {\n      background: var(--affine-hover-color);\n    }\n\n    .affine-reference-title {\n      margin-left: 4px;\n      border-bottom: 0.5px solid var(--affine-divider-color);\n      transition: border 0.2s ease-out;\n    }\n    .affine-reference-title:hover {\n      border-bottom: 0.5px solid var(--affine-icon-color);\n    }\n  `;\n\n  private _refAttribute: NonNullable<AffineTextAttributes['reference']> = {\n    type: 'LinkedPage',\n    pageId: '0',\n  };\n\n  private _updateRefMeta = (doc: Doc) => {\n    const refAttribute = this.delta.attributes?.reference;\n    if (!refAttribute) {\n      return;\n    }\n\n    this._refAttribute = refAttribute;\n    const refMeta = doc.collection.meta.docMetas.find(\n      doc => doc.id === refAttribute.pageId\n    );\n    this.refMeta = refMeta\n      ? {\n          ...refMeta,\n        }\n      : undefined;\n  };\n\n  private _whenHover: HoverController = new HoverController(\n    this,\n    ({ abortController }) => {\n      if (\n        this.doc?.readonly ||\n        this.closest('.prevent-reference-popup') ||\n        !this.selfInlineRange ||\n        !this.inlineEditor\n      ) {\n        return null;\n      }\n\n      const selection = this.std?.selection;\n      if (!selection) {\n        return null;\n      }\n      const textSelection = selection.find('text');\n      if (!!textSelection && !textSelection.isCollapsed()) {\n        return null;\n      }\n\n      const blockSelections = selection.filter('block');\n      if (blockSelections.length) {\n        return null;\n      }\n\n      return {\n        template: toggleReferencePopup(\n          this,\n          this.isLinkedNode(),\n          this.referenceInfo,\n          this.inlineEditor,\n          this.selfInlineRange,\n          this.refMeta?.title ?? DEFAULT_DOC_NAME,\n          abortController\n        ),\n      };\n    },\n    { enterDelay: 500 }\n  );\n\n  get block() {\n    const block = this.inlineEditor?.rootElement.closest<BlockComponent>(\n      `[${BLOCK_ID_ATTR}]`\n    );\n    return block;\n  }\n\n  get customContent() {\n    return this.config.customContent;\n  }\n\n  get customIcon() {\n    return this.config.customIcon;\n  }\n\n  get customTitle() {\n    return this.config.customTitle;\n  }\n\n  get doc() {\n    const doc = this.config.doc;\n    return doc;\n  }\n\n  get inlineEditor() {\n    const inlineRoot = this.closest<InlineRootElement<AffineTextAttributes>>(\n      `[${INLINE_ROOT_ATTR}]`\n    );\n    return inlineRoot?.inlineEditor;\n  }\n\n  get referenceInfo(): ReferenceInfo {\n    const reference = this.delta.attributes?.reference;\n    const id = this.doc?.id;\n    if (!reference) return { pageId: id ?? '' };\n\n    const { pageId, params } = reference;\n    const info: ReferenceInfo = { pageId };\n    if (!params) return info;\n\n    const { mode, blockIds, elementIds } = params;\n    info.params = {};\n    if (mode) info.params.mode = mode;\n    if (blockIds?.length) info.params.blockIds = [...blockIds];\n    if (elementIds?.length) info.params.elementIds = [...elementIds];\n    return info;\n  }\n\n  get selfInlineRange() {\n    const selfInlineRange = this.inlineEditor?.getInlineRangeFromElement(this);\n    return selfInlineRange;\n  }\n\n  get std() {\n    const std = this.block?.std;\n    if (!std) {\n      throw new BlockSuiteError(\n        ErrorCode.ValueNotExists,\n        'std not found in reference node'\n      );\n    }\n    return std;\n  }\n\n  private _onClick() {\n    if (!this.config.interactable) return;\n\n    const refMeta = this.refMeta;\n    const model = getModelByElement(this);\n    if (!refMeta) {\n      // The doc is deleted\n      console.warn('The doc is deleted', this._refAttribute.pageId);\n      return;\n    }\n    if (!model || refMeta.id === model.doc.id) {\n      // the doc is the current doc.\n      return;\n    }\n    const targetDocId = refMeta.id;\n    const rootComponent = getRootByElement(\n      this\n    ) as BlockComponent<RootBlockModel> & { slots: RefNodeSlots };\n    rootComponent.slots.docLinkClicked.emit({ pageId: targetDocId });\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    if (!this.config) {\n      console.error('`reference-node` need `ReferenceNodeConfig`.');\n      return;\n    }\n\n    if (this.delta.insert !== REFERENCE_NODE) {\n      console.error(\n        `Reference node must be initialized with '${REFERENCE_NODE}', but got '${this.delta.insert}'`\n      );\n    }\n\n    const doc = this.doc;\n    if (doc) {\n      this._disposables.add(\n        doc.collection.slots.docUpdated.on(() => this._updateRefMeta(doc))\n      );\n    }\n\n    this.updateComplete\n      .then(() => {\n        if (!this.inlineEditor || !doc) return;\n\n        // observe yText update\n        this.disposables.add(\n          this.inlineEditor.slots.textChange.on(() => this._updateRefMeta(doc))\n        );\n      })\n      .catch(console.error);\n  }\n\n  // linking block/element\n  isLinkedNode() {\n    const reference = this.delta.attributes?.reference;\n    if (!reference?.params) return false;\n    const { mode, blockIds, elementIds } = reference.params;\n    if (!mode) return false;\n    if (blockIds && blockIds.length > 0) return true;\n    if (elementIds && elementIds.length > 0) return true;\n    return false;\n  }\n\n  override render() {\n    const refMeta = this.refMeta;\n    const isDeleted = !refMeta;\n\n    const attributes = this.delta.attributes;\n    const type = attributes?.reference?.type;\n    if (!type) {\n      return nothing;\n    }\n\n    const title = this.customTitle\n      ? this.customTitle(this)\n      : isDeleted\n        ? 'Deleted doc'\n        : refMeta.title.length > 0\n          ? refMeta.title\n          : DEFAULT_DOC_NAME;\n\n    const icon = choose(\n      type,\n      [\n        [\n          'LinkedPage',\n          () => (this.isLinkedNode() ? BlockLinkIcon : FontLinkedDocIcon),\n        ],\n        ['Subpage', () => FontDocIcon],\n      ],\n      () => this.customIcon?.(this) ?? nothing\n    );\n\n    const style = affineTextStyles(\n      attributes,\n      isDeleted\n        ? {\n            color: 'var(--affine-text-disable-color)',\n            textDecoration: 'line-through',\n            fill: 'var(--affine-text-disable-color)',\n          }\n        : {}\n    );\n\n    const content = this.customContent\n      ? this.customContent(this)\n      : html`${icon}<span data-title=${title} class=\"affine-reference-title\"\n            >${title}</span\n          >`;\n\n    // we need to add `<v-text .str=${ZERO_WIDTH_NON_JOINER}></v-text>` in an\n    // embed element to make sure inline range calculation is correct\n    return html`<span\n      ${this.config.interactable ? ref(this._whenHover.setReference) : ''}\n      data-selected=${this.selected}\n      class=\"affine-reference\"\n      style=${style}\n      @click=${this._onClick}\n      >${content}<v-text .str=${ZERO_WIDTH_NON_JOINER}></v-text\n    ></span>`;\n  }\n\n  override willUpdate(_changedProperties: Map<PropertyKey, unknown>) {\n    super.willUpdate(_changedProperties);\n\n    const doc = this.doc;\n    if (doc) {\n      this._updateRefMeta(doc);\n    }\n  }\n\n  @property({ attribute: false })\n  accessor config!: ReferenceNodeConfig;\n\n  @property({ type: Object })\n  accessor delta: DeltaInsert<AffineTextAttributes> = {\n    insert: ZERO_WIDTH_SPACE,\n    attributes: {},\n  };\n\n  // Since the linked doc may be deleted, the `_refMeta` could be undefined.\n  @state()\n  accessor refMeta: DocMeta | undefined = undefined;\n\n  @property({ type: Boolean })\n  accessor selected = false;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-reference': AffineReference;\n  }\n}\n"]}