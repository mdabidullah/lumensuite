{"version":3,"file":"affine-link.js","sourceRoot":"","sources":["../../../../../../src/rich-text/inline/presets/nodes/link-node/affine-link.ts"],"names":[],"mappings":"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","sourcesContent":["import type { BlockComponent } from '@lumensuite/block-std';\n\nimport { BLOCK_ID_ATTR, ShadowlessElement } from '@lumensuite/block-std';\nimport {\n  type DeltaInsert,\n  INLINE_ROOT_ATTR,\n  type InlineRootElement,\n  ZERO_WIDTH_SPACE,\n} from '@lumensuite/inline';\nimport { css, html } from 'lit';\nimport { customElement, property } from 'lit/decorators.js';\nimport { ref } from 'lit/directives/ref.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport type { AffineTextAttributes } from '../../../../extension/index.js';\n\nimport { HoverController } from '../../../../../hover/index.js';\nimport { affineTextStyles } from '../affine-text.js';\nimport { toggleLinkPopup } from './link-popup/toggle-link-popup.js';\n\n@customElement('affine-link')\nexport class AffineLink extends ShadowlessElement {\n  static override styles = css`\n    affine-link a:hover [data-v-text='true'] {\n      text-decoration: underline;\n    }\n  `;\n\n  private _whenHover = new HoverController(\n    this,\n    ({ abortController }) => {\n      if (this.block?.doc.readonly) {\n        return null;\n      }\n      if (!this.inlineEditor || !this.selfInlineRange) {\n        return null;\n      }\n\n      const selection = this.std?.selection;\n      const textSelection = selection?.find('text');\n      if (!!textSelection && !textSelection.isCollapsed()) {\n        return null;\n      }\n\n      const blockSelections = selection?.filter('block');\n      if (blockSelections?.length) {\n        return null;\n      }\n\n      return {\n        template: toggleLinkPopup(\n          this.inlineEditor,\n          'view',\n          this.selfInlineRange,\n          abortController\n        ),\n      };\n    },\n    { enterDelay: 500 }\n  );\n\n  // Workaround for links not working in contenteditable div\n  // see also https://stackoverflow.com/questions/12059211/how-to-make-clickable-anchor-in-contenteditable-div\n  //\n  // Note: We cannot use JS to directly open a new page as this may be blocked by the browser.\n  //\n  // Please also note that when readonly mode active,\n  // this workaround is not necessary and links work normally.\n  get block() {\n    const block = this.inlineEditor?.rootElement.closest<BlockComponent>(\n      `[${BLOCK_ID_ATTR}]`\n    );\n    return block;\n  }\n\n  get inlineEditor() {\n    const inlineRoot = this.closest<InlineRootElement<AffineTextAttributes>>(\n      `[${INLINE_ROOT_ATTR}]`\n    );\n    return inlineRoot?.inlineEditor;\n  }\n\n  get link() {\n    const link = this.delta.attributes?.link;\n    if (!link) {\n      return '';\n    }\n    return link;\n  }\n\n  get selfInlineRange() {\n    const selfInlineRange = this.inlineEditor?.getInlineRangeFromElement(this);\n    return selfInlineRange;\n  }\n\n  get std() {\n    const std = this.block?.std;\n    return std;\n  }\n\n  // see https://github.com/toeverything/AFFiNE/issues/1540\n  private _onMouseUp() {\n    const anchorElement = this.querySelector('a');\n    if (!anchorElement || !anchorElement.isContentEditable) return;\n    anchorElement.contentEditable = 'false';\n    setTimeout(() => {\n      anchorElement.removeAttribute('contenteditable');\n    }, 0);\n  }\n\n  override render() {\n    const linkStyles = {\n      color: 'var(--affine-link-color)',\n      fill: 'var(--affine-link-color)',\n      'text-decoration': 'none',\n      cursor: 'pointer',\n    };\n    if (this.delta.attributes && this.delta.attributes?.code) {\n      const codeStyle = affineTextStyles(this.delta.attributes);\n      return html`<code style=${codeStyle}\n        ><a\n      ${ref(this._whenHover.setReference)}\n      href=${this.link}\n      style=${styleMap(linkStyles)}\n      rel=\"noopener noreferrer\"\n      target=\"_blank\"\n      @mouseup=${this._onMouseUp}\n      ><v-text .str=${this.delta.insert}></v-text\n    ></a></v-text></code>`;\n    }\n\n    const styles = this.delta.attributes\n      ? affineTextStyles(this.delta.attributes, linkStyles)\n      : styleMap({});\n\n    return html`<a\n      ${ref(this._whenHover.setReference)}\n      href=${this.link}\n      rel=\"noopener noreferrer\"\n      target=\"_blank\"\n      style=${styles}\n      @mouseup=${this._onMouseUp}\n      ><v-text .str=${this.delta.insert}></v-text\n    ></a>`;\n  }\n\n  @property({ type: Object })\n  accessor delta: DeltaInsert<AffineTextAttributes> = {\n    insert: ZERO_WIDTH_SPACE,\n  };\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-link': AffineLink;\n  }\n}\n"]}