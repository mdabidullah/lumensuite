{"version":3,"file":"latex-node.js","sourceRoot":"","sources":["../../../../../../src/rich-text/inline/presets/nodes/latex-node/latex-node.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  type BlockComponent,\n  type BlockStdScope,\n  ShadowlessElement,\n  SignalWatcher,\n  WithDisposable,\n} from '@blocksuite/block-std';\nimport {\n  type DeltaInsert,\n  type InlineEditor,\n  ZERO_WIDTH_NON_JOINER,\n  ZERO_WIDTH_SPACE,\n} from '@blocksuite/inline';\nimport { effect, signal } from '@lit-labs/preact-signals';\nimport { cssVar } from '@toeverything/theme';\nimport { cssVarV2 } from '@toeverything/theme/v2';\nimport katex from 'katex';\nimport { css, html, render, unsafeCSS } from 'lit';\nimport { customElement, property } from 'lit/decorators.js';\n\nimport type { AffineTextAttributes } from '../../../../extension/index.js';\n\nimport { createLitPortal } from '../../../../../portal/helper.js';\nimport './latex-editor-menu.js';\nimport './latex-editor-unit.js';\n\n@customElement('affine-latex-node')\nexport class AffineLatexNode extends SignalWatcher(\n  WithDisposable(ShadowlessElement)\n) {\n  static override styles = css`\n    affine-latex-node {\n      display: inline-block;\n    }\n\n    affine-latex-node .affine-latex {\n      white-space: nowrap;\n      word-break: break-word;\n      color: ${unsafeCSS(cssVar('textPrimaryColor'))};\n      fill: var(--affine-icon-color);\n      border-radius: 4px;\n      text-decoration: none;\n      cursor: pointer;\n      user-select: none;\n      padding: 1px 2px 1px 0;\n      display: grid;\n      grid-template-columns: auto 0;\n      place-items: center;\n      padding: 0 4px;\n      margin: 0 2px;\n    }\n    affine-latex-node .affine-latex:hover {\n      background: ${unsafeCSS(cssVar('hoverColor'))};\n    }\n    affine-latex-node .affine-latex[data-selected='true'] {\n      background: ${unsafeCSS(cssVar('hoverColor'))};\n    }\n\n    affine-latex-node .error-placeholder {\n      display: flex;\n      padding: 2px 4px;\n      justify-content: center;\n      align-items: flex-start;\n      gap: 10px;\n\n      border-radius: 4px;\n      background: ${unsafeCSS(cssVarV2('label/red'))};\n\n      color: ${unsafeCSS(cssVarV2('text/highlight/fg/red'))};\n      font-family: Inter;\n      font-size: 12px;\n      font-weight: 500;\n      line-height: normal;\n    }\n\n    affine-latex-node .placeholder {\n      display: flex;\n      padding: 2px 4px;\n      justify-content: center;\n      align-items: flex-start;\n\n      border-radius: 4px;\n      background: ${unsafeCSS(cssVarV2('layer/background/secondary'))};\n\n      color: ${unsafeCSS(cssVarV2('text/secondary'))};\n      font-family: Inter;\n      font-size: 12px;\n      font-weight: 500;\n      line-height: normal;\n    }\n  `;\n\n  private _editorAbortController: AbortController | null = null;\n\n  readonly latex$ = signal('');\n\n  get deltaLatex() {\n    return this.delta.attributes?.latex as string;\n  }\n\n  get latexContainer() {\n    return this.querySelector<HTMLElement>('.latex-container');\n  }\n\n  override connectedCallback() {\n    const result = super.connectedCallback();\n\n    this.latex$.value = this.deltaLatex;\n\n    this.disposables.add(\n      effect(() => {\n        const latex = this.latex$.value;\n\n        if (latex !== this.deltaLatex) {\n          this.editor.formatText(\n            {\n              index: this.startOffset,\n              length: this.endOffset - this.startOffset,\n            },\n            {\n              latex,\n            }\n          );\n        }\n\n        this.updateComplete\n          .then(() => {\n            const latexContainer = this.latexContainer;\n            if (!latexContainer) return;\n\n            latexContainer.replaceChildren();\n            // @ts-ignore\n            delete latexContainer['_$litPart$'];\n\n            if (latex.length === 0) {\n              render(\n                html`<span class=\"placeholder\">Equation</span>`,\n                latexContainer\n              );\n            } else {\n              try {\n                katex.render(latex, latexContainer, {\n                  displayMode: true,\n                  output: 'mathml',\n                });\n              } catch {\n                latexContainer.replaceChildren();\n                // @ts-ignore\n                delete latexContainer['_$litPart$'];\n                render(\n                  html`<span class=\"error-placeholder\">Error equation</span>`,\n                  latexContainer\n                );\n              }\n            }\n          })\n          .catch(console.error);\n      })\n    );\n\n    this._editorAbortController?.abort();\n    this._editorAbortController = new AbortController();\n    this.disposables.add(() => {\n      this._editorAbortController?.abort();\n    });\n\n    this.disposables.addFromEvent(this, 'click', e => {\n      e.preventDefault();\n      e.stopPropagation();\n      this.toggleEditor();\n    });\n\n    return result;\n  }\n\n  override render() {\n    return html`<span class=\"affine-latex\" data-selected=${this.selected}\n      ><div class=\"latex-container\"></div>\n      <v-text .str=${ZERO_WIDTH_NON_JOINER}></v-text\n    ></span>`;\n  }\n\n  toggleEditor() {\n    const blockComponent = this.closest<BlockComponent>('[data-block-id]');\n    if (!blockComponent) return;\n\n    this._editorAbortController?.abort();\n    this._editorAbortController = new AbortController();\n\n    const portal = createLitPortal({\n      template: html`<latex-editor-menu\n        .std=${this.std}\n        .latexSignal=${this.latex$}\n        .abortController=${this._editorAbortController}\n      ></latex-editor-menu>`,\n      container: blockComponent.host,\n      computePosition: {\n        referenceElement: this,\n        placement: 'bottom-start',\n        autoUpdate: {\n          animationFrame: true,\n        },\n      },\n      closeOnClickAway: true,\n      abortController: this._editorAbortController,\n      shadowDom: false,\n      portalStyles: {\n        zIndex: 'var(--affine-z-index-popover)',\n      },\n    });\n\n    this._editorAbortController.signal.addEventListener(\n      'abort',\n      () => {\n        portal.remove();\n      },\n      { once: true }\n    );\n  }\n\n  @property({ attribute: false })\n  accessor delta: DeltaInsert<AffineTextAttributes> = {\n    insert: ZERO_WIDTH_SPACE,\n  };\n\n  @property({ attribute: false })\n  accessor editor!: InlineEditor<AffineTextAttributes>;\n\n  @property({ attribute: false })\n  accessor endOffset!: number;\n\n  @property({ attribute: false })\n  accessor selected = false;\n\n  @property({ attribute: false })\n  accessor startOffset!: number;\n\n  @property({ attribute: false })\n  accessor std!: BlockStdScope;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-latex-node': AffineLatexNode;\n  }\n}\n"]}