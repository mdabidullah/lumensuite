{"version":3,"file":"latex-editor-menu.js","sourceRoot":"","sources":["../../../../../../src/rich-text/inline/presets/nodes/latex-node/latex-editor-menu.ts"],"names":[],"mappings":"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","sourcesContent":["import type { Y } from '@lumensuite/store';\n\nimport { ColorScheme } from '@lumensuite/affine-model';\nimport { ThemeObserver } from '@lumensuite/affine-shared/theme';\nimport {\n  type BlockStdScope,\n  ShadowlessElement,\n  SignalWatcher,\n  WithDisposable,\n} from '@lumensuite/block-std';\nimport { noop } from '@lumensuite/global/utils';\nimport { DoneIcon } from '@blocksuite/icons/lit';\nimport { DocCollection } from '@lumensuite/store';\nimport { effect, type Signal, signal } from '@lit-labs/preact-signals';\nimport { cssVar } from '@toeverything/theme';\nimport { css, html, unsafeCSS } from 'lit';\nimport { customElement, property } from 'lit/decorators.js';\nimport { codeToTokensBase, type ThemedToken } from 'shiki';\n\nimport { InlineManagerExtension } from '../../../../extension/index.js';\nimport { LatexEditorUnitSpecExtension } from '../../affine-inline-specs.js';\n\nexport const LatexEditorInlineManagerExtension = InlineManagerExtension({\n  id: 'latex-inline-editor',\n  enableMarkdown: false,\n  specs: [LatexEditorUnitSpecExtension.identifier],\n});\n\n@customElement('latex-editor-menu')\nexport class LatexEditorMenu extends SignalWatcher(\n  WithDisposable(ShadowlessElement)\n) {\n  static override styles = css`\n    .latex-editor-container {\n      display: grid;\n      grid-template-columns: 1fr auto;\n      grid-template-rows: auto auto;\n      grid-template-areas:\n        'editor-box confirm-box'\n        'hint-box hint-box';\n\n      padding: 8px;\n      border-radius: 8px;\n      border: 0.5px solid ${unsafeCSS(cssVar('borderColor'))};\n      background: ${unsafeCSS(cssVar('backgroundOverlayPanelColor'))};\n\n      /* light/toolbarShadow */\n      box-shadow: 0px 6px 16px 0px rgba(0, 0, 0, 0.14);\n    }\n\n    .latex-editor {\n      grid-area: editor-box;\n      width: 280px;\n      padding: 4px 10px;\n\n      border-radius: 4px;\n      background: ${unsafeCSS(cssVar('white10'))};\n\n      /* light/activeShadow */\n      box-shadow: 0px 0px 0px 2px rgba(30, 150, 235, 0.3);\n\n      font-family: ${unsafeCSS(cssVar('fontCodeFamily'))};\n    }\n    .latex-editor:focus-within {\n      border: 1px solid ${unsafeCSS(cssVar('blue700'))};\n    }\n\n    .latex-editor-confirm {\n      grid-area: confirm-box;\n      display: flex;\n      align-items: flex-end;\n      padding-left: 10px;\n    }\n\n    .latex-editor-hint {\n      grid-area: hint-box;\n      padding-top: 6px;\n\n      color: ${unsafeCSS(cssVar('placeholderColor'))};\n\n      /* MobileTypeface/caption */\n      font-family: 'SF Pro Text';\n      font-size: 12px;\n      font-style: normal;\n      font-weight: 400;\n      line-height: 16px; /* 133.333% */\n      letter-spacing: -0.24px;\n    }\n  `;\n\n  highlightTokens$: Signal<ThemedToken[][]> = signal([]);\n\n  yText!: Y.Text;\n\n  get inlineManager() {\n    return this.std.get(LatexEditorInlineManagerExtension.identifier);\n  }\n\n  get richText() {\n    return this.querySelector('rich-text');\n  }\n\n  private _updateHighlightTokens(text: string) {\n    const theme =\n      ThemeObserver.instance.mode$.value === ColorScheme.Dark\n        ? 'dark-plus'\n        : 'light-plus';\n\n    codeToTokensBase(text, {\n      lang: 'latex',\n      theme,\n    })\n      .then(token => {\n        this.highlightTokens$.value = token;\n      })\n      .catch(console.error);\n  }\n\n  override connectedCallback(): void {\n    super.connectedCallback();\n\n    const doc = new DocCollection.Y.Doc();\n    this.yText = doc.getText('latex');\n    this.yText.insert(0, this.latexSignal.value);\n\n    const yTextObserver = () => {\n      const text = this.yText.toString();\n      this.latexSignal.value = text;\n\n      this._updateHighlightTokens(text);\n    };\n    this.yText.observe(yTextObserver);\n    this.disposables.add(() => {\n      this.yText.unobserve(yTextObserver);\n    });\n\n    this.disposables.add(\n      effect(() => {\n        noop(this.highlightTokens$.value);\n        this.richText?.inlineEditor?.requestUpdate();\n      })\n    );\n\n    this.disposables.add(\n      ThemeObserver.subscribe(() => {\n        this._updateHighlightTokens(this.yText.toString());\n      })\n    );\n\n    this.disposables.addFromEvent(this, 'keydown', e => {\n      if (e.key === 'Enter' && !e.shiftKey) {\n        e.preventDefault();\n        e.stopPropagation();\n        this.abortController.abort();\n      }\n    });\n\n    this.updateComplete\n      .then(async () => {\n        await this.richText?.updateComplete;\n\n        this.richText?.inlineEditorContainer.focus();\n        this.richText?.inlineEditor?.focusEnd();\n      })\n      .catch(console.error);\n  }\n\n  override render() {\n    return html`<div class=\"latex-editor-container\">\n      <div class=\"latex-editor\">\n        <rich-text\n          .yText=${this.yText}\n          .attributesSchema=${this.inlineManager.getSchema()}\n          .attributeRenderer=${this.inlineManager.getRenderer()}\n        ></rich-text>\n      </div>\n      <div class=\"latex-editor-confirm\">\n        ${DoneIcon({\n          width: '24',\n          height: '24',\n        })}\n      </div>\n      <div class=\"latex-editor-hint\">Shift Enter to line break</div>\n    </div>`;\n  }\n\n  @property({ attribute: false })\n  accessor abortController!: AbortController;\n\n  @property({ attribute: false })\n  accessor latexSignal!: Signal<string>;\n\n  @property({ attribute: false })\n  accessor std!: BlockStdScope;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'latex-editor-menu': LatexEditorMenu;\n  }\n}\n"]}