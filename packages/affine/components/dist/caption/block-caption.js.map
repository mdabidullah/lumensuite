{"version":3,"file":"block-caption.js","sourceRoot":"","sources":["../../src/caption/block-caption.ts"],"names":[],"mappings":"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","sourcesContent":["import type { DocMode } from '@blocksuite/affine-model';\nimport type { BlockStdScope } from '@blocksuite/block-std';\nimport type { BlockModel, Doc } from '@blocksuite/store';\n\nimport { stopPropagation } from '@blocksuite/affine-shared/utils';\nimport {\n  docContext,\n  modelContext,\n  ShadowlessElement,\n  stdContext,\n  WithDisposable,\n} from '@blocksuite/block-std';\nimport { Text } from '@blocksuite/store';\nimport { consume } from '@lit/context';\nimport { css, html, nothing } from 'lit';\nimport { customElement, query, state } from 'lit/decorators.js';\n\nimport { focusTextModel } from '../rich-text/index.js';\n\nexport interface BlockCaptionProps {\n  caption: string | null | undefined;\n}\n\n@customElement('block-caption-editor')\nexport class BlockCaptionEditor<\n  Model extends BlockModel<BlockCaptionProps> = BlockModel<BlockCaptionProps>,\n> extends WithDisposable(ShadowlessElement) {\n  static override styles = css`\n    .block-caption-editor {\n      display: inline-table;\n      resize: none;\n      width: 100%;\n      outline: none;\n      border: 0;\n      background: transparent;\n      color: var(--affine-icon-color);\n      font-size: var(--affine-font-sm);\n      font-family: inherit;\n      text-align: center;\n    }\n    .block-caption-editor::placeholder {\n      color: var(--affine-placeholder-color);\n    }\n  `;\n\n  private _focus = false;\n\n  show = () => {\n    this.display = true;\n    this.updateComplete.then(() => this.input.focus()).catch(console.error);\n  };\n\n  get mode(): DocMode {\n    return this.doc.getParent(this.model)?.flavour === 'affine:surface'\n      ? 'edgeless'\n      : 'page';\n  }\n\n  private _onCaptionKeydown(event: KeyboardEvent) {\n    event.stopPropagation();\n\n    if (this.mode === 'edgeless' || event.isComposing) {\n      return;\n    }\n\n    if (event.key === 'Enter') {\n      event.preventDefault();\n      const doc = this.doc;\n      const target = event.target as HTMLInputElement;\n      const start = target.selectionStart;\n      if (start === null) {\n        return;\n      }\n\n      const model = this.model;\n      const parent = doc.getParent(model);\n      if (!parent) {\n        return;\n      }\n\n      const value = target.value;\n      const caption = value.slice(0, start);\n      doc.updateBlock(model, { caption });\n\n      const nextBlockText = value.slice(start);\n      const index = parent.children.indexOf(model);\n      const id = doc.addBlock(\n        'affine:paragraph',\n        { text: new Text(nextBlockText) },\n        parent,\n        index + 1\n      );\n\n      focusTextModel(this.std, id);\n    }\n  }\n\n  private _onInputBlur() {\n    this._focus = false;\n    this.display = !!this.caption?.length;\n  }\n\n  private _onInputChange(e: InputEvent) {\n    const target = e.target as HTMLInputElement;\n    this.caption = target.value;\n    this.doc.updateBlock(this.model, {\n      caption: this.caption,\n    });\n  }\n\n  private _onInputFocus() {\n    this._focus = true;\n  }\n\n  override connectedCallback(): void {\n    super.connectedCallback();\n\n    this.caption = this.model.caption;\n\n    this.disposables.add(\n      this.model.propsUpdated.on(({ key }) => {\n        if (key === 'caption') {\n          this.caption = this.model.caption;\n          if (!this._focus) {\n            this.display = !!this.caption?.length;\n          }\n        }\n      })\n    );\n  }\n\n  override render() {\n    if (!this.display && !this.caption) {\n      return nothing;\n    }\n\n    return html`<textarea\n      .disabled=${this.doc.readonly}\n      placeholder=\"Write a caption\"\n      class=\"block-caption-editor\"\n      .value=${this.caption ?? ''}\n      @input=${this._onInputChange}\n      @focus=${this._onInputFocus}\n      @blur=${this._onInputBlur}\n      @pointerdown=${stopPropagation}\n      @click=${stopPropagation}\n      @dblclick=${stopPropagation}\n      @cut=${stopPropagation}\n      @copy=${stopPropagation}\n      @paste=${stopPropagation}\n      @keydown=${this._onCaptionKeydown}\n      @keyup=${stopPropagation}\n    ></textarea>`;\n  }\n\n  @state()\n  accessor caption: string | null | undefined = undefined;\n\n  @state()\n  accessor display = false;\n\n  @consume({ context: docContext })\n  accessor doc!: Doc;\n\n  @query('.block-caption-editor')\n  accessor input!: HTMLInputElement;\n\n  @consume({ context: modelContext })\n  accessor model!: Model;\n\n  @consume({ context: stdContext })\n  accessor std!: BlockStdScope;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'block-caption-editor': BlockCaptionEditor;\n  }\n}\n"]}