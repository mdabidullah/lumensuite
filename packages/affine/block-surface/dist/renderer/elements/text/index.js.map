{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../src/renderer/elements/text/index.ts"],"names":[],"mappings":"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","sourcesContent":["import type { TextElementModel } from '@blocksuite/affine-model';\n\nimport type { CanvasRenderer } from '../../canvas-renderer.js';\n\nimport {\n  deltaInsertsToChunks,\n  getFontString,\n  getLineHeight,\n  getTextWidth,\n  isRTL,\n  wrapTextDeltas,\n} from './utils.js';\n\nexport function text(\n  model: TextElementModel,\n  ctx: CanvasRenderingContext2D,\n  matrix: DOMMatrix,\n  renderer: CanvasRenderer\n) {\n  const { fontSize, fontWeight, fontStyle, fontFamily, textAlign, rotate } =\n    model;\n  const [, , w, h] = model.deserializedXYWH;\n  const cx = w / 2;\n  const cy = h / 2;\n\n  ctx.setTransform(\n    matrix.translateSelf(cx, cy).rotateSelf(rotate).translateSelf(-cx, -cy)\n  );\n\n  // const deltas: ITextDelta[] = yText.toDelta() as ITextDelta[];\n  const font = getFontString({\n    fontStyle,\n    fontWeight,\n    fontSize,\n    fontFamily,\n  });\n  const deltas = wrapTextDeltas(model.text, font, w);\n  const lines = deltaInsertsToChunks(deltas);\n  const lineHeightPx = getLineHeight(fontFamily, fontSize, fontWeight);\n  const horizontalOffset =\n    textAlign === 'center' ? w / 2 : textAlign === 'right' ? w : 0;\n\n  const color = renderer.getColorValue(model.color, '#000000', true);\n\n  ctx.font = font;\n  ctx.fillStyle = color;\n  ctx.textAlign = textAlign;\n  ctx.textBaseline = 'ideographic';\n\n  for (const [lineIndex, line] of lines.entries()) {\n    let beforeTextWidth = 0;\n\n    for (const delta of line) {\n      const str = delta.insert;\n      const rtl = isRTL(str);\n      const shouldTemporarilyAttach = rtl && !ctx.canvas.isConnected;\n      if (shouldTemporarilyAttach) {\n        // to correctly render RTL text mixed with LTR, we have to append it\n        // to the DOM\n        document.body.append(ctx.canvas);\n      }\n\n      ctx.canvas.setAttribute('dir', rtl ? 'rtl' : 'ltr');\n\n      // 0.5 comes from v-line padding\n      const offset =\n        textAlign === 'center' ? 0 : textAlign === 'right' ? -0.5 : 0.5;\n      ctx.fillText(\n        str,\n        horizontalOffset + beforeTextWidth + offset,\n        (lineIndex + 1) * lineHeightPx\n      );\n\n      beforeTextWidth += getTextWidth(str, font);\n\n      if (shouldTemporarilyAttach) {\n        ctx.canvas.remove();\n      }\n    }\n  }\n}\n"]}