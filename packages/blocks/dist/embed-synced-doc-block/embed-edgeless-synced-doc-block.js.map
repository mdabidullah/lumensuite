{"version":3,"file":"embed-edgeless-synced-doc-block.js","sourceRoot":"","sources":["../../src/embed-synced-doc-block/embed-edgeless-synced-doc-block.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  EMBED_CARD_HEIGHT,\n  EMBED_CARD_WIDTH,\n} from '@lumensuite/affine-shared/consts';\nimport { ThemeObserver } from '@lumensuite/affine-shared/theme';\nimport { BlockStdScope } from '@lumensuite/block-std';\nimport { assertExists, Bound } from '@lumensuite/global/utils';\nimport { html } from 'lit';\nimport { customElement } from 'lit/decorators.js';\nimport { choose } from 'lit/directives/choose.js';\nimport { classMap } from 'lit/directives/class-map.js';\nimport { guard } from 'lit/directives/guard.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport type { EdgelessRootService } from '../root-block/index.js';\n\nimport { toEdgelessEmbedBlock } from '../_common/embed-block-helper/embed-block-element.js';\nimport { EmbedSyncedDocBlockComponent } from './embed-synced-doc-block.js';\n\n@customElement('affine-embed-edgeless-synced-doc-block')\nexport class EmbedEdgelessSyncedDocBlockComponent extends toEdgelessEmbedBlock(\n  EmbedSyncedDocBlockComponent\n) {\n  protected override _renderSyncedView = () => {\n    const syncedDoc = this.syncedDoc;\n    const editorMode = this.syncedDocMode;\n\n    assertExists(syncedDoc, 'Doc should exist');\n\n    let containerStyleMap = styleMap({\n      position: 'relative',\n      width: '100%',\n    });\n    const modelScale = this.model.scale ?? 1;\n    const bound = Bound.deserialize(this.model.xywh);\n    const width = bound.w / modelScale;\n    const height = bound.h / modelScale;\n    containerStyleMap = styleMap({\n      width: `${width}px`,\n      height: `${height}px`,\n      minHeight: `${height}px`,\n      transform: `scale(${modelScale})`,\n      transformOrigin: '0 0',\n    });\n\n    const theme = ThemeObserver.mode;\n    const isSelected = !!this.selected?.is('block');\n    const scale = this.model.scale ?? 1;\n\n    this.dataset.nestedEditor = '';\n\n    const renderEditor = () => {\n      return choose(editorMode, [\n        [\n          'page',\n          () => html`\n            <div class=\"affine-page-viewport\">\n              ${new BlockStdScope({\n                doc: syncedDoc,\n                extensions: this._buildPreviewSpec('page:preview'),\n              }).render()}\n            </div>\n          `,\n        ],\n        [\n          'edgeless',\n          () => html`\n            <div class=\"affine-edgeless-viewport\">\n              ${new BlockStdScope({\n                doc: syncedDoc,\n                extensions: this._buildPreviewSpec('edgeless:preview'),\n              }).render()}\n            </div>\n          `,\n        ],\n      ]);\n    };\n\n    return this.renderEmbed(\n      () => html`\n        <div\n          class=${classMap({\n            'affine-embed-synced-doc-container': true,\n            [editorMode]: true,\n            [theme]: true,\n            selected: isSelected,\n            surface: true,\n          })}\n          @click=${this._handleClick}\n          style=${containerStyleMap}\n          ?data-scale=${scale}\n        >\n          <div class=\"affine-embed-synced-doc-editor\">\n            ${this.isPageMode && this._isEmptySyncedDoc\n              ? html`\n                  <div class=\"affine-embed-synced-doc-editor-empty\">\n                    <span>\n                      This is a linked doc, you can add content here.\n                    </span>\n                  </div>\n                `\n              : guard([editorMode, syncedDoc], renderEditor)}\n          </div>\n          <div class=\"affine-embed-synced-doc-editor-overlay\"></div>\n        </div>\n      `\n    );\n  };\n\n  override convertToCard = () => {\n    const { id, doc, pageId, caption, xywh } = this.model;\n\n    const edgelessService = this.rootService;\n    const style = 'vertical';\n    const bound = Bound.deserialize(xywh);\n    bound.w = EMBED_CARD_WIDTH[style];\n    bound.h = EMBED_CARD_HEIGHT[style];\n\n    if (!edgelessService) {\n      return;\n    }\n\n    const newId = edgelessService.addBlock(\n      'affine:embed-linked-doc',\n      { pageId, xywh: bound.serialize(), style, caption },\n      edgelessService.surface\n    );\n\n    this.std.command.exec('reassociateConnectors', {\n      oldId: id,\n      newId,\n    });\n\n    edgelessService.selection.set({\n      editing: false,\n      elements: [newId],\n    });\n    doc.deleteBlock(this.model);\n  };\n\n  get rootService() {\n    return this.std.getService('affine:page') as EdgelessRootService;\n  }\n\n  override renderGfxBlock() {\n    const { style, xywh } = this.model;\n\n    const bound = Bound.deserialize(xywh);\n    this._width = bound.w;\n    this._height = bound.h;\n\n    const width = this._width;\n    const height = this._height;\n\n    this.embedContainerStyle.transform = `scale(${bound.w / width}, ${bound.h / height})`;\n    this.cardStyleMap = {\n      display: 'block',\n      width: `${EMBED_CARD_WIDTH[style]}px`,\n      height: `${EMBED_CARD_WIDTH[style]}px`,\n      transform: `scale(${bound.w / EMBED_CARD_WIDTH[style]}, ${bound.h / EMBED_CARD_HEIGHT[style]})`,\n      transformOrigin: '0 0',\n    };\n\n    return this.renderPageContent();\n  }\n\n  override accessor useCaptionEditor = true;\n}\n"]}