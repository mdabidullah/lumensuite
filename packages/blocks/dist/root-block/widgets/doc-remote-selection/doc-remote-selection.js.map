{"version":3,"file":"doc-remote-selection.js","sourceRoot":"","sources":["../../../../src/root-block/widgets/doc-remote-selection/doc-remote-selection.ts"],"names":[],"mappings":"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","sourcesContent":["import type { UserInfo } from '@lumensuite/store';\n\nimport { matchFlavours } from '@lumensuite/affine-shared/utils';\nimport {\n  type BaseSelection,\n  BlockSelection,\n  TextSelection,\n} from '@lumensuite/block-std';\nimport { WidgetComponent } from '@lumensuite/block-std';\nimport { assertExists } from '@lumensuite/global/utils';\nimport { computed } from '@lit-labs/preact-signals';\nimport { css, html, nothing } from 'lit';\nimport { customElement } from 'lit/decorators.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport type { DocRemoteSelectionConfig } from './config.js';\n\nimport { RemoteColorManager } from '../../../root-block/remote-color-manager/remote-color-manager.js';\nimport { cursorStyle, filterCoveringRects, selectionStyle } from './utils.js';\n\nexport interface SelectionRect {\n  width: number;\n  height: number;\n  top: number;\n  left: number;\n  transparent?: boolean;\n}\n\nexport const AFFINE_DOC_REMOTE_SELECTION_WIDGET =\n  'affine-doc-remote-selection-widget';\n\n@customElement(AFFINE_DOC_REMOTE_SELECTION_WIDGET)\nexport class AffineDocRemoteSelectionWidget extends WidgetComponent {\n  // avoid being unable to select text by mouse click or drag\n  static override styles = css`\n    :host {\n      pointer-events: none;\n    }\n  `;\n\n  private _abortController = new AbortController();\n\n  private _remoteColorManager: RemoteColorManager | null = null;\n\n  private _remoteSelections = computed(() => {\n    const status = this.doc.awarenessStore.getStates();\n    return [...this.std.selection.remoteSelections.entries()].map(\n      ([id, selections]) => {\n        return {\n          id,\n          selections,\n          user: status.get(id)?.user,\n        };\n      }\n    );\n  });\n\n  private _resizeObserver: ResizeObserver = new ResizeObserver(() => {\n    this.requestUpdate();\n  });\n\n  private get _config(): DocRemoteSelectionConfig {\n    const config =\n      this.std.getConfig('affine:page')?.docRemoteSelectionWidget ?? {};\n\n    return {\n      blockSelectionBackgroundTransparent: block => {\n        return (\n          matchFlavours(block, [\n            'affine:code',\n            'affine:database',\n            'affine:image',\n            'affine:attachment',\n            'affine:bookmark',\n            'affine:surface-ref',\n          ]) || /affine:embed-*/.test(block.flavour)\n        );\n      },\n      ...config,\n    };\n  }\n\n  private get _container() {\n    return this.offsetParent;\n  }\n\n  private get _containerRect() {\n    return this.offsetParent?.getBoundingClientRect();\n  }\n\n  private get _selectionManager() {\n    return this.host.selection;\n  }\n\n  private _getCursorRect(selections: BaseSelection[]): SelectionRect | null {\n    if (this.block.model.flavour !== 'affine:page') {\n      console.error('remote selection widget must be used in page component');\n      return null;\n    }\n\n    const textSelection = selections.find(\n      selection => selection instanceof TextSelection\n    ) as TextSelection | undefined;\n    const blockSelections = selections.filter(\n      selection => selection instanceof BlockSelection\n    );\n    const container = this._container;\n    const containerRect = this._containerRect;\n\n    if (textSelection) {\n      const range = this.std.range.textSelectionToRange(\n        this._selectionManager.create('text', {\n          from: {\n            blockId: textSelection.to\n              ? textSelection.to.blockId\n              : textSelection.from.blockId,\n            index: textSelection.to\n              ? textSelection.to.index + textSelection.to.length\n              : textSelection.from.index + textSelection.from.length,\n            length: 0,\n          },\n          to: null,\n        })\n      );\n\n      if (!range) {\n        return null;\n      }\n\n      const container = this._container;\n      const containerRect = this._containerRect;\n      const rangeRects = Array.from(range.getClientRects());\n      if (rangeRects.length > 0) {\n        const rect =\n          rangeRects.length === 1\n            ? rangeRects[0]\n            : rangeRects[rangeRects.length - 1];\n        return {\n          width: 2,\n          height: rect.height,\n          top:\n            rect.top - (containerRect?.top ?? 0) + (container?.scrollTop ?? 0),\n          left:\n            rect.left -\n            (containerRect?.left ?? 0) +\n            (container?.scrollLeft ?? 0),\n        };\n      }\n    } else if (blockSelections.length > 0) {\n      const lastBlockSelection = blockSelections[blockSelections.length - 1];\n\n      const block = this.host.view.getBlock(lastBlockSelection.blockId);\n      if (block) {\n        const rect = block.getBoundingClientRect();\n\n        return {\n          width: 2,\n          height: rect.height,\n          top:\n            rect.top - (containerRect?.top ?? 0) + (container?.scrollTop ?? 0),\n          left:\n            rect.left +\n            rect.width -\n            (containerRect?.left ?? 0) +\n            (container?.scrollLeft ?? 0),\n        };\n      }\n    }\n\n    return null;\n  }\n\n  private _getSelectionRect(selections: BaseSelection[]): SelectionRect[] {\n    if (this.block.model.flavour !== 'affine:page') {\n      console.error('remote selection widget must be used in page component');\n      return [];\n    }\n\n    const textSelection = selections.find(\n      selection => selection instanceof TextSelection\n    ) as TextSelection | undefined;\n    const blockSelections = selections.filter(\n      selection => selection instanceof BlockSelection\n    );\n\n    const container = this._container;\n    const containerRect = this._containerRect;\n    if (textSelection) {\n      const range = this.std.range.textSelectionToRange(textSelection);\n\n      if (range) {\n        const nativeRects = Array.from(range.getClientRects());\n        const rectsWithoutFiltered = nativeRects\n          .map(rect => ({\n            width: rect.right - rect.left,\n            height: rect.bottom - rect.top,\n            top:\n              rect.top -\n              (containerRect?.top ?? 0) +\n              (container?.scrollTop ?? 0),\n            left:\n              rect.left -\n              (containerRect?.left ?? 0) +\n              (container?.scrollLeft ?? 0),\n          }))\n          .filter(rect => rect.width > 0 && rect.height > 0);\n\n        return filterCoveringRects(rectsWithoutFiltered);\n      }\n    } else if (blockSelections.length > 0) {\n      return blockSelections.flatMap(blockSelection => {\n        const block = this.host.view.getBlock(blockSelection.blockId);\n        if (block) {\n          const rect = block.getBoundingClientRect();\n\n          const transparent = this._config.blockSelectionBackgroundTransparent(\n            block.model\n          );\n\n          return {\n            width: rect.width,\n            height: rect.height,\n            top:\n              rect.top -\n              (containerRect?.top ?? 0) +\n              (container?.scrollTop ?? 0),\n            left:\n              rect.left -\n              (containerRect?.left ?? 0) +\n              (container?.scrollLeft ?? 0),\n            transparent,\n          };\n        }\n\n        return [];\n      });\n    }\n\n    return [];\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this.handleEvent('wheel', () => {\n      this.requestUpdate();\n    });\n\n    this.disposables.addFromEvent(window, 'resize', () => {\n      this.requestUpdate();\n    });\n\n    this._remoteColorManager = new RemoteColorManager(this.host);\n  }\n\n  override disconnectedCallback() {\n    super.disconnectedCallback();\n    this._resizeObserver.disconnect();\n    this._abortController.abort();\n  }\n\n  override render() {\n    if (this._remoteSelections.value.length === 0) {\n      return nothing;\n    }\n\n    const remoteUsers = new Set<number>();\n    const selections: Array<{\n      id: number;\n      selections: BaseSelection[];\n      rects: SelectionRect[];\n      user?: UserInfo;\n    }> = this._remoteSelections.value.flatMap(({ selections, id, user }) => {\n      if (remoteUsers.has(id)) {\n        return [];\n      } else {\n        remoteUsers.add(id);\n      }\n\n      return {\n        id,\n        selections,\n        rects: this._getSelectionRect(selections),\n        user,\n      };\n    });\n\n    const remoteColorManager = this._remoteColorManager;\n    assertExists(remoteColorManager);\n    return html`<div>\n      ${selections.flatMap(selection => {\n        const color = remoteColorManager.get(selection.id);\n        if (!color) return;\n        const cursorRect = this._getCursorRect(selection.selections);\n\n        return selection.rects\n          .map(r => html`<div style=\"${selectionStyle(r, color)}\"></div>`)\n          .concat([\n            html`\n              <div\n                style=\"${cursorRect\n                  ? cursorStyle(cursorRect, color)\n                  : styleMap({\n                      display: 'none',\n                    })}\"\n              >\n                <div\n                  style=\"${styleMap({\n                    position: 'relative',\n                    height: '100%',\n                  })}\"\n                >\n                  <div\n                    style=\"${styleMap({\n                      position: 'absolute',\n                      left: '-4px',\n                      bottom: `${\n                        cursorRect?.height ? cursorRect.height - 4 : 0\n                      }px`,\n                      backgroundColor: color,\n                      color: 'white',\n                      maxWidth: '160px',\n                      padding: '0 3px',\n                      border: '1px solid var(--affine-pure-black-20)',\n                      boxShadow: '0px 1px 6px 0px rgba(0, 0, 0, 0.16)',\n                      borderRadius: '4px',\n                      fontSize: '12px',\n                      lineHeight: '18px',\n                      overflow: 'hidden',\n                      textOverflow: 'ellipsis',\n                      whiteSpace: 'nowrap',\n                      display: selection.user ? 'block' : 'none',\n                    })}\"\n                  >\n                    ${selection.user?.name}\n                  </div>\n                </div>\n              </div>\n            `,\n          ]);\n      })}\n    </div>`;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    [AFFINE_DOC_REMOTE_SELECTION_WIDGET]: AffineDocRemoteSelectionWidget;\n  }\n}\n"]}