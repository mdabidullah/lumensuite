{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../src/root-block/widgets/edgeless-copilot/index.ts"],"names":[],"mappings":"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","sourcesContent":["import type { RootBlockModel } from '@blocksuite/affine-model';\n\nimport {\n  MOUSE_BUTTON,\n  requestConnectedFrame,\n} from '@blocksuite/affine-shared/utils';\nimport { WidgetComponent } from '@blocksuite/block-std';\nimport { Bound, getElementsBound } from '@blocksuite/global/utils';\nimport {\n  autoUpdate,\n  computePosition,\n  flip,\n  offset,\n  shift,\n  size,\n} from '@floating-ui/dom';\nimport { css, html, nothing } from 'lit';\nimport { customElement, query, state } from 'lit/decorators.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport type { AIItemGroupConfig } from '../../../_common/components/ai-item/types.js';\nimport type { EdgelessRootBlockComponent } from '../../edgeless/edgeless-root-block.js';\nimport type { CopilotSelectionController } from '../../edgeless/tools/copilot-tool.js';\nimport type { AffineAIPanelWidget } from '../ai-panel/ai-panel.js';\n\nimport { AFFINE_AI_PANEL_WIDGET } from '../ai-panel/ai-panel.js';\nimport { EdgelessCopilotPanel } from '../edgeless-copilot-panel/index.js';\n\nexport const AFFINE_EDGELESS_COPILOT_WIDGET = 'affine-edgeless-copilot-widget';\n\n@customElement(AFFINE_EDGELESS_COPILOT_WIDGET)\nexport class EdgelessCopilotWidget extends WidgetComponent<\n  RootBlockModel,\n  EdgelessRootBlockComponent\n> {\n  static override styles = css`\n    .copilot-selection-rect {\n      position: absolute;\n      box-sizing: border-box;\n      border-radius: 4px;\n      border: 2px dashed var(--affine-brand-color, #1e96eb);\n    }\n  `;\n\n  private _clickOutsideOff: (() => void) | null = null;\n\n  private _copilotPanel!: EdgelessCopilotPanel | null;\n\n  private _listenClickOutsideId: number | null = null;\n\n  private _selectionModelRect!: DOMRect;\n\n  groups: AIItemGroupConfig[] = [];\n\n  get edgeless() {\n    return this.block;\n  }\n\n  get selectionModelRect() {\n    return this._selectionModelRect;\n  }\n\n  get selectionRect() {\n    return this._selectionRect;\n  }\n\n  get visible() {\n    return !!(\n      this._visible &&\n      this._selectionRect.width &&\n      this._selectionRect.height\n    );\n  }\n\n  set visible(visible: boolean) {\n    this._visible = visible;\n  }\n\n  private _showCopilotPanel() {\n    requestConnectedFrame(() => {\n      if (!this._copilotPanel) {\n        const panel = new EdgelessCopilotPanel();\n        panel.host = this.host;\n        panel.groups = this.groups;\n        panel.edgeless = this.edgeless;\n        this.renderRoot.append(panel);\n        this._copilotPanel = panel;\n      }\n\n      const referenceElement = this.selectionElem;\n      const panel = this._copilotPanel;\n      // @TODO: optimize\n      const viewport = this.edgeless.service.viewport;\n\n      if (!referenceElement || !referenceElement.isConnected) return;\n\n      autoUpdate(referenceElement, panel, () => {\n        computePosition(referenceElement, panel, {\n          placement: 'right-start',\n          middleware: [\n            offset({\n              mainAxis: 16,\n            }),\n            flip({\n              mainAxis: true,\n              crossAxis: true,\n              flipAlignment: true,\n            }),\n            shift(() => {\n              const { left, top, width, height } = viewport;\n              return {\n                padding: 20,\n                crossAxis: true,\n                rootBoundary: {\n                  x: left,\n                  y: top,\n                  width,\n                  height: height - 100,\n                },\n              };\n            }),\n            size({\n              apply: ({ elements }) => {\n                const { height } = viewport;\n                elements.floating.style.maxHeight = `${height - 140}px`;\n              },\n            }),\n          ],\n        })\n          .then(({ x, y }) => {\n            panel.style.left = `${x}px`;\n            panel.style.top = `${y}px`;\n          })\n          .catch(e => {\n            console.warn(\"Can't compute EdgelessCopilotPanel position\", e);\n          });\n      });\n    }, this);\n  }\n\n  private _updateSelection(rect: DOMRect) {\n    this._selectionModelRect = rect;\n\n    const zoom = this.edgeless.service.viewport.zoom;\n    const [x, y] = this.edgeless.service.viewport.toViewCoord(\n      rect.left,\n      rect.top\n    );\n    const [width, height] = [rect.width * zoom, rect.height * zoom];\n\n    this._selectionRect = { x, y, width, height };\n  }\n\n  private _watchClickOutside() {\n    this._clickOutsideOff?.();\n\n    const { width, height } = this._selectionRect;\n\n    if (width && height) {\n      this._listenClickOutsideId &&\n        cancelAnimationFrame(this._listenClickOutsideId);\n      this._listenClickOutsideId = requestConnectedFrame(() => {\n        if (!this.isConnected) {\n          return;\n        }\n\n        const off = this.block.dispatcher.add('pointerDown', ctx => {\n          const e = ctx.get('pointerState').raw;\n          const aiPanel = this.host.view.getWidget(\n            AFFINE_AI_PANEL_WIDGET,\n            this.doc.root!.id\n          ) as AffineAIPanelWidget;\n\n          if (\n            e.button === MOUSE_BUTTON.MAIN &&\n            !this.contains(e.target as HTMLElement) &&\n            (!aiPanel || aiPanel.state === 'hidden')\n          ) {\n            off();\n            this._visible = false;\n            this.hideCopilotPanel();\n          }\n        });\n        this._listenClickOutsideId = null;\n        this._clickOutsideOff = off;\n      }, this);\n    }\n  }\n\n  override connectedCallback(): void {\n    super.connectedCallback();\n\n    const CopilotSelectionTool = this.edgeless.tools.controllers[\n      'copilot'\n    ] as CopilotSelectionController;\n\n    this._disposables.add(\n      CopilotSelectionTool.draggingAreaUpdated.on(shouldShowPanel => {\n        this._visible = true;\n        this._updateSelection(CopilotSelectionTool.area);\n        if (shouldShowPanel) {\n          this._showCopilotPanel();\n          this._watchClickOutside();\n        } else {\n          this.hideCopilotPanel();\n        }\n      })\n    );\n\n    this._disposables.add(\n      this.edgeless.service.viewport.viewportUpdated.on(() => {\n        if (!this._visible) return;\n\n        this._updateSelection(CopilotSelectionTool.area);\n      })\n    );\n\n    this._disposables.add(\n      this.edgeless.slots.edgelessToolUpdated.on(({ type }) => {\n        if (!this._visible || type === 'copilot') return;\n\n        this._visible = false;\n        this._clickOutsideOff = null;\n        this._copilotPanel?.remove();\n        this._copilotPanel = null;\n      })\n    );\n  }\n\n  determineInsertionBounds(width = 800, height = 95) {\n    const elements = this.edgeless.service.selection.selectedElements;\n    const offsetY = 20 / this.edgeless.service.viewport.zoom;\n    const bounds = new Bound(0, 0, width, height);\n    if (elements.length) {\n      const { x, y, h } = getElementsBound(\n        elements.map(ele => ele.elementBound)\n      );\n      bounds.x = x;\n      bounds.y = y + h + offsetY;\n    } else {\n      const { x, y, height: h } = this.selectionModelRect;\n      bounds.x = x;\n      bounds.y = y + h + offsetY;\n    }\n    return bounds;\n  }\n\n  hideCopilotPanel() {\n    this._copilotPanel?.hide();\n    this._copilotPanel = null;\n    this._clickOutsideOff = null;\n  }\n\n  lockToolbar(disabled: boolean) {\n    this.edgeless.slots.toolbarLocked.emit(disabled);\n  }\n\n  override render() {\n    if (!this._visible) return nothing;\n\n    const rect = this._selectionRect;\n\n    return html`<div class=\"affine-edgeless-ai\">\n      <div\n        class=\"copilot-selection-rect\"\n        style=${styleMap({\n          left: `${rect.x}px`,\n          top: `${rect.y}px`,\n          width: `${rect.width}px`,\n          height: `${rect.height}px`,\n        })}\n      ></div>\n    </div>`;\n  }\n\n  @state()\n  private accessor _selectionRect: {\n    x: number;\n    y: number;\n    width: number;\n    height: number;\n  } = { x: 0, y: 0, width: 0, height: 0 };\n\n  @state()\n  private accessor _visible = false;\n\n  @query('.copilot-selection-rect')\n  accessor selectionElem!: HTMLDivElement;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    [AFFINE_EDGELESS_COPILOT_WIDGET]: EdgelessCopilotWidget;\n  }\n}\n"]}