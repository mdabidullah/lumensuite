{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../src/root-block/widgets/pie-menu/index.ts"],"names":[],"mappings":"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","sourcesContent":["import type { UIEventStateContext } from '@lumensuite/block-std';\nimport type { IVec } from '@lumensuite/global/utils';\n\nimport { WidgetComponent } from '@lumensuite/block-std';\nimport { noop } from '@lumensuite/global/utils';\nimport { nothing } from 'lit';\nimport { customElement, state } from 'lit/decorators.js';\n\nimport type { PieMenuSchema } from './base.js';\n\nimport { EdgelessRootBlockComponent } from '../../edgeless/edgeless-root-block.js';\nimport { PieNodeCenter } from './components/pie-node-center.js';\nimport { PieNodeChild } from './components/pie-node-child.js';\nimport { PieNodeContent } from './components/pie-node-content.js';\nimport { PieCenterRotator } from './components/rotator.js';\nimport { edgelessToolsPieSchema } from './config.js';\nimport { PieMenu } from './menu.js';\nimport { PieManager } from './pie-manager.js';\n\nnoop(PieNodeContent);\nnoop(PieNodeCenter);\nnoop(PieCenterRotator);\nnoop(PieNodeChild);\n\nexport const AFFINE_PIE_MENU_WIDGET = 'affine-pie-menu-widget';\n\n@customElement(AFFINE_PIE_MENU_WIDGET)\nexport class AffinePieMenuWidget extends WidgetComponent {\n  private _handleCursorPos = (ctx: UIEventStateContext) => {\n    const ev = ctx.get('pointerState');\n    const { x, y } = ev.point;\n    this.mouse = [x, y];\n  };\n\n  private _handleKeyUp = (ctx: UIEventStateContext) => {\n    if (!this.currentMenu) return;\n    const ev = ctx.get('keyboardState');\n    const { trigger } = this.currentMenu.schema;\n\n    if (trigger({ keyEvent: ev.raw, rootComponent: this.rootComponent })) {\n      clearTimeout(this.selectOnTrigRelease.timeout);\n      if (this.selectOnTrigRelease.allow) {\n        this.currentMenu.selectHovered();\n        this.currentMenu.close();\n      }\n    }\n  };\n\n  mouse: IVec = [innerWidth / 2, innerHeight / 2];\n\n  // No action if the currently hovered node is a submenu\n  selectOnTrigRelease: { allow: boolean; timeout?: NodeJS.Timeout } = {\n    allow: false,\n  };\n\n  get isEnabled() {\n    return this.doc.awarenessStore.getFlag('enable_pie_menu');\n  }\n\n  // if key is released before 100ms then the menu is kept open, else\n  get isOpen() {\n    return !!this.currentMenu;\n  }\n\n  get rootComponent(): EdgelessRootBlockComponent {\n    const rootComponent = this.block;\n    if (rootComponent instanceof EdgelessRootBlockComponent) {\n      return rootComponent;\n    }\n    throw new Error('AffinePieMenuWidget is only supported in edgeless');\n  }\n\n  private _attachMenu(schema: PieMenuSchema) {\n    if (this.currentMenu && this.currentMenu.id === schema.id)\n      return this.currentMenu.close();\n\n    const [x, y] = this.mouse;\n    const menu = this._createMenu(schema, {\n      x,\n      y,\n      widgetComponent: this,\n    });\n    this.currentMenu = menu;\n\n    this.selectOnTrigRelease.timeout = setTimeout(() => {\n      this.selectOnTrigRelease.allow = true;\n    }, PieManager.settings.SELECT_ON_RELEASE_TIMEOUT);\n  }\n\n  private _initPie() {\n    PieManager.setup({ rootComponent: this.rootComponent });\n\n    this._disposables.add(\n      PieManager.slots.open.on(this._attachMenu.bind(this))\n    );\n  }\n\n  private _onMenuClose() {\n    this.currentMenu = null;\n    this.selectOnTrigRelease.allow = false;\n  }\n\n  // on trigger key release it will select the currently hovered menu node\n  _createMenu(\n    schema: PieMenuSchema,\n    {\n      x,\n      y,\n      widgetComponent,\n    }: {\n      x: number;\n      y: number;\n      widgetComponent: AffinePieMenuWidget;\n    }\n  ) {\n    const menu = new PieMenu();\n    menu.id = schema.id;\n    menu.schema = schema;\n    menu.position = [x, y];\n    menu.rootComponent = widgetComponent.rootComponent;\n    menu.widgetComponent = widgetComponent;\n    menu.abortController.signal.addEventListener(\n      'abort',\n      this._onMenuClose.bind(this)\n    );\n\n    return menu;\n  }\n\n  override connectedCallback(): void {\n    super.connectedCallback();\n\n    if (!this.isEnabled) return;\n\n    this.handleEvent('keyUp', this._handleKeyUp, { global: true });\n    this.handleEvent('pointerMove', this._handleCursorPos, { global: true });\n    this.handleEvent(\n      'wheel',\n      ctx => {\n        const state = ctx.get('defaultState');\n        if (state.event instanceof WheelEvent) state.event.stopPropagation();\n      },\n      { global: true }\n    );\n\n    this._initPie();\n  }\n\n  override disconnectedCallback(): void {\n    super.disconnectedCallback();\n    PieManager.dispose();\n  }\n\n  override render() {\n    return this.currentMenu ?? nothing;\n  }\n\n  @state()\n  accessor currentMenu: PieMenu | null = null;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    [AFFINE_PIE_MENU_WIDGET]: AffinePieMenuWidget;\n  }\n}\n\nPieManager.add(edgelessToolsPieSchema);\n"]}