{"version":3,"file":"pie-builder.js","sourceRoot":"","sources":["../../../../src/root-block/widgets/pie-menu/pie-builder.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,YAAY,EAAE,MAAM,0BAA0B,CAAC;AAYxD,OAAO,EAAE,SAAS,EAAE,MAAM,gDAAgD,CAAC;AAC3E,OAAO,EAAE,UAAU,EAAE,MAAM,kBAAkB,CAAC;AAC9C,OAAO,EAAE,cAAc,EAAE,cAAc,EAAE,kBAAkB,EAAE,MAAM,YAAY,CAAC;AAgBhF,MAAM,OAAO,cAAc;IAKzB,YAAY,IAAgC;QAJpC,YAAO,GAAyB,IAAI,CAAC;QAErC,WAAM,GAAmB,EAAE,CAAC;QAGlC,IAAI,CAAC,OAAO,GAAG;YACb,GAAG,IAAI;YACP,IAAI,EAAE;gBACJ,IAAI,EAAE,MAAM;gBACZ,QAAQ,EAAE,EAAE;gBACZ,KAAK,EAAE,IAAI,CAAC,KAAK;gBACjB,IAAI,EAAE,IAAI,CAAC,IAAI;gBACf,QAAQ,EAAE,KAAK;aAChB;SACF,CAAC;QACF,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;IACtC,CAAC;IAEO,cAAc,CAAC,IAAkB;QACvC,IACE,CAAC,kBAAkB,CAAC,IAAI,CAAC;YACzB,CAAC,IAAI,CAAC,QAAQ;YACd,IAAI,CAAC,QAAQ,CAAC,MAAM,KAAK,CAAC,EAC1B,CAAC;YACD,OAAO;QACT,CAAC;QACD,MAAM,WAAW,GACf,IAAI,CAAC,KAAK,IAAI,SAAS,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,KAAK,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC;QACjE,MAAM,MAAM,GAAG,cAAc,CAAC,IAAI,CAAC,QAAQ,EAAE,WAAW,CAAC,CAAC;QAC1D,MAAM,MAAM,GAAG,cAAc,CAAC,MAAM,EAAE,WAAW,CAAC,CAAC;QAEnD,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,QAAQ,CAAC,MAAM,EAAE,EAAE,CAAC,EAAE,CAAC;YAC9C,MAAM,KAAK,GAAG,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC;YAC/B,KAAK,CAAC,KAAK,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC;YACxB,KAAK,CAAC,UAAU,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC;YACnC,KAAK,CAAC,QAAQ,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC;YAE/B,IAAI,CAAC,cAAc,CAAC,KAAK,CAAC,CAAC;QAC7B,CAAC;IACH,CAAC;IAEO,YAAY;QAClB,MAAM,IAAI,GAAG,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;QACjD,YAAY,CAAC,IAAI,EAAE,gBAAgB,CAAC,CAAC;QACrC,OAAO,IAAI,CAAC;IACd,CAAC;IAED,YAAY,CACV,IAA6D,EAC7D,MAAsC;QAEtC,MAAM,OAAO,GAAG,IAAI,CAAC,YAAY,EAAE,CAAC;QACpC,MAAM,WAAW,GAAwB;YACvC,WAAW,EAAE,IAAI;YACjB,GAAG,IAAI;YACP,IAAI,EAAE,SAAS;YACf,IAAI,EAAE,MAAM,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,SAAS;YACpC,MAAM;YACN,QAAQ,EAAE,EAAE;SACb,CAAC;QACF,IAAI,WAAW,CAAC,MAAM,KAAK,SAAS;YAClC,WAAW,CAAC,eAAe;gBACzB,UAAU,CAAC,QAAQ,CAAC,8BAA8B,CAAC;QAEvD,IAAI,kBAAkB,CAAC,OAAO,CAAC,EAAE,CAAC;YAChC,OAAO,CAAC,QAAQ,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QACrC,CAAC;QAED,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QAE9B,OAAO,IAAI,CAAC;IACd,CAAC;IAED,KAAK;QACH,MAAM,MAAM,GAAG,IAAI,CAAC,OAAO,CAAC;QAC5B,YAAY,CAAC,MAAM,CAAC,CAAC;QACrB,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;QAEjC,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC;QACpB,IAAI,CAAC,MAAM,GAAG,EAAE,CAAC;QACjB,OAAO,MAAM,CAAC;IAChB,CAAC;IAED,WAAW,CAAC,KAA+B;QACzC,MAAM,MAAM,GAAG,KAAK,CAAC,MAAM,IAAI,KAAK,CAAC;QAErC,MAAM,IAAI,GAAG,CAAC,GAAmB,EAAE,EAAE;YACnC,MAAM,KAAK,GAAG,KAAK,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;YAEhC,OAAO,SAAS,CAAC,KAAK,EAAE,EAAE,YAAY,EAAE,MAAM,EAAE,CAAC,CAAC;QACpD,CAAC,CAAC;QAEF,MAAM,eAAe,GAAwB;YAC3C,IAAI,EAAE,SAAS;YACf,IAAI;YACJ,KAAK,EAAE,KAAK,CAAC,KAAK;YAClB,IAAI,EAAE,cAAc;YACpB,WAAW,EAAE,KAAK,CAAC,WAAW,IAAI,IAAI;YACtC,QAAQ,EAAE,KAAK,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,EAAE,KAAK,EAAE,EAAE,EAAE,CAAC,CAAC;gBACzC,IAAI,EAAE,GAAG,EAAE,CAAC,SAAS,CAAC,KAAK,EAAE,EAAE,YAAY,EAAE,MAAM,EAAE,CAAC;gBACtD,IAAI,EAAE,OAAO;gBACb,YAAY,EAAE,MAAM;gBACpB,KAAK,EAAE,KAAK;gBACZ,KAAK,EAAE,KAAK;gBACZ,QAAQ,EAAE,KAAK,CAAC,QAAQ;aACzB,CAAC,CAAC;SACJ,CAAC;QAEF,MAAM,OAAO,GAAG,IAAI,CAAC,YAAY,EAAE,CAAC;QACpC,IAAI,kBAAkB,CAAC,OAAO,CAAC,EAAE,CAAC;YAChC,OAAO,CAAC,QAAQ,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC;QACzC,CAAC;IACH,CAAC;IAED,OAAO,CAAC,IAAuC;QAC7C,MAAM,OAAO,GAAG,IAAI,CAAC,YAAY,EAAE,CAAC;QACpC,MAAM,UAAU,GAAwB,EAAE,GAAG,IAAI,EAAE,IAAI,EAAE,SAAS,EAAE,CAAC;QAErE,IAAI,kBAAkB,CAAC,OAAO,CAAC,EAAE,CAAC;YAChC,OAAO,CAAC,QAAQ,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;QACpC,CAAC;QAED,OAAO,IAAI,CAAC;IACd,CAAC;IAED,UAAU;QACR,IAAI,IAAI,CAAC,MAAM,CAAC,MAAM,KAAK,CAAC;YAC1B,MAAM,IAAI,KAAK,CAAC,2CAA2C,CAAC,CAAC;QAC/D,IAAI,CAAC,MAAM,CAAC,GAAG,EAAE,CAAC;QAElB,OAAO,IAAI,CAAC;IACd,CAAC;IAED,iBAAiB,CACf,IAGC;QAED,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,IAAI,CAAC;QAC7B,IAAI,CAAC,YAAY,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,EAAE,IAAI,CAAC,MAAM,CAAC,CAAC;QAChD,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;QACpB,IAAI,CAAC,UAAU,EAAE,CAAC;IACpB,CAAC;IAED,KAAK,CAAC,IAAgC;QACpC,IAAI,CAAC,MAAM,GAAG,EAAE,CAAC;QACjB,IAAI,CAAC,OAAO,GAAG;YACb,GAAG,IAAI;YACP,IAAI,EAAE,EAAE,IAAI,EAAE,MAAM,EAAE,QAAQ,EAAE,EAAE,EAAE,KAAK,EAAE,IAAI,CAAC,KAAK,EAAE;SACxD,CAAC;QAEF,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;IACtC,CAAC;CACF","sourcesContent":["import { assertExists } from '@blocksuite/global/utils';\n\nimport type {\n  ActionFunction,\n  PieColorNodeModel,\n  PieCommandNodeModel,\n  PieMenuContext,\n  PieMenuSchema,\n  PieNodeModel,\n  PieSubmenuNodeModel,\n} from './base.js';\n\nimport { ColorUnit } from '../../edgeless/components/panel/color-panel.js';\nimport { PieManager } from './pie-manager.js';\nimport { calcNodeAngles, calcNodeWedges, isNodeWithChildren } from './utils.js';\n\nexport interface IPieColorPickerNodeProps {\n  label: string;\n  active: (ctx: PieMenuContext) => string;\n  onChange: PieColorNodeModel['onChange'];\n  openOnHover?: PieSubmenuNodeModel['openOnHover'];\n  hollow?: boolean;\n  colors: { color: string }[];\n}\n\ntype PieBuilderConstructorProps = Omit<\n  PieMenuSchema,\n  'root' | 'angle' | 'startAngle' | 'endAngle' | 'disabled'\n> & { icon: PieNodeModel['icon'] };\n\nexport class PieMenuBuilder {\n  private _schema: PieMenuSchema | null = null;\n\n  private _stack: PieNodeModel[] = [];\n\n  constructor(base: PieBuilderConstructorProps) {\n    this._schema = {\n      ...base,\n      root: {\n        type: 'root',\n        children: [],\n        label: base.label,\n        icon: base.icon,\n        disabled: false,\n      },\n    };\n    this._stack.push(this._schema.root);\n  }\n\n  private _computeAngles(node: PieNodeModel) {\n    if (\n      !isNodeWithChildren(node) ||\n      !node.children ||\n      node.children.length === 0\n    ) {\n      return;\n    }\n    const parentAngle =\n      node.angle == undefined ? undefined : (node.angle + 180) % 360;\n    const angles = calcNodeAngles(node.children, parentAngle);\n    const wedges = calcNodeWedges(angles, parentAngle);\n\n    for (let i = 0; i < node.children.length; ++i) {\n      const child = node.children[i];\n      child.angle = angles[i];\n      child.startAngle = wedges[i].start;\n      child.endAngle = wedges[i].end;\n\n      this._computeAngles(child);\n    }\n  }\n\n  private _currentNode(): PieNodeModel {\n    const node = this._stack[this._stack.length - 1];\n    assertExists(node, 'No node active');\n    return node;\n  }\n\n  beginSubmenu(\n    node: Omit<PieSubmenuNodeModel, 'type' | 'children' | 'role'>,\n    action?: PieSubmenuNodeModel['action']\n  ) {\n    const curNode = this._currentNode();\n    const submenuNode: PieSubmenuNodeModel = {\n      openOnHover: true,\n      ...node,\n      type: 'submenu',\n      role: action ? 'default' : 'command',\n      action,\n      children: [],\n    };\n    if (submenuNode.action !== undefined)\n      submenuNode.timeoutOverride =\n        PieManager.settings.EXPANDABLE_ACTION_NODE_TIMEOUT;\n\n    if (isNodeWithChildren(curNode)) {\n      curNode.children.push(submenuNode);\n    }\n\n    this._stack.push(submenuNode);\n\n    return this;\n  }\n\n  build() {\n    const schema = this._schema;\n    assertExists(schema);\n    this._computeAngles(schema.root);\n\n    this._schema = null;\n    this._stack = [];\n    return schema;\n  }\n\n  colorPicker(props: IPieColorPickerNodeProps) {\n    const hollow = props.hollow ?? false;\n\n    const icon = (ctx: PieMenuContext) => {\n      const color = props.active(ctx);\n\n      return ColorUnit(color, { hollowCircle: hollow });\n    };\n\n    const colorPickerNode: PieSubmenuNodeModel = {\n      type: 'submenu',\n      icon,\n      label: props.label,\n      role: 'color-picker',\n      openOnHover: props.openOnHover ?? true,\n      children: props.colors.map(({ color }) => ({\n        icon: () => ColorUnit(color, { hollowCircle: hollow }),\n        type: 'color',\n        hollowCircle: hollow,\n        label: color,\n        color: color,\n        onChange: props.onChange,\n      })),\n    };\n\n    const curNode = this._currentNode();\n    if (isNodeWithChildren(curNode)) {\n      curNode.children.push(colorPickerNode);\n    }\n  }\n\n  command(node: Omit<PieCommandNodeModel, 'type'>) {\n    const curNode = this._currentNode();\n    const actionNode: PieCommandNodeModel = { ...node, type: 'command' };\n\n    if (isNodeWithChildren(curNode)) {\n      curNode.children.push(actionNode);\n    }\n\n    return this;\n  }\n\n  endSubmenu() {\n    if (this._stack.length === 1)\n      throw new Error('Cant end submenu already on the root node');\n    this._stack.pop();\n\n    return this;\n  }\n\n  expandableCommand(\n    node: Omit<PieSubmenuNodeModel, 'type' | 'children' | 'role'> & {\n      action: ActionFunction;\n      submenus: (pie: PieMenuBuilder) => void;\n    }\n  ) {\n    const { icon, label } = node;\n    this.beginSubmenu({ icon, label }, node.action);\n    node.submenus(this);\n    this.endSubmenu();\n  }\n\n  reset(base: PieBuilderConstructorProps) {\n    this._stack = [];\n    this._schema = {\n      ...base,\n      root: { type: 'root', children: [], label: base.label },\n    };\n\n    this._stack.push(this._schema.root);\n  }\n}\n"]}