{"version":3,"file":"node.js","sourceRoot":"","sources":["../../../../src/root-block/widgets/pie-menu/node.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IVec } from '@lumensuite/global/utils';\n\nimport { WithDisposable } from '@lumensuite/block-std';\nimport { html, LitElement } from 'lit';\nimport { customElement, property, state } from 'lit/decorators.js';\n\nimport type { PieNodeModel } from './base.js';\nimport type { PieMenu } from './menu.js';\n\nimport { pieNodeStyles } from './styles.js';\nimport {\n  isAngleBetween,\n  isColorNode,\n  isCommandNode,\n  isNodeWithAction,\n  isNodeWithChildren,\n  isRootNode,\n} from './utils.js';\n\n@customElement('affine-pie-node')\nexport class PieNode extends WithDisposable(LitElement) {\n  static override styles = pieNodeStyles;\n\n  private _handleChildNodeClick = () => {\n    this.select();\n    if (isCommandNode(this.model)) this.menu.close();\n  };\n\n  private _handleGoBack = () => {\n    // If the node is not active and if it is hovered then we can go back to that node\n    if (this.menu.activeNode !== this) {\n      this.menu.popSelectionChainTo(this);\n    }\n  };\n\n  private _onPointerAngleUpdated = (angle: number | null) => {\n    this._rotatorAngle = angle;\n    this.menu.activeNode.requestUpdate();\n\n    if (isRootNode(this.model) || !this.menu.isChildOfActiveNode(this)) return;\n    if (angle === null) {\n      this._isHovering = false;\n      this.menu.setHovered(null);\n      return;\n    }\n\n    if (isAngleBetween(angle, this.startAngle, this.endAngle)) {\n      if (this.menu.hoveredNode !== this) {\n        this._isHovering = true;\n        this.menu.setHovered(this);\n      }\n    } else {\n      this._isHovering = false;\n    }\n  };\n\n  private _rotatorAngle: number | null = null;\n\n  get icon() {\n    const icon = this.model.icon;\n    if (typeof icon === 'function') {\n      const { menu } = this;\n      const { rootComponent, widgetComponent } = menu;\n      return icon({\n        rootComponent,\n        menu,\n        widgetComponent,\n        node: this,\n      });\n    }\n    return icon;\n  }\n\n  private _renderCenterNode() {\n    const isActiveNode = this.isActive();\n\n    return html`\n      <pie-node-center\n        .node=${this}\n        .hoveredNode=${this.menu.hoveredNode}\n        .isActive=${isActiveNode}\n        .onMouseEnter=${this._handleGoBack}\n        .rotatorAngle=\"${this._rotatorAngle}\"\n      >\n        <slot name=\"children-slot\"></slot>\n      </pie-node-center>\n    `;\n  }\n\n  private _renderChildNode() {\n    const visible = this.menu.isChildOfActiveNode(this);\n    return html`<pie-node-child\n      .node=\"${this}\"\n      .visible=\"${visible}\"\n      .hovering=\"${this._isHovering}\"\n      .onClick=\"${this._handleChildNodeClick}\"\n    >\n    </pie-node-child>`;\n  } // for selecting with keyboard\n\n  private _setupEvents() {\n    this._disposables.add(\n      this.menu.slots.pointerAngleUpdated.on(this._onPointerAngleUpdated)\n    );\n\n    this._disposables.add(\n      this.menu.slots.requestNodeUpdate.on(() => this.requestUpdate())\n    );\n  }\n\n  override connectedCallback(): void {\n    super.connectedCallback();\n    this._setupEvents();\n  }\n\n  isActive() {\n    return this.menu.isActiveNode(this);\n  }\n\n  isCenterNode() {\n    return (\n      isNodeWithChildren(this.model) && this.menu.selectionChain.includes(this)\n    );\n  }\n\n  protected override render() {\n    return this.isCenterNode()\n      ? this._renderCenterNode()\n      : this._renderChildNode();\n  }\n\n  select() {\n    const schema = this.model;\n\n    if (isRootNode(schema)) return;\n\n    const ctx = {\n      rootComponent: this.menu.rootComponent,\n      menu: this.menu,\n      widgetComponent: this.menu.widgetComponent,\n      node: this,\n    };\n\n    if (isNodeWithAction(schema)) {\n      schema.action(ctx);\n    } else if (isColorNode(schema)) {\n      schema.onChange(schema.color, ctx);\n    }\n\n    this.requestUpdate();\n  }\n\n  @state()\n  private accessor _isHovering = false;\n\n  @property({ attribute: false })\n  accessor angle!: number;\n\n  @property({ attribute: false })\n  accessor containerNode: PieNode | null = null;\n\n  @property({ attribute: false })\n  accessor endAngle!: number;\n\n  @property({ attribute: false })\n  accessor index!: number;\n\n  @property({ attribute: false })\n  accessor menu!: PieMenu;\n\n  @property({ attribute: false })\n  accessor model!: PieNodeModel;\n\n  @property({ attribute: false })\n  accessor position!: IVec;\n\n  @property({ attribute: false })\n  accessor startAngle!: number;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'pie-node': PieNode;\n  }\n}\n"]}