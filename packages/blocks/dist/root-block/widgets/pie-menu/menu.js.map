{"version":3,"file":"menu.js","sourceRoot":"","sources":["../../../../src/root-block/widgets/pie-menu/menu.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IVec } from '@blocksuite/global/utils';\n\nimport { CommonUtils } from '@blocksuite/affine-block-surface';\nimport { WithDisposable } from '@blocksuite/block-std';\nimport {\n  assertEquals,\n  assertExists,\n  Slot,\n  Vec,\n} from '@blocksuite/global/utils';\nimport { html, LitElement, nothing } from 'lit';\nimport { customElement, property } from 'lit/decorators.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport type { EdgelessRootBlockComponent } from '../../edgeless/edgeless-root-block.js';\nimport type { PieMenuSchema, PieNodeModel } from './base.js';\nimport type { AffinePieMenuWidget } from './index.js';\n\nimport { PieNode } from './node.js';\nimport { PieManager } from './pie-manager.js';\nimport { pieMenuStyles } from './styles.js';\nimport {\n  getPosition,\n  isColorNode,\n  isCommandNode,\n  isNodeWithAction,\n  isNodeWithChildren,\n  isRootNode,\n  isSubmenuNode,\n} from './utils.js';\n\nconst { toDegree, toRadian } = CommonUtils;\n\n@customElement('affine-pie-menu')\nexport class PieMenu extends WithDisposable(LitElement) {\n  static override styles = pieMenuStyles;\n\n  private _handleKeyDown = (ev: KeyboardEvent) => {\n    const { key } = ev;\n    if (key === 'Escape') {\n      return this.abortController.abort();\n    }\n\n    if (ev.code === 'Backspace') {\n      if (this.selectionChain.length <= 1) return;\n      const { containerNode } = this.activeNode;\n      if (containerNode) this.popSelectionChainTo(containerNode);\n    }\n\n    if (key.match(/\\d+/)) {\n      this.selectChildWithIndex(parseInt(key));\n    }\n  };\n\n  private _handlePointerMove = (ev: PointerEvent) => {\n    const { clientX, clientY } = ev;\n\n    const { ACTIVATE_THRESHOLD_MIN } = PieManager.settings;\n\n    const lenSq = this.getActiveNodeToMouseLenSq([clientX, clientY]);\n\n    if (lenSq > ACTIVATE_THRESHOLD_MIN ** 2) {\n      const [nodeX, nodeY] = this.getActiveNodeRelPos();\n      const dx = clientX - nodeX;\n      const dy = clientY - nodeY;\n\n      const TAU = Math.PI * 2;\n      const angle = toDegree((Math.atan2(dy, dx) + TAU) % TAU); // convert from [-PI, PI] to [0  TAU]\n      this.slots.pointerAngleUpdated.emit(angle);\n    } else {\n      this.slots.pointerAngleUpdated.emit(null); // acts like a abort signal\n    }\n  };\n\n  private _hoveredNode: PieNode | null = null;\n\n  private _openSubmenuTimeout?: NodeJS.Timeout;\n\n  private selectChildWithIndex = (index: number) => {\n    const activeNode = this.activeNode;\n    if (!activeNode || isNaN(index)) return;\n\n    const node = activeNode.querySelector(\n      `& > affine-pie-node[index='${index}']`\n    );\n\n    if (node instanceof PieNode && !isColorNode(node.model)) {\n      // colors are more than 9 may be another method ?\n      if (isSubmenuNode(node.model)) this.openSubmenu(node);\n      else node.select();\n\n      if (isCommandNode(node.model)) this.close();\n    }\n  };\n\n  abortController = new AbortController();\n\n  selectionChain: PieNode[] = [];\n\n  slots = {\n    pointerAngleUpdated: new Slot<number | null>(),\n    requestNodeUpdate: new Slot(),\n  };\n\n  get activeNode() {\n    const node = this.selectionChain[this.selectionChain.length - 1];\n    assertExists(node, 'Required atLeast 1 node active');\n    return node;\n  }\n\n  get hoveredNode() {\n    return this._hoveredNode;\n  }\n\n  get rootNode() {\n    const node = this.selectionChain[0];\n    assertExists(node, 'No root node');\n    return node;\n  }\n\n  private _createNodeTree(nodeSchema: PieNodeModel): PieNode {\n    const node = new PieNode();\n    const { angle, startAngle, endAngle, label } = nodeSchema;\n\n    node.id = label;\n    node.model = nodeSchema;\n    node.angle = angle ?? 0;\n    node.startAngle = startAngle ?? 0;\n    node.endAngle = endAngle ?? 0;\n    node.menu = this;\n\n    if (!isRootNode(nodeSchema)) {\n      node.slot = 'children-slot';\n      const { PIE_RADIUS } = PieManager.settings;\n      const isColorNode = nodeSchema.type === 'color';\n      const radius = isColorNode ? PIE_RADIUS * 0.6 : PIE_RADIUS;\n\n      node.position = getPosition(toRadian(node.angle), [radius, radius]);\n    } else {\n      node.position = [0, 0];\n    }\n\n    if (isNodeWithChildren(nodeSchema)) {\n      nodeSchema.children.forEach((childSchema, i) => {\n        const childNode = this._createNodeTree(childSchema);\n        childNode.containerNode = node;\n        childNode.index = i + 1;\n        childNode.setAttribute('index', childNode.index.toString());\n\n        node.append(childNode);\n      });\n    }\n\n    return node;\n  }\n\n  private _setupEvents() {\n    this._disposables.addFromEvent(\n      this.widgetComponent,\n      'pointermove',\n      this._handlePointerMove\n    );\n\n    this._disposables.addFromEvent(document, 'keydown', this._handleKeyDown);\n  }\n\n  close() {\n    this.abortController.abort();\n  }\n\n  override connectedCallback(): void {\n    super.connectedCallback();\n    this._setupEvents();\n    const root = this._createNodeTree(this.schema.root);\n    this.selectionChain.push(root);\n  }\n\n  /**\n   * Position of the active node relative to the view\n   */\n  getActiveNodeRelPos(): IVec {\n    const position: IVec = [...this.position]; // use the menus position at start which will be the position of the root node\n\n    for (const node of this.selectionChain) {\n      position[0] += node.position[0];\n      position[1] += node.position[1];\n    }\n    return position;\n  }\n\n  getActiveNodeToMouseLenSq(mouse: IVec) {\n    const [x, y] = mouse;\n    const [nodeX, nodeY] = this.getActiveNodeRelPos();\n\n    const dx = x - nodeX;\n    const dy = y - nodeY;\n\n    return Vec.len2([dx, dy]);\n  }\n\n  getNodeRelPos(node: PieNode): IVec {\n    const position: IVec = [...this.position];\n    let cur: PieNode | null = node;\n\n    while (cur !== null) {\n      position[0] += cur.position[0];\n      position[1] += cur.position[1];\n      cur = cur.containerNode;\n    }\n\n    return position;\n  }\n\n  isActiveNode(node: PieNode) {\n    return this.activeNode === node;\n  }\n\n  isChildOfActiveNode(node: PieNode) {\n    return node.containerNode === this.activeNode;\n  }\n\n  openSubmenu(submenu: PieNode) {\n    assertEquals(submenu.model.type, 'submenu', 'Need node of type submenu');\n\n    if (isNodeWithAction(submenu.model)) submenu.select();\n\n    this.selectionChain.push(submenu);\n    this.setHovered(null);\n    this.slots.requestNodeUpdate.emit();\n  }\n\n  popSelectionChainTo(node: PieNode) {\n    assertEquals(\n      isNodeWithChildren(node.model),\n      true,\n      'Required a root node or a submenu node'\n    );\n\n    while (this.selectionChain.length > 1 && this.activeNode !== node) {\n      this.selectionChain.pop();\n    }\n    this.requestUpdate();\n    this.slots.requestNodeUpdate.emit();\n  }\n\n  override render() {\n    const [x, y] = this.position;\n    const menuStyles = {\n      transform: `translate(${x}px, ${y}px) translate(-50%, -50%)`,\n    };\n\n    return html` <div class=\"pie-menu-container\">\n      <div class=\"overlay\" @click=\"${() => this.abortController.abort()}\"></div>\n\n      <div style=\"${styleMap(menuStyles)}\" class=\"pie-menu\">\n        ${this.rootNode ?? nothing}\n      </div>\n    </div>`;\n  }\n\n  selectHovered() {\n    const { hoveredNode } = this;\n\n    if (hoveredNode) {\n      hoveredNode.select();\n    }\n  }\n\n  setHovered(node: PieNode | null) {\n    clearTimeout(this._openSubmenuTimeout);\n\n    this._hoveredNode = node;\n\n    if (!node) return;\n\n    if (isSubmenuNode(node.model)) {\n      const { openOnHover, timeoutOverride } = node.model;\n      const { SUBMENU_OPEN_TIMEOUT } = PieManager.settings;\n\n      if (openOnHover !== undefined && !openOnHover) return;\n\n      this._openSubmenuTimeout = setTimeout(() => {\n        this.openSubmenu(node);\n      }, timeoutOverride ?? SUBMENU_OPEN_TIMEOUT);\n    }\n  }\n\n  @property({ attribute: false })\n  accessor position!: IVec;\n\n  @property({ attribute: false })\n  accessor rootComponent!: EdgelessRootBlockComponent;\n\n  @property({ attribute: false })\n  accessor schema!: PieMenuSchema;\n\n  @property({ attribute: false })\n  accessor widgetComponent!: AffinePieMenuWidget;\n}\n"]}