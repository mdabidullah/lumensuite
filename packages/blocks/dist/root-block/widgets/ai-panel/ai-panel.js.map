{"version":3,"file":"ai-panel.js","sourceRoot":"","sources":["../../../../src/root-block/widgets/ai-panel/ai-panel.ts"],"names":[],"mappings":"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","sourcesContent":["import type { BaseSelection } from '@lumensuite/block-std';\n\nimport {\n  getPageRootByElement,\n  stopPropagation,\n} from '@lumensuite/affine-shared/utils';\nimport { WidgetComponent } from '@lumensuite/block-std';\nimport { assertExists } from '@lumensuite/global/utils';\nimport {\n  autoPlacement,\n  autoUpdate,\n  computePosition,\n  type ComputePositionConfig,\n  flip,\n  offset,\n  type Rect,\n  shift,\n} from '@floating-ui/dom';\nimport { css, html, nothing, type PropertyValues } from 'lit';\nimport { customElement, property, query } from 'lit/decorators.js';\nimport { choose } from 'lit/directives/choose.js';\n\nimport type { AIError } from '../../../_common/components/index.js';\nimport type { EdgelessRootService } from '../../edgeless/edgeless-root-service.js';\nimport type { AIPanelGenerating } from './components/index.js';\nimport type { AffineAIPanelState, AffineAIPanelWidgetConfig } from './type.js';\n\nimport { PageRootService } from '../../page/page-root-service.js';\nimport { AFFINE_FORMAT_BAR_WIDGET } from '../format-bar/format-bar.js';\nimport {\n  AFFINE_VIEWPORT_OVERLAY_WIDGET,\n  type AffineViewportOverlayWidget,\n} from '../viewport-overlay/viewport-overlay.js';\nimport './components/index.js';\n\nexport const AFFINE_AI_PANEL_WIDGET = 'affine-ai-panel-widget';\n\n@customElement(AFFINE_AI_PANEL_WIDGET)\nexport class AffineAIPanelWidget extends WidgetComponent {\n  static override styles = css`\n    :host {\n      display: flex;\n      outline: none;\n      border-radius: var(--8, 8px);\n      border: 1px solid var(--affine-border-color);\n      background: var(--affine-background-overlay-panel-color);\n      box-shadow: var(--affine-overlay-shadow);\n\n      position: absolute;\n      width: max-content;\n      height: auto;\n      top: 0;\n      left: 0;\n      overflow-y: auto;\n      scrollbar-width: none !important;\n      z-index: var(--affine-z-index-popover);\n    }\n\n    .ai-panel-container {\n      display: flex;\n      flex-direction: column;\n      box-sizing: border-box;\n      width: 100%;\n      height: fit-content;\n      padding: 8px 0;\n    }\n\n    .ai-panel-container:not(:has(ai-panel-generating)) {\n      gap: 8px;\n    }\n\n    .ai-panel-container:has(ai-panel-answer),\n    .ai-panel-container:has(ai-panel-error),\n    .ai-panel-container:has(ai-panel-generating:has(generating-placeholder)) {\n      padding: 12px 0;\n    }\n\n    :host([data-state='hidden']) {\n      display: none;\n    }\n  `;\n\n  private _abortController = new AbortController();\n\n  private _answer: string | null = null;\n\n  private _cancelCallback = () => {\n    this.focus();\n  };\n\n  private _clearDiscardModal = () => {\n    if (this._discardModalAbort) {\n      this._discardModalAbort.abort();\n      this._discardModalAbort = null;\n    }\n  };\n\n  private _clickOutside = () => {\n    switch (this.state) {\n      case 'hidden':\n        return;\n      case 'error':\n      case 'finished':\n        if (!this._answer) {\n          this.hide();\n        } else {\n          this.discard();\n        }\n        break;\n      default:\n        this.discard();\n    }\n  };\n\n  private _discardCallback = () => {\n    this.hide();\n    this.config?.discardCallback?.();\n  };\n\n  private _discardModalAbort: AbortController | null = null;\n\n  private _inputFinish = (text: string) => {\n    this._inputText = text;\n    this.generate();\n  };\n\n  private _inputText: string | null = null;\n\n  private _onDocumentClick = (e: MouseEvent) => {\n    if (\n      this.state !== 'hidden' &&\n      e.target !== this &&\n      !this.contains(e.target as Node)\n    ) {\n      this._clickOutside();\n      return true;\n    }\n\n    return false;\n  };\n\n  private _onKeyDown = (event: KeyboardEvent) => {\n    event.stopPropagation();\n    const { state } = this;\n    if (state !== 'generating' && state !== 'input') {\n      return;\n    }\n\n    const { key, isComposing } = event;\n    if (key === 'Escape') {\n      if (state === 'generating') {\n        this.stopGenerating();\n      } else {\n        this.hide();\n      }\n      return;\n    }\n\n    if (key === 'Delete' || key === 'Backspace') {\n      if (isComposing) return;\n\n      if (state === 'input' && !this._inputText) {\n        this.hide();\n      }\n    }\n  };\n\n  private _resetAbortController = () => {\n    if (this.state === 'generating') {\n      this._abortController.abort();\n    }\n    this._abortController = new AbortController();\n  };\n\n  private _selection?: BaseSelection[];\n\n  private _stopAutoUpdate?: undefined | (() => void);\n\n  ctx: unknown = null;\n\n  discard = () => {\n    if ((this.state === 'finished' || this.state === 'error') && !this.answer) {\n      this._discardCallback();\n      return;\n    }\n    if (this.state === 'input') {\n      this.hide();\n      return;\n    }\n    this.showDiscardModal()\n      .then(discard => {\n        if (discard) {\n          this._discardCallback();\n        } else {\n          this._cancelCallback();\n        }\n        this._restoreSelection();\n      })\n      .catch(console.error);\n  };\n\n  /**\n   * You can evaluate this method multiple times to regenerate the answer.\n   */\n  generate = () => {\n    assertExists(this.config);\n    const text = this._inputText;\n    assertExists(text);\n    assertExists(this.config.generateAnswer);\n\n    this._resetAbortController();\n\n    // reset answer\n    this._answer = null;\n\n    const update = (answer: string) => {\n      this._answer = answer;\n      this.requestUpdate();\n    };\n    const finish = (type: 'success' | 'error' | 'aborted', err?: AIError) => {\n      if (type === 'aborted') return;\n\n      assertExists(this.config);\n      if (type === 'error') {\n        this.state = 'error';\n        this.config.errorStateConfig.error = err;\n      } else {\n        this.state = 'finished';\n        this.config.errorStateConfig.error = undefined;\n      }\n\n      this._resetAbortController();\n    };\n\n    this.scrollTop = 0; // reset scroll top\n    this.state = 'generating';\n    this.config.generateAnswer({\n      input: text,\n      update,\n      finish,\n      signal: this._abortController.signal,\n    });\n  };\n\n  hide = () => {\n    this._resetAbortController();\n    this.state = 'hidden';\n    this._stopAutoUpdate?.();\n    this._inputText = null;\n    this._answer = null;\n    this._stopAutoUpdate = undefined;\n    this.config?.hideCallback?.();\n    this.viewportOverlayWidget?.unlock();\n  };\n\n  onInput = (text: string) => {\n    this._inputText = text;\n  };\n\n  showDiscardModal = () => {\n    const notification =\n      this.host.std.getService('affine:page').notificationService;\n    if (!notification) {\n      return Promise.resolve(true);\n    }\n    this._clearDiscardModal();\n    this._discardModalAbort = new AbortController();\n    return notification\n      .confirm({\n        title: 'Discard the AI result',\n        message: 'Do you want to discard the results the AI just generated?',\n        cancelText: 'Cancel',\n        confirmText: 'Discard',\n        abort: this._abortController.signal,\n      })\n      .finally(() => (this._discardModalAbort = null));\n  };\n\n  stopGenerating = () => {\n    this._abortController.abort();\n    this.state = 'finished';\n    if (!this.answer) {\n      this.hide();\n    }\n  };\n\n  toggle = (reference: Element, input?: string) => {\n    if (input) {\n      this._inputText = input;\n      this.generate();\n    } else {\n      // reset state\n      this.hide();\n      this.state = 'input';\n    }\n\n    this._autoUpdatePosition(reference);\n  };\n\n  get answer() {\n    return this._answer;\n  }\n\n  get inputText() {\n    return this._inputText;\n  }\n\n  get viewportOverlayWidget() {\n    const rootId = this.host.doc.root?.id;\n    return rootId\n      ? (this.host.view.getWidget(\n          AFFINE_VIEWPORT_OVERLAY_WIDGET,\n          rootId\n        ) as AffineViewportOverlayWidget)\n      : null;\n  }\n\n  private _autoUpdatePosition(reference: Element) {\n    // workaround for the case that the reference contains children block elements, like:\n    // paragraph\n    //    child paragraph\n    {\n      const childrenContainer = reference.querySelector(\n        '.affine-block-children-container'\n      );\n      if (childrenContainer && childrenContainer.previousElementSibling) {\n        reference = childrenContainer.previousElementSibling;\n      }\n    }\n\n    this._stopAutoUpdate?.();\n    this._stopAutoUpdate = autoUpdate(reference, this, () => {\n      computePosition(reference, this, this._calcPositionOptions(reference))\n        .then(({ x, y }) => {\n          this.style.left = `${x}px`;\n          this.style.top = `${y}px`;\n        })\n        .catch(console.error);\n    });\n  }\n\n  private _calcPositionOptions(\n    reference: Element\n  ): Partial<ComputePositionConfig> {\n    let rootBoundary: Rect | undefined;\n    {\n      const rootService = this.host.std.getService('affine:page');\n      if (rootService instanceof PageRootService) {\n        rootBoundary = undefined;\n      } else {\n        // TODO circular dependency: instanceof EdgelessRootService\n        const viewport = (rootService as EdgelessRootService).viewport;\n        rootBoundary = {\n          x: viewport.left,\n          y: viewport.top,\n          width: viewport.width,\n          height: viewport.height - 100, // 100 for edgeless toolbar\n        };\n      }\n    }\n\n    const overflowOptions = {\n      padding: 20,\n      rootBoundary: rootBoundary,\n    };\n\n    // block element in page editor\n    if (getPageRootByElement(reference)) {\n      return {\n        placement: 'bottom-start',\n        middleware: [offset(8), shift(overflowOptions)],\n      };\n    }\n    // block element in doc in edgeless editor\n    else if (reference.closest('edgeless-block-portal-note')) {\n      return {\n        middleware: [\n          offset(8),\n          shift(overflowOptions),\n          autoPlacement({\n            ...overflowOptions,\n            allowedPlacements: ['top-start', 'bottom-start'],\n          }),\n        ],\n      };\n    }\n    // edgeless element\n    else {\n      return {\n        placement: 'right-start',\n        middleware: [\n          offset({ mainAxis: 16 }),\n          flip({\n            mainAxis: true,\n            crossAxis: true,\n            flipAlignment: true,\n            ...overflowOptions,\n          }),\n          shift({\n            crossAxis: true,\n            ...overflowOptions,\n          }),\n        ],\n      };\n    }\n  }\n\n  private _restoreSelection() {\n    if (this._selection) {\n      this.host.selection.set([...this._selection]);\n      if (this.state === 'hidden') {\n        this._selection = undefined;\n      }\n    }\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this.tabIndex = -1;\n    this.disposables.addFromEvent(\n      document,\n      'pointerdown',\n      this._onDocumentClick\n    );\n    this.disposables.add(\n      this.block.host.event.add('pointerDown', evtState =>\n        this._onDocumentClick(\n          evtState.get('pointerState').event as PointerEvent\n        )\n      )\n    );\n    this.disposables.add(\n      this.block.host.event.add('click', () => {\n        return this.state !== 'hidden' ? true : false;\n      })\n    );\n    this.disposables.addFromEvent(this, 'wheel', stopPropagation);\n    this.disposables.addFromEvent(this, 'pointerdown', stopPropagation);\n    this.disposables.addFromEvent(this, 'pointerup', stopPropagation);\n    this.disposables.addFromEvent(this, 'keydown', this._onKeyDown);\n  }\n\n  override disconnectedCallback() {\n    super.disconnectedCallback();\n    this._clearDiscardModal();\n    this._stopAutoUpdate?.();\n  }\n\n  override render() {\n    if (this.state === 'hidden') {\n      return nothing;\n    }\n\n    if (!this.config) return nothing;\n    const config = this.config;\n\n    this.updateComplete\n      .then(() => {\n        this.focus();\n      })\n      .catch(console.error);\n\n    const mainTemplate = choose(this.state, [\n      [\n        'input',\n        () =>\n          html`<ai-panel-input\n            .onBlur=${() => this.discard()}\n            .onFinish=${this._inputFinish}\n            .onInput=${this.onInput}\n          ></ai-panel-input>`,\n      ],\n      [\n        'generating',\n        () => html`\n          ${this.answer\n            ? html`\n                <ai-panel-answer\n                  .finish=${false}\n                  .config=${config.finishStateConfig}\n                  .host=${this.host}\n                >\n                  ${this.answer &&\n                  config.answerRenderer(this.answer, this.state)}\n                </ai-panel-answer>\n              `\n            : nothing}\n          <ai-panel-generating\n            .config=${config.generatingStateConfig}\n            .stopGenerating=${this.stopGenerating}\n            .withAnswer=${!!this.answer}\n          ></ai-panel-generating>\n        `,\n      ],\n      [\n        'finished',\n        () => html`\n          <ai-panel-answer\n            .config=${config.finishStateConfig}\n            .copy=${config.copy}\n            .host=${this.host}\n          >\n            ${this.answer && config.answerRenderer(this.answer, this.state)}\n          </ai-panel-answer>\n        `,\n      ],\n      [\n        'error',\n        () => html`\n          <ai-panel-error\n            .config=${config.errorStateConfig}\n            .copy=${config.copy}\n            .withAnswer=${!!this.answer}\n            .host=${this.host}\n          >\n            ${this.answer && config.answerRenderer(this.answer, this.state)}\n          </ai-panel-error>\n        `,\n      ],\n    ]);\n\n    return html`<div class=\"ai-panel-container\">${mainTemplate}</div>`;\n  }\n\n  protected override willUpdate(changed: PropertyValues): void {\n    const prevState = changed.get('state');\n    if (prevState) {\n      if (prevState === 'hidden') {\n        this._selection = this.host.selection.value;\n        requestAnimationFrame(() => {\n          this.scrollIntoView({\n            block: 'center',\n          });\n        });\n      } else {\n        this.host.updateComplete\n          .then(() => {\n            if (this.state !== 'hidden') {\n              this.focus();\n            }\n          })\n          .catch(console.error);\n        this._restoreSelection();\n      }\n\n      // tell format bar to show or hide\n      const rootBlockId = this.host.doc.root?.id;\n      const formatBar = rootBlockId\n        ? this.host.view.getWidget(AFFINE_FORMAT_BAR_WIDGET, rootBlockId)\n        : null;\n\n      if (formatBar) {\n        formatBar.requestUpdate();\n      }\n    }\n\n    if (this.state !== 'hidden') {\n      this.viewportOverlayWidget?.lock();\n    } else {\n      this.viewportOverlayWidget?.unlock();\n    }\n\n    this.dataset.state = this.state;\n  }\n\n  @property({ attribute: false })\n  accessor config: AffineAIPanelWidgetConfig | null = null;\n\n  @query('ai-panel-generating')\n  accessor generatingElement: AIPanelGenerating | null = null;\n\n  @property()\n  accessor state: AffineAIPanelState = 'hidden';\n}\n"]}