{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../src/root-block/widgets/slash-menu/index.ts"],"names":[],"mappings":"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","sourcesContent":["import type { UIEventStateContext } from '@blocksuite/block-std';\n\nimport { getInlineEditorByModel } from '@blocksuite/affine-components/rich-text';\nimport {\n  getCurrentNativeRange,\n  matchFlavours,\n} from '@blocksuite/affine-shared/utils';\nimport { WidgetComponent } from '@blocksuite/block-std';\nimport {\n  assertExists,\n  debounce,\n  DisposableGroup,\n  throttle,\n} from '@blocksuite/global/utils';\nimport { customElement } from 'lit/decorators.js';\n\nimport type { RootBlockComponent } from '../../types.js';\n\nimport { getPopperPosition } from '../../utils/position.js';\nimport {\n  defaultSlashMenuConfig,\n  type SlashMenuActionItem,\n  type SlashMenuContext,\n  type SlashMenuGroupDivider,\n  type SlashMenuItem,\n  type SlashMenuItemGenerator,\n  type SlashMenuStaticConfig,\n  type SlashSubMenu,\n} from './config.js';\nimport { SlashMenu } from './slash-menu-popover.js';\nimport { filterEnabledSlashMenuItems } from './utils.js';\n\nexport { insertContent } from './utils.js';\n\nexport type AffineSlashMenuContext = SlashMenuContext;\nexport type AffineSlashMenuItem = SlashMenuItem;\nexport type AffineSlashMenuActionItem = SlashMenuActionItem;\nexport type AffineSlashMenuItemGenerator = SlashMenuItemGenerator;\nexport type AffineSlashSubMenu = SlashSubMenu;\nexport type AffineSlashMenuGroupDivider = SlashMenuGroupDivider;\n\nlet globalAbortController = new AbortController();\n\nfunction closeSlashMenu() {\n  globalAbortController.abort();\n}\n\nconst showSlashMenu = debounce(\n  ({\n    context,\n    range,\n    container = document.body,\n    abortController = new AbortController(),\n    config,\n    triggerKey,\n  }: {\n    context: SlashMenuContext;\n    range: Range;\n    container?: HTMLElement;\n    abortController?: AbortController;\n    config: SlashMenuStaticConfig;\n    triggerKey: string;\n  }) => {\n    globalAbortController = abortController;\n    const disposables = new DisposableGroup();\n    abortController.signal.addEventListener('abort', () =>\n      disposables.dispose()\n    );\n\n    const inlineEditor = getInlineEditorByModel(\n      context.rootComponent.host,\n      context.model\n    );\n    if (!inlineEditor) return;\n    const slashMenu = new SlashMenu(inlineEditor, abortController);\n    disposables.add(() => slashMenu.remove());\n    slashMenu.context = context;\n    slashMenu.config = config;\n    slashMenu.triggerKey = triggerKey;\n\n    // Handle position\n    const updatePosition = throttle(() => {\n      const slashMenuElement = slashMenu.slashMenuElement;\n      assertExists(\n        slashMenuElement,\n        'You should render the slash menu node even if no position'\n      );\n      const position = getPopperPosition(slashMenuElement, range);\n      slashMenu.updatePosition(position);\n    }, 10);\n\n    disposables.addFromEvent(window, 'resize', updatePosition);\n\n    // FIXME(Flrande): It is not a best practice,\n    // but merely a temporary measure for reusing previous components.\n    // Mount\n    container.append(slashMenu);\n    // Wait for the Node to be mounted\n    setTimeout(updatePosition);\n    return slashMenu;\n  },\n  100\n);\n\nexport const AFFINE_SLASH_MENU_WIDGET = 'affine-slash-menu-widget';\n\n@customElement(AFFINE_SLASH_MENU_WIDGET)\nexport class AffineSlashMenuWidget extends WidgetComponent {\n  static DEFAULT_CONFIG = defaultSlashMenuConfig;\n\n  private _onBeforeInput = (ctx: UIEventStateContext) => {\n    const eventState = ctx.get('defaultState');\n    const event = eventState.event as InputEvent;\n\n    const triggerKey = event.data;\n    if (!triggerKey || !this.config.triggerKeys.includes(triggerKey)) return;\n\n    const textSelection = this.host.selection.find('text');\n    if (!textSelection) return;\n\n    const block = this.host.doc.getBlock(textSelection.blockId);\n    assertExists(block);\n\n    const { model } = block;\n\n    if (matchFlavours(model, this.config.ignoreBlockTypes)) return;\n\n    const inlineEditor = getInlineEditorByModel(this.host, model);\n    if (!inlineEditor) return;\n\n    inlineEditor.slots.inlineRangeApply.once(() => {\n      const rootComponent = this.block;\n      if (rootComponent.model.flavour !== 'affine:page') {\n        console.error('SlashMenuWidget should be used in RootBlock');\n        return;\n      }\n\n      const config: SlashMenuStaticConfig = {\n        ...this.config,\n        items: filterEnabledSlashMenuItems(this.config.items, {\n          model,\n          rootComponent: rootComponent as RootBlockComponent,\n        }),\n      };\n\n      // Wait for dom update, see this case https://github.com/toeverything/blocksuite/issues/2611\n      requestAnimationFrame(() => {\n        const curRange = getCurrentNativeRange();\n        if (!curRange) return;\n\n        closeSlashMenu();\n        showSlashMenu({\n          context: {\n            model,\n            rootComponent: rootComponent as RootBlockComponent,\n          },\n          range: curRange,\n          triggerKey,\n          config,\n        });\n      });\n    });\n  };\n\n  config = AffineSlashMenuWidget.DEFAULT_CONFIG;\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    if (this.config.triggerKeys.some(key => key.length === 0)) {\n      console.error('Trigger key of slash menu should not be empty string');\n      return;\n    }\n\n    this.handleEvent('beforeInput', this._onBeforeInput);\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    [AFFINE_SLASH_MENU_WIDGET]: AffineSlashMenuWidget;\n  }\n}\n"]}