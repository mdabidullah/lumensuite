{"version":3,"file":"tools-manager.js","sourceRoot":"","sources":["../../../../src/root-block/edgeless/services/tools-manager.ts"],"names":[],"mappings":"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","sourcesContent":["import type {\n  EventName,\n  PointerEventState,\n  SurfaceSelection,\n  UIEventHandler,\n  UIEventState,\n} from '@blocksuite/block-std';\nimport type { Bound } from '@blocksuite/global/utils';\n\nimport { NoteDisplayMode } from '@blocksuite/affine-model';\nimport { IS_MAC } from '@blocksuite/global/env';\nimport { DisposableGroup } from '@blocksuite/global/utils';\n\nimport type { EdgelessRootBlockComponent } from '../edgeless-root-block.js';\nimport type { EdgelessRootService } from '../edgeless-root-service.js';\nimport type { EdgelessToolController } from '../tools/index.js';\nimport type { EdgelessTool } from '../types.js';\nimport type { EdgelessSelectionState } from './selection-manager.js';\n\nimport {\n  isMiddleButtonPressed,\n  isRightButtonPressed,\n} from '../../../_common/utils/index.js';\nimport { CopilotSelectionController } from '../tools/copilot-tool.js';\nimport { edgelessElementsBound } from '../utils/bound-utils.js';\nimport { isNoteBlock } from '../utils/query.js';\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\ntype Constructor<T = object> = new (...args: any[]) => T;\ntype AbstractClassConstructor<T = object> = Constructor<T> & {\n  prototype: T;\n};\n\nexport type EdgelessToolConstructor =\n  AbstractClassConstructor<EdgelessToolController>;\n\nexport interface EdgelessHoverState {\n  rect: Bound;\n  content: BlockSuite.EdgelessModel;\n}\n\nexport interface SelectionArea {\n  start: DOMPoint;\n  end: DOMPoint;\n}\n\nexport class EdgelessToolsManager {\n  private _add = (name: EventName, fn: UIEventHandler) => {\n    this._disposables.add(this.dispatcher.add(name, fn));\n  };\n\n  private _container!: EdgelessRootBlockComponent;\n\n  private _controllers: Record<\n    EdgelessTool['type'] | string,\n    EdgelessToolController\n  > = {};\n\n  private _dragging = false;\n\n  private _edgelessTool: EdgelessTool = this._getToolFromLocalStorage();\n\n  /** Latest mouse position in view coords */\n  private _lastMousePos: { x: number; y: number } = { x: 0, y: 0 };\n\n  private _mounted = false;\n\n  private _onContainerClick = (e: PointerEventState) => {\n    this._updateLastMousePos(e);\n    return this.currentController.onContainerClick(e);\n  };\n\n  private _onContainerContextMenu = (e: UIEventState) => {\n    // should display context menu when right-clicking on editing block\n    // e.g. `note` `edgeless-text` and `shape-text`\n    if (this.selection.editing) return;\n    e.event.preventDefault();\n  };\n\n  private _onContainerDblClick = (e: PointerEventState) => {\n    return this.currentController.onContainerDblClick(e);\n  };\n\n  private _onContainerDragEnd = (e: PointerEventState) => {\n    // only allow pan tool in readonly mode\n    if (this.doc.readonly && this.edgelessTool.type !== 'pan') return;\n    // do nothing when holding right-key and not in pan mode\n    if (\n      e.button === 2 &&\n      this.edgelessTool.type !== 'pan' &&\n      this.edgelessTool.type !== 'copilot'\n    )\n      return;\n\n    return this.currentController.onContainerDragEnd(e);\n  };\n\n  private _onContainerDragMove = (e: PointerEventState) => {\n    // only allow pan tool in readonly mode\n    if (this.doc.readonly && this.edgelessTool.type !== 'pan') return;\n    // do nothing when holding right-key and not in pan mode\n    if (\n      e.button === 2 &&\n      this.edgelessTool.type !== 'pan' &&\n      this.edgelessTool.type !== 'copilot'\n    )\n      return;\n\n    return this.currentController.onContainerDragMove(e);\n  };\n\n  private _onContainerDragStart = (e: PointerEventState) => {\n    // only allow pan tool in readonly mode\n    if (this.doc.readonly && this.edgelessTool.type !== 'pan') return;\n    // do nothing when holding right-key and not in pan mode\n    if (\n      e.button === 2 &&\n      this.edgelessTool.type !== 'pan' &&\n      this.edgelessTool.type !== 'copilot'\n    )\n      return;\n\n    return this.currentController.onContainerDragStart(e);\n  };\n\n  private _onContainerPointerDown = (e: PointerEventState) => {\n    const pointEvt = e.raw;\n    const metaKeyPressed = IS_MAC ? pointEvt.metaKey : pointEvt.ctrlKey;\n\n    if (\n      !this.selection.editing &&\n      (isMiddleButtonPressed(pointEvt) ||\n        isRightButtonPressed(pointEvt) ||\n        metaKeyPressed)\n    ) {\n      const isRightButton = isRightButtonPressed(pointEvt);\n      const targetTool = (\n        isRightButton || metaKeyPressed\n          ? {\n              type: 'copilot',\n            }\n          : { type: 'pan', panning: true }\n      ) as EdgelessTool;\n      const prevEdgelessTool = this._edgelessTool;\n      const targetButtonRelease = (_e: MouseEvent) =>\n        (isMiddleButtonPressed(e.raw) && !isMiddleButtonPressed(_e)) ||\n        (isRightButton && !isRightButtonPressed(_e)) ||\n        metaKeyPressed;\n\n      const switchToPreMode = (_e: MouseEvent) => {\n        if (targetTool.type === 'copilot') return;\n\n        if (targetButtonRelease(_e)) {\n          this.setEdgelessTool(\n            prevEdgelessTool,\n            undefined,\n            !isRightButton && !metaKeyPressed\n          );\n          document.removeEventListener('pointerup', switchToPreMode, false);\n          document.removeEventListener('pointerover', switchToPreMode, false);\n        }\n      };\n\n      this.dispatcher.disposables.addFromEvent(\n        document,\n        'pointerup',\n        switchToPreMode\n      );\n\n      this.setEdgelessTool(targetTool);\n      return;\n    }\n\n    if (this.doc.readonly) return;\n\n    return this.currentController.onContainerPointerDown(e);\n  };\n\n  private _onContainerPointerMove = (e: PointerEventState) => {\n    this._updateLastMousePos(e);\n    return this._controllers[this.edgelessTool.type].onContainerMouseMove(e);\n  };\n\n  private _onContainerPointerOut = (e: PointerEventState) => {\n    return this._controllers[this.edgelessTool.type].onContainerMouseOut(e);\n  };\n\n  private _onContainerPointerUp = (_ev: PointerEventState) => {};\n\n  private _onContainerTripleClick = (e: PointerEventState) => {\n    return this.currentController.onContainerTripleClick(e);\n  };\n\n  private _service!: EdgelessRootService;\n\n  // pressed shift key\n  private _shiftKey = false;\n\n  private _spaceBar = false;\n\n  protected readonly _disposables = new DisposableGroup();\n\n  setEdgelessTool = (\n    edgelessTool: EdgelessTool,\n    state: EdgelessSelectionState | SurfaceSelection[] = {\n      elements: [],\n      editing: false,\n    },\n    restoreToLastSelection = true\n  ) => {\n    const { type } = edgelessTool;\n    if (this.doc.readonly && type !== 'pan' && type !== 'frameNavigator') {\n      return;\n    }\n    if (this.edgelessTool === edgelessTool) return;\n\n    if (\n      this.currentController instanceof CopilotSelectionController &&\n      this.currentController.processing\n    ) {\n      return;\n    }\n\n    const lastType = this.edgelessTool.type;\n    this._controllers[lastType].beforeModeSwitch(edgelessTool);\n    this._controllers[type].beforeModeSwitch(edgelessTool);\n\n    const isEditing = !Array.isArray(state) && state.editing;\n\n    if (!isEditing) {\n      const isDefaultType = type === 'default';\n      const isLassoType = type === 'lasso';\n      const isLastTypeLasso = lastType === 'lasso';\n      const isCopilotType = type === 'copilot';\n      const isLastTypeCopilot = lastType === 'copilot';\n      const isLastTypeDefault = lastType === 'default';\n      const isEmptyState = Array.isArray(state)\n        ? this.selection.isEmpty(state)\n        : state.elements.length === 0;\n      const hasLastState = !!this.selection.lastSurfaceSelections;\n      const isNotSingleDocOnlyNote = !(\n        this.selection.lastSurfaceSelections &&\n        this.selection.lastSurfaceSelections[0] &&\n        this.selection.lastSurfaceSelections[0].elements.length === 1 &&\n        this._isDocOnlyNote(this.selection.lastSurfaceSelections[0].elements[0])\n      );\n\n      if (\n        (isDefaultType && isLastTypeDefault) ||\n        (isLassoType && isLastTypeDefault) ||\n        (isDefaultType && isLastTypeLasso) ||\n        (isLassoType && isLastTypeLasso) ||\n        (isCopilotType && isLastTypeDefault) ||\n        // (isDefaultType && isLastTypeCopilot) ||\n        (isCopilotType && isLastTypeCopilot)\n      ) {\n        // if state is provided, override the selection( if state is empty array, clear all selection )\n        if (!state) {\n          // selection should remain same when switching between default and lasso tool\n          state = this.selection.surfaceSelections;\n        }\n      } else if (\n        ((isDefaultType && !isLastTypeLasso) || isLassoType) &&\n        ((isDefaultType && !isLastTypeCopilot) || isCopilotType) &&\n        isEmptyState &&\n        hasLastState &&\n        isNotSingleDocOnlyNote &&\n        restoreToLastSelection\n      ) {\n        state = this.selection.lastSurfaceSelections; // for getting the selection back after going to another tools\n      }\n    }\n\n    this.selection.set(state);\n    this.edgelessTool = edgelessTool;\n    this.container.slots.edgelessToolUpdated.emit(edgelessTool);\n    this._controllers[lastType].afterModeSwitch(edgelessTool);\n    this._controllers[edgelessTool.type].afterModeSwitch(edgelessTool);\n  };\n\n  get container() {\n    return this._container;\n  }\n\n  get controllers() {\n    return this._controllers;\n  }\n\n  get currentController() {\n    return this._controllers[this.edgelessTool.type];\n  }\n\n  get dispatcher() {\n    return this.container.dispatcher;\n  }\n\n  get doc() {\n    return this.service.doc;\n  }\n\n  get dragging() {\n    return this._dragging;\n  }\n\n  get draggingArea() {\n    if (!this.currentController.draggingArea) return null;\n\n    const { start, end } = this.currentController.draggingArea;\n    const minX = Math.min(start.x, end.x);\n    const minY = Math.min(start.y, end.y);\n    const maxX = Math.max(start.x, end.x);\n    const maxY = Math.max(start.y, end.y);\n    return new DOMRect(minX, minY, maxX - minX, maxY - minY);\n  }\n\n  get edgelessTool() {\n    return this._edgelessTool;\n  }\n\n  set edgelessTool(mode: EdgelessTool) {\n    this._edgelessTool = mode;\n    // sync mouse mode\n    this._controllers[this._edgelessTool.type].tool = this._edgelessTool;\n  }\n\n  get lastMousePos() {\n    return this._lastMousePos;\n  }\n\n  get selection() {\n    return this.service.selection;\n  }\n\n  get service() {\n    return this._service;\n  }\n\n  set shiftKey(pressed: boolean) {\n    this._shiftKey = pressed;\n    this.currentController.onPressShiftKey(pressed);\n  }\n\n  get shiftKey() {\n    return this._shiftKey;\n  }\n\n  set spaceBar(pressed: boolean) {\n    this._spaceBar = pressed;\n    this.currentController.onPressSpaceBar(pressed);\n  }\n\n  get spaceBar() {\n    return this._spaceBar;\n  }\n\n  constructor(service: EdgelessRootService) {\n    this._service = service;\n  }\n\n  static create(\n    service: EdgelessRootService,\n    controllers: AbstractClassConstructor<EdgelessToolController>[]\n  ) {\n    const manager = new EdgelessToolsManager(service);\n\n    controllers.forEach(controller => {\n      manager.register(controller);\n    });\n\n    return manager;\n  }\n\n  private _getToolFromLocalStorage(): EdgelessTool {\n    const type = localStorage.defaultTool;\n    if (type === 'pan') return { type: 'pan', panning: false };\n    return { type: 'default' };\n  }\n\n  private _initMouseAndWheelEvents() {\n    this._add('dragStart', ctx => {\n      this._dragging = true;\n      const event = ctx.get('pointerState');\n      this._onContainerDragStart(event);\n    });\n    this._add('dragMove', ctx => {\n      const event = ctx.get('pointerState');\n      this._onContainerDragMove(event);\n    });\n    this._add('dragEnd', ctx => {\n      this._dragging = false;\n      const event = ctx.get('pointerState');\n      this._onContainerDragEnd(event);\n    });\n    this._add('click', ctx => {\n      const event = ctx.get('pointerState');\n      this._onContainerClick(event);\n    });\n    this._add('doubleClick', ctx => {\n      const event = ctx.get('pointerState');\n      this._onContainerDblClick(event);\n    });\n    this._add('tripleClick', ctx => {\n      const event = ctx.get('pointerState');\n      this._onContainerTripleClick(event);\n    });\n    this._add('pointerMove', ctx => {\n      const event = ctx.get('pointerState');\n      this._onContainerPointerMove(event);\n    });\n    this._add('pointerDown', ctx => {\n      const event = ctx.get('pointerState');\n      this._onContainerPointerDown(event);\n    });\n    this._add('pointerUp', ctx => {\n      const event = ctx.get('pointerState');\n      this._onContainerPointerUp(event);\n    });\n    this._add('pointerOut', ctx => {\n      const event = ctx.get('pointerState');\n      this._onContainerPointerOut(event);\n    });\n    this._add('contextMenu', ctx => {\n      const event = ctx.get('defaultState');\n      this._onContainerContextMenu(event);\n    });\n  }\n\n  private _isDocOnlyNote(selectedId: string) {\n    const selected = this.service.doc.getBlockById(selectedId);\n    if (!selected) return false;\n\n    return (\n      isNoteBlock(selected) && selected.displayMode === NoteDisplayMode.DocOnly\n    );\n  }\n\n  private _updateLastMousePos(e: PointerEventState) {\n    this._lastMousePos = {\n      x: e.x,\n      y: e.y,\n    };\n  }\n\n  clear() {}\n\n  dispose() {\n    this._disposables.dispose();\n  }\n\n  getHoverState(): EdgelessHoverState | null {\n    if (!this.currentController.enableHover) {\n      return null;\n    }\n    const { x, y } = this._lastMousePos;\n    const [modelX, modelY] = this.service.viewport.toModelCoord(x, y);\n    const hovered = this.service.gfx.getElementByPoint(modelX, modelY);\n\n    if (!hovered || this.selection?.editing) {\n      return null;\n    }\n\n    return {\n      rect: this.service.viewport.toViewBound(edgelessElementsBound([hovered])),\n      content: hovered,\n    };\n  }\n\n  mount(container: EdgelessRootBlockComponent) {\n    this._container = container;\n    this._mounted = true;\n\n    Object.values(this._controllers).forEach(controller => {\n      controller.mount(container);\n    });\n\n    this._initMouseAndWheelEvents();\n  }\n\n  register(Tool: EdgelessToolConstructor) {\n    const tool = new Tool(this.service);\n\n    this._controllers[tool.tool.type] = tool;\n\n    if (this._mounted) {\n      tool.mount(this.container);\n    }\n  }\n\n  switchToDefaultMode(state: EdgelessSelectionState) {\n    this.setEdgelessTool({ type: 'default' }, state);\n  }\n}\n"]}