{"version":3,"file":"edit-session.js","sourceRoot":"","sources":["../../../../src/root-block/edgeless/services/edit-session.ts"],"names":[],"mappings":"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","sourcesContent":["import type { BlockService } from '@lumensuite/block-std';\n\nimport { getShapeName, type ShapeProps } from '@lumensuite/affine-model';\nimport { ColorSchema, NodePropsSchema } from '@lumensuite/affine-shared/utils';\nimport {\n  type DeepPartial,\n  DisposableGroup,\n  Slot,\n} from '@lumensuite/global/utils';\nimport { computed, type Signal, signal } from '@lit-labs/preact-signals';\nimport clonedeep from 'lodash.clonedeep';\nimport isPlainObject from 'lodash.isplainobject';\nimport merge from 'lodash.merge';\nimport { z } from 'zod';\n\nconst LastPropsSchema = NodePropsSchema;\nexport type LastProps = z.infer<typeof NodePropsSchema>;\nexport type LastPropsKey = keyof LastProps;\n\nconst SESSION_PROP_KEY = 'lumensuite:prop:record';\n\nconst SessionPropsSchema = z.object({\n  viewport: z.union([\n    z.object({\n      centerX: z.number(),\n      centerY: z.number(),\n      zoom: z.number(),\n    }),\n    z.object({\n      xywh: z.string(),\n      padding: z\n        .tuple([z.number(), z.number(), z.number(), z.number()])\n        .optional(),\n    }),\n  ]),\n  templateCache: z.string(),\n  remoteColor: z.string(),\n  showBidirectional: z.boolean(),\n});\n\nconst LocalPropsSchema = z.object({\n  presentBlackBackground: z.boolean(),\n  presentFillScreen: z.boolean(),\n  presentHideToolbar: z.boolean(),\n\n  autoHideEmbedHTMLFullScreenToolbar: z.boolean(),\n});\n\ntype SessionProps = z.infer<typeof SessionPropsSchema>;\ntype LocalProps = z.infer<typeof LocalPropsSchema>;\ntype StorageProps = SessionProps & LocalProps;\ntype StoragePropsKey = keyof StorageProps;\n\nfunction isLocalProp(key: string): key is keyof LocalProps {\n  return key in LocalPropsSchema.shape;\n}\n\nfunction isSessionProp(key: string): key is keyof SessionProps {\n  return key in SessionPropsSchema.shape;\n}\n\nexport type SerializedViewport = z.infer<\n  typeof SessionPropsSchema.shape.viewport\n>;\n\nexport class EditPropsStore {\n  private _disposables = new DisposableGroup();\n\n  private innerProps$: Signal<DeepPartial<LastProps>> = signal({});\n\n  lastProps$: Signal<LastProps>;\n\n  slots = {\n    storageUpdated: new Slot<{\n      key: StoragePropsKey;\n      value: StorageProps[StoragePropsKey];\n    }>(),\n  };\n\n  constructor(private _service: BlockService) {\n    const initProps: LastProps = LastPropsSchema.parse(\n      Object.entries(LastPropsSchema.shape).reduce((value, [key, schema]) => {\n        return {\n          ...value,\n          [key]: schema.parse(undefined),\n        };\n      }, {})\n    );\n\n    const props = sessionStorage.getItem(SESSION_PROP_KEY);\n    if (props) {\n      const result = LastPropsSchema.safeParse(JSON.parse(props));\n      if (result.success) {\n        merge(clonedeep(initProps), result.data);\n      }\n    }\n\n    this.lastProps$ = computed(() => {\n      const editorSetting$ =\n        this._service.std.getConfig('affine:page')?.editorSetting;\n      return merge(\n        clonedeep(initProps),\n        editorSetting$?.value,\n        this.innerProps$.value\n      );\n    });\n  }\n\n  private _getStorage<T extends StoragePropsKey>(key: T) {\n    return isSessionProp(key) ? sessionStorage : localStorage;\n  }\n\n  private _getStorageKey<T extends StoragePropsKey>(key: T) {\n    const id = this._service.doc.id;\n    switch (key) {\n      case 'viewport':\n        return 'lumensuite:' + id + ':edgelessViewport';\n      case 'presentBlackBackground':\n        return 'lumensuite:presentation:blackBackground';\n      case 'presentFillScreen':\n        return 'lumensuite:presentation:fillScreen';\n      case 'presentHideToolbar':\n        return 'lumensuite:presentation:hideToolbar';\n      case 'templateCache':\n        return 'lumensuite:' + id + ':templateTool';\n      case 'remoteColor':\n        return 'lumensuite:remote-color';\n      case 'showBidirectional':\n        return 'lumensuite:' + id + ':showBidirectional';\n      case 'autoHideEmbedHTMLFullScreenToolbar':\n        return 'lumensuite:embedHTML:autoHideFullScreenToolbar';\n      default:\n        return key;\n    }\n  }\n\n  applyLastProps(key: LastPropsKey, props: Record<string, unknown>) {\n    const lastProps = this.lastProps$.value[key];\n    return merge(clonedeep(lastProps), props);\n  }\n\n  dispose() {\n    this._disposables.dispose();\n  }\n\n  getStorage<T extends StoragePropsKey>(key: T) {\n    try {\n      const storage = this._getStorage(key);\n      const value = storage.getItem(this._getStorageKey(key));\n      if (!value) return null;\n      if (isLocalProp(key)) {\n        return LocalPropsSchema.shape[key].parse(\n          JSON.parse(value)\n        ) as StorageProps[T];\n      } else if (isSessionProp(key)) {\n        return SessionPropsSchema.shape[key].parse(\n          JSON.parse(value)\n        ) as StorageProps[T];\n      } else {\n        return null;\n      }\n    } catch {\n      return null;\n    }\n  }\n\n  recordLastProps(key: LastPropsKey, props: Partial<LastProps[LastPropsKey]>) {\n    const overrideProps = extractProps(\n      props,\n      LastPropsSchema.shape[key]._def.innerType\n    );\n    if (Object.keys(overrideProps).length === 0) return;\n\n    const innerProps = this.innerProps$.value;\n    this.innerProps$.value = merge(clonedeep(innerProps), {\n      [key]: overrideProps,\n    });\n  }\n\n  setStorage<T extends StoragePropsKey>(key: T, value: StorageProps[T]) {\n    const oldValue = this.getStorage(key);\n    this._getStorage(key).setItem(\n      this._getStorageKey(key),\n      JSON.stringify(value)\n    );\n    if (oldValue === value) return;\n    this.slots.storageUpdated.emit({ key, value });\n  }\n}\n\nexport function getLastPropsKey(\n  modelType: LumenSuite.EdgelessModelKeys,\n  modelProps: Partial<LastProps[LastPropsKey]>\n): LastPropsKey | null {\n  if (modelType === 'shape') {\n    const { shapeType, radius } = modelProps as ShapeProps;\n    const shapeName = getShapeName(shapeType, radius);\n    return `${modelType}:${shapeName}`;\n  }\n\n  if (isLastPropsKey(modelType)) {\n    return modelType;\n  }\n\n  return null;\n}\n\nfunction extractProps(\n  props: Record<string, unknown>,\n  ref: z.ZodObject<z.ZodRawShape>\n): Record<string, unknown> {\n  const result: Record<string, unknown> = {};\n\n  Object.entries(props).forEach(([key, value]) => {\n    if (!(key in ref.shape)) return;\n    if (isPlainObject(value)) {\n      if (isColorType(key, value)) {\n        const color = processColorValue(value as z.infer<typeof ColorSchema>);\n        if (Object.keys(color).length === 0) return;\n        result[key] = color;\n        return;\n      }\n\n      result[key] = extractProps(\n        props[key] as Record<string, unknown>,\n        ref.shape[key] as z.ZodObject<z.ZodRawShape>\n      );\n    } else {\n      result[key] = value;\n    }\n  });\n\n  return result;\n}\n\nfunction isLastPropsKey(key: string): key is LastPropsKey {\n  return Object.keys(LastPropsSchema.shape).includes(key);\n}\n\nfunction isColorType(key: string, value: unknown) {\n  return (\n    ['background', 'color', 'stroke', 'fill', 'Color'].some(\n      stuff => key.startsWith(stuff) || key.endsWith(stuff)\n    ) && ColorSchema.safeParse(value).success\n  );\n}\n\n// Don't want the user to create a transparent element, so the alpha value is removed.\nfunction processColorValue(value: z.infer<typeof ColorSchema>) {\n  const obj: Record<string, string> = {};\n  for (const [k, v] of Object.entries(value)) {\n    obj[k] = v.startsWith('#') ? v.substring(0, 7) : v;\n  }\n  return obj;\n}\n"]}