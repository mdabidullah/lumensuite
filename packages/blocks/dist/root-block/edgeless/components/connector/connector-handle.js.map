{"version":3,"file":"connector-handle.js","sourceRoot":"","sources":["../../../../../src/root-block/edgeless/components/connector/connector-handle.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ConnectorElementModel } from '@lumensuite/affine-model';\n\nimport { WithDisposable } from '@lumensuite/block-std';\nimport { DisposableGroup, Vec } from '@lumensuite/global/utils';\nimport { css, html, LitElement } from 'lit';\nimport { customElement, property, query } from 'lit/decorators.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport type { EdgelessRootBlockComponent } from '../../edgeless-root-block.js';\n\nconst SIZE = 12;\nconst HALF_SIZE = SIZE / 2;\n\n@customElement('edgeless-connector-handle')\nexport class EdgelessConnectorHandle extends WithDisposable(LitElement) {\n  static override styles = css`\n    .line-controller {\n      position: absolute;\n      width: ${SIZE}px;\n      height: ${SIZE}px;\n      box-sizing: border-box;\n      border-radius: 50%;\n      border: 2px solid var(--affine-text-emphasis-color);\n      background-color: var(--affine-background-primary-color);\n      cursor: pointer;\n      z-index: 10;\n      pointer-events: all;\n      /**\n       * Fix: pointerEvent stops firing after a short time.\n       * When a gesture is started, the browser intersects the touch-action values of the touched element and its ancestors,\n       * up to the one that implements the gesture (in other words, the first containing scrolling element)\n       * https://developer.mozilla.org/en-US/docs/Web/CSS/touch-action\n       */\n      touch-action: none;\n    }\n    .line-controller-hidden {\n      display: none;\n    }\n  `;\n\n  private _lastZoom = 1;\n\n  private _bindEvent() {\n    const edgeless = this.edgeless;\n\n    this._disposables.addFromEvent(this._startHandler, 'pointerdown', e => {\n      edgeless.slots.elementResizeStart.emit();\n      this._capPointerDown(e, 'source');\n    });\n    this._disposables.addFromEvent(this._endHandler, 'pointerdown', e => {\n      edgeless.slots.elementResizeStart.emit();\n      this._capPointerDown(e, 'target');\n    });\n    this._disposables.add(() => {\n      edgeless.service.connectorOverlay.clear();\n    });\n  }\n\n  private _capPointerDown(e: PointerEvent, connection: 'target' | 'source') {\n    const { edgeless, connector, _disposables } = this;\n    const { service } = edgeless;\n    e.stopPropagation();\n    _disposables.addFromEvent(document, 'pointermove', e => {\n      const point = service.viewport.toModelCoordFromClientCoord([e.x, e.y]);\n      const isStartPointer = connection === 'source';\n      const otherSideId = connector[isStartPointer ? 'target' : 'source'].id;\n\n      connector[connection] = edgeless.service.connectorOverlay.renderConnector(\n        point,\n        otherSideId ? [otherSideId] : []\n      );\n      this.requestUpdate();\n    });\n\n    _disposables.addFromEvent(document, 'pointerup', () => {\n      edgeless.service.overlays.connector.clear();\n      edgeless.doc.captureSync();\n      _disposables.dispose();\n      this._disposables = new DisposableGroup();\n      this._bindEvent();\n      edgeless.slots.elementResizeEnd.emit();\n    });\n  }\n\n  override firstUpdated() {\n    const { edgeless } = this;\n    const { viewport } = edgeless.service;\n\n    this._lastZoom = viewport.zoom;\n    edgeless.service.viewport.viewportUpdated.on(() => {\n      if (viewport.zoom !== this._lastZoom) {\n        this._lastZoom = viewport.zoom;\n        this.requestUpdate();\n      }\n    });\n\n    this._bindEvent();\n  }\n\n  override render() {\n    const { service } = this.edgeless;\n    // path is relative to the element's xywh\n    const { path } = this.connector;\n    const zoom = service.viewport.zoom;\n    const startPoint = Vec.subScalar(Vec.mul(path[0], zoom), HALF_SIZE);\n    const endPoint = Vec.subScalar(\n      Vec.mul(path[path.length - 1], zoom),\n      HALF_SIZE\n    );\n    const startStyle = {\n      transform: `translate3d(${startPoint[0]}px,${startPoint[1]}px,0)`,\n    };\n    const endStyle = {\n      transform: `translate3d(${endPoint[0]}px,${endPoint[1]}px,0)`,\n    };\n    return html`\n      <div\n        class=\"line-controller line-start\"\n        style=${styleMap(startStyle)}\n      ></div>\n      <div class=\"line-controller line-end\" style=${styleMap(endStyle)}></div>\n    `;\n  }\n\n  @query('.line-end')\n  private accessor _endHandler!: HTMLDivElement;\n\n  @query('.line-start')\n  private accessor _startHandler!: HTMLDivElement;\n\n  @property({ attribute: false })\n  accessor connector!: ConnectorElementModel;\n\n  @property({ attribute: false })\n  accessor edgeless!: EdgelessRootBlockComponent;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'edgeless-connector-handle': EdgelessConnectorHandle;\n  }\n}\n"]}