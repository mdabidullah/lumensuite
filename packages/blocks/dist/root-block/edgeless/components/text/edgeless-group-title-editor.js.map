{"version":3,"file":"edgeless-group-title-editor.js","sourceRoot":"","sources":["../../../../../src/root-block/edgeless/components/text/edgeless-group-title-editor.ts"],"names":[],"mappings":"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","sourcesContent":["import type { RichText } from '@lumensuite/affine-components/rich-text';\nimport type { GroupElementModel } from '@lumensuite/affine-model';\n\nimport {\n  GROUP_TITLE_FONT_SIZE,\n  GROUP_TITLE_OFFSET,\n  GROUP_TITLE_PADDING,\n} from '@lumensuite/affine-block-surface';\nimport {\n  RANGE_SYNC_EXCLUDE_ATTR,\n  ShadowlessElement,\n  WithDisposable,\n} from '@lumensuite/block-std';\nimport { assertExists, Bound } from '@lumensuite/global/utils';\nimport { html, nothing } from 'lit';\nimport { customElement, property, query } from 'lit/decorators.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport type { EdgelessRootBlockComponent } from '../../edgeless-root-block.js';\n\n@customElement('edgeless-group-title-editor')\nexport class EdgelessGroupTitleEditor extends WithDisposable(\n  ShadowlessElement\n) {\n  get inlineEditor() {\n    assertExists(this.richText.inlineEditor);\n    return this.richText.inlineEditor;\n  }\n\n  get inlineEditorContainer() {\n    return this.inlineEditor.rootElement;\n  }\n\n  private _unmount() {\n    // dispose in advance to avoid execute `this.remove()` twice\n    this.disposables.dispose();\n    this.group.showTitle = true;\n    this.edgeless.service.selection.set({\n      elements: [this.group.id],\n      editing: false,\n    });\n    this.remove();\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    this.setAttribute(RANGE_SYNC_EXCLUDE_ATTR, 'true');\n  }\n\n  override firstUpdated(): void {\n    const dispatcher = this.edgeless.dispatcher;\n    assertExists(dispatcher);\n\n    this.updateComplete\n      .then(() => {\n        this.inlineEditor.selectAll();\n\n        this.group.showTitle = false;\n\n        this.inlineEditor.slots.renderComplete.on(() => {\n          this.requestUpdate();\n        });\n\n        this.disposables.add(\n          dispatcher.add('keyDown', ctx => {\n            const state = ctx.get('keyboardState');\n            if (state.raw.key === 'Enter' && !state.raw.isComposing) {\n              this._unmount();\n              return true;\n            }\n            requestAnimationFrame(() => {\n              this.requestUpdate();\n            });\n            return false;\n          })\n        );\n        this.disposables.add(\n          this.edgeless.service.viewport.viewportUpdated.on(() => {\n            this.requestUpdate();\n          })\n        );\n\n        this.disposables.add(dispatcher.add('click', () => true));\n        this.disposables.add(dispatcher.add('doubleClick', () => true));\n        this.disposables.addFromEvent(\n          this.inlineEditorContainer,\n          'blur',\n          () => {\n            this._unmount();\n          }\n        );\n      })\n      .catch(console.error);\n  }\n\n  override async getUpdateComplete(): Promise<boolean> {\n    const result = await super.getUpdateComplete();\n    await this.richText?.updateComplete;\n    return result;\n  }\n\n  override render() {\n    if (!this.group.externalXYWH) {\n      console.error('group.externalXYWH is not set');\n      return nothing;\n    }\n    const viewport = this.edgeless.service.viewport;\n    const bound = Bound.deserialize(this.group.externalXYWH);\n    const [x, y] = viewport.toViewCoord(bound.x, bound.y);\n\n    const inlineEditorStyle = styleMap({\n      transformOrigin: 'top left',\n      borderRadius: '2px',\n      width: 'fit-content',\n      maxHeight: '30px',\n      height: 'fit-content',\n      padding: `${GROUP_TITLE_PADDING[1]}px ${GROUP_TITLE_PADDING[0]}px`,\n      fontSize: GROUP_TITLE_FONT_SIZE + 'px',\n      position: 'absolute',\n      left: x + 'px',\n      top: `${y - GROUP_TITLE_OFFSET + 2}px`,\n      minWidth: '8px',\n      fontFamily: 'var(--affine-font-family)',\n      color: 'var(--affine-text-primary-color)',\n      background: 'var(--affine-white-10)',\n      outline: 'none',\n      zIndex: '1',\n      border: `1px solid\n        var(--affine-primary-color)`,\n      boxShadow: 'var(--affine-active-shadow)',\n    });\n    return html`<rich-text\n      .yText=${this.group.title}\n      .enableFormat=${false}\n      .enableAutoScrollHorizontally=${false}\n      style=${inlineEditorStyle}\n    ></rich-text>`;\n  }\n\n  @property({ attribute: false })\n  accessor edgeless!: EdgelessRootBlockComponent;\n\n  @property({ attribute: false })\n  accessor group!: GroupElementModel;\n\n  @query('rich-text')\n  accessor richText!: RichText;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'edgeless-group-title-editor': EdgelessGroupTitleEditor;\n  }\n}\n"]}