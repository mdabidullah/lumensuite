{"version":3,"file":"edgeless-frame-title-editor.js","sourceRoot":"","sources":["../../../../../src/root-block/edgeless/components/text/edgeless-frame-title-editor.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEA,OAAO,EAAE,eAAe,EAAE,MAAM,0BAA0B,CAAC;AAC3D,OAAO,EACL,uBAAuB,EACvB,iBAAiB,EACjB,cAAc,GACf,MAAM,uBAAuB,CAAC;AAC/B,OAAO,EAAE,YAAY,EAAE,KAAK,EAAE,MAAM,0BAA0B,CAAC;AAC/D,OAAO,EAAE,QAAQ,EAAE,MAAM,wBAAwB,CAAC;AAClD,OAAO,EAAE,GAAG,EAAE,IAAI,EAAE,MAAM,KAAK,CAAC;AAChC,OAAO,EAAE,aAAa,EAAE,QAAQ,EAAE,KAAK,EAAE,MAAM,mBAAmB,CAAC;AACnE,OAAO,EAAE,QAAQ,EAAE,MAAM,6BAA6B,CAAC;AAIvD,OAAO,EAEL,mBAAmB,GACpB,MAAM,kCAAkC,CAAC;IAG7B,wBAAwB;4BADpC,aAAa,CAAC,6BAA6B,CAAC;;;;sBACC,cAAc,CAC1D,iBAAiB,CAClB;;;;;;;;;;wCAFqC,SAAQ,WAE7C;;;;oCA+IE,QAAQ,CAAC,EAAE,SAAS,EAAE,KAAK,EAAE,CAAC;sCAG9B,QAAQ,CAAC,EAAE,SAAS,EAAE,KAAK,EAAE,CAAC;oCAG9B,KAAK,CAAC,WAAW,CAAC;YALnB,6KAAS,QAAQ,6BAAR,QAAQ,2FAA8B;YAG/C,mLAAS,UAAU,6BAAV,UAAU,+FAAmB;YAGtC,6KAAS,QAAQ,6BAAR,QAAQ,2FAAY;YAxJ/B,6KAyJC;;;;iBAtJiB,WAAM,GAAG,GAAG,CAAA;;;;;;;;;;;;;;;GAe3B,AAfqB,CAepB;QAEF,IAAI,UAAU;YACZ,OAAO,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC;QAC5B,CAAC;QAED,IAAI,UAAU;YACZ,MAAM,KAAK,GAAG,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,QAAQ,CACzC,IAAI,CAAC,UAAU,CAAC,EAAE,CACW,CAAC;YAChC,OAAO,KAAK,CAAC;QACf,CAAC;QAED,IAAI,YAAY;YACd,YAAY,CAAC,IAAI,CAAC,QAAQ,CAAC,YAAY,CAAC,CAAC;YACzC,OAAO,IAAI,CAAC,QAAQ,CAAC,YAAY,CAAC;QACpC,CAAC;QAED,IAAI,qBAAqB;YACvB,OAAO,IAAI,CAAC,YAAY,CAAC,WAAW,CAAC;QACvC,CAAC;QAEO,QAAQ;YACd,4DAA4D;YAC5D,IAAI,CAAC,WAAW,CAAC,OAAO,EAAE,CAAC;YAC3B,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,SAAS,CAAC,GAAG,CAAC;gBAClC,QAAQ,EAAE,EAAE;gBACZ,OAAO,EAAE,KAAK;aACf,CAAC,CAAC;YACH,IAAI,CAAC,MAAM,EAAE,CAAC;QAChB,CAAC;QAEQ,iBAAiB;YACxB,KAAK,CAAC,iBAAiB,EAAE,CAAC;YAC1B,IAAI,CAAC,YAAY,CAAC,uBAAuB,EAAE,MAAM,CAAC,CAAC;QACrD,CAAC;QAEQ,YAAY;YACnB,MAAM,UAAU,GAAG,IAAI,CAAC,QAAQ,CAAC,UAAU,CAAC;YAC5C,YAAY,CAAC,UAAU,CAAC,CAAC;YACzB,IAAI,CAAC,cAAc;iBAChB,IAAI,CAAC,GAAG,EAAE;gBACT,IAAI,CAAC,YAAY,CAAC,SAAS,EAAE,CAAC;gBAE9B,IAAI,CAAC,YAAY,CAAC,KAAK,CAAC,cAAc,CAAC,EAAE,CAAC,GAAG,EAAE;oBAC7C,IAAI,CAAC,aAAa,EAAE,CAAC;gBACvB,CAAC,CAAC,CAAC;gBAEH,IAAI,CAAC,WAAW,CAAC,GAAG,CAClB,UAAU,CAAC,GAAG,CAAC,SAAS,EAAE,GAAG,CAAC,EAAE;oBAC9B,MAAM,KAAK,GAAG,GAAG,CAAC,GAAG,CAAC,eAAe,CAAC,CAAC;oBACvC,IAAI,KAAK,CAAC,GAAG,CAAC,GAAG,KAAK,OAAO,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,WAAW,EAAE,CAAC;wBACxD,IAAI,CAAC,QAAQ,EAAE,CAAC;wBAChB,OAAO,IAAI,CAAC;oBACd,CAAC;oBACD,qBAAqB,CAAC,GAAG,EAAE;wBACzB,IAAI,CAAC,aAAa,EAAE,CAAC;oBACvB,CAAC,CAAC,CAAC;oBACH,OAAO,KAAK,CAAC;gBACf,CAAC,CAAC,CACH,CAAC;gBACF,IAAI,CAAC,WAAW,CAAC,GAAG,CAClB,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,QAAQ,CAAC,eAAe,CAAC,EAAE,CAAC,GAAG,EAAE;oBACrD,IAAI,CAAC,aAAa,EAAE,CAAC;gBACvB,CAAC,CAAC,CACH,CAAC;gBAEF,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,UAAU,CAAC,GAAG,CAAC,OAAO,EAAE,GAAG,EAAE,CAAC,IAAI,CAAC,CAAC,CAAC;gBAC1D,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,UAAU,CAAC,GAAG,CAAC,aAAa,EAAE,GAAG,EAAE,CAAC,IAAI,CAAC,CAAC,CAAC;gBAChE,IAAI,CAAC,WAAW,CAAC,YAAY,CAC3B,IAAI,CAAC,qBAAqB,EAC1B,MAAM,EACN,GAAG,EAAE;oBACH,IAAI,CAAC,QAAQ,EAAE,CAAC;gBAClB,CAAC,CACF,CAAC;YACJ,CAAC,CAAC;iBACD,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;QAC1B,CAAC;QAEQ,KAAK,CAAC,iBAAiB;YAC9B,MAAM,MAAM,GAAG,MAAM,KAAK,CAAC,iBAAiB,EAAE,CAAC;YAC/C,MAAM,IAAI,CAAC,QAAQ,EAAE,cAAc,CAAC;YACpC,OAAO,MAAM,CAAC;QAChB,CAAC;QAEQ,MAAM;YACb,MAAM,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,QAAQ,CAAC;YAChD,MAAM,KAAK,GAAG,KAAK,CAAC,WAAW,CAAC,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC;YACtD,MAAM,CAAC,CAAC,EAAE,CAAC,CAAC,GAAG,QAAQ,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC,CAAC,CAAC;YACtD,MAAM,OAAO,GAAG,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,CAChD,IAAI,CAAC,UAAU,CAAC,YAAY,EAC5B,IAAI,EACJ,IAAI,EACJ,KAAK,CAAC,EAAE,CAAC,KAAK,KAAK,IAAI,CAAC,UAAU,IAAI,KAAK,YAAY,eAAe,CACvE,CAAC;YAEF,MAAM,MAAM,GAAG,IAAI,CAAC,UAAU,EAAE,YAAY,EAAE,MAAM,IAAI;gBACtD,UAAU,EAAE,QAAQ,CAAC,iCAAiC,CAAC;gBACvD,IAAI,EAAE,kCAAkC;aACzC,CAAC;YAEF,MAAM,iBAAiB,GAAG,QAAQ,CAAC;gBACjC,QAAQ,EAAE,mBAAmB,CAAC,QAAQ,GAAG,IAAI;gBAC7C,QAAQ,EAAE,UAAU;gBACpB,IAAI,EAAE,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,IAAI;gBAClC,GAAG,EAAE,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,mBAAmB,CAAC,MAAM,GAAG,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,IAAI;gBACxE,QAAQ,EAAE,KAAK;gBACf,MAAM,EAAE,mBAAmB,CAAC,MAAM,GAAG,IAAI;gBACzC,UAAU,EAAE,MAAM,CAAC,UAAU;gBAC7B,KAAK,EAAE,MAAM,CAAC,IAAI;aACnB,CAAC,CAAC;YAEH,MAAM,aAAa,GAAG,QAAQ,CAAC;gBAC7B,MAAM,EAAE,aAAa;aACtB,CAAC,CAAC;YAEH,OAAO,IAAI,CAAA,yCAAyC,iBAAiB;;iBAExD,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,KAAK;wBACpB,KAAK;wCACW,KAAK;gBAC7B,aAAa;;WAElB,CAAC;QACV,CAAC;QAGD,qFAA+C;QAA/C,IAAS,QAAQ,8CAA8B;QAA/C,IAAS,QAAQ,oDAA8B;QAG/C,iJAAsC;QAAtC,IAAS,UAAU,gDAAmB;QAAtC,IAAS,UAAU,sDAAmB;QAGtC,+IAA6B;QAA7B,IAAS,QAAQ,8CAAY;QAA7B,IAAS,QAAQ,oDAAY;;;;;;YAxJlB,uDAAwB;;;;;SAAxB,wBAAwB","sourcesContent":["import type { RichText } from '@blocksuite/affine-components/rich-text';\n\nimport { FrameBlockModel } from '@blocksuite/affine-model';\nimport {\n  RANGE_SYNC_EXCLUDE_ATTR,\n  ShadowlessElement,\n  WithDisposable,\n} from '@blocksuite/block-std';\nimport { assertExists, Bound } from '@blocksuite/global/utils';\nimport { cssVarV2 } from '@toeverything/theme/v2';\nimport { css, html } from 'lit';\nimport { customElement, property, query } from 'lit/decorators.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport type { EdgelessRootBlockComponent } from '../../edgeless-root-block.js';\n\nimport {\n  type FrameBlockComponent,\n  frameTitleStyleVars,\n} from '../../../../frame-block/index.js';\n\n@customElement('edgeless-frame-title-editor')\nexport class EdgelessFrameTitleEditor extends WithDisposable(\n  ShadowlessElement\n) {\n  static override styles = css`\n    .frame-title-editor {\n      display: flex;\n      align-items: center;\n      transform-origin: top left;\n      border-radius: 4px;\n      width: fit-content;\n      padding: 0 4px;\n      outline: none;\n      z-index: 1;\n      border: 1px solid var(--affine-primary-color);\n      box-shadow: 0px 0px 0px 2px rgba(30, 150, 235, 0.3);\n      overflow: hidden;\n      font-family: var(--affine-font-family);\n    }\n  `;\n\n  get editorHost() {\n    return this.edgeless.host;\n  }\n\n  get frameBlock() {\n    const block = this.editorHost.view.getBlock(\n      this.frameModel.id\n    ) as FrameBlockComponent | null;\n    return block;\n  }\n\n  get inlineEditor() {\n    assertExists(this.richText.inlineEditor);\n    return this.richText.inlineEditor;\n  }\n\n  get inlineEditorContainer() {\n    return this.inlineEditor.rootElement;\n  }\n\n  private _unmount() {\n    // dispose in advance to avoid execute `this.remove()` twice\n    this.disposables.dispose();\n    this.edgeless.service.selection.set({\n      elements: [],\n      editing: false,\n    });\n    this.remove();\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    this.setAttribute(RANGE_SYNC_EXCLUDE_ATTR, 'true');\n  }\n\n  override firstUpdated(): void {\n    const dispatcher = this.edgeless.dispatcher;\n    assertExists(dispatcher);\n    this.updateComplete\n      .then(() => {\n        this.inlineEditor.selectAll();\n\n        this.inlineEditor.slots.renderComplete.on(() => {\n          this.requestUpdate();\n        });\n\n        this.disposables.add(\n          dispatcher.add('keyDown', ctx => {\n            const state = ctx.get('keyboardState');\n            if (state.raw.key === 'Enter' && !state.raw.isComposing) {\n              this._unmount();\n              return true;\n            }\n            requestAnimationFrame(() => {\n              this.requestUpdate();\n            });\n            return false;\n          })\n        );\n        this.disposables.add(\n          this.edgeless.service.viewport.viewportUpdated.on(() => {\n            this.requestUpdate();\n          })\n        );\n\n        this.disposables.add(dispatcher.add('click', () => true));\n        this.disposables.add(dispatcher.add('doubleClick', () => true));\n        this.disposables.addFromEvent(\n          this.inlineEditorContainer,\n          'blur',\n          () => {\n            this._unmount();\n          }\n        );\n      })\n      .catch(console.error);\n  }\n\n  override async getUpdateComplete(): Promise<boolean> {\n    const result = await super.getUpdateComplete();\n    await this.richText?.updateComplete;\n    return result;\n  }\n\n  override render() {\n    const viewport = this.edgeless.service.viewport;\n    const bound = Bound.deserialize(this.frameModel.xywh);\n    const [x, y] = viewport.toViewCoord(bound.x, bound.y);\n    const isInner = this.edgeless.service.gfx.grid.has(\n      this.frameModel.elementBound,\n      true,\n      true,\n      model => model !== this.frameModel && model instanceof FrameBlockModel\n    );\n\n    const colors = this.frameBlock?.titleElement?.colors ?? {\n      background: cssVarV2('edgeless/frame/background/white'),\n      text: 'var(--affine-text-primary-color)',\n    };\n\n    const inlineEditorStyle = styleMap({\n      fontSize: frameTitleStyleVars.fontSize + 'px',\n      position: 'absolute',\n      left: (isInner ? x + 4 : x) + 'px',\n      top: (isInner ? y + 4 : y - (frameTitleStyleVars.height + 8 / 2)) + 'px',\n      minWidth: '8px',\n      height: frameTitleStyleVars.height + 'px',\n      background: colors.background,\n      color: colors.text,\n    });\n\n    const richTextStyle = styleMap({\n      height: 'fit-content',\n    });\n\n    return html`<div class=\"frame-title-editor\" style=${inlineEditorStyle}>\n      <rich-text\n        .yText=${this.frameModel.title.yText}\n        .enableFormat=${false}\n        .enableAutoScrollHorizontally=${false}\n        style=${richTextStyle}\n      ></rich-text>\n    </div>`;\n  }\n\n  @property({ attribute: false })\n  accessor edgeless!: EdgelessRootBlockComponent;\n\n  @property({ attribute: false })\n  accessor frameModel!: FrameBlockModel;\n\n  @query('rich-text')\n  accessor richText!: RichText;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'edgeless-frame-title-editor': EdgelessFrameTitleEditor;\n  }\n}\n"]}