{"version":3,"file":"edgeless-connector-label-editor.js","sourceRoot":"","sources":["../../../../../src/root-block/edgeless/components/text/edgeless-connector-label-editor.ts"],"names":[],"mappings":"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","sourcesContent":["import type { RichText } from '@lumensuite/affine-components/rich-text';\nimport type { ConnectorElementModel } from '@lumensuite/affine-model';\n\nimport { TextUtils } from '@lumensuite/affine-block-surface';\nimport '@lumensuite/affine-components/rich-text';\nimport { ThemeObserver } from '@lumensuite/affine-shared/theme';\nimport { almostEqual } from '@lumensuite/affine-shared/utils';\nimport {\n  RANGE_SYNC_EXCLUDE_ATTR,\n  ShadowlessElement,\n  WithDisposable,\n} from '@lumensuite/block-std';\nimport { assertExists, Bound, Vec } from '@lumensuite/global/utils';\nimport { DocCollection } from '@lumensuite/store';\nimport { css, html, nothing } from 'lit';\nimport { customElement, property, query } from 'lit/decorators.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport type { EdgelessRootBlockComponent } from '../../edgeless-root-block.js';\n\nconst HORIZONTAL_PADDING = 2;\nconst VERTICAL_PADDING = 2;\nconst BORDER_WIDTH = 1;\n\n@customElement('edgeless-connector-label-editor')\nexport class EdgelessConnectorLabelEditor extends WithDisposable(\n  ShadowlessElement\n) {\n  static override styles = css`\n    .edgeless-connector-label-editor {\n      position: absolute;\n      left: 0;\n      top: 0;\n      transform-origin: center;\n      z-index: 10;\n      padding: ${VERTICAL_PADDING}px ${HORIZONTAL_PADDING}px;\n      border: ${BORDER_WIDTH}px solid var(--affine-primary-color, #1e96eb);\n      background: var(--affine-background-primary-color, #fff);\n      border-radius: 2px;\n      box-shadow: 0px 0px 0px 2px rgba(30, 150, 235, 0.3);\n      box-sizing: border-box;\n      overflow: visible;\n\n      .inline-editor {\n        white-space: pre-wrap !important;\n        outline: none;\n      }\n\n      .inline-editor span {\n        word-break: normal !important;\n        overflow-wrap: anywhere !important;\n      }\n\n      .edgeless-connector-label-editor-placeholder {\n        pointer-events: none;\n        color: var(--affine-text-disable-color);\n        white-space: nowrap;\n      }\n    }\n  `;\n\n  private _isComposition = false;\n\n  private _keeping = false;\n\n  private _resizeObserver: ResizeObserver | null = null;\n\n  private _updateLabelRect = () => {\n    const { connector, edgeless } = this;\n    if (!connector || !edgeless) return;\n\n    const newWidth = this.inlineEditorContainer.scrollWidth;\n    const newHeight = this.inlineEditorContainer.scrollHeight;\n    const center = connector.getPointByOffsetDistance(\n      connector.labelOffset.distance\n    );\n    const bounds = Bound.fromCenter(center, newWidth, newHeight);\n    const labelXYWH = bounds.toXYWH();\n\n    if (\n      !connector.labelXYWH ||\n      labelXYWH.some((p, i) => !almostEqual(p, connector.labelXYWH![i]))\n    ) {\n      edgeless.service.updateElement(connector.id, {\n        labelXYWH,\n      });\n    }\n  };\n\n  get inlineEditor() {\n    assertExists(this.richText.inlineEditor);\n    return this.richText.inlineEditor;\n  }\n\n  get inlineEditorContainer() {\n    return this.inlineEditor.rootElement;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    this.setAttribute(RANGE_SYNC_EXCLUDE_ATTR, 'true');\n  }\n\n  override disconnectedCallback() {\n    super.disconnectedCallback();\n    this._resizeObserver?.disconnect();\n    this._resizeObserver = null;\n  }\n\n  override firstUpdated() {\n    const { edgeless, connector } = this;\n    const { dispatcher } = edgeless;\n    assertExists(dispatcher);\n\n    this._resizeObserver = new ResizeObserver(() => {\n      this._updateLabelRect();\n      this.requestUpdate();\n    });\n    this._resizeObserver.observe(this.richText);\n\n    this.updateComplete\n      .then(() => {\n        this.inlineEditor.selectAll();\n\n        this.inlineEditor.slots.renderComplete.on(() => {\n          this.requestUpdate();\n        });\n\n        this.disposables.add(\n          dispatcher.add('keyDown', ctx => {\n            const state = ctx.get('keyboardState');\n            const { key, ctrlKey, metaKey, altKey, shiftKey, isComposing } =\n              state.raw;\n            const onlyCmd = (ctrlKey || metaKey) && !altKey && !shiftKey;\n            const isModEnter = onlyCmd && key === 'Enter';\n            const isEscape = key === 'Escape';\n            if (!isComposing && (isModEnter || isEscape)) {\n              this.inlineEditorContainer.blur();\n\n              edgeless.service.selection.set({\n                elements: [connector.id],\n                editing: false,\n              });\n              return true;\n            }\n            return false;\n          })\n        );\n\n        this.disposables.add(\n          edgeless.service.surface.elementUpdated.on(({ id }) => {\n            if (id === connector.id) this.requestUpdate();\n          })\n        );\n\n        this.disposables.add(\n          edgeless.service.viewport.viewportUpdated.on(() => {\n            this.requestUpdate();\n          })\n        );\n\n        this.disposables.add(dispatcher.add('click', () => true));\n        this.disposables.add(dispatcher.add('doubleClick', () => true));\n\n        this.disposables.add(() => {\n          if (connector.text) {\n            const text = connector.text.toString();\n            const trimed = text.trim();\n            const len = trimed.length;\n            if (len === 0) {\n              // reset\n              edgeless.service.updateElement(connector.id, {\n                text: undefined,\n                labelXYWH: undefined,\n                labelStyle: undefined,\n                labelOffset: undefined,\n              });\n            } else if (len < text.length) {\n              edgeless.service.updateElement(connector.id, {\n                // @TODO: trim in Y.Text?\n                text: new DocCollection.Y.Text(trimed),\n              });\n            }\n          }\n\n          connector.lableEditing = false;\n\n          edgeless.service.selection.set({\n            elements: [],\n            editing: false,\n          });\n        });\n\n        this.disposables.addFromEvent(\n          this.inlineEditorContainer,\n          'blur',\n          () => {\n            if (this._keeping) return;\n            this.remove();\n          }\n        );\n\n        this.disposables.addFromEvent(\n          this.inlineEditorContainer,\n          'compositionstart',\n          () => {\n            this._isComposition = true;\n            this.requestUpdate();\n          }\n        );\n        this.disposables.addFromEvent(\n          this.inlineEditorContainer,\n          'compositionend',\n          () => {\n            this._isComposition = false;\n            this.requestUpdate();\n          }\n        );\n\n        connector.lableEditing = true;\n      })\n      .catch(console.error);\n  }\n\n  override async getUpdateComplete(): Promise<boolean> {\n    const result = await super.getUpdateComplete();\n    await this.richText?.updateComplete;\n    return result;\n  }\n\n  override render() {\n    const { connector } = this;\n    const {\n      labelOffset: { distance },\n      labelStyle: {\n        fontFamily,\n        fontSize,\n        fontStyle,\n        fontWeight,\n        textAlign,\n        color: labelColor,\n      },\n      labelConstraints: { hasMaxWidth, maxWidth },\n    } = connector;\n\n    const lineHeight = TextUtils.getLineHeight(\n      fontFamily,\n      fontSize,\n      fontWeight\n    );\n    const { translateX, translateY, zoom } = this.edgeless.service.viewport;\n    const [x, y] = Vec.mul(connector.getPointByOffsetDistance(distance), zoom);\n    const transformOperation = [\n      'translate(-50%, -50%)',\n      `translate(${translateX}px, ${translateY}px)`,\n      `translate(${x}px, ${y}px)`,\n      `scale(${zoom})`,\n    ];\n\n    const isEmpty = !connector.text!.length && !this._isComposition;\n    const color = ThemeObserver.generateColorProperty(labelColor, '#000000');\n\n    return html`\n      <div\n        class=\"edgeless-connector-label-editor\"\n        style=${styleMap({\n          fontFamily: `\"${fontFamily}\"`,\n          fontSize: `${fontSize}px`,\n          fontStyle,\n          fontWeight,\n          textAlign,\n          lineHeight: `${lineHeight}px`,\n          maxWidth: hasMaxWidth\n            ? `${maxWidth + BORDER_WIDTH * 2 + HORIZONTAL_PADDING * 2}px`\n            : 'initial',\n          color,\n          transform: transformOperation.join(' '),\n        })}\n      >\n        <rich-text\n          .yText=${connector.text}\n          .enableFormat=${false}\n          style=${isEmpty\n            ? styleMap({\n                position: 'absolute',\n                left: 0,\n                top: 0,\n                padding: `${VERTICAL_PADDING}px ${HORIZONTAL_PADDING}px`,\n              })\n            : nothing}\n        ></rich-text>\n        ${isEmpty\n          ? html`\n              <span class=\"edgeless-connector-label-editor-placeholder\">\n                Add text\n              </span>\n            `\n          : nothing}\n      </div>\n    `;\n  }\n\n  setKeeping(keeping: boolean) {\n    this._keeping = keeping;\n  }\n\n  @property({ attribute: false })\n  accessor connector!: ConnectorElementModel;\n\n  @property({ attribute: false })\n  accessor edgeless!: EdgelessRootBlockComponent;\n\n  @query('rich-text')\n  accessor richText!: RichText;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'edgeless-connector-label-editor': EdgelessConnectorLabelEditor;\n  }\n}\n"]}