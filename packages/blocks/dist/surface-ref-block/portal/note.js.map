{"version":3,"file":"note.js","sourceRoot":"","sources":["../../../src/surface-ref-block/portal/note.ts"],"names":[],"mappings":"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","sourcesContent":["import type { CanvasRenderer } from '@lumensuite/affine-block-surface';\nimport type { NoteBlockModel } from '@lumensuite/affine-model';\n\nimport {\n  DEFAULT_NOTE_BACKGROUND_COLOR,\n  NoteDisplayMode,\n  NoteShadow,\n} from '@lumensuite/affine-model';\nimport { ThemeObserver } from '@lumensuite/affine-shared/theme';\nimport {\n  BlockStdScope,\n  type EditorHost,\n  RANGE_QUERY_EXCLUDE_ATTR,\n} from '@lumensuite/block-std';\nimport { ShadowlessElement, WithDisposable } from '@lumensuite/block-std';\nimport { deserializeXYWH } from '@lumensuite/global/utils';\nimport { type BlockModel, BlockViewType, type Query } from '@lumensuite/store';\nimport { css, nothing } from 'lit';\nimport { customElement, property } from 'lit/decorators.js';\nimport { styleMap } from 'lit/directives/style-map.js';\nimport { html } from 'lit/static-html.js';\n\nimport {\n  EDGELESS_BLOCK_CHILD_BORDER_WIDTH,\n  EDGELESS_BLOCK_CHILD_PADDING,\n} from '../../_common/consts.js';\nimport { SpecProvider } from '../../_specs/utils/spec-provider.js';\n\n@customElement('surface-ref-note-portal')\nexport class SurfaceRefNotePortal extends WithDisposable(ShadowlessElement) {\n  static override styles = css`\n    surface-ref-note-portal {\n      position: relative;\n    }\n  `;\n\n  ancestors = new Set<string>();\n\n  query: Query | null = null;\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    const ancestors = new Set<string>();\n    let parent: BlockModel | null = this.model;\n    while (parent) {\n      this.ancestors.add(parent.id);\n      parent = this.model.doc.getParent(parent.id);\n    }\n    const query: Query = {\n      mode: 'include',\n      match: Array.from(ancestors).map(id => ({\n        id,\n        viewType: BlockViewType.Display,\n      })),\n    };\n    this.query = query;\n\n    const doc = this.model.doc;\n    this._disposables.add(() => {\n      doc.blockCollection.clearQuery(query, true);\n    });\n  }\n\n  override firstUpdated() {\n    this.disposables.add(\n      this.model.propsUpdated.on(() => this.requestUpdate())\n    );\n  }\n\n  override render() {\n    const { model, index } = this;\n    const { displayMode, edgeless } = model;\n    if (!!displayMode && displayMode === NoteDisplayMode.DocOnly)\n      return nothing;\n\n    const backgroundColor = ThemeObserver.generateColorProperty(\n      model.background,\n      DEFAULT_NOTE_BACKGROUND_COLOR\n    );\n\n    const [modelX, modelY, modelW, modelH] = deserializeXYWH(model.xywh);\n    const style = {\n      zIndex: `${index}`,\n      width: modelW + 'px',\n      height:\n        edgeless.collapse && edgeless.collapsedHeight\n          ? edgeless.collapsedHeight + 'px'\n          : undefined,\n      transform: `translate(${modelX}px, ${modelY}px)`,\n      padding: `${EDGELESS_BLOCK_CHILD_PADDING}px`,\n      border: `${EDGELESS_BLOCK_CHILD_BORDER_WIDTH}px none var(--affine-black-10)`,\n      backgroundColor,\n      boxShadow: `var(${NoteShadow.Sticker})`,\n      position: 'absolute',\n      borderRadius: '0px',\n      boxSizing: 'border-box',\n      pointerEvents: 'none',\n      overflow: 'hidden',\n      transformOrigin: '0 0',\n      userSelect: 'none',\n    };\n\n    return html`\n      <div\n        class=\"surface-ref-note-portal\"\n        style=${styleMap(style)}\n        data-model-height=\"${modelH}\"\n        data-portal-reference-block-id=\"${model.id}\"\n      >\n        ${this.renderPreview()}\n      </div>\n    `;\n  }\n\n  renderPreview() {\n    if (!this.query) {\n      console.error('Query is not set before rendering note preview');\n      return nothing;\n    }\n    const doc = this.model.doc.blockCollection.getDoc({\n      query: this.query,\n      readonly: true,\n    });\n    const previewSpec = SpecProvider.getInstance().getSpec('page:preview');\n    return new BlockStdScope({\n      doc,\n      extensions: previewSpec.value.slice(),\n    }).render();\n  }\n\n  override updated() {\n    setTimeout(() => {\n      const editableElements = Array.from<HTMLDivElement>(\n        this.querySelectorAll('[contenteditable]')\n      );\n      const blocks = Array.from(this.querySelectorAll(`[data-block-id]`));\n\n      editableElements.forEach(element => {\n        if (element.contentEditable === 'true')\n          element.contentEditable = 'false';\n      });\n\n      blocks.forEach(element => {\n        element.setAttribute(RANGE_QUERY_EXCLUDE_ATTR, 'true');\n      });\n    }, 500);\n  }\n\n  @property({ attribute: false })\n  accessor host!: EditorHost;\n\n  @property({ attribute: false })\n  accessor index!: number;\n\n  @property({ attribute: false })\n  accessor model!: NoteBlockModel;\n\n  @property({ attribute: false })\n  accessor renderer!: CanvasRenderer;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'surface-ref-note-portal': SurfaceRefNotePortal;\n  }\n}\n"]}