{"version":3,"file":"file-drop-manager.js","sourceRoot":"","sources":["../../../src/_common/components/file-drop-manager.ts"],"names":[],"mappings":"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","sourcesContent":["import type { BlockService, EditorHost } from '@blocksuite/block-std';\nimport type { IVec } from '@blocksuite/global/utils';\nimport type { BlockModel } from '@blocksuite/store';\n\nimport {\n  getClosestBlockComponentByPoint,\n  isInsidePageEditor,\n  matchFlavours,\n} from '@blocksuite/affine-shared/utils';\nimport { assertExists, Point } from '@blocksuite/global/utils';\n\nimport type { DragIndicator } from './drag-indicator.js';\n\nimport { calcDropTarget, type DropResult } from '../../_common/utils/index.js';\n\nexport type onDropProps = {\n  files: File[];\n  targetModel: BlockModel | null;\n  place: 'before' | 'after';\n  point: IVec;\n};\n\nexport type FileDropOptions = {\n  flavour: string;\n  onDrop?: ({\n    files,\n    targetModel,\n    place,\n    point,\n  }: onDropProps) => Promise<boolean> | void;\n};\n\nexport class FileDropManager {\n  private static _dropResult: DropResult | null = null;\n\n  private _blockService: BlockService;\n\n  private _fileDropOptions: FileDropOptions;\n\n  private _indicator!: DragIndicator;\n\n  private _onDrop = (event: DragEvent) => {\n    this._indicator.rect = null;\n\n    const { onDrop } = this._fileDropOptions;\n    if (!onDrop) return;\n\n    const dataTransfer = event.dataTransfer;\n    if (!dataTransfer) return;\n\n    const effectAllowed = dataTransfer.effectAllowed;\n    if (effectAllowed === 'none') return;\n\n    const droppedFiles = dataTransfer.files;\n    if (!droppedFiles || !droppedFiles.length) return;\n\n    event.preventDefault();\n\n    const { targetModel, type: place } = this;\n    const { x, y } = event;\n\n    onDrop({\n      files: [...droppedFiles],\n      targetModel,\n      place,\n      point: [x, y],\n    })?.catch(console.error);\n  };\n\n  onDragLeave = () => {\n    FileDropManager._dropResult = null;\n    this._indicator.rect = null;\n  };\n\n  onDragOver = (event: DragEvent) => {\n    event.preventDefault();\n\n    const dataTransfer = event.dataTransfer;\n    if (!dataTransfer) return;\n\n    const effectAllowed = dataTransfer.effectAllowed;\n    if (effectAllowed === 'none') return;\n\n    const { clientX, clientY } = event;\n    const point = new Point(clientX, clientY);\n    const element = getClosestBlockComponentByPoint(point.clone());\n\n    let result: DropResult | null = null;\n    if (element) {\n      const model = element.model;\n      const parent = this.doc.getParent(model);\n      if (!matchFlavours(parent, ['affine:surface'])) {\n        result = calcDropTarget(point, model, element);\n      }\n    }\n    if (result) {\n      FileDropManager._dropResult = result;\n      this._indicator.rect = result.rect;\n    } else {\n      FileDropManager._dropResult = null;\n      this._indicator.rect = null;\n    }\n  };\n\n  get doc() {\n    return this._blockService.doc;\n  }\n\n  get editorHost(): EditorHost {\n    return this._blockService.std.host;\n  }\n\n  get targetModel(): BlockModel | null {\n    let targetModel = FileDropManager._dropResult?.modelState.model || null;\n\n    if (!targetModel && isInsidePageEditor(this.editorHost)) {\n      const rootModel = this.doc.root;\n      assertExists(rootModel);\n\n      let lastNote = rootModel.children[rootModel.children.length - 1];\n      if (!lastNote || !matchFlavours(lastNote, ['affine:note'])) {\n        const newNoteId = this.doc.addBlock('affine:note', {}, rootModel.id);\n        const newNote = this.doc.getBlockById(newNoteId);\n        assertExists(newNote);\n        lastNote = newNote;\n      }\n\n      const lastItem = lastNote.children[lastNote.children.length - 1];\n      if (lastItem) {\n        targetModel = lastItem;\n      } else {\n        const newParagraphId = this.doc.addBlock(\n          'affine:paragraph',\n          {},\n          lastNote,\n          0\n        );\n        const newParagraph = this.doc.getBlockById(newParagraphId);\n        assertExists(newParagraph);\n        targetModel = newParagraph;\n      }\n    }\n    return targetModel;\n  }\n\n  get type(): 'before' | 'after' {\n    return !FileDropManager._dropResult ||\n      FileDropManager._dropResult.type !== 'before'\n      ? 'after'\n      : 'before';\n  }\n\n  constructor(blockService: BlockService, fileDropOptions: FileDropOptions) {\n    this._blockService = blockService;\n    this._fileDropOptions = fileDropOptions;\n\n    this._indicator = document.querySelector(\n      'affine-drag-indicator'\n    ) as DragIndicator;\n    if (!this._indicator) {\n      this._indicator = document.createElement(\n        'affine-drag-indicator'\n      ) as DragIndicator;\n      document.body.append(this._indicator);\n    }\n\n    if (fileDropOptions.onDrop) {\n      this._blockService.disposables.addFromEvent(\n        this._blockService.std.host,\n        'drop',\n        this._onDrop\n      );\n    }\n  }\n}\n"]}