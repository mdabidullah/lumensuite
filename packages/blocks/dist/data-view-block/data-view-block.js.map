{"version":3,"file":"data-view-block.js","sourceRoot":"","sources":["../../src/data-view-block/data-view-block.ts"],"names":[],"mappings":"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","sourcesContent":["import { CaptionedBlockComponent } from '@lumensuite/affine-components/caption';\nimport { popMenu } from '@lumensuite/affine-components/context-menu';\nimport {\n  CopyIcon,\n  DeleteIcon,\n  MoreHorizontalIcon,\n} from '@lumensuite/affine-components/icons';\nimport { RANGE_SYNC_EXCLUDE_ATTR } from '@lumensuite/block-std';\nimport {\n  DatabaseSelection,\n  type DataSource,\n  DataView,\n  dataViewCommonStyle,\n  type DataViewProps,\n  type DataViewSelection,\n  type DataViewWidget,\n  type DataViewWidgetProps,\n  defineUniComponent,\n  renderUniLit,\n} from '@lumensuite/data-view';\nimport { widgetPresets } from '@lumensuite/data-view/widget-presets';\nimport { Slice } from '@lumensuite/store';\nimport { computed } from '@lit-labs/preact-signals';\nimport { css, nothing, unsafeCSS } from 'lit';\nimport { customElement } from 'lit/decorators.js';\nimport { html } from 'lit/static-html.js';\n\nimport type { NoteBlockComponent } from '../note-block/index.js';\nimport type { DataViewBlockModel } from './data-view-model.js';\n\nimport {\n  type AffineInnerModalWidget,\n  EdgelessRootBlockComponent,\n} from '../root-block/index.js';\nimport { AFFINE_INNER_MODAL_WIDGET } from '../root-block/widgets/inner-modal/inner-modal.js';\nimport { BlockQueryDataSource } from './data-source.js';\n\n@customElement('affine-data-view')\nexport class DataViewBlockComponent extends CaptionedBlockComponent<DataViewBlockModel> {\n  static override styles = css`\n    ${unsafeCSS(dataViewCommonStyle('affine-database'))}\n    affine-database {\n      display: block;\n      border-radius: 8px;\n      background-color: var(--affine-background-primary-color);\n      padding: 8px;\n      margin: 8px -8px -8px;\n    }\n\n    .database-block-selected {\n      background-color: var(--affine-hover-color);\n      border-radius: 4px;\n    }\n\n    .database-ops {\n      margin-top: 4px;\n      padding: 2px;\n      border-radius: 4px;\n      display: flex;\n      cursor: pointer;\n    }\n\n    .database-ops svg {\n      width: 16px;\n      height: 16px;\n      color: var(--affine-icon-color);\n    }\n\n    .database-ops:hover {\n      background-color: var(--affine-hover-color);\n    }\n\n    @media print {\n      .database-ops {\n        display: none;\n      }\n\n      .database-header-bar {\n        display: none !important;\n      }\n    }\n  `;\n\n  private _clickDatabaseOps = (e: MouseEvent) => {\n    popMenu(e.currentTarget as HTMLElement, {\n      options: {\n        input: {\n          initValue: this.model.title,\n          placeholder: 'Untitled',\n          onComplete: text => {\n            this.model.title = text;\n          },\n        },\n        items: [\n          {\n            type: 'action',\n            icon: CopyIcon,\n            name: 'Copy',\n            select: () => {\n              const slice = Slice.fromModels(this.doc, [this.model]);\n              this.std.clipboard.copySlice(slice).catch(console.error);\n            },\n          },\n          // {\n          //   type: 'action',\n          //   icon: DuplicateIcon,\n          //   name: 'Duplicate',\n          //   select: () => {\n          //   },\n          // },\n          {\n            type: 'group',\n            name: '',\n            children: () => [\n              {\n                type: 'action',\n                icon: DeleteIcon,\n                class: 'delete-item',\n                name: 'Delete Database',\n                select: () => {\n                  this.model.children.slice().forEach(block => {\n                    this.doc.deleteBlock(block);\n                  });\n                  this.doc.deleteBlock(this.model);\n                },\n              },\n            ],\n          },\n        ],\n      },\n    });\n  };\n\n  private _dataSource?: DataSource;\n\n  private dataView = new DataView();\n\n  _bindHotkey: DataViewProps['bindHotkey'] = hotkeys => {\n    return {\n      dispose: this.host.event.bindHotkey(hotkeys, {\n        blockId: this.topContenteditableElement?.blockId ?? this.blockId,\n      }),\n    };\n  };\n\n  _handleEvent: DataViewProps['handleEvent'] = (name, handler) => {\n    return {\n      dispose: this.host.event.add(name, handler, {\n        blockId: this.blockId,\n      }),\n    };\n  };\n\n  getRootService = () => {\n    return this.std.getService('affine:page');\n  };\n\n  headerWidget: DataViewWidget = defineUniComponent(\n    (props: DataViewWidgetProps) => {\n      return html`\n        <div style=\"margin-bottom: 16px;display:flex;flex-direction: column\">\n          <div style=\"display:flex;gap:8px;padding: 0 6px;margin-bottom: 8px;\">\n            <div>${this.model.title}</div>\n            ${this.renderDatabaseOps()}\n          </div>\n          <div\n            style=\"display:flex;align-items:center;justify-content: space-between;gap: 12px\"\n            class=\"database-header-bar\"\n          >\n            <div style=\"flex:1\">\n              ${renderUniLit(widgetPresets.viewBar, props)}\n            </div>\n            ${renderUniLit(this.toolsWidget, props)}\n          </div>\n          ${renderUniLit(widgetPresets.filterBar, props)}\n        </div>\n      `;\n    }\n  );\n\n  selection$ = computed(() => {\n    const databaseSelection = this.selection.value.find(\n      (selection): selection is DatabaseSelection => {\n        if (selection.blockId !== this.blockId) {\n          return false;\n        }\n        return selection instanceof DatabaseSelection;\n      }\n    );\n    return databaseSelection?.viewSelection;\n  });\n\n  setSelection = (selection: DataViewSelection | undefined) => {\n    this.selection.setGroup(\n      'note',\n      selection\n        ? [\n            new DatabaseSelection({\n              blockId: this.blockId,\n              viewSelection: selection,\n            }),\n          ]\n        : []\n    );\n  };\n\n  toolsWidget: DataViewWidget = widgetPresets.createTools({\n    table: [\n      widgetPresets.tools.filter,\n      widgetPresets.tools.search,\n      widgetPresets.tools.viewOptions,\n      widgetPresets.tools.tableAddRow,\n    ],\n    kanban: [\n      widgetPresets.tools.filter,\n      widgetPresets.tools.search,\n      widgetPresets.tools.viewOptions,\n    ],\n  });\n\n  get dataSource(): DataSource {\n    if (!this._dataSource) {\n      this._dataSource = new BlockQueryDataSource(this.host, this.model, {\n        type: 'todo',\n      });\n    }\n    return this._dataSource;\n  }\n\n  get innerModalWidget() {\n    return this.rootComponent?.widgetComponents[\n      AFFINE_INNER_MODAL_WIDGET\n    ] as AffineInnerModalWidget;\n  }\n\n  override get topContenteditableElement() {\n    if (this.rootComponent instanceof EdgelessRootBlockComponent) {\n      const note = this.closest<NoteBlockComponent>('affine-note');\n      return note;\n    }\n    return this.rootComponent;\n  }\n\n  get view() {\n    return this.dataView.expose;\n  }\n\n  private renderDatabaseOps() {\n    if (this.doc.readonly) {\n      return nothing;\n    }\n    return html` <div class=\"database-ops\" @click=\"${this._clickDatabaseOps}\">\n      ${MoreHorizontalIcon}\n    </div>`;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this.setAttribute(RANGE_SYNC_EXCLUDE_ATTR, 'true');\n  }\n\n  override renderBlock() {\n    const peekViewService = this.getRootService().peekViewService;\n    return html`\n      <div contenteditable=\"false\" style=\"position: relative\">\n        ${this.dataView.render({\n          bindHotkey: this._bindHotkey,\n          handleEvent: this._handleEvent,\n          selection$: this.selection$,\n          setSelection: this.setSelection,\n          dataSource: this.dataSource,\n          headerWidget: this.headerWidget,\n          std: this.std,\n          detailPanelConfig: {\n            openDetailPanel: peekViewService\n              ? (target, template) => peekViewService.peek(target, template)\n              : undefined,\n            target: () => this.innerModalWidget.target,\n          },\n        })}\n      </div>\n    `;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-data-view': DataViewBlockComponent;\n  }\n}\n"]}