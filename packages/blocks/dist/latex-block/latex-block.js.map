{"version":3,"file":"latex-block.js","sourceRoot":"","sources":["../../src/latex-block/latex-block.ts"],"names":[],"mappings":"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","sourcesContent":["import type { LatexBlockModel } from '@lumensuite/affine-model';\nimport type { Placement } from '@floating-ui/dom';\n\nimport { CaptionedBlockComponent } from '@lumensuite/affine-components/caption';\nimport { createLitPortal } from '@lumensuite/affine-components/portal';\nimport { effect } from '@lit-labs/preact-signals';\nimport katex from 'katex';\nimport { html, render } from 'lit';\nimport { customElement, query } from 'lit/decorators.js';\n\nimport type { LatexBlockService } from './latex-service.js';\n\nimport { latexBlockStyles } from './styles.js';\n\n@customElement('affine-latex')\nexport class LatexBlockComponent extends CaptionedBlockComponent<\n  LatexBlockModel,\n  LatexBlockService\n> {\n  static override styles = latexBlockStyles;\n\n  private _editorAbortController: AbortController | null = null;\n\n  get editorPlacement(): Placement {\n    return 'bottom';\n  }\n\n  get isBlockSelected() {\n    const blockSelection = this.selection.filter('block');\n    return blockSelection.some(\n      selection => selection.blockId === this.model.id\n    );\n  }\n\n  override firstUpdated(props: Map<string, unknown>) {\n    super.firstUpdated(props);\n\n    const { disposables } = this;\n\n    this._editorAbortController?.abort();\n    this._editorAbortController = new AbortController();\n    disposables.add(() => {\n      this._editorAbortController?.abort();\n    });\n\n    const katexContainer = this._katexContainer;\n    if (!katexContainer) return;\n\n    disposables.add(\n      effect(() => {\n        const latex = this.model.latex$.value;\n\n        katexContainer.replaceChildren();\n        // @ts-ignore\n        delete katexContainer['_$litPart$'];\n\n        if (latex.length === 0) {\n          render(\n            html`<span class=\"latex-block-empty-placeholder\">Equation</span>`,\n            katexContainer\n          );\n        } else {\n          try {\n            katex.render(latex, katexContainer, {\n              displayMode: true,\n              output: 'mathml',\n            });\n          } catch {\n            katexContainer.replaceChildren();\n            // @ts-ignore\n            delete katexContainer['_$litPart$'];\n            render(\n              html`<span class=\"latex-block-error-placeholder\"\n                >Error equation</span\n              >`,\n              katexContainer\n            );\n          }\n        }\n      })\n    );\n\n    this.disposables.addFromEvent(this, 'click', () => {\n      if (this.isBlockSelected) {\n        this.toggleEditor();\n      } else {\n        this.selectBlock();\n      }\n    });\n  }\n\n  removeEditor(portal: HTMLDivElement) {\n    portal.remove();\n  }\n\n  override renderBlock() {\n    return html`\n      <div contenteditable=\"false\" class=\"latex-block-container\">\n        <div class=\"katex\"></div>\n      </div>\n    `;\n  }\n\n  selectBlock() {\n    this.host.command.exec('selectBlock', {\n      focusBlock: this,\n    });\n  }\n\n  toggleEditor() {\n    const katexContainer = this._katexContainer;\n    if (!katexContainer) return;\n\n    this._editorAbortController?.abort();\n    this._editorAbortController = new AbortController();\n\n    this.selection.setGroup('note', [\n      this.selection.create('block', {\n        blockId: this.model.id,\n      }),\n    ]);\n\n    const portal = createLitPortal({\n      template: html`<latex-editor-menu\n        .std=${this.std}\n        .latexSignal=${this.model.latex$}\n        .abortController=${this._editorAbortController}\n      ></latex-editor-menu>`,\n      container: this.host,\n      computePosition: {\n        referenceElement: this,\n        placement: this.editorPlacement,\n        autoUpdate: {\n          animationFrame: true,\n        },\n      },\n      closeOnClickAway: true,\n      abortController: this._editorAbortController,\n      shadowDom: false,\n      portalStyles: {\n        zIndex: 'var(--affine-z-index-popover)',\n      },\n    });\n\n    this._editorAbortController.signal.addEventListener(\n      'abort',\n      () => {\n        this.removeEditor(portal);\n      },\n      { once: true }\n    );\n  }\n\n  @query('.latex-block-container')\n  private accessor _katexContainer!: HTMLDivElement;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-latex': LatexBlockComponent;\n  }\n}\n"]}