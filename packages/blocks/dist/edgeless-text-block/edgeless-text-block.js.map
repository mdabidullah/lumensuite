{"version":3,"file":"edgeless-text-block.js","sourceRoot":"","sources":["../../src/edgeless-text-block/edgeless-text-block.ts"],"names":[],"mappings":"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","sourcesContent":["import type { EdgelessTextBlockModel } from '@lumensuite/affine-model';\nimport type { BlockComponent } from '@lumensuite/block-std';\n\nimport { TextUtils } from '@lumensuite/affine-block-surface';\nimport { ThemeObserver } from '@lumensuite/affine-shared/theme';\nimport { matchFlavours } from '@lumensuite/affine-shared/utils';\nimport { GfxBlockComponent } from '@lumensuite/block-std';\nimport { Bound } from '@lumensuite/global/utils';\nimport { css, html } from 'lit';\nimport { customElement, query, state } from 'lit/decorators.js';\nimport { type StyleInfo, styleMap } from 'lit/directives/style-map.js';\n\nimport type {\n  EdgelessRootBlockComponent,\n  EdgelessRootService,\n} from '../root-block/index.js';\nimport type { EdgelessTextBlockService } from './edgeless-text-service.js';\n\nimport { HandleDirection } from '../root-block/edgeless/components/resize/resize-handles.js';\nimport {\n  DefaultModeDragType,\n  DefaultToolController,\n} from '../root-block/edgeless/tools/default-tool.js';\n\nexport const EDGELESS_TEXT_BLOCK_MIN_WIDTH = 50;\nexport const EDGELESS_TEXT_BLOCK_MIN_HEIGHT = 50;\n\n@customElement('affine-edgeless-text')\nexport class EdgelessTextBlockComponent extends GfxBlockComponent<\n  EdgelessTextBlockModel,\n  EdgelessTextBlockService\n> {\n  static override styles = css`\n    .edgeless-text-block-container[data-max-width='false'] .inline-editor span {\n      word-break: normal !important;\n      overflow-wrap: normal !important;\n    }\n  `;\n\n  private _horizontalResizing = false;\n\n  private _resizeObserver = new ResizeObserver(() => {\n    if (this.doc.readonly) {\n      return;\n    }\n\n    if (this._editing && !this.model.hasMaxWidth) {\n      this._updateW();\n    }\n\n    this._updateH();\n  });\n\n  get dragMoving() {\n    const controller = this.rootService.tool.currentController;\n    return (\n      controller instanceof DefaultToolController &&\n      controller.dragType === DefaultModeDragType.ContentMoving\n    );\n  }\n\n  override get parentComponent() {\n    return super.parentComponent as EdgelessRootBlockComponent;\n  }\n\n  get rootService() {\n    return this.std.getService('affine:page') as EdgelessRootService;\n  }\n\n  private _initDragEffect() {\n    const edgelessSelection = this.rootService.selection;\n    const selectedRect = this.parentComponent.selectedRect;\n    const disposables = this.disposables;\n\n    if (!edgelessSelection || !selectedRect) {\n      return;\n    }\n\n    disposables.add(\n      selectedRect.slots.dragStart\n        .filter(() => edgelessSelection.selectedElements.includes(this.model))\n        .on(() => {\n          if (\n            selectedRect.dragDirection === HandleDirection.Left ||\n            selectedRect.dragDirection === HandleDirection.Right\n          ) {\n            this._horizontalResizing = true;\n          }\n        })\n    );\n    disposables.add(\n      selectedRect.slots.dragEnd\n        .filter(() => edgelessSelection.selectedElements.includes(this.model))\n        .on(() => {\n          if (\n            selectedRect.dragDirection === HandleDirection.Left ||\n            selectedRect.dragDirection === HandleDirection.Right\n          ) {\n            this._horizontalResizing = false;\n          }\n        })\n    );\n  }\n\n  private _updateH() {\n    const bound = Bound.deserialize(this.model.xywh);\n    const rect = this._textContainer.getBoundingClientRect();\n    bound.h = Math.max(\n      rect.height / this.gfx.viewport.zoom,\n      EDGELESS_TEXT_BLOCK_MIN_HEIGHT * this.gfx.viewport.zoom\n    );\n\n    this.doc.updateBlock(this.model, {\n      xywh: bound.serialize(),\n    });\n  }\n\n  private _updateW() {\n    const bound = Bound.deserialize(this.model.xywh);\n    const rect = this._textContainer.getBoundingClientRect();\n    bound.w = Math.max(\n      rect.width / this.gfx.viewport.zoom,\n      EDGELESS_TEXT_BLOCK_MIN_WIDTH * this.gfx.viewport.zoom\n    );\n\n    this.doc.updateBlock(this.model, {\n      xywh: bound.serialize(),\n    });\n  }\n\n  checkWidthOverflow(width: number) {\n    let wValid = true;\n\n    const oldWidthStr = this._textContainer.style.width;\n    this._textContainer.style.width = `${width}px`;\n    if (\n      this.childrenContainer.scrollWidth > this.childrenContainer.offsetWidth\n    ) {\n      wValid = false;\n    }\n    this._textContainer.style.width = oldWidthStr;\n\n    return wValid;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this.disposables.add(\n      this.model.propsUpdated.on(({ key }) => {\n        this.updateComplete\n          .then(() => {\n            const command = this.host.command;\n            const blockSelections = this.model.children.map(child =>\n              this.host.selection.create('block', {\n                blockId: child.id,\n              })\n            );\n\n            if (key === 'fontStyle') {\n              command.exec('formatBlock', {\n                blockSelections,\n                styles: {\n                  italic: null,\n                },\n              });\n            } else if (key === 'color') {\n              command.exec('formatBlock', {\n                blockSelections,\n                styles: {\n                  color: null,\n                },\n              });\n            } else if (key === 'fontWeight') {\n              command.exec('formatBlock', {\n                blockSelections,\n                styles: {\n                  bold: null,\n                },\n              });\n            }\n          })\n          .catch(console.error);\n      })\n    );\n\n    this.style.transformOrigin = '0 0';\n  }\n\n  override firstUpdated(props: Map<string, unknown>) {\n    super.firstUpdated(props);\n\n    const { disposables, rootService } = this;\n    const edgelessSelection = rootService.selection;\n\n    this._initDragEffect();\n\n    disposables.add(\n      edgelessSelection.slots.updated.on(() => {\n        if (edgelessSelection.has(this.model.id) && edgelessSelection.editing) {\n          this._editing = true;\n        } else {\n          this._editing = false;\n        }\n      })\n    );\n\n    this._resizeObserver.observe(this._textContainer);\n\n    disposables.add(() => {\n      this._resizeObserver.disconnect();\n    });\n\n    disposables.addFromEvent(this._textContainer, 'click', e => {\n      if (!this._editing) return;\n\n      const containerRect = this._textContainer.getBoundingClientRect();\n      const isTop = e.clientY < containerRect.top + containerRect.height / 2;\n\n      let newParagraphId: string | null = null;\n      if (isTop) {\n        const firstChild = this.model.firstChild();\n        if (\n          !firstChild ||\n          !matchFlavours(firstChild, ['affine:list', 'affine:paragraph'])\n        ) {\n          newParagraphId = this.doc.addBlock(\n            'affine:paragraph',\n            {},\n            this.model.id,\n            0\n          );\n        }\n      } else {\n        const lastChild = this.model.lastChild();\n        if (\n          !lastChild ||\n          !matchFlavours(lastChild, ['affine:list', 'affine:paragraph'])\n        ) {\n          newParagraphId = this.doc.addBlock(\n            'affine:paragraph',\n            {},\n            this.model.id\n          );\n        }\n      }\n\n      if (newParagraphId) {\n        this.rootService.selectionManager.setGroup('note', [\n          this.rootService.selectionManager.create('text', {\n            from: {\n              blockId: newParagraphId,\n              index: 0,\n              length: 0,\n            },\n            to: null,\n          }),\n        ]);\n      }\n    });\n\n    disposables.addFromEvent(this._textContainer, 'focusout', () => {\n      if (!this._editing) return;\n\n      this.rootService.selectionManager.clear();\n    });\n  }\n\n  override getRenderingRect() {\n    const { xywh, scale, rotate, hasMaxWidth } = this.model;\n    const bound = Bound.deserialize(xywh);\n    const w =\n      hasMaxWidth || this._horizontalResizing || this.dragMoving\n        ? bound.w / scale\n        : undefined;\n\n    return {\n      x: bound.x,\n      y: bound.y,\n      w,\n      h: bound.h / scale,\n      rotate,\n      zIndex: this.toZIndex(),\n    };\n  }\n\n  override renderGfxBlock() {\n    const { model } = this;\n    const { scale, rotate, hasMaxWidth } = model;\n    const containerStyle: StyleInfo = {\n      transform: `rotate(${rotate}deg)`,\n      transformOrigin: 'center',\n      padding: '5px 10px',\n      border: `1px solid ${this._editing ? 'var(--affine—primary—color, #1e96eb)' : 'transparent'}`,\n      borderRadius: '4px',\n      boxSizing: 'border-box',\n      boxShadow: this._editing\n        ? '0px 0px 0px 2px rgba(30, 150, 235, 0.3)'\n        : 'none',\n      fontWeight: '400',\n      lineHeight: 'var(--affine-line-height)',\n    };\n\n    this.style.transform = `scale(${scale})`;\n\n    return html`\n      <div\n        class=\"edgeless-text-block-container\"\n        data-max-width=\"${hasMaxWidth}\"\n        style=${styleMap(containerStyle)}\n      >\n        <div\n          style=${styleMap({\n            pointerEvents: this._editing ? 'auto' : 'none',\n          })}\n        >\n          ${this.renderPageContent()}\n        </div>\n      </div>\n    `;\n  }\n\n  override renderPageContent() {\n    const { fontFamily, fontStyle, fontWeight, textAlign } = this.model;\n    const color = ThemeObserver.generateColorProperty(\n      this.model.color,\n      '#000000'\n    );\n\n    const style = styleMap({\n      color,\n      fontFamily: TextUtils.wrapFontFamily(fontFamily),\n      fontStyle,\n      fontWeight,\n      textAlign,\n    });\n\n    return html`\n      <div style=${style} class=\"affine-edgeless-text-block-container\">\n        <div class=\"affine-block-children-container\">\n          ${this.renderChildren(this.model)}\n        </div>\n      </div>\n    `;\n  }\n\n  tryFocusEnd() {\n    const paragraphOrLists = Array.from(\n      this.querySelectorAll<BlockComponent>('affine-paragraph, affine-list')\n    );\n    const last = paragraphOrLists.at(-1);\n    if (last) {\n      this.host.selection.setGroup('note', [\n        this.host.selection.create('text', {\n          from: {\n            blockId: last.blockId,\n            index: last.model.text?.length ?? 0,\n            length: 0,\n          },\n          to: null,\n        }),\n      ]);\n    }\n  }\n\n  @state()\n  private accessor _editing = false;\n\n  @query('.edgeless-text-block-container')\n  private accessor _textContainer!: HTMLDivElement;\n\n  @query('.affine-block-children-container')\n  accessor childrenContainer!: HTMLDivElement;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-edgeless-text': EdgelessTextBlockComponent;\n  }\n}\n"]}