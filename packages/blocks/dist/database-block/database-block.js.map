{"version":3,"file":"database-block.js","sourceRoot":"","sources":["../../src/database-block/database-block.ts"],"names":[],"mappings":"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","sourcesContent":["import type { DatabaseBlockModel } from '@lumensuite/affine-model';\n\nimport { CaptionedBlockComponent } from '@lumensuite/affine-components/caption';\nimport { popMenu } from '@lumensuite/affine-components/context-menu';\nimport { toast } from '@lumensuite/affine-components/toast';\nimport { DatabaseBlockSchema } from '@lumensuite/affine-model';\nimport { NOTE_SELECTOR } from '@lumensuite/affine-shared/consts';\nimport { RANGE_SYNC_EXCLUDE_ATTR } from '@lumensuite/block-std';\nimport {\n  DatabaseSelection,\n  DataView,\n  dataViewCommonStyle,\n  type DataViewExpose,\n  type DataViewProps,\n  type DataViewSelection,\n  type DataViewWidget,\n  type DataViewWidgetProps,\n  defineUniComponent,\n  renderUniLit,\n} from '@lumensuite/data-view';\nimport { widgetPresets } from '@lumensuite/data-view/widget-presets';\nimport { Rect } from '@lumensuite/global/utils';\nimport {\n  CopyIcon,\n  DeleteIcon,\n  MoreHorizontalIcon,\n} from '@blocksuite/icons/lit';\nimport { Slice } from '@lumensuite/store';\nimport { computed } from '@lit-labs/preact-signals';\nimport { css, html, nothing, unsafeCSS } from 'lit';\nimport { customElement } from 'lit/decorators.js';\n\nimport type { NoteBlockComponent } from '../note-block/index.js';\nimport type { AffineInnerModalWidget } from '../root-block/index.js';\nimport type { DatabaseOptionsConfig } from './config.js';\nimport type { DatabaseBlockService } from './database-service.js';\n\nimport { DragIndicator } from '../_common/components/index.js';\nimport {\n  AffineDragHandleWidget,\n  EdgelessRootBlockComponent,\n} from '../root-block/index.js';\nimport {\n  captureEventTarget,\n  getDropResult,\n} from '../root-block/widgets/drag-handle/utils.js';\nimport { AFFINE_INNER_MODAL_WIDGET } from '../root-block/widgets/inner-modal/inner-modal.js';\nimport './components/title/index.js';\nimport { DatabaseBlockDataSource } from './data-source.js';\n\n@customElement('affine-database')\nexport class DatabaseBlockComponent extends CaptionedBlockComponent<\n  DatabaseBlockModel,\n  DatabaseBlockService\n> {\n  static override styles = css`\n    ${unsafeCSS(dataViewCommonStyle('affine-database'))}\n    affine-database {\n      display: block;\n      border-radius: 8px;\n      background-color: var(--affine-background-primary-color);\n      padding: 8px;\n      margin: 8px -8px -8px;\n    }\n\n    .database-block-selected {\n      background-color: var(--affine-hover-color);\n      border-radius: 4px;\n    }\n\n    .database-ops {\n      margin-top: 4px;\n      padding: 2px;\n      border-radius: 4px;\n      display: flex;\n      cursor: pointer;\n    }\n\n    .database-ops svg {\n      width: 16px;\n      height: 16px;\n      color: var(--affine-icon-color);\n    }\n\n    .database-ops:hover {\n      background-color: var(--affine-hover-color);\n    }\n\n    @media print {\n      .database-ops {\n        display: none;\n      }\n\n      .database-header-bar {\n        display: none !important;\n      }\n    }\n  `;\n\n  private _clickDatabaseOps = (e: MouseEvent) => {\n    const options = this.optionsConfig.configure(this.model, {\n      input: {\n        initValue: this.model.title.toString(),\n        placeholder: 'Untitled',\n        onComplete: text => {\n          this.model.title.replace(0, this.model.title.length, text);\n        },\n      },\n      items: [\n        {\n          type: 'action',\n          icon: CopyIcon(),\n          name: 'Copy',\n          select: () => {\n            const slice = Slice.fromModels(this.doc, [this.model]);\n            this.std.clipboard\n              .copySlice(slice)\n              .then(() => {\n                toast(this.host, 'Copied to clipboard');\n              })\n              .catch(console.error);\n          },\n        },\n        {\n          type: 'group',\n          name: '',\n          children: () => [\n            {\n              type: 'action',\n              icon: DeleteIcon(),\n              class: 'delete-item',\n              name: 'Delete Database',\n              select: () => {\n                this.model.children.slice().forEach(block => {\n                  this.doc.deleteBlock(block);\n                });\n                this.doc.deleteBlock(this.model);\n              },\n            },\n          ],\n        },\n      ],\n    });\n\n    popMenu(e.currentTarget as HTMLElement, { options });\n  };\n\n  private _dataSource?: DatabaseBlockDataSource;\n\n  private dataView = new DataView();\n\n  private renderTitle = (dataViewMethod: DataViewExpose) => {\n    const addRow = () => dataViewMethod.addRow?.('start');\n    return html` <affine-database-title\n      style=\"overflow: hidden\"\n      .titleText=\"${this.model.title}\"\n      .readonly=\"${this.doc.readonly}\"\n      .onPressEnterKey=\"${addRow}\"\n    ></affine-database-title>`;\n  };\n\n  _bindHotkey: DataViewProps['bindHotkey'] = hotkeys => {\n    return {\n      dispose: this.host.event.bindHotkey(hotkeys, {\n        blockId: this.topContenteditableElement?.blockId ?? this.blockId,\n      }),\n    };\n  };\n\n  _handleEvent: DataViewProps['handleEvent'] = (name, handler) => {\n    return {\n      dispose: this.host.event.add(name, handler, {\n        blockId: this.blockId,\n      }),\n    };\n  };\n\n  getRootService = () => {\n    return this.std.getService('affine:page');\n  };\n\n  headerWidget: DataViewWidget = defineUniComponent(\n    (props: DataViewWidgetProps) => {\n      return html`\n        <div style=\"margin-bottom: 16px;display:flex;flex-direction: column\">\n          <div style=\"display:flex;gap:8px;padding: 0 6px;margin-bottom: 8px;\">\n            ${this.renderTitle(props.viewMethods)} ${this.renderDatabaseOps()}\n          </div>\n          <div\n            style=\"display:flex;align-items:center;justify-content: space-between;gap: 12px\"\n            class=\"database-header-bar\"\n          >\n            <div style=\"flex:1\">\n              ${renderUniLit(widgetPresets.viewBar, props)}\n            </div>\n            ${renderUniLit(this.toolsWidget, props)}\n          </div>\n          ${renderUniLit(widgetPresets.filterBar, props)}\n        </div>\n      `;\n    }\n  );\n\n  indicator = new DragIndicator();\n\n  onDrag = (evt: MouseEvent, id: string): (() => void) => {\n    const result = getDropResult(evt);\n    if (result && result.rect) {\n      document.body.append(this.indicator);\n      this.indicator.rect = Rect.fromLWTH(\n        result.rect.left,\n        result.rect.width,\n        result.rect.top,\n        result.rect.height\n      );\n      return () => {\n        this.indicator.remove();\n        const model = this.doc.getBlock(id)?.model;\n        const target = this.doc.getBlock(result.dropBlockId)?.model ?? null;\n        let parent = this.doc.getParent(result.dropBlockId);\n        const shouldInsertIn = result.dropType === 'in';\n        if (shouldInsertIn) {\n          parent = target;\n        }\n        if (model && target && parent) {\n          if (shouldInsertIn) {\n            this.doc.moveBlocks([model], parent);\n          } else {\n            this.doc.moveBlocks(\n              [model],\n              parent,\n              target,\n              result.dropType === 'before'\n            );\n          }\n        }\n      };\n    }\n    this.indicator.remove();\n    return () => {};\n  };\n\n  setSelection = (selection: DataViewSelection | undefined) => {\n    this.selection.setGroup(\n      'note',\n      selection\n        ? [\n            new DatabaseSelection({\n              blockId: this.blockId,\n              viewSelection: selection,\n            }),\n          ]\n        : []\n    );\n  };\n\n  toolsWidget: DataViewWidget = widgetPresets.createTools({\n    table: [\n      widgetPresets.tools.filter,\n      widgetPresets.tools.search,\n      widgetPresets.tools.viewOptions,\n      widgetPresets.tools.tableAddRow,\n    ],\n    kanban: [\n      widgetPresets.tools.filter,\n      widgetPresets.tools.search,\n      widgetPresets.tools.viewOptions,\n    ],\n  });\n\n  viewSelection$ = computed(() => {\n    const databaseSelection = this.selection.value.find(\n      (selection): selection is DatabaseSelection => {\n        if (selection.blockId !== this.blockId) {\n          return false;\n        }\n        return selection instanceof DatabaseSelection;\n      }\n    );\n    return databaseSelection?.viewSelection;\n  });\n\n  get dataSource(): DatabaseBlockDataSource {\n    if (!this._dataSource) {\n      this._dataSource = new DatabaseBlockDataSource(this.host, {\n        pageId: this.host.doc.id,\n        blockId: this.model.id,\n      });\n    }\n    return this._dataSource;\n  }\n\n  get innerModalWidget() {\n    return this.rootComponent!.widgetComponents[\n      AFFINE_INNER_MODAL_WIDGET\n    ] as AffineInnerModalWidget;\n  }\n\n  get optionsConfig(): DatabaseOptionsConfig {\n    return {\n      configure: (_model, options) => options,\n      ...this.std.getConfig('affine:page')?.databaseOptions,\n    };\n  }\n\n  override get topContenteditableElement() {\n    if (this.rootComponent instanceof EdgelessRootBlockComponent) {\n      const note = this.closest<NoteBlockComponent>(NOTE_SELECTOR);\n      return note;\n    }\n    return this.rootComponent;\n  }\n\n  get view() {\n    return this.dataView.expose;\n  }\n\n  private renderDatabaseOps() {\n    if (this.doc.readonly) {\n      return nothing;\n    }\n    return html` <div class=\"database-ops\" @click=\"${this._clickDatabaseOps}\">\n      ${MoreHorizontalIcon()}\n    </div>`;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this.setAttribute(RANGE_SYNC_EXCLUDE_ATTR, 'true');\n    let canDrop = false;\n    this.disposables.add(\n      AffineDragHandleWidget.registerOption({\n        flavour: DatabaseBlockSchema.model.flavour,\n        onDragMove: state => {\n          const target = captureEventTarget(state.raw.target);\n          const view = this.view;\n          if (view && target instanceof HTMLElement && this.contains(target)) {\n            canDrop = view.showIndicator?.(state.raw) ?? false;\n            return false;\n          }\n          if (canDrop) {\n            view?.hideIndicator?.();\n            canDrop = false;\n          }\n          return false;\n        },\n        onDragEnd: ({ state, draggingElements }) => {\n          const target = state.raw.target;\n          const view = this.view;\n          if (\n            canDrop &&\n            view &&\n            view.moveTo &&\n            target instanceof HTMLElement &&\n            this.parentElement?.contains(target)\n          ) {\n            const blocks = draggingElements.map(v => v.model);\n            this.doc.moveBlocks(blocks, this.model);\n            blocks.forEach(model => {\n              view.moveTo?.(model.id, state.raw);\n            });\n            view.hideIndicator?.();\n            return false;\n          }\n          if (canDrop) {\n            view?.hideIndicator?.();\n            canDrop = false;\n          }\n          return false;\n        },\n      })\n    );\n  }\n\n  override renderBlock() {\n    const peekViewService = this.getRootService().peekViewService;\n    return html`\n      <div\n        contenteditable=\"false\"\n        style=\"position: relative;background-color: var(--affine-background-primary-color);border-radius: 4px\"\n      >\n        ${this.dataView.render({\n          bindHotkey: this._bindHotkey,\n          handleEvent: this._handleEvent,\n          selection$: this.viewSelection$,\n          setSelection: this.setSelection,\n          dataSource: this.dataSource,\n          headerWidget: this.headerWidget,\n          onDrag: this.onDrag,\n          std: this.std,\n          detailPanelConfig: {\n            openDetailPanel: peekViewService\n              ? (target, template) => peekViewService.peek(target, template)\n              : undefined,\n            target: () => this.innerModalWidget.target,\n          },\n        })}\n      </div>\n    `;\n  }\n\n  override accessor useZeroWidth = true;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'affine-database': DatabaseBlockComponent;\n  }\n}\n"]}