{"version":3,"file":"lumen-container.js","sourceRoot":"","sources":["../../src/editors/lumen-container.ts"],"names":[],"mappings":"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","sourcesContent":["import type { BlockModel, Doc } from '@lumensuite/store';\n\nimport {\n  BlockStdScope,\n  EditorHost,\n  type ExtensionType,\n  ShadowlessElement,\n  SignalWatcher,\n  WithDisposable,\n} from '@lumensuite/block-std';\nimport {\n  type AbstractEditor,\n  type DocMode,\n  DocModeProvider,\n  EdgelessEditorBlockSpecs,\n  type EdgelessRootBlockComponent,\n  PageEditorBlockSpecs,\n  type PageRootBlockComponent,\n} from '@lumensuite/blocks';\nimport { noop, Slot } from '@lumensuite/global/utils';\nimport { computed, effect, signal } from '@lit-labs/preact-signals';\nimport { css, html } from 'lit';\nimport { customElement, property, query } from 'lit/decorators.js';\nimport { keyed } from 'lit/directives/keyed.js';\nimport { when } from 'lit/directives/when.js';\n\nimport '../fragments/doc-title/doc-title.js';\n\nnoop(EditorHost);\n\n/**\n * @deprecated need to refactor\n */\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction forwardSlot<T extends Record<string, Slot<any>>>(\n  from: T,\n  to: Partial<T>\n) {\n  Object.entries(from).forEach(([key, slot]) => {\n    const target = to[key];\n    if (target) {\n      slot.pipe(target);\n    }\n  });\n}\n\n@customElement('lumen-editor-container')\nexport class LumenEditorContainer\n  extends SignalWatcher(WithDisposable(ShadowlessElement))\n  implements AbstractEditor\n{\n  static override styles = css`\n    .affine-page-viewport {\n      position: relative;\n      display: flex;\n      flex-direction: column;\n      overflow-x: hidden;\n      overflow-y: auto;\n      container-name: viewport;\n      container-type: inline-size;\n      font-family: var(--affine-font-family);\n    }\n    .affine-page-viewport * {\n      box-sizing: border-box;\n    }\n\n    @media print {\n      .affine-page-viewport {\n        height: auto;\n      }\n    }\n\n    .playground-page-editor-container {\n      flex-grow: 1;\n      font-family: var(--affine-font-family);\n      display: block;\n    }\n\n    .playground-page-editor-container * {\n      box-sizing: border-box;\n    }\n\n    @media print {\n      .playground-page-editor-container {\n        height: auto;\n      }\n    }\n\n    .edgeless-editor-container {\n      font-family: var(--affine-font-family);\n      background: var(--affine-background-primary-color);\n      display: block;\n      height: 100%;\n      position: relative;\n      overflow: clip;\n    }\n\n    .edgeless-editor-container * {\n      box-sizing: border-box;\n    }\n\n    @media print {\n      .edgeless-editor-container {\n        height: auto;\n      }\n    }\n\n    .affine-edgeless-viewport {\n      display: block;\n      height: 100%;\n      position: relative;\n      overflow: clip;\n      container-name: viewport;\n      container-type: inline-size;\n    }\n  `;\n\n  private _doc = signal<Doc>();\n\n  private _edgelessSpecs = signal<ExtensionType[]>(EdgelessEditorBlockSpecs);\n\n  private _editorTemplate = computed(() => {\n    return this._std.value.render();\n  });\n\n  private _forwardRef = (mode: DocMode) => {\n    requestAnimationFrame(() => {\n      if (mode === 'page') {\n        if (this._pageRoot) forwardSlot(this._pageRoot.slots, this.slots);\n      } else {\n        if (this._edgelessRoot)\n          forwardSlot(this._edgelessRoot.slots, this.slots);\n      }\n    });\n  };\n\n  private _mode = signal<DocMode>('page');\n\n  private _pageSpecs = signal<ExtensionType[]>(PageEditorBlockSpecs);\n\n  private _specs = computed(() =>\n    this._mode.value === 'page'\n      ? this._pageSpecs.value\n      : this._edgelessSpecs.value\n  );\n\n  private _std = computed(() => {\n    return new BlockStdScope({\n      doc: this.doc,\n      extensions: this._specs.value,\n    });\n  });\n\n  /**\n   * @deprecated need to refactor\n   */\n  slots: AbstractEditor['slots'] = {\n    docLinkClicked: new Slot(),\n    editorModeSwitched: new Slot(),\n    docUpdated: new Slot(),\n    tagClicked: new Slot<{ tagId: string }>(),\n  };\n\n  get doc() {\n    return this._doc.value as Doc;\n  }\n\n  set doc(doc: Doc) {\n    this._doc.value = doc;\n  }\n\n  set edgelessSpecs(specs: ExtensionType[]) {\n    this._edgelessSpecs.value = specs;\n  }\n\n  get edgelessSpecs() {\n    return this._edgelessSpecs.value;\n  }\n\n  get host() {\n    try {\n      return this.std.host;\n    } catch {\n      return null;\n    }\n  }\n\n  get mode() {\n    return this._mode.value;\n  }\n\n  set mode(mode: DocMode) {\n    this._mode.value = mode;\n  }\n\n  set pageSpecs(specs: ExtensionType[]) {\n    this._pageSpecs.value = specs;\n  }\n\n  get pageSpecs() {\n    return this._pageSpecs.value;\n  }\n\n  get rootModel() {\n    return this.doc.root as BlockModel;\n  }\n\n  get std() {\n    return this._std.value;\n  }\n\n  /**\n   * @deprecated need to refactor\n   */\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this._disposables.add(\n      this.doc.slots.rootAdded.on(() => this.requestUpdate())\n    );\n  }\n\n  override firstUpdated() {\n    if (this.mode === 'page') {\n      setTimeout(() => {\n        if (this.autofocus) {\n          const richText = this.querySelector('rich-text');\n          const inlineEditor = richText?.inlineEditor;\n          inlineEditor?.focusEnd();\n        }\n      });\n    }\n\n    this._disposables.add(\n      effect(() => {\n        const std = this._std.value;\n        const mode = std.get(DocModeProvider).getPrimaryMode(this.doc.id);\n        this._forwardRef(mode);\n      })\n    );\n  }\n\n  override render() {\n    const mode = this._mode.value;\n\n    return html`${keyed(\n      this.rootModel.id + mode,\n      html`\n        <div\n          class=${mode === 'page'\n            ? 'affine-page-viewport'\n            : 'affine-edgeless-viewport'}\n        >\n          ${when(\n            mode === 'page',\n            () => html` <doc-title .doc=${this.doc}></doc-title> `\n          )}\n          <div\n            class=${mode === 'page'\n              ? 'page-editor playground-page-editor-container'\n              : 'edgeless-editor-container'}\n          >\n            ${this._editorTemplate.value}\n          </div>\n        </div>\n      `\n    )}`;\n  }\n\n  switchEditor(mode: DocMode) {\n    this._mode.value = mode;\n  }\n\n  /**\n   * @deprecated need to refactor\n   */\n  override updated(changedProperties: Map<string, unknown>) {\n    if (changedProperties.has('doc')) {\n      this.slots.docUpdated.emit({ newDocId: this.doc.id });\n      this._forwardRef(this.mode);\n    }\n\n    if (!changedProperties.has('doc') && !changedProperties.has('mode')) {\n      return;\n    }\n  }\n\n  /** @deprecated unreliable since edgelessSpecs can be overridden */\n  @query('affine-edgeless-root')\n  private accessor _edgelessRoot: EdgelessRootBlockComponent | null = null;\n\n  /** @deprecated unreliable since pageSpecs can be overridden */\n  @query('affine-page-root')\n  private accessor _pageRoot: PageRootBlockComponent | null = null;\n\n  @property({ attribute: false })\n  override accessor autofocus = false;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'lumen-editor-container': LumenEditorContainer;\n  }\n}\n"]}