{"version":3,"file":"frame.spec.js","sourceRoot":"","sources":["../../../src/__tests__/edgeless/frame.spec.ts"],"names":[],"mappings":"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","sourcesContent":["import type {\n  EdgelessRootBlockComponent,\n  FrameBlockComponent,\n} from '@lumensuite/blocks';\n\nimport { assertType } from '@lumensuite/global/utils';\nimport { Text } from '@lumensuite/store';\nimport { beforeEach, describe, expect, test } from 'vitest';\n\nimport { wait } from '../utils/common.js';\nimport { addNote, getDocRootBlock } from '../utils/edgeless.js';\nimport { setupEditor } from '../utils/setup.js';\n\ndescribe('frame', () => {\n  let service!: EdgelessRootBlockComponent['service'];\n\n  beforeEach(async () => {\n    const cleanup = await setupEditor('edgeless');\n    service = getDocRootBlock(window.doc, window.editor, 'edgeless').service;\n\n    return cleanup;\n  });\n\n  test('frame should have title', async () => {\n    const frame = service.doc.addBlock(\n      'affine:frame',\n      {\n        xywh: '[0,0,300,300]',\n        title: new Text('Frame 1'),\n      },\n      service.surface.id\n    );\n    await wait();\n\n    const titleDom = document.querySelector(\n      `affine-frame[data-block-id=\"${frame}\"] .affine-frame-title`\n    );\n    const rect = titleDom?.getBoundingClientRect();\n\n    expect(titleDom).not.toBeNull();\n    expect(rect).not.toBeNull();\n    expect(rect!.width).toBeGreaterThan(0);\n    expect(rect!.height).toBeGreaterThan(0);\n\n    const [titleX, titleY] = service.viewport.toModelCoord(rect!.x, rect!.y);\n    expect(titleX).toBeCloseTo(0);\n    expect(titleY).toBeLessThan(0);\n\n    const nestedFrame = service.doc.addBlock(\n      'affine:frame',\n      {\n        xywh: '[20,20,200,200]',\n        title: new Text('Frame 2'),\n      },\n      service.surface.id\n    );\n    await wait();\n    const nestedTitle = document.querySelector(\n      `affine-frame[data-block-id=\"${nestedFrame}\"] .affine-frame-title`\n    );\n    const nestedTitleRect = nestedTitle!.getBoundingClientRect()!;\n    const [nestedTitleX, nestedTitleY] = service.viewport.toModelCoord(\n      nestedTitleRect.x,\n      nestedTitleRect.y\n    );\n\n    expect(nestedTitleX).toBeGreaterThan(20);\n    expect(nestedTitleY).toBeGreaterThan(20);\n  });\n\n  test('frame should always be placed under the bottom of other blocks', async () => {\n    addNote(doc, {\n      xywh: '[0,0,300,300]',\n      index: service.layer.generateIndex('affine:note'),\n    });\n    addNote(doc, {\n      xywh: '[100,100,300,300]',\n      index: service.layer.generateIndex('affine:note'),\n    });\n    const frameId = service.doc.addBlock(\n      'affine:frame',\n      {\n        xywh: '[0,60,300,240]',\n        title: new Text('Frame 1'),\n      },\n      service.surface.id\n    );\n    service.zoomToFit();\n    await wait(500); // fit has a transition animation\n\n    const frameTitle = document.querySelector(\n      `[data-block-id=\"${frameId}\"] .affine-frame-title`\n    )!;\n    const titleRect = frameTitle.getBoundingClientRect();\n    const frameBody = document.querySelector(\n      `[data-block-id=\"${frameId}\"] .affine-frame-container`\n    )!;\n    const bodyRect = frameBody.getBoundingClientRect();\n\n    const pointDom1 = document.elementFromPoint(\n      titleRect.x + titleRect.width / 2,\n      titleRect.y + titleRect.height / 2\n    );\n    const pointDom2 = document.elementFromPoint(\n      bodyRect.x + bodyRect.width / 2,\n      bodyRect.y + bodyRect.height / 2\n    );\n\n    expect(\n      frameTitle.contains(pointDom1),\n      'Frame title should be on top'\n    ).toBeTruthy();\n\n    expect(\n      frameBody.contains(pointDom2),\n      'Frame body should be on bottom'\n    ).toBeFalsy();\n  });\n\n  test('frame should have externalXYWH after moving viewport to contains frame', async () => {\n    const frameId = service.doc.addBlock(\n      'affine:frame',\n      {\n        xywh: '[1800,1800,200,200]',\n        title: new Text('Frame 1'),\n      },\n      service.surface.id\n    );\n    await wait();\n\n    const frame = service.doc.getBlock(frameId);\n    expect(frame).toBeTruthy();\n\n    assertType<FrameBlockComponent>(frame);\n\n    service.viewport.setCenter(900, 900);\n    expect(frame?.model.externalXYWH).toBeDefined();\n  });\n});\n"]}