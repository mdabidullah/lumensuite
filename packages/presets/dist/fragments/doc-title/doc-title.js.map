{"version":3,"file":"doc-title.js","sourceRoot":"","sources":["../../../src/fragments/doc-title/doc-title.ts"],"names":[],"mappings":"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","sourcesContent":["import type { EditorHost } from '@blocksuite/block-std';\nimport type { RichText, RootBlockModel } from '@blocksuite/blocks';\nimport type { Doc } from '@blocksuite/store';\n\nimport { ShadowlessElement, WithDisposable } from '@blocksuite/block-std';\nimport { assertExists } from '@blocksuite/global/utils';\nimport { css, html } from 'lit';\nimport { customElement, property, query, state } from 'lit/decorators.js';\n\nconst DOC_BLOCK_CHILD_PADDING = 24;\n\n@customElement('doc-title')\nexport class DocTitle extends WithDisposable(ShadowlessElement) {\n  static override styles = css`\n    .doc-title-container {\n      box-sizing: border-box;\n      font-family: var(--affine-font-family);\n      font-size: var(--affine-font-base);\n      line-height: var(--affine-line-height);\n      color: var(--affine-text-primary-color);\n      font-size: 40px;\n      line-height: 50px;\n      font-weight: 700;\n      outline: none;\n      resize: none;\n      border: 0;\n      width: 100%;\n      max-width: var(--affine-editor-width);\n      margin-left: auto;\n      margin-right: auto;\n      padding: 38px 0;\n\n      padding-left: var(\n        --affine-editor-side-padding,\n        ${DOC_BLOCK_CHILD_PADDING}px\n      );\n      padding-right: var(\n        --affine-editor-side-padding,\n        ${DOC_BLOCK_CHILD_PADDING}px\n      );\n    }\n\n    /* Extra small devices (phones, 640px and down) */\n    @container viewport (width <= 640px) {\n      .doc-title-container {\n        padding-left: ${DOC_BLOCK_CHILD_PADDING}px;\n        padding-right: ${DOC_BLOCK_CHILD_PADDING}px;\n      }\n    }\n\n    .doc-title-container-empty::before {\n      content: 'Title';\n      color: var(--affine-placeholder-color);\n      position: absolute;\n      opacity: 0.5;\n      pointer-events: none;\n    }\n\n    .doc-title-container:disabled {\n      background-color: transparent;\n    }\n  `;\n\n  private _onTitleKeyDown = (event: KeyboardEvent) => {\n    if (event.isComposing || this.doc.readonly) return;\n    const hasContent = !this.doc.isEmpty;\n\n    if (event.key === 'Enter' && hasContent && !event.isComposing) {\n      event.preventDefault();\n      event.stopPropagation();\n\n      const inlineEditor = this._inlineEditor;\n      const inlineRange = inlineEditor?.getInlineRange();\n      if (inlineRange) {\n        const rightText = this._rootModel.title.split(inlineRange.index);\n        this._pageRoot.prependParagraphWithText(rightText);\n      }\n    } else if (event.key === 'ArrowDown' && hasContent) {\n      event.preventDefault();\n      event.stopPropagation();\n      this._pageRoot.focusFirstParagraph();\n    } else if (event.key === 'Tab') {\n      event.preventDefault();\n      event.stopPropagation();\n    }\n  };\n\n  private _updateTitleInMeta = () => {\n    this.doc.collection.setDocMeta(this.doc.id, {\n      title: this._rootModel.title.toString(),\n    });\n  };\n\n  private get _inlineEditor() {\n    return this._richTextElement.inlineEditor;\n  }\n\n  private get _pageRoot() {\n    const pageRoot = this._viewport.querySelector('affine-page-root');\n    assertExists(pageRoot);\n    return pageRoot;\n  }\n\n  private get _rootModel() {\n    return this.doc.root as RootBlockModel;\n  }\n\n  private get _viewport() {\n    const el = this.closest<HTMLElement>('.affine-page-viewport');\n    assertExists(el);\n    return el;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this._isReadonly = this.doc.readonly;\n    this._disposables.add(\n      this.doc.awarenessStore.slots.update.on(() => {\n        if (this._isReadonly !== this.doc.readonly) {\n          this._isReadonly = this.doc.readonly;\n          this.requestUpdate();\n        }\n      })\n    );\n\n    this._disposables.addFromEvent(this, 'keydown', this._onTitleKeyDown);\n\n    // Workaround for inline editor skips composition event\n    this._disposables.addFromEvent(\n      this,\n      'compositionstart',\n      () => (this._isComposing = true)\n    );\n\n    this._disposables.addFromEvent(\n      this,\n      'compositionend',\n      () => (this._isComposing = false)\n    );\n\n    const updateMetaTitle = () => {\n      this._updateTitleInMeta();\n      this.requestUpdate();\n    };\n    this._rootModel.title.yText.observe(updateMetaTitle);\n    this._disposables.add(() => {\n      this._rootModel.title.yText.unobserve(updateMetaTitle);\n    });\n  }\n\n  override render() {\n    const isEmpty = !this._rootModel.title.length && !this._isComposing;\n\n    return html`\n      <div\n        class=\"doc-title-container ${isEmpty\n          ? 'doc-title-container-empty'\n          : ''}\"\n        data-block-is-title=\"true\"\n      >\n        <rich-text\n          .yText=${this._rootModel.title.yText}\n          .undoManager=${this.doc.history}\n          .verticalScrollContainerGetter=${() => this._viewport}\n          .readonly=${this.doc.readonly}\n          .enableFormat=${false}\n        ></rich-text>\n      </div>\n    `;\n  }\n\n  @state()\n  private accessor _isComposing = false;\n\n  @state()\n  private accessor _isReadonly = false;\n\n  @query('rich-text')\n  private accessor _richTextElement!: RichText;\n\n  @property({ attribute: false })\n  accessor doc!: Doc;\n}\n\nexport function getDocTitleByEditorHost(\n  editorHost: EditorHost\n): DocTitle | null {\n  const docViewport = editorHost.closest('.affine-page-viewport');\n  if (!docViewport) return null;\n  return docViewport.querySelector('doc-title');\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'doc-title': DocTitle;\n  }\n}\n"]}