{"version":3,"file":"outline-viewer.js","sourceRoot":"","sources":["../../../src/fragments/outline/outline-viewer.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  PropTypes,\n  requiredProperties,\n  SignalWatcher,\n  WithDisposable,\n} from '@blocksuite/block-std';\nimport { NoteDisplayMode, scrollbarStyle } from '@blocksuite/blocks';\nimport { signal } from '@lit-labs/preact-signals';\nimport { css, html, LitElement, nothing } from 'lit';\nimport { customElement, property, query, state } from 'lit/decorators.js';\nimport { classMap } from 'lit/directives/class-map.js';\nimport { repeat } from 'lit/directives/repeat.js';\n\nimport type { AffineEditorContainer } from '../../editors/editor-container.js';\n\nimport { TocIcon } from '../_common/icons.js';\nimport { getHeadingBlocksFromDoc } from './utils/query.js';\nimport {\n  observeActiveHeadingDuringScroll,\n  scrollToBlockWithHighlight,\n} from './utils/scroll.js';\n\nexport const AFFINE_OUTLINE_VIEWER = 'affine-outline-viewer';\n\n@requiredProperties({\n  editor: PropTypes.object,\n})\n@customElement(AFFINE_OUTLINE_VIEWER)\nexport class OutlineViewer extends SignalWatcher(WithDisposable(LitElement)) {\n  static override styles = css`\n    :host {\n      display: flex;\n    }\n    .outline-viewer-root {\n      --duration: 120ms;\n      --timing: cubic-bezier(0.42, 0, 0.58, 1);\n\n      max-height: 100%;\n      box-sizing: border-box;\n      display: flex;\n    }\n\n    .outline-viewer-indicators-container {\n      position: absolute;\n      top: 0;\n      right: 0;\n      max-height: 100%;\n      display: flex;\n      flex-direction: column;\n      align-items: flex-end;\n      overflow-y: hidden;\n    }\n\n    .outline-viewer-indicator-wrapper {\n      flex: 1 1 16px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n    }\n\n    .outline-viewer-indicator {\n      width: 20px;\n      height: 2px;\n      border-radius: 1px;\n      overflow: hidden;\n      background: var(--affine-black-10, rgba(0, 0, 0, 0.1));\n    }\n\n    .outline-viewer-indicator.active {\n      width: 24px;\n      background: var(--affine-text-primary-color);\n    }\n\n    .outline-viewer-panel {\n      position: relative;\n      display: flex;\n      width: 0px;\n      max-height: 100%;\n      box-sizing: border-box;\n      flex-direction: column;\n      align-items: flex-start;\n\n      border-radius: 8px;\n      border-width: 0px;\n      border-style: solid;\n      border-color: var(--affine-border-color);\n      background: var(--affine-background-overlay-panel-color);\n      box-shadow: 0px 6px 16px 0px rgba(0, 0, 0, 0.14);\n\n      overflow-y: auto;\n\n      opacity: 0;\n      transform: translateX(0px);\n      transition:\n        width 0s var(--duration),\n        padding 0s var(--duration),\n        border-width 0s var(--duration),\n        transform var(--duration) var(--timing),\n        opacity var(--duration) var(--timing);\n    }\n\n    ${scrollbarStyle('.outline-viewer-panel')}\n\n    .outline-viewer-header {\n      display: flex;\n      padding: 6px;\n      align-items: center;\n      gap: 4px;\n      align-self: stretch;\n\n      span {\n        flex: 1;\n        overflow: hidden;\n        color: var(--affine-text-secondary-color);\n        text-overflow: ellipsis;\n\n        font-family: var(--affine-font-family);\n        font-size: 12px;\n        font-style: normal;\n        font-weight: 500;\n        line-height: 20px;\n      }\n    }\n\n    .outline-viewer-item {\n      display: flex;\n      align-items: center;\n      align-self: stretch;\n    }\n\n    .outline-viewer-root:hover {\n      .outline-viewer-indicators-container {\n        visibility: hidden;\n      }\n\n      .outline-viewer-panel {\n        width: 200px;\n        border-width: 1px;\n        padding: 8px 4px 8px 8px;\n        opacity: 1;\n        transform: translateX(-10px);\n        transition:\n          transform var(--duration) var(--timing),\n          opacity var(--duration) var(--timing);\n      }\n    }\n  `;\n\n  private _activeHeadingId$ = signal<string | null>(null);\n\n  private _highlightMaskDisposable = () => {};\n\n  private _lockActiveHeadingId = false;\n\n  private _scrollPanel = () => {\n    this._activeItem?.scrollIntoView({\n      behavior: 'instant',\n      block: 'center',\n    });\n  };\n\n  private async _scrollToBlock(blockId: string) {\n    this._lockActiveHeadingId = true;\n    this._activeHeadingId$.value = blockId;\n    this._highlightMaskDisposable = await scrollToBlockWithHighlight(\n      this.editor,\n      blockId\n    );\n    this._lockActiveHeadingId = false;\n  }\n\n  private _toggleOutlinePanel() {\n    if (this.toggleOutlinePanel) {\n      this._showViewer = false;\n      this.toggleOutlinePanel();\n    }\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this.disposables.add(\n      observeActiveHeadingDuringScroll(\n        () => this.editor,\n        newHeadingId => {\n          if (this._lockActiveHeadingId) return;\n          this._activeHeadingId$.value = newHeadingId;\n        }\n      )\n    );\n  }\n\n  override disconnectedCallback() {\n    super.disconnectedCallback();\n    this._highlightMaskDisposable();\n  }\n\n  override render() {\n    if (this.editor.doc.root === null || this.editor.mode === 'edgeless')\n      return nothing;\n\n    const headingBlocks = getHeadingBlocksFromDoc(\n      this.editor.doc,\n      [NoteDisplayMode.DocAndEdgeless, NoteDisplayMode.DocOnly],\n      true\n    );\n\n    if (headingBlocks.length === 0) return nothing;\n\n    const items = [\n      ...(this.editor.doc.meta?.title !== '' ? [this.editor.doc.root] : []),\n      ...headingBlocks,\n    ];\n\n    return html`\n      <div class=\"outline-viewer-root\" @mouseenter=${this._scrollPanel}>\n        <div class=\"outline-viewer-indicators-container\">\n          ${repeat(\n            items,\n            block => block.id,\n            block =>\n              html`<div class=\"outline-viewer-indicator-wrapper\">\n                <div\n                  class=${classMap({\n                    'outline-viewer-indicator': true,\n                    active: this._activeHeadingId$.value === block.id,\n                  })}\n                ></div>\n              </div>`\n          )}\n        </div>\n        <div class=\"outline-viewer-panel\">\n          <div class=\"outline-viewer-item outline-viewer-header\">\n            <span>Table of Contents</span>\n            <edgeless-tool-icon-button\n              .tooltip=${'Open in sidebar'}\n              .tipPosition=${'top-end'}\n              .activeMode=${'background'}\n              @click=${this._toggleOutlinePanel}\n            >\n              ${TocIcon}\n            </edgeless-tool-icon-button>\n          </div>\n          ${repeat(\n            items,\n            block => block.id,\n            block => {\n              return html`<div\n                class=${classMap({\n                  'outline-viewer-item': true,\n                  active: this._activeHeadingId$.value === block.id,\n                })}\n              >\n                <affine-outline-block-preview\n                  class=${classMap({\n                    active: this._activeHeadingId$.value === block.id,\n                  })}\n                  .block=${block}\n                  @click=${() => {\n                    this._scrollToBlock(block.id).catch(console.error);\n                  }}\n                >\n                </affine-outline-block-preview>\n              </div>`;\n            }\n          )}\n        </div>\n      </div>\n    `;\n  }\n\n  @query('.outline-viewer-item.active')\n  private accessor _activeItem: HTMLElement | null = null;\n\n  @state()\n  private accessor _showViewer: boolean = false;\n\n  @property({ attribute: false })\n  accessor editor!: AffineEditorContainer;\n\n  @property({ attribute: false })\n  accessor toggleOutlinePanel: (() => void) | null = null;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    [AFFINE_OUTLINE_VIEWER]: OutlineViewer;\n  }\n}\n"]}