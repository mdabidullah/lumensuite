{"version":3,"file":"text-renderer.js","sourceRoot":"","sources":["../../../../src/blocks/ai-chat-block/components/text-renderer.ts"],"names":[],"mappings":"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","sourcesContent":["import type { AffineAIPanelState } from '@blocksuite/blocks';\n\nimport {\n  BlockStdScope,\n  type EditorHost,\n  WithDisposable,\n} from '@blocksuite/block-std';\nimport {\n  CodeBlockComponent,\n  DividerBlockComponent,\n  ListBlockComponent,\n  ParagraphBlockComponent,\n  SpecProvider,\n} from '@blocksuite/blocks';\nimport { BlockViewType, type Doc, type Query } from '@blocksuite/store';\nimport { css, html, LitElement, nothing, type PropertyValues } from 'lit';\nimport { customElement, property, query } from 'lit/decorators.js';\nimport { classMap } from 'lit/directives/class-map.js';\nimport { keyed } from 'lit/directives/keyed.js';\n\nimport { markDownToDoc } from '../../_common/utils.js';\n\nconst textBlockStyles = css`\n  ${ParagraphBlockComponent.styles}\n  ${ListBlockComponent.styles}\n  ${DividerBlockComponent.styles}\n  ${CodeBlockComponent.styles}\n`;\n\nconst customHeadingStyles = css`\n  .custom-heading {\n    .h1 {\n      font-size: calc(var(--affine-font-h-1) - 2px);\n      code {\n        font-size: calc(var(--affine-font-base) + 6px);\n      }\n    }\n    .h2 {\n      font-size: calc(var(--affine-font-h-2) - 2px);\n      code {\n        font-size: calc(var(--affine-font-base) + 4px);\n      }\n    }\n    .h3 {\n      font-size: calc(var(--affine-font-h-3) - 2px);\n      code {\n        font-size: calc(var(--affine-font-base) + 2px);\n      }\n    }\n    .h4 {\n      font-size: calc(var(--affine-font-h-4) - 2px);\n      code {\n        font-size: var(--affine-font-base);\n      }\n    }\n    .h5 {\n      font-size: calc(var(--affine-font-h-5) - 2px);\n      code {\n        font-size: calc(var(--affine-font-base) - 2px);\n      }\n    }\n    .h6 {\n      font-size: calc(var(--affine-font-h-6) - 2px);\n      code {\n        font-size: calc(var(--affine-font-base) - 4px);\n      }\n    }\n  }\n`;\n\nexport type TextRendererOptions = {\n  maxHeight?: number;\n  customHeading?: boolean;\n};\n\n@customElement('text-renderer')\nexport class TextRenderer extends WithDisposable(LitElement) {\n  static override styles = css`\n    .ai-answer-text-editor.affine-page-viewport {\n      background: transparent;\n      font-family: var(--affine-font-family);\n      margin-top: 0;\n      margin-bottom: 0;\n    }\n\n    .ai-answer-text-editor .affine-page-root-block-container {\n      padding: 0;\n      line-height: var(--affine-line-height);\n      color: var(--affine-text-primary-color);\n      font-weight: 400;\n    }\n\n    .affine-paragraph-block-container {\n      line-height: 22px;\n    }\n\n    .ai-answer-text-editor {\n      .affine-note-block-container {\n        > .affine-block-children-container {\n          > :first-child,\n          > :first-child * {\n            margin-top: 0 !important;\n          }\n          > :last-child,\n          > :last-child * {\n            margin-bottom: 0 !important;\n          }\n        }\n      }\n    }\n\n    .ai-answer-text-container {\n      overflow-y: auto;\n      overflow-x: hidden;\n      padding: 0;\n      overscroll-behavior-y: none;\n    }\n    .ai-answer-text-container.show-scrollbar::-webkit-scrollbar {\n      width: 5px;\n      height: 100px;\n    }\n    .ai-answer-text-container.show-scrollbar::-webkit-scrollbar-thumb {\n      border-radius: 20px;\n    }\n    .ai-answer-text-container.show-scrollbar:hover::-webkit-scrollbar-thumb {\n      background-color: var(--affine-black-30);\n    }\n    .ai-answer-text-container.show-scrollbar::-webkit-scrollbar-corner {\n      display: none;\n    }\n\n    .ai-answer-text-container {\n      rich-text .nowrap-lines v-text span,\n      rich-text .nowrap-lines v-element span {\n        white-space: pre;\n      }\n      editor-host:focus-visible {\n        outline: none;\n      }\n      editor-host * {\n        box-sizing: border-box;\n      }\n    }\n\n    ${textBlockStyles}\n    ${customHeadingStyles}\n  `;\n\n  private _answers: string[] = [];\n\n  private _clearTimer = () => {\n    if (this._timer) {\n      clearInterval(this._timer);\n      this._timer = null;\n    }\n  };\n\n  private _doc: Doc | null = null;\n\n  private readonly _query: Query = {\n    mode: 'strict',\n    match: [\n      'affine:page',\n      'affine:note',\n      'affine:surface',\n      'affine:paragraph',\n      'affine:code',\n      'affine:list',\n      'affine:divider',\n    ].map(flavour => ({ flavour, viewType: BlockViewType.Display })),\n  };\n\n  private _timer?: ReturnType<typeof setInterval> | null = null;\n\n  private _updateDoc = () => {\n    if (this._answers.length > 0) {\n      const latestAnswer = this._answers.pop();\n      this._answers = [];\n      if (latestAnswer) {\n        markDownToDoc(this.host, latestAnswer)\n          .then(doc => {\n            this._doc = doc.blockCollection.getDoc({\n              query: this._query,\n            });\n            this.disposables.add(() => {\n              doc.blockCollection.clearQuery(this._query);\n            });\n            this._doc.awarenessStore.setReadonly(\n              this._doc.blockCollection,\n              true\n            );\n            this.requestUpdate();\n            if (this.state !== 'generating') {\n              this._clearTimer();\n            }\n          })\n          .catch(console.error);\n      }\n    }\n  };\n\n  private _onWheel(e: MouseEvent) {\n    e.stopPropagation();\n    if (this.state === 'generating') {\n      e.preventDefault();\n    }\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n    this._answers.push(this.answer);\n\n    this._updateDoc();\n    if (this.state === 'generating') {\n      this._timer = setInterval(this._updateDoc, 600);\n    }\n  }\n\n  override disconnectedCallback() {\n    super.disconnectedCallback();\n    this._clearTimer();\n  }\n\n  override render() {\n    if (!this._doc) {\n      return nothing;\n    }\n\n    const { maxHeight, customHeading } = this.options;\n    const previewSpec = SpecProvider.getInstance().getSpec('page:preview');\n    const classes = classMap({\n      'ai-answer-text-container': true,\n      'show-scrollbar': !!maxHeight,\n      'custom-heading': !!customHeading,\n    });\n    return html`\n      <style>\n        .ai-answer-text-container {\n          max-height: ${maxHeight ? Math.max(maxHeight, 200) + 'px' : ''};\n        }\n      </style>\n      <div class=${classes} @wheel=${this._onWheel}>\n        ${keyed(\n          this._doc,\n          html`<div class=\"ai-answer-text-editor affine-page-viewport\">\n            ${new BlockStdScope({\n              doc: this._doc,\n              extensions: previewSpec.value,\n            }).render()}\n          </div>`\n        )}\n      </div>\n    `;\n  }\n\n  override shouldUpdate(changedProperties: PropertyValues) {\n    if (changedProperties.has('answer')) {\n      this._answers.push(this.answer);\n      return false;\n    }\n\n    return true;\n  }\n\n  override updated(changedProperties: PropertyValues) {\n    super.updated(changedProperties);\n    requestAnimationFrame(() => {\n      if (!this._container) return;\n      this._container.scrollTop = this._container.scrollHeight;\n    });\n  }\n\n  @query('.ai-answer-text-container')\n  private accessor _container!: HTMLDivElement;\n\n  @property({ attribute: false })\n  accessor answer!: string;\n\n  @property({ attribute: false })\n  accessor host!: EditorHost;\n\n  @property({ attribute: false })\n  accessor options!: TextRendererOptions;\n\n  @property({ attribute: false })\n  accessor state: AffineAIPanelState | undefined = undefined;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'text-renderer': TextRenderer;\n  }\n}\n"]}