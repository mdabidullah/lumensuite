{"version":3,"file":"event.js","sourceRoot":"","sources":["../../src/services/event.ts"],"names":[],"mappings":"AAIA,OAAO,EAEL,gBAAgB,EAChB,YAAY,EACZ,aAAa,GACd,MAAM,mBAAmB,CAAC;AAC3B,OAAO,EAAE,uBAAuB,EAAE,MAAM,0BAA0B,CAAC;AACnE,OAAO,EAAE,cAAc,EAAE,MAAM,6BAA6B,CAAC;AAE7D,MAAM,OAAO,YAAY;IAqXvB,IAAI,mBAAmB;QACrB,OAAO,IAAI,CAAC,MAAM,CAAC,mBAAmB,CAAC;IACzC,CAAC;IAED,IAAI,WAAW;QACb,OAAO,IAAI,CAAC,YAAY,CAAC;IAC3B,CAAC;IAED,YAAqB,MAAoC;QAApC,WAAM,GAAN,MAAM,CAA8B;QA5XjD,4BAAuB,GAAuB,IAAI,CAAC;QAEnD,iBAAY,GAAG,KAAK,CAAC;QAErB,6BAAwB,GAAG,CAAC,KAAY,EAAE,EAAE;YAClD,MAAM,WAAW,GAAG,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC;YAC5C,MAAM,SAAS,GAAG,QAAQ,CAAC,WAAW,EAAE,CAAC;YACzC,SAAS,CAAC,UAAU,CAAC,WAAW,CAAC,CAAC;YAElC,IACE,KAAK,CAAC,cAAc,CAAC,uBAAuB,CAAC,KAAK,CAAC,YAAY,CAAC;gBAChE,IAAI,CAAC,2BAA2B,EAChC,CAAC;gBACD,OAAO,CACL,SAAS,CAAC,YAAY,CAAC,KAAK,CAAC,cAAc,EAAE,KAAK,CAAC,WAAW,CAAC,IAAI,CAAC;oBACpE,SAAS,CAAC,YAAY,CAAC,KAAK,CAAC,YAAY,EAAE,KAAK,CAAC,SAAS,CAAC,IAAI,CAAC,CACjE,CAAC;YACJ,CAAC;iBAAM,CAAC;gBACN,OAAO,CACL,SAAS,CAAC,YAAY,CAAC,KAAK,CAAC,YAAY,EAAE,KAAK,CAAC,WAAW,CAAC,IAAI,CAAC;oBAClE,SAAS,CAAC,YAAY,CAAC,KAAK,CAAC,cAAc,EAAE,KAAK,CAAC,SAAS,CAAC,IAAI,CAAC,CACnE,CAAC;YACJ,CAAC;QACH,CAAC,CAAC;QAEM,mBAAc,GAAG,CAAC,KAAiB,EAAE,EAAE;YAC7C,MAAM,KAAK,GAAG,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,cAAc,EAAE,CAAC;YACxD,IACE,IAAI,CAAC,MAAM,CAAC,UAAU;gBACtB,IAAI,CAAC,YAAY;gBACjB,CAAC,KAAK;gBACN,CAAC,IAAI,CAAC,wBAAwB,CAAC,KAAK,CAAC;gBAErC,OAAO;YAET,IAAI,WAAW,GAAG,IAAI,CAAC,MAAM,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;YACnD,IAAI,CAAC,WAAW;gBAAE,OAAO;YAEzB,IAAI,mBAAmB,GAAG,IAAI,CAAC;YAE/B,IAAI,KAAK,CAAC,SAAS,CAAC,UAAU,CAAC,QAAQ,CAAC,EAAE,CAAC;gBACzC,IACE,YAAY,CAAC,KAAK,CAAC,uBAAuB,CAAC;oBAC3C,WAAW,CAAC,MAAM,KAAK,CAAC;oBACxB,WAAW,CAAC,KAAK,GAAG,CAAC,EACrB,CAAC;oBACD,WAAW,GAAG;wBACZ,KAAK,EAAE,WAAW,CAAC,KAAK,GAAG,CAAC;wBAC5B,MAAM,EAAE,CAAC;qBACV,CAAC;oBACF,mBAAmB,GAAG,KAAK,CAAC;gBAC9B,CAAC;qBAAM,IACL,aAAa,CAAC,KAAK,CAAC,uBAAuB,CAAC;oBAC5C,WAAW,CAAC,MAAM,KAAK,CAAC;oBACxB,WAAW,CAAC,KAAK,GAAG,CAAC,EACrB,CAAC;oBACD,qDAAqD;oBACrD,yDAAyD;oBACzD,WAAW,GAAG;wBACZ,KAAK,EAAE,WAAW,CAAC,KAAK,GAAG,CAAC;wBAC5B,MAAM,EAAE,CAAC;qBACV,CAAC;oBACF,mBAAmB,GAAG,KAAK,CAAC;gBAC9B,CAAC;YACH,CAAC;YAED,IAAI,mBAAmB,EAAE,CAAC;gBACxB,MAAM,YAAY,GAAG,KAAK,CAAC,eAAe,EAAE,CAAC;gBAC7C,IAAI,YAAY,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;oBAC5B,MAAM,WAAW,GAAG,YAAY,CAAC,CAAC,CAAC,CAAC;oBACpC,MAAM,KAAK,GAAG,QAAQ,CAAC,WAAW,EAAE,CAAC;oBACrC,KAAK,CAAC,QAAQ,CAAC,WAAW,CAAC,cAAc,EAAE,WAAW,CAAC,WAAW,CAAC,CAAC;oBACpE,KAAK,CAAC,MAAM,CAAC,WAAW,CAAC,YAAY,EAAE,WAAW,CAAC,SAAS,CAAC,CAAC;oBAC9D,MAAM,iBAAiB,GAAG,IAAI,CAAC,MAAM,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;oBAE3D,IAAI,CAAC,uBAAuB,CAAC,WAAW,EAAE,iBAAiB,CAAC,EAAE,CAAC;wBAC7D,WAAW,GAAG,iBAAiB,CAAC;oBAClC,CAAC;gBACH,CAAC;YACH,CAAC;YAED,IAAI,CAAC,WAAW;gBAAE,OAAO;YAEzB,KAAK,CAAC,cAAc,EAAE,CAAC;YAEvB,MAAM,GAAG,GAAuC;gBAC9C,YAAY,EAAE,IAAI,CAAC,MAAM;gBACzB,GAAG,EAAE,KAAK;gBACV,WAAW;gBACX,IAAI,EAAE,KAAK,CAAC,IAAI,IAAI,KAAK,CAAC,YAAY,EAAE,OAAO,CAAC,YAAY,CAAC,IAAI,IAAI;gBACrE,UAAU,EAAE,EAAoB;aACjC,CAAC;YACF,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,WAAW,EAAE,CAAC,GAAG,CAAC,CAAC;YAErC,cAAc,CACZ,GAAG,CAAC,GAAG,CAAC,SAAS,EACjB,GAAG,CAAC,IAAI,EACR,GAAG,CAAC,UAAU,EACd,GAAG,CAAC,WAAW,EACf,IAAI,CAAC,MAAsB,CAC5B,CAAC;YAEF,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,SAAS,CAAC,IAAI,EAAE,CAAC;QACrC,CAAC,CAAC;QAEM,aAAQ,GAAG,CAAC,KAAiB,EAAE,EAAE;YACvC,wCAAwC;YACxC,IAAI,KAAK,CAAC,MAAM,YAAY,IAAI,IAAI,gBAAgB,CAAC,KAAK,CAAC,MAAM,CAAC,EAAE,CAAC;gBACnE,MAAM,SAAS,GAAG,QAAQ,CAAC,YAAY,EAAE,CAAC;gBAC1C,IAAI,CAAC,SAAS;oBAAE,OAAO;gBACvB,IAAI,KAAK,CAAC,MAAM,YAAY,WAAW,EAAE,CAAC;oBACxC,MAAM,QAAQ,GAAG,KAAK,CAAC,MAAM,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC;oBACnD,IAAI,QAAQ,EAAE,CAAC;wBACb,SAAS,CAAC,iBAAiB,CAAC,QAAQ,CAAC,CAAC;oBACxC,CAAC;gBACH,CAAC;qBAAM,CAAC;oBACN,MAAM,QAAQ,GAAG,KAAK,CAAC,MAAM,CAAC,aAAa,EAAE,OAAO,CAAC,WAAW,CAAC,CAAC;oBAClE,IAAI,QAAQ,EAAE,CAAC;wBACb,SAAS,CAAC,iBAAiB,CAAC,QAAQ,CAAC,CAAC;oBACxC,CAAC;gBACH,CAAC;YACH,CAAC;QACH,CAAC,CAAC;QAEM,sBAAiB,GAAG,KAAK,EAAE,KAAuB,EAAE,EAAE;YAC5D,IAAI,CAAC,YAAY,GAAG,KAAK,CAAC;YAC1B,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC,WAAW;gBAAE,OAAO;YAEjD,MAAM,KAAK,GAAG,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,cAAc,EAAE,CAAC;YACxD,IACE,IAAI,CAAC,MAAM,CAAC,UAAU;gBACtB,CAAC,KAAK;gBACN,CAAC,IAAI,CAAC,wBAAwB,CAAC,KAAK,CAAC;gBAErC,OAAO;YAET,IAAI,CAAC,MAAM,CAAC,mBAAmB,EAAE,CAAC;YAClC,MAAM,IAAI,CAAC,MAAM,CAAC,aAAa,EAAE,CAAC;YAElC,MAAM,WAAW,GAAG,IAAI,CAAC,uBAAuB,CAAC;YACjD,IAAI,CAAC,WAAW;gBAAE,OAAO;YAEzB,KAAK,CAAC,cAAc,EAAE,CAAC;YAEvB,MAAM,GAAG,GAA0C;gBACjD,YAAY,EAAE,IAAI,CAAC,MAAM;gBACzB,GAAG,EAAE,KAAK;gBACV,WAAW;gBACX,IAAI,EAAE,KAAK,CAAC,IAAI;gBAChB,UAAU,EAAE,EAAoB;aACjC,CAAC;YACF,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,cAAc,EAAE,CAAC,GAAG,CAAC,CAAC;YAExC,MAAM,EAAE,WAAW,EAAE,cAAc,EAAE,IAAI,EAAE,OAAO,EAAE,GAAG,GAAG,CAAC;YAC3D,IAAI,OAAO,IAAI,OAAO,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;gBAClC,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,cAAc,EAAE,OAAO,EAAE,GAAG,CAAC,UAAU,CAAC,CAAC;gBAChE,IAAI,CAAC,MAAM,CAAC,cAAc,CACxB;oBACE,KAAK,EAAE,cAAc,CAAC,KAAK,GAAG,OAAO,CAAC,MAAM;oBAC5C,MAAM,EAAE,CAAC;iBACV,EACD,KAAK,CACN,CAAC;YACJ,CAAC;YAED,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,SAAS,CAAC,IAAI,EAAE,CAAC;QACrC,CAAC,CAAC;QAEM,wBAAmB,GAAG,GAAG,EAAE;YACjC,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC;YACzB,+CAA+C;YAC/C,MAAM,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC,gBAAgB,CACrD,uBAAuB,CACxB,CAAC;YACF,MAAM,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE;gBACrB,KAAK,CAAC,eAAe,CAAC,iBAAiB,CAAC,CAAC;YAC3C,CAAC,CAAC,CAAC;YAEH,MAAM,KAAK,GAAG,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,cAAc,EAAE,CAAC;YACxD,IAAI,KAAK,EAAE,CAAC;gBACV,IAAI,CAAC,uBAAuB,GAAG,IAAI,CAAC,MAAM,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;YAClE,CAAC;iBAAM,CAAC;gBACN,IAAI,CAAC,uBAAuB,GAAG,IAAI,CAAC;YACtC,CAAC;QACH,CAAC,CAAC;QAEM,yBAAoB,GAAG,GAAG,EAAE;YAClC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC,WAAW;gBAAE,OAAO;YAEjD,MAAM,KAAK,GAAG,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,cAAc,EAAE,CAAC;YACxD,IACE,IAAI,CAAC,MAAM,CAAC,UAAU;gBACtB,CAAC,KAAK;gBACN,CAAC,IAAI,CAAC,wBAAwB,CAAC,KAAK,CAAC;gBAErC,OAAO;YAET,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,SAAS,CAAC,IAAI,EAAE,CAAC;QACrC,CAAC,CAAC;QAEM,eAAU,GAAG,CAAC,KAAoB,EAAE,EAAE;YAC5C,MAAM,WAAW,GAAG,IAAI,CAAC,MAAM,CAAC,cAAc,EAAE,CAAC;YACjD,IAAI,CAAC,WAAW;gBAAE,OAAO;YAEzB,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YAEtC,IACE,CAAC,KAAK,CAAC,QAAQ;gBACf,CAAC,KAAK,CAAC,GAAG,KAAK,WAAW,IAAI,KAAK,CAAC,GAAG,KAAK,YAAY,CAAC,EACzD,CAAC;gBACD,IAAI,WAAW,CAAC,MAAM,KAAK,CAAC;oBAAE,OAAO;gBAErC,MAAM,OAAO,GAAG,GAAG,EAAE;oBACnB,KAAK,CAAC,cAAc,EAAE,CAAC;oBACvB,KAAK,CAAC,eAAe,EAAE,CAAC;gBAC1B,CAAC,CAAC;gBAEF,MAAM,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC,sBAAsB,CAAC,WAAW,CAAC,CAAC;gBAC/D,IAAI,MAAM,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;oBACxB,IAAI,KAAK,CAAC,GAAG,KAAK,WAAW,IAAI,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC;wBACnE,OAAO,EAAE,CAAC;wBACV,IAAI,CAAC,MAAM,CAAC,cAAc,CAAC;4BACzB,KAAK,EAAE,WAAW,CAAC,KAAK,GAAG,CAAC;4BAC5B,MAAM,EAAE,CAAC;yBACV,CAAC,CAAC;oBACL,CAAC;yBAAM,IACL,KAAK,CAAC,GAAG,KAAK,YAAY;wBAC1B,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,EACjC,CAAC;wBACD,OAAO,EAAE,CAAC;wBACV,IAAI,CAAC,MAAM,CAAC,cAAc,CAAC;4BACzB,KAAK,EAAE,WAAW,CAAC,KAAK;4BACxB,MAAM,EAAE,CAAC;yBACV,CAAC,CAAC;oBACL,CAAC;gBACH,CAAC;qBAAM,IAAI,MAAM,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;oBAC/B,MAAM,KAAK,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;oBAC3B,IAAI,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE,CAAC;wBAC/B,IAAI,KAAK,CAAC,GAAG,KAAK,WAAW,IAAI,WAAW,CAAC,KAAK,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC;4BAC5D,OAAO,EAAE,CAAC;4BACV,IAAI,CAAC,MAAM,CAAC,cAAc,CAAC;gCACzB,KAAK,EAAE,WAAW,CAAC,KAAK,GAAG,CAAC;gCAC5B,MAAM,EAAE,CAAC;6BACV,CAAC,CAAC;wBACL,CAAC;6BAAM,IACL,KAAK,CAAC,GAAG,KAAK,YAAY;4BAC1B,WAAW,CAAC,KAAK,GAAG,CAAC,IAAI,IAAI,CAAC,MAAM,CAAC,WAAW,EAChD,CAAC;4BACD,OAAO,EAAE,CAAC;4BACV,IAAI,CAAC,MAAM,CAAC,cAAc,CAAC;gCACzB,KAAK,EAAE,WAAW,CAAC,KAAK;gCACxB,MAAM,EAAE,CAAC;6BACV,CAAC,CAAC;wBACL,CAAC;oBACH,CAAC;gBACH,CAAC;YACH,CAAC;QACH,CAAC,CAAC;QAEM,uBAAkB,GAAG,GAAG,EAAE;YAChC,MAAM,WAAW,GAAG,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC;YAC5C,MAAM,mBAAmB,GAAG,IAAI,CAAC,MAAM,CAAC,cAAc,EAAE,CAAC;YACzD,IAAI,IAAI,CAAC,YAAY,EAAE,CAAC;gBACtB,OAAO;YACT,CAAC;YAED,MAAM,SAAS,GAAG,QAAQ,CAAC,YAAY,EAAE,CAAC;YAC1C,IAAI,CAAC,SAAS;gBAAE,OAAO;YACvB,IAAI,SAAS,CAAC,UAAU,KAAK,CAAC,EAAE,CAAC;gBAC/B,IAAI,mBAAmB,KAAK,IAAI,EAAE,CAAC;oBACjC,IAAI,CAAC,MAAM,CAAC,cAAc,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;gBAC1C,CAAC;gBAED,OAAO;YACT,CAAC;YAED,MAAM,KAAK,GAAG,SAAS,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC;YACtC,IAAI,CAAC,KAAK,CAAC,cAAc,CAAC,WAAW,CAAC,EAAE,CAAC;gBACvC,MAAM,mBAAmB,GACvB,KAAK,CAAC,YAAY,CAAC,QAAQ,CAAC,WAAW,CAAC;oBACxC,KAAK,CAAC,IAAI,CAAC,KAAK,CAAC,YAAY,CAAC,UAAU,CAAC,CAAC,MAAM,CAC9C,IAAI,CAAC,EAAE,CAAC,IAAI,YAAY,WAAW,CACpC,CAAC,MAAM,KAAK,CAAC;oBACd,KAAK,CAAC,cAAc,CAAC,QAAQ,CAAC,WAAW,CAAC;oBAC1C,KAAK,CAAC,IAAI,CAAC,KAAK,CAAC,cAAc,CAAC,UAAU,CAAC,CAAC,MAAM,CAChD,IAAI,CAAC,EAAE,CAAC,IAAI,YAAY,WAAW,CACpC,CAAC,MAAM,KAAK,CAAC,CAAC;gBACjB,IAAI,mBAAmB,EAAE,CAAC;oBACxB,IAAI,CAAC,MAAM,CAAC,QAAQ,EAAE,CAAC;oBACvB,OAAO;gBACT,CAAC;qBAAM,CAAC;oBACN,IAAI,mBAAmB,KAAK,IAAI,EAAE,CAAC;wBACjC,IAAI,CAAC,MAAM,CAAC,cAAc,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;oBAC1C,CAAC;oBACD,OAAO;gBACT,CAAC;YACH,CAAC;YAED,IAAI,CAAC,eAAe,GAAG,CAAC,KAAK,CAAC,cAAc,EAAE,KAAK,CAAC,WAAW,CAAC,CAAC;YACjE,IAAI,CAAC,cAAc,GAAG,CAAC,KAAK,CAAC,YAAY,EAAE,KAAK,CAAC,SAAS,CAAC,CAAC;YAE5D,MAAM,WAAW,GAAG,IAAI,CAAC,MAAM,CAAC,aAAa,CAAC,SAAS,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,CAAC;YACvE,IAAI,CAAC,uBAAuB,CAAC,mBAAmB,EAAE,WAAW,CAAC,EAAE,CAAC;gBAC/D,IAAI,CAAC,MAAM,CAAC,cAAc,CAAC,WAAW,EAAE,KAAK,CAAC,CAAC;YACjD,CAAC;YAED,iCAAiC;YACjC,IACE,CAAC,CAAC,KAAK,CAAC,cAAc,CAAC,QAAQ,KAAK,IAAI,CAAC,SAAS;gBAChD,KAAK,CAAC,YAAY,CAAC,QAAQ,KAAK,IAAI,CAAC,SAAS,CAAC;gBAC/C,KAAK,CAAC,cAAc,KAAK,IAAI,CAAC,eAAe,CAAC,CAAC,CAAC;gBAChD,KAAK,CAAC,YAAY,KAAK,IAAI,CAAC,cAAc,CAAC,CAAC,CAAC;gBAC7C,KAAK,CAAC,WAAW,KAAK,IAAI,CAAC,eAAe,CAAC,CAAC,CAAC;gBAC7C,KAAK,CAAC,SAAS,KAAK,IAAI,CAAC,cAAc,CAAC,CAAC,CAAC,CAAC;gBAC7C,KAAK,CAAC,cAAc,CAAC,QAAQ,KAAK,IAAI,CAAC,YAAY;gBACnD,KAAK,CAAC,YAAY,CAAC,QAAQ,KAAK,IAAI,CAAC,YAAY,EACjD,CAAC;gBACD,IAAI,CAAC,MAAM,CAAC,eAAe,EAAE,CAAC;YAChC,CAAC;QACH,CAAC,CAAC;QAEM,oBAAe,GAAuB,IAAI,CAAC;QAE3C,mBAAc,GAAuB,IAAI,CAAC;QAElD,UAAK,GAAG,GAAG,EAAE;YACX,MAAM,WAAW,GAAG,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC;YAC5C,MAAM,WAAW,GAAG,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC;YAE5C,IAAI,CAAC,IAAI,CAAC,mBAAmB,EAAE,CAAC;gBAC9B,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC,YAAY,CAClC,QAAQ,EACR,iBAAiB,EACjB,IAAI,CAAC,kBAAkB,CACxB,CAAC;YACJ,CAAC;YAED,IAAI,CAAC,WAAW,EAAE,CAAC;gBACjB,OAAO,CAAC,KAAK,CAAC,gDAAgD,CAAC,CAAC;gBAChE,OAAO;YACT,CAAC;YAED,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC,YAAY,CAClC,WAAW,EACX,aAAa,EACb,IAAI,CAAC,cAAc,CACpB,CAAC;YACF,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC,YAAY,CAClC,WAAW,EACX,kBAAkB,EAClB,IAAI,CAAC,mBAAmB,CACzB,CAAC;YACF,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC,YAAY,CAClC,WAAW,EACX,mBAAmB,EACnB,IAAI,CAAC,oBAAoB,CAC1B,CAAC;YACF,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC,YAAY,CAClC,WAAW,EACX,gBAAgB,EAChB,CAAC,KAAuB,EAAE,EAAE;gBAC1B,IAAI,CAAC,iBAAiB,CAAC,KAAK,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;YACrD,CAAC,CACF,CAAC;YACF,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC,YAAY,CAClC,WAAW,EACX,SAAS,EACT,IAAI,CAAC,UAAU,CAChB,CAAC;YACF,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC,YAAY,CAAC,WAAW,EAAE,OAAO,EAAE,IAAI,CAAC,QAAQ,CAAC,CAAC;QAC5E,CAAC,CAAC;IAU0D,CAAC;CAC9D","sourcesContent":["import type { InlineEditor } from '../inline-editor.js';\nimport type { InlineRange, NativePoint } from '../types.js';\nimport type { BeforeinputHookCtx, CompositionEndHookCtx } from './hook.js';\n\nimport {\n  type BaseTextAttributes,\n  isInEmbedElement,\n  isInEmbedGap,\n  isInEmptyLine,\n} from '../utils/index.js';\nimport { isMaybeInlineRangeEqual } from '../utils/inline-range.js';\nimport { transformInput } from '../utils/transform-input.js';\n\nexport class EventService<TextAttributes extends BaseTextAttributes> {\n  private _compositionInlineRange: InlineRange | null = null;\n\n  private _isComposing = false;\n\n  private _isRangeCompletelyInRoot = (range: Range) => {\n    const rootElement = this.editor.rootElement;\n    const rootRange = document.createRange();\n    rootRange.selectNode(rootElement);\n\n    if (\n      range.startContainer.compareDocumentPosition(range.endContainer) &\n      Node.DOCUMENT_POSITION_FOLLOWING\n    ) {\n      return (\n        rootRange.comparePoint(range.startContainer, range.startOffset) >= 0 &&\n        rootRange.comparePoint(range.endContainer, range.endOffset) <= 0\n      );\n    } else {\n      return (\n        rootRange.comparePoint(range.endContainer, range.startOffset) >= 0 &&\n        rootRange.comparePoint(range.startContainer, range.endOffset) <= 0\n      );\n    }\n  };\n\n  private _onBeforeInput = (event: InputEvent) => {\n    const range = this.editor.rangeService.getNativeRange();\n    if (\n      this.editor.isReadonly ||\n      this._isComposing ||\n      !range ||\n      !this._isRangeCompletelyInRoot(range)\n    )\n      return;\n\n    let inlineRange = this.editor.toInlineRange(range);\n    if (!inlineRange) return;\n\n    let ifHandleTargetRange = true;\n\n    if (event.inputType.startsWith('delete')) {\n      if (\n        isInEmbedGap(range.commonAncestorContainer) &&\n        inlineRange.length === 0 &&\n        inlineRange.index > 0\n      ) {\n        inlineRange = {\n          index: inlineRange.index - 1,\n          length: 1,\n        };\n        ifHandleTargetRange = false;\n      } else if (\n        isInEmptyLine(range.commonAncestorContainer) &&\n        inlineRange.length === 0 &&\n        inlineRange.index > 0\n      ) {\n        // do not use target range when deleting across lines\n        // https://github.com/toeverything/lumensuite/issues/5381\n        inlineRange = {\n          index: inlineRange.index - 1,\n          length: 1,\n        };\n        ifHandleTargetRange = false;\n      }\n    }\n\n    if (ifHandleTargetRange) {\n      const targetRanges = event.getTargetRanges();\n      if (targetRanges.length > 0) {\n        const staticRange = targetRanges[0];\n        const range = document.createRange();\n        range.setStart(staticRange.startContainer, staticRange.startOffset);\n        range.setEnd(staticRange.endContainer, staticRange.endOffset);\n        const targetInlineRange = this.editor.toInlineRange(range);\n\n        if (!isMaybeInlineRangeEqual(inlineRange, targetInlineRange)) {\n          inlineRange = targetInlineRange;\n        }\n      }\n    }\n\n    if (!inlineRange) return;\n\n    event.preventDefault();\n\n    const ctx: BeforeinputHookCtx<TextAttributes> = {\n      inlineEditor: this.editor,\n      raw: event,\n      inlineRange,\n      data: event.data ?? event.dataTransfer?.getData('text/plain') ?? null,\n      attributes: {} as TextAttributes,\n    };\n    this.editor.hooks.beforeinput?.(ctx);\n\n    transformInput<TextAttributes>(\n      ctx.raw.inputType,\n      ctx.data,\n      ctx.attributes,\n      ctx.inlineRange,\n      this.editor as InlineEditor\n    );\n\n    this.editor.slots.inputting.emit();\n  };\n\n  private _onClick = (event: MouseEvent) => {\n    // select embed element when click on it\n    if (event.target instanceof Node && isInEmbedElement(event.target)) {\n      const selection = document.getSelection();\n      if (!selection) return;\n      if (event.target instanceof HTMLElement) {\n        const vElement = event.target.closest('v-element');\n        if (vElement) {\n          selection.selectAllChildren(vElement);\n        }\n      } else {\n        const vElement = event.target.parentElement?.closest('v-element');\n        if (vElement) {\n          selection.selectAllChildren(vElement);\n        }\n      }\n    }\n  };\n\n  private _onCompositionEnd = async (event: CompositionEvent) => {\n    this._isComposing = false;\n    if (!this.editor.rootElement.isConnected) return;\n\n    const range = this.editor.rangeService.getNativeRange();\n    if (\n      this.editor.isReadonly ||\n      !range ||\n      !this._isRangeCompletelyInRoot(range)\n    )\n      return;\n\n    this.editor.rerenderWholeEditor();\n    await this.editor.waitForUpdate();\n\n    const inlineRange = this._compositionInlineRange;\n    if (!inlineRange) return;\n\n    event.preventDefault();\n\n    const ctx: CompositionEndHookCtx<TextAttributes> = {\n      inlineEditor: this.editor,\n      raw: event,\n      inlineRange,\n      data: event.data,\n      attributes: {} as TextAttributes,\n    };\n    this.editor.hooks.compositionEnd?.(ctx);\n\n    const { inlineRange: newInlineRange, data: newData } = ctx;\n    if (newData && newData.length > 0) {\n      this.editor.insertText(newInlineRange, newData, ctx.attributes);\n      this.editor.setInlineRange(\n        {\n          index: newInlineRange.index + newData.length,\n          length: 0,\n        },\n        false\n      );\n    }\n\n    this.editor.slots.inputting.emit();\n  };\n\n  private _onCompositionStart = () => {\n    this._isComposing = true;\n    // embeds is not editable and it will break IME\n    const embeds = this.editor.rootElement.querySelectorAll(\n      '[data-v-embed=\"true\"]'\n    );\n    embeds.forEach(embed => {\n      embed.removeAttribute('contenteditable');\n    });\n\n    const range = this.editor.rangeService.getNativeRange();\n    if (range) {\n      this._compositionInlineRange = this.editor.toInlineRange(range);\n    } else {\n      this._compositionInlineRange = null;\n    }\n  };\n\n  private _onCompositionUpdate = () => {\n    if (!this.editor.rootElement.isConnected) return;\n\n    const range = this.editor.rangeService.getNativeRange();\n    if (\n      this.editor.isReadonly ||\n      !range ||\n      !this._isRangeCompletelyInRoot(range)\n    )\n      return;\n\n    this.editor.slots.inputting.emit();\n  };\n\n  private _onKeyDown = (event: KeyboardEvent) => {\n    const inlineRange = this.editor.getInlineRange();\n    if (!inlineRange) return;\n\n    this.editor.slots.keydown.emit(event);\n\n    if (\n      !event.shiftKey &&\n      (event.key === 'ArrowLeft' || event.key === 'ArrowRight')\n    ) {\n      if (inlineRange.length !== 0) return;\n\n      const prevent = () => {\n        event.preventDefault();\n        event.stopPropagation();\n      };\n\n      const deltas = this.editor.getDeltasByInlineRange(inlineRange);\n      if (deltas.length === 2) {\n        if (event.key === 'ArrowLeft' && this.editor.isEmbed(deltas[0][0])) {\n          prevent();\n          this.editor.setInlineRange({\n            index: inlineRange.index - 1,\n            length: 1,\n          });\n        } else if (\n          event.key === 'ArrowRight' &&\n          this.editor.isEmbed(deltas[1][0])\n        ) {\n          prevent();\n          this.editor.setInlineRange({\n            index: inlineRange.index,\n            length: 1,\n          });\n        }\n      } else if (deltas.length === 1) {\n        const delta = deltas[0][0];\n        if (this.editor.isEmbed(delta)) {\n          if (event.key === 'ArrowLeft' && inlineRange.index - 1 >= 0) {\n            prevent();\n            this.editor.setInlineRange({\n              index: inlineRange.index - 1,\n              length: 1,\n            });\n          } else if (\n            event.key === 'ArrowRight' &&\n            inlineRange.index + 1 <= this.editor.yTextLength\n          ) {\n            prevent();\n            this.editor.setInlineRange({\n              index: inlineRange.index,\n              length: 1,\n            });\n          }\n        }\n      }\n    }\n  };\n\n  private _onSelectionChange = () => {\n    const rootElement = this.editor.rootElement;\n    const previousInlineRange = this.editor.getInlineRange();\n    if (this._isComposing) {\n      return;\n    }\n\n    const selection = document.getSelection();\n    if (!selection) return;\n    if (selection.rangeCount === 0) {\n      if (previousInlineRange !== null) {\n        this.editor.setInlineRange(null, false);\n      }\n\n      return;\n    }\n\n    const range = selection.getRangeAt(0);\n    if (!range.intersectsNode(rootElement)) {\n      const isContainerSelected =\n        range.endContainer.contains(rootElement) &&\n        Array.from(range.endContainer.childNodes).filter(\n          node => node instanceof HTMLElement\n        ).length === 1 &&\n        range.startContainer.contains(rootElement) &&\n        Array.from(range.startContainer.childNodes).filter(\n          node => node instanceof HTMLElement\n        ).length === 1;\n      if (isContainerSelected) {\n        this.editor.focusEnd();\n        return;\n      } else {\n        if (previousInlineRange !== null) {\n          this.editor.setInlineRange(null, false);\n        }\n        return;\n      }\n    }\n\n    this._previousAnchor = [range.startContainer, range.startOffset];\n    this._previousFocus = [range.endContainer, range.endOffset];\n\n    const inlineRange = this.editor.toInlineRange(selection.getRangeAt(0));\n    if (!isMaybeInlineRangeEqual(previousInlineRange, inlineRange)) {\n      this.editor.setInlineRange(inlineRange, false);\n    }\n\n    // avoid infinite syncInlineRange\n    if (\n      ((range.startContainer.nodeType !== Node.TEXT_NODE ||\n        range.endContainer.nodeType !== Node.TEXT_NODE) &&\n        range.startContainer !== this._previousAnchor[0] &&\n        range.endContainer !== this._previousFocus[0] &&\n        range.startOffset !== this._previousAnchor[1] &&\n        range.endOffset !== this._previousFocus[1]) ||\n      range.startContainer.nodeType === Node.COMMENT_NODE ||\n      range.endContainer.nodeType === Node.COMMENT_NODE\n    ) {\n      this.editor.syncInlineRange();\n    }\n  };\n\n  private _previousAnchor: NativePoint | null = null;\n\n  private _previousFocus: NativePoint | null = null;\n\n  mount = () => {\n    const eventSource = this.editor.eventSource;\n    const rootElement = this.editor.rootElement;\n\n    if (!this.inlineRangeProvider) {\n      this.editor.disposables.addFromEvent(\n        document,\n        'selectionchange',\n        this._onSelectionChange\n      );\n    }\n\n    if (!eventSource) {\n      console.error('Mount inline editor without event source ready');\n      return;\n    }\n\n    this.editor.disposables.addFromEvent(\n      eventSource,\n      'beforeinput',\n      this._onBeforeInput\n    );\n    this.editor.disposables.addFromEvent(\n      eventSource,\n      'compositionstart',\n      this._onCompositionStart\n    );\n    this.editor.disposables.addFromEvent(\n      eventSource,\n      'compositionupdate',\n      this._onCompositionUpdate\n    );\n    this.editor.disposables.addFromEvent(\n      eventSource,\n      'compositionend',\n      (event: CompositionEvent) => {\n        this._onCompositionEnd(event).catch(console.error);\n      }\n    );\n    this.editor.disposables.addFromEvent(\n      eventSource,\n      'keydown',\n      this._onKeyDown\n    );\n    this.editor.disposables.addFromEvent(rootElement, 'click', this._onClick);\n  };\n\n  get inlineRangeProvider() {\n    return this.editor.inlineRangeProvider;\n  }\n\n  get isComposing() {\n    return this._isComposing;\n  }\n\n  constructor(readonly editor: InlineEditor<TextAttributes>) {}\n}\n"]}