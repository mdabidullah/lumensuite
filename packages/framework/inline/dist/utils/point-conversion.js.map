{"version":3,"file":"point-conversion.js","sourceRoot":"","sources":["../../src/utils/point-conversion.ts"],"names":[],"mappings":"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","sourcesContent":["import { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\n\nimport type { VElement, VLine } from '../components/index.js';\nimport type { DomPoint, TextPoint } from '../types.js';\n\nimport { INLINE_ROOT_ATTR, ZERO_WIDTH_SPACE } from '../consts.js';\nimport {\n  isInlineRoot,\n  isNativeTextInVText,\n  isVElement,\n  isVLine,\n} from './guard.js';\nimport { calculateTextLength, getTextNodesFromElement } from './text.js';\n\nexport function nativePointToTextPoint(\n  node: unknown,\n  offset: number\n): TextPoint | null {\n  if (isNativeTextInVText(node)) {\n    return [node, offset];\n  }\n\n  if (isVElement(node)) {\n    const texts = getTextNodesFromElement(node);\n    const vElement = texts[0].parentElement?.closest('[data-v-element=\"true\"]');\n\n    if (\n      texts.length === 1 &&\n      vElement instanceof HTMLElement &&\n      vElement.dataset.vEmbed === 'true'\n    ) {\n      return [texts[0], 0];\n    }\n\n    if (texts.length > 0) {\n      return texts[offset] ? [texts[offset], 0] : null;\n    }\n  }\n\n  if (isVLine(node) || isInlineRoot(node)) {\n    return getTextPointRoughlyFromElementByOffset(node, offset, true);\n  }\n\n  if (!(node instanceof Node)) {\n    return null;\n  }\n\n  const vNodes = getVNodesFromNode(node);\n\n  if (vNodes) {\n    return getTextPointFromVNodes(vNodes, node, offset);\n  }\n\n  return null;\n}\n\nexport function textPointToDomPoint(\n  text: Text,\n  offset: number,\n  rootElement: HTMLElement\n): DomPoint | null {\n  if (rootElement.dataset.vRoot !== 'true') {\n    throw new BlockSuiteError(\n      ErrorCode.InlineEditorError,\n      'textRangeToDomPoint should be called with editor root element'\n    );\n  }\n\n  if (!rootElement.contains(text)) return null;\n\n  const texts = getTextNodesFromElement(rootElement);\n  if (texts.length === 0) return null;\n\n  const goalIndex = texts.indexOf(text);\n  let index = 0;\n  for (const text of texts.slice(0, goalIndex)) {\n    index += calculateTextLength(text);\n  }\n\n  if (text.wholeText !== ZERO_WIDTH_SPACE) {\n    index += offset;\n  }\n\n  const textParentElement = text.parentElement;\n  if (!textParentElement) {\n    throw new BlockSuiteError(\n      ErrorCode.InlineEditorError,\n      'text element parent not found'\n    );\n  }\n\n  const lineElement = textParentElement.closest('v-line');\n\n  if (!lineElement) {\n    throw new BlockSuiteError(\n      ErrorCode.InlineEditorError,\n      'line element not found'\n    );\n  }\n\n  const lineIndex = Array.from(rootElement.querySelectorAll('v-line')).indexOf(\n    lineElement\n  );\n\n  return { text, index: index + lineIndex };\n}\n\nfunction getVNodesFromNode(node: Node): VElement[] | VLine[] | null {\n  const vLine = node.parentElement?.closest('v-line');\n\n  if (vLine) {\n    return Array.from(vLine.querySelectorAll('v-element'));\n  }\n\n  const container =\n    node instanceof Element\n      ? node.closest(`[${INLINE_ROOT_ATTR}]`)\n      : node.parentElement?.closest(`[${INLINE_ROOT_ATTR}]`);\n\n  if (container) {\n    return Array.from(container.querySelectorAll('v-line'));\n  }\n\n  return null;\n}\n\nfunction getTextPointFromVNodes(\n  vNodes: VLine[] | VElement[],\n  node: Node,\n  offset: number\n): TextPoint | null {\n  const first = vNodes[0];\n  for (let i = 0; i < vNodes.length; i++) {\n    const vNode = vNodes[i];\n\n    if (i === 0 && AFollowedByB(node, vNode)) {\n      return getTextPointRoughlyFromElementByOffset(first, offset, true);\n    }\n\n    if (AInsideB(node, vNode)) {\n      return getTextPointRoughlyFromElementByOffset(first, offset, false);\n    }\n\n    if (i === vNodes.length - 1 && APrecededByB(node, vNode)) {\n      return getTextPointRoughlyFromElement(vNode);\n    }\n\n    if (\n      i < vNodes.length - 1 &&\n      APrecededByB(node, vNode) &&\n      AFollowedByB(node, vNodes[i + 1])\n    ) {\n      return getTextPointRoughlyFromElement(vNode);\n    }\n  }\n\n  return null;\n}\n\nfunction getTextPointRoughlyFromElement(element: Element): TextPoint | null {\n  const texts = getTextNodesFromElement(element);\n  if (texts.length === 0) return null;\n  const text = texts[texts.length - 1];\n  return [text, calculateTextLength(text)];\n}\n\nfunction getTextPointRoughlyFromElementByOffset(\n  element: Element,\n  offset: number,\n  fromStart: boolean\n): TextPoint | null {\n  const texts = getTextNodesFromElement(element);\n  if (texts.length === 0) return null;\n  const text = fromStart ? texts[0] : texts[texts.length - 1];\n  return [text, offset === 0 ? offset : text.length];\n}\n\nfunction AInsideB(a: Node, b: Node): boolean {\n  return (\n    b.compareDocumentPosition(a) === Node.DOCUMENT_POSITION_CONTAINED_BY ||\n    b.compareDocumentPosition(a) ===\n      (Node.DOCUMENT_POSITION_CONTAINED_BY | Node.DOCUMENT_POSITION_FOLLOWING)\n  );\n}\n\nfunction AFollowedByB(a: Node, b: Node): boolean {\n  return a.compareDocumentPosition(b) === Node.DOCUMENT_POSITION_FOLLOWING;\n}\n\nfunction APrecededByB(a: Node, b: Node): boolean {\n  return a.compareDocumentPosition(b) === Node.DOCUMENT_POSITION_PRECEDING;\n}\n"]}