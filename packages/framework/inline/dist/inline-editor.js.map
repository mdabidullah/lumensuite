{"version":3,"file":"inline-editor.js","sourceRoot":"","sources":["../src/inline-editor.ts"],"names":[],"mappings":"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","sourcesContent":["import { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport { assertExists, DisposableGroup, Slot } from '@blocksuite/global/utils';\nimport { nothing, render, type TemplateResult } from 'lit';\nimport * as Y from 'yjs';\n\nimport type { VLine } from './components/v-line.js';\nimport type {\n  DeltaInsert,\n  InlineRange,\n  InlineRangeUpdatedProp,\n} from './types.js';\n\nimport { INLINE_ROOT_ATTR } from './consts.js';\nimport { InlineHookService } from './services/hook.js';\nimport {\n  AttributeService,\n  DeltaService,\n  EventService,\n  RangeService,\n} from './services/index.js';\nimport { InlineTextService } from './services/text.js';\nimport {\n  type BaseTextAttributes,\n  nativePointToTextPoint,\n  textPointToDomPoint,\n} from './utils/index.js';\nimport { getTextNodesFromElement } from './utils/text.js';\n\nexport type InlineRootElement<\n  T extends BaseTextAttributes = BaseTextAttributes,\n> = HTMLElement & {\n  inlineEditor: InlineEditor<T>;\n};\n\nexport interface InlineRangeProvider {\n  inlineRangeUpdated: Slot<InlineRangeUpdatedProp>;\n  getInlineRange(): InlineRange | null;\n  setInlineRange(inlineRange: InlineRange | null, sync: boolean): void;\n}\n\nexport class InlineEditor<\n  TextAttributes extends BaseTextAttributes = BaseTextAttributes,\n> {\n  static getTextNodesFromElement = getTextNodesFromElement;\n\n  static nativePointToTextPoint = nativePointToTextPoint;\n\n  static textPointToDomPoint = textPointToDomPoint;\n\n  private _attributeService: AttributeService<TextAttributes> =\n    new AttributeService<TextAttributes>(this);\n\n  private _deltaService: DeltaService<TextAttributes> =\n    new DeltaService<TextAttributes>(this);\n\n  private _disposables = new DisposableGroup();\n\n  private _eventService: EventService<TextAttributes> =\n    new EventService<TextAttributes>(this);\n\n  private _eventSource: HTMLElement | null = null;\n\n  private _hooksService: InlineHookService<TextAttributes>;\n\n  private _isReadonly = false;\n\n  private _mounted = false;\n\n  private _onYTextChange = (_: Y.YTextEvent, transaction: Y.Transaction) => {\n    if (this.yText.toString().includes('\\r')) {\n      throw new BlockSuiteError(\n        ErrorCode.InlineEditorError,\n        'yText must not contain \"\\\\r\" because it will break the range synchronization'\n      );\n    }\n\n    this.slots.textChange.emit();\n\n    Promise.resolve()\n      .then(() => {\n        this.deltaService.render().catch(console.error);\n\n        const inlineRange = this.rangeService.getInlineRange();\n        if (!inlineRange || transaction.local) return;\n\n        const lastStartRelativePosition =\n          this.rangeService.lastStartRelativePosition;\n        const lastEndRelativePosition =\n          this.rangeService.lastEndRelativePosition;\n        if (!lastStartRelativePosition || !lastEndRelativePosition) return;\n\n        const doc = this.yText.doc;\n        assertExists(doc);\n        const absoluteStart = Y.createAbsolutePositionFromRelativePosition(\n          lastStartRelativePosition,\n          doc\n        );\n        const absoluteEnd = Y.createAbsolutePositionFromRelativePosition(\n          lastEndRelativePosition,\n          doc\n        );\n\n        const startIndex = absoluteStart?.index;\n        const endIndex = absoluteEnd?.index;\n        if (!startIndex || !endIndex) return;\n\n        const newInlineRange: InlineRange = {\n          index: startIndex,\n          length: endIndex - startIndex,\n        };\n        if (!this.isValidInlineRange(newInlineRange)) return;\n\n        this.setInlineRange(newInlineRange);\n      })\n      .catch(console.error);\n  };\n\n  private _rangeService: RangeService<TextAttributes> =\n    new RangeService<TextAttributes>(this);\n\n  private _rootElement: InlineRootElement<TextAttributes> | null = null;\n\n  private _textService: InlineTextService<TextAttributes> =\n    new InlineTextService<TextAttributes>(this);\n\n  private readonly _yText: Y.Text;\n\n  // Expose text service API\n  deleteText = this._textService.deleteText;\n\n  focusEnd = this.rangeService.focusEnd;\n\n  focusIndex = this.rangeService.focusIndex;\n\n  focusStart = this.rangeService.focusStart;\n\n  formatText = this._textService.formatText;\n\n  getDeltaByRangeIndex = this.deltaService.getDeltaByRangeIndex;\n\n  // Expose delta service API\n  getDeltasByInlineRange = this.deltaService.getDeltasByInlineRange;\n\n  getFormat = this._attributeService.getFormat;\n\n  getInlineRange = this.rangeService.getInlineRange;\n\n  getInlineRangeFromElement = this.rangeService.getInlineRangeFromElement;\n\n  getLine = this.rangeService.getLine;\n\n  getNativeSelection = this.rangeService.getNativeSelection;\n\n  getTextPoint = this.rangeService.getTextPoint;\n\n  readonly inlineRangeProvider: InlineRangeProvider | null;\n\n  insertLineBreak = this._textService.insertLineBreak;\n\n  insertText = this._textService.insertText;\n\n  readonly isEmbed: (delta: DeltaInsert<TextAttributes>) => boolean;\n\n  isFirstLine = this.rangeService.isFirstLine;\n\n  isLastLine = this.rangeService.isLastLine;\n\n  isValidInlineRange = this.rangeService.isValidInlineRange;\n\n  mapDeltasInInlineRange = this.deltaService.mapDeltasInInlineRange;\n\n  resetMarks = this._attributeService.resetMarks;\n\n  resetText = this._textService.resetText;\n\n  selectAll = this.rangeService.selectAll;\n\n  setAttributeRenderer = this._attributeService.setAttributeRenderer;\n\n  setAttributeSchema = this._attributeService.setAttributeSchema;\n\n  setInlineRange = this.rangeService.setInlineRange;\n\n  setMarks = this._attributeService.setMarks;\n\n  setText = this._textService.setText;\n\n  readonly slots = {\n    mounted: new Slot(),\n    unmounted: new Slot(),\n    textChange: new Slot(),\n    render: new Slot(),\n    renderComplete: new Slot(),\n    inlineRangeUpdate: new Slot<InlineRangeUpdatedProp>(),\n    inlineRangeApply: new Slot<Range>(),\n    /**\n     * Corresponding to the `compositionUpdate` and `beforeInput` events, and triggered only when the `inlineRange` is not null.\n     */\n    inputting: new Slot(),\n    /**\n     * Triggered only when the `inlineRange` is not null.\n     */\n    keydown: new Slot<KeyboardEvent>(),\n  };\n\n  syncInlineRange = this.rangeService.syncInlineRange;\n\n  // Expose range service API\n  toDomRange = this.rangeService.toDomRange;\n\n  toInlineRange = this.rangeService.toInlineRange;\n\n  readonly vLineRenderer: ((vLine: VLine) => TemplateResult) | null;\n\n  get attributeService() {\n    return this._attributeService;\n  }\n\n  get deltaService() {\n    return this._deltaService;\n  }\n\n  get disposables() {\n    return this._disposables;\n  }\n\n  get eventService() {\n    return this._eventService;\n  }\n\n  get eventSource() {\n    return this._eventSource;\n  }\n\n  // Expose hook service API\n  get hooks() {\n    return this._hooksService.hooks;\n  }\n\n  // Expose event service API\n  get isComposing() {\n    return this._eventService.isComposing;\n  }\n\n  get isReadonly() {\n    return this._isReadonly;\n  }\n\n  // Expose attribute service API\n  get marks() {\n    return this._attributeService.marks;\n  }\n\n  get mounted() {\n    return this._mounted;\n  }\n\n  get rangeService() {\n    return this._rangeService;\n  }\n\n  get rootElement() {\n    assertExists(this._rootElement);\n    return this._rootElement;\n  }\n\n  get yText() {\n    return this._yText;\n  }\n\n  get yTextDeltas() {\n    return this.yText.toDelta();\n  }\n\n  get yTextLength() {\n    return this.yText.length;\n  }\n\n  get yTextString() {\n    return this.yText.toString();\n  }\n\n  constructor(\n    yText: InlineEditor['yText'],\n    ops: {\n      isEmbed?: (delta: DeltaInsert<TextAttributes>) => boolean;\n      hooks?: InlineHookService<TextAttributes>['hooks'];\n      inlineRangeProvider?: InlineRangeProvider;\n      vLineRenderer?: (vLine: VLine) => TemplateResult;\n    } = {}\n  ) {\n    if (!yText.doc) {\n      throw new BlockSuiteError(\n        ErrorCode.InlineEditorError,\n        'yText must be attached to a Y.Doc'\n      );\n    }\n\n    if (yText.toString().includes('\\r')) {\n      throw new BlockSuiteError(\n        ErrorCode.InlineEditorError,\n        'yText must not contain \"\\\\r\" because it will break the range synchronization'\n      );\n    }\n\n    const {\n      isEmbed = () => false,\n      hooks = {},\n      inlineRangeProvider = null,\n      vLineRenderer = null,\n    } = ops;\n    this._yText = yText;\n    this.isEmbed = isEmbed;\n    this.vLineRenderer = vLineRenderer;\n    this._hooksService = new InlineHookService(this, hooks);\n    this.inlineRangeProvider = inlineRangeProvider;\n\n    if (inlineRangeProvider) {\n      inlineRangeProvider.inlineRangeUpdated.on(prop => {\n        this.slots.inlineRangeUpdate.emit(prop);\n      });\n    }\n    this.slots.inlineRangeUpdate.on(this.rangeService.onInlineRangeUpdated);\n  }\n\n  private _bindYTextObserver() {\n    this.yText.observe(this._onYTextChange);\n    this.disposables.add({\n      dispose: () => {\n        this.yText.unobserve(this._onYTextChange);\n      },\n    });\n  }\n\n  mount(\n    rootElement: HTMLElement,\n    eventSource: HTMLElement = rootElement,\n    isReadonly = false\n  ) {\n    const inlineRoot = rootElement as InlineRootElement<TextAttributes>;\n    inlineRoot.inlineEditor = this;\n    this._rootElement = inlineRoot;\n    this._eventSource = eventSource;\n    this._eventSource.style.outline = 'none';\n    this._rootElement.dataset.vRoot = 'true';\n    this.setReadonly(isReadonly);\n    render(nothing, this._rootElement);\n\n    this._bindYTextObserver();\n\n    this._eventService.mount();\n\n    this._mounted = true;\n    this.slots.mounted.emit();\n    this._deltaService.render().catch(console.error);\n  }\n\n  requestUpdate(syncInlineRange = true): void {\n    this._deltaService.render(syncInlineRange).catch(console.error);\n  }\n\n  rerenderWholeEditor() {\n    if (!this.rootElement.isConnected) return;\n    render(nothing, this.rootElement);\n    this._deltaService.render().catch(console.error);\n  }\n\n  setReadonly(isReadonly: boolean): void {\n    const value = isReadonly ? 'false' : 'true';\n\n    if (this.rootElement.contentEditable !== value) {\n      this.rootElement.contentEditable = value;\n    }\n\n    if (this.eventSource && this.eventSource.contentEditable !== value) {\n      this.eventSource.contentEditable = value;\n    }\n\n    this._isReadonly = isReadonly;\n  }\n\n  transact(fn: () => void): void {\n    const doc = this.yText.doc;\n    if (!doc) {\n      throw new BlockSuiteError(\n        ErrorCode.InlineEditorError,\n        'yText is not attached to a doc'\n      );\n    }\n\n    doc.transact(fn, doc.clientID);\n  }\n\n  unmount() {\n    if (this.rootElement.isConnected) {\n      render(nothing, this.rootElement);\n    }\n    this.rootElement.removeAttribute(INLINE_ROOT_ATTR);\n    this._rootElement = null;\n    this._mounted = false;\n    this.disposables.dispose();\n    this.slots.unmounted.emit();\n  }\n\n  async waitForUpdate() {\n    const vLines = Array.from(this.rootElement.querySelectorAll('v-line'));\n    await Promise.all(vLines.map(line => line.updateComplete));\n  }\n}\n"]}