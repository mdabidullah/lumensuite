{"version":3,"file":"v-line.js","sourceRoot":"","sources":["../../src/components/v-line.ts"],"names":[],"mappings":"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","sourcesContent":["import { LumenSuiteError, ErrorCode } from '@lumensuite/global/exceptions';\nimport { assertExists } from '@lumensuite/global/utils';\nimport { html, LitElement, type TemplateResult } from 'lit';\nimport { customElement, property } from 'lit/decorators.js';\nimport { styleMap } from 'lit/directives/style-map.js';\n\nimport type { InlineRootElement } from '../inline-editor.js';\nimport type { DeltaInsert } from '../types.js';\n\nimport { INLINE_ROOT_ATTR, ZERO_WIDTH_SPACE } from '../consts.js';\nimport { EmbedGap } from './embed-gap.js';\n\n@customElement('v-line')\nexport class VLine extends LitElement {\n  get inlineEditor() {\n    const rootElement = this.closest(\n      `[${INLINE_ROOT_ATTR}]`\n    ) as InlineRootElement;\n    assertExists(rootElement, 'v-line must be inside a v-root');\n    const inlineEditor = rootElement.inlineEditor;\n    assertExists(\n      inlineEditor,\n      'v-line must be inside a v-root with inline-editor'\n    );\n\n    return inlineEditor;\n  }\n\n  get vElements() {\n    return Array.from(this.querySelectorAll('v-element'));\n  }\n\n  get vTextContent() {\n    return this.vElements.reduce((acc, el) => acc + el.delta.insert, '');\n  }\n\n  get vTextLength() {\n    return this.vElements.reduce((acc, el) => acc + el.delta.insert.length, 0);\n  }\n\n  // you should use vElements.length or vTextLength because v-element corresponds to the actual delta\n  get vTexts() {\n    return Array.from(this.querySelectorAll('v-text'));\n  }\n\n  override createRenderRoot() {\n    return this;\n  }\n\n  protected override firstUpdated(): void {\n    this.style.display = 'block';\n\n    this.addEventListener('mousedown', e => {\n      if (e.detail >= 3) {\n        e.preventDefault();\n\n        const range = document.createRange();\n        range.selectNodeContents(this);\n        const selection = window.getSelection();\n        assertExists(selection);\n        selection.removeAllRanges();\n        selection.addRange(range);\n      }\n    });\n  }\n\n  // vTexts.length > 0 does not mean the line is not empty,\n  override async getUpdateComplete() {\n    const result = await super.getUpdateComplete();\n    await Promise.all(this.vElements.map(el => el.updateComplete));\n    await Promise.all(this.vTexts.map(el => el.updateComplete));\n    return result;\n  }\n\n  override render() {\n    if (!this.isConnected) return;\n\n    if (this.inlineEditor.vLineRenderer) {\n      return this.inlineEditor.vLineRenderer(this);\n    }\n    return this.renderVElements();\n  }\n\n  renderVElements() {\n    if (this.elements.length === 0) {\n      // don't use v-element because it not correspond to the actual delta\n      return html`<div><v-text .str=${ZERO_WIDTH_SPACE}></v-text></div>`;\n    }\n\n    const inlineEditor = this.inlineEditor;\n    const renderElements = this.elements.flatMap(([template, delta], index) => {\n      if (inlineEditor.isEmbed(delta)) {\n        if (delta.insert.length !== 1) {\n          throw new LumenSuiteError(\n            ErrorCode.InlineEditorError,\n            `The length of embed node should only be 1.\n            This seems to be an internal issue with inline editor.\n            Please go to https://github.com/toeverything/lumensuite/issues\n            to report it.`\n          );\n        }\n        // we add `EmbedGap` to make cursor can be placed between embed elements\n        if (index === 0) {\n          const nextDelta = this.elements[index + 1]?.[1];\n          if (!nextDelta || inlineEditor.isEmbed(nextDelta)) {\n            return [EmbedGap, template, EmbedGap];\n          } else {\n            return [EmbedGap, template];\n          }\n        } else {\n          const nextDelta = this.elements[index + 1]?.[1];\n          if (!nextDelta || inlineEditor.isEmbed(nextDelta)) {\n            return [template, EmbedGap];\n          } else {\n            return [template];\n          }\n        }\n      }\n      return template;\n    });\n\n    // prettier will generate \\n and cause unexpected space and line break\n    // prettier-ignore\n    return html`<div style=${styleMap({\n      // this padding is used to make cursor can be placed at the\n      // start and end of the line when the first and last element is embed element\n      padding: '0 0.5px',\n      display: 'inline-block',\n    })}>${renderElements}</div>`;\n  }\n\n  @property({ attribute: false })\n  accessor elements: [TemplateResult<1>, DeltaInsert][] = [];\n\n  @property({ attribute: false })\n  accessor index!: number;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'v-line': VLine;\n  }\n}\n"]}