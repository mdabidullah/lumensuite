{"version":3,"file":"dispatcher.js","sourceRoot":"","sources":["../../src/event/dispatcher.ts"],"names":[],"mappings":"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","sourcesContent":["import { LumenSuiteError, ErrorCode } from '@lumensuite/global/exceptions';\nimport { DisposableGroup } from '@lumensuite/global/utils';\n\nimport type { BlockComponent } from '../view/index.js';\n\nimport { LifeCycleWatcher } from '../extension/index.js';\nimport {\n  type UIEventHandler,\n  UIEventState,\n  UIEventStateContext,\n} from './base.js';\nimport { ClipboardControl } from './control/clipboard.js';\nimport { KeyboardControl } from './control/keyboard.js';\nimport { PointerControl } from './control/pointer.js';\nimport { RangeControl } from './control/range.js';\nimport { EventScopeSourceType, EventSourceState } from './state/source.js';\nimport { toLowerCase } from './utils.js';\n\nconst bypassEventNames = [\n  'beforeInput',\n\n  'blur',\n  'focus',\n  'drop',\n  'contextMenu',\n  'wheel',\n] as const;\n\nconst eventNames = [\n  'click',\n  'doubleClick',\n  'tripleClick',\n\n  'pointerDown',\n  'pointerMove',\n  'pointerUp',\n  'pointerOut',\n\n  'dragStart',\n  'dragMove',\n  'dragEnd',\n\n  'pinch',\n  'pan',\n\n  'keyDown',\n  'keyUp',\n\n  'selectionChange',\n  'compositionStart',\n  'compositionUpdate',\n  'compositionEnd',\n\n  'cut',\n  'copy',\n  'paste',\n\n  ...bypassEventNames,\n] as const;\n\nexport type EventName = (typeof eventNames)[number];\nexport type EventOptions = {\n  flavour?: string;\n  blockId?: string;\n};\nexport type EventHandlerRunner = {\n  fn: UIEventHandler;\n  flavour?: string;\n  blockId?: string;\n};\n\nexport class UIEventDispatcher extends LifeCycleWatcher {\n  private static _activeDispatcher: UIEventDispatcher | null = null;\n\n  static override readonly key = 'UIEventDispatcher';\n\n  private _active = false;\n\n  private _clipboardControl: ClipboardControl;\n\n  private _handlersMap = Object.fromEntries(\n    eventNames.map((name): [EventName, Array<EventHandlerRunner>] => [name, []])\n  ) as Record<EventName, Array<EventHandlerRunner>>;\n\n  private _keyboardControl: KeyboardControl;\n\n  private _pointerControl: PointerControl;\n\n  private _rangeControl: RangeControl;\n\n  bindHotkey = (...args: Parameters<KeyboardControl['bindHotkey']>) =>\n    this._keyboardControl.bindHotkey(...args);\n\n  disposables = new DisposableGroup();\n\n  private get _currentSelections() {\n    return this.std.selection.value;\n  }\n\n  get active() {\n    return this._active;\n  }\n\n  get host() {\n    return this.std.host;\n  }\n\n  constructor(std: LumenSuite.Std) {\n    super(std);\n    this._pointerControl = new PointerControl(this);\n    this._keyboardControl = new KeyboardControl(this);\n    this._rangeControl = new RangeControl(this);\n    this._clipboardControl = new ClipboardControl(this);\n  }\n\n  private _bindEvents() {\n    bypassEventNames.forEach(eventName => {\n      this.disposables.addFromEvent(\n        this.host,\n        toLowerCase(eventName),\n        event => {\n          this.run(\n            eventName,\n            UIEventStateContext.from(\n              new UIEventState(event),\n              new EventSourceState({\n                event,\n                sourceType: EventScopeSourceType.Selection,\n              })\n            )\n          );\n        },\n        eventName === 'wheel'\n          ? {\n              passive: false,\n            }\n          : undefined\n      );\n    });\n\n    this._pointerControl.listen();\n    this._keyboardControl.listen();\n    this._rangeControl.listen();\n    this._clipboardControl.listen();\n\n    let _dragging = false;\n    this.disposables.addFromEvent(this.host, 'pointerdown', () => {\n      _dragging = true;\n      this._setActive(true);\n    });\n    this.disposables.addFromEvent(this.host, 'pointerup', () => {\n      _dragging = false;\n    });\n    this.disposables.addFromEvent(this.host, 'click', () => {\n      this._setActive(true);\n    });\n    this.disposables.addFromEvent(this.host, 'focusin', () => {\n      this._setActive(true);\n    });\n    this.disposables.addFromEvent(this.host, 'focusout', e => {\n      if (e.relatedTarget && !this.host.contains(e.relatedTarget as Node)) {\n        this._setActive(false);\n      }\n    });\n    this.disposables.addFromEvent(this.host, 'blur', () => {\n      if (_dragging) {\n        return;\n      }\n\n      this._setActive(false);\n    });\n    this.disposables.addFromEvent(this.host, 'pointerenter', () => {\n      if (this._isActiveElementOutsideHost()) {\n        return;\n      }\n\n      this._setActive(true);\n    });\n    this.disposables.addFromEvent(this.host, 'pointerleave', () => {\n      if (\n        (document.activeElement &&\n          this.host.contains(document.activeElement)) ||\n        _dragging\n      ) {\n        return;\n      }\n\n      this._setActive(false);\n    });\n  }\n\n  private _buildEventScopeBySelection(name: EventName) {\n    const handlers = this._handlersMap[name];\n    if (!handlers) return;\n\n    const selections = this._currentSelections;\n    const ids = selections.map(selection => selection.blockId);\n\n    return this.buildEventScope(name, ids);\n  }\n\n  private _buildEventScopeByTarget(name: EventName, target: Node) {\n    const handlers = this._handlersMap[name];\n    if (!handlers) return;\n\n    // TODO(mirone/#6534): find a better way to get block element from a node\n    const el = target instanceof Element ? target : target.parentElement;\n    const block = el?.closest<BlockComponent>('[data-block-id]');\n\n    const blockId = block?.blockId;\n    if (!blockId) {\n      return this._buildEventScopeBySelection(name);\n    }\n\n    return this.buildEventScope(name, [blockId]);\n  }\n\n  private _getDeepActiveElement(): Element | null {\n    let active = document.activeElement;\n    while (active && active.shadowRoot && active.shadowRoot.activeElement) {\n      active = active.shadowRoot.activeElement;\n    }\n    return active;\n  }\n\n  private _getEventScope(name: EventName, state: EventSourceState) {\n    const handlers = this._handlersMap[name];\n    if (!handlers) return;\n\n    let output: EventHandlerRunner[] | undefined;\n\n    switch (state.sourceType) {\n      case EventScopeSourceType.Selection: {\n        output = this._buildEventScopeBySelection(name);\n        break;\n      }\n      case EventScopeSourceType.Target: {\n        output = this._buildEventScopeByTarget(\n          name,\n          state.event.target as Node\n        );\n        break;\n      }\n      default: {\n        throw new LumenSuiteError(\n          ErrorCode.EventDispatcherError,\n          `Unknown event scope source: ${state.sourceType}`\n        );\n      }\n    }\n\n    return output;\n  }\n\n  private _isActiveElementOutsideHost(): boolean {\n    const activeElement = this._getDeepActiveElement();\n    return (\n      activeElement !== null &&\n      this._isEditableElementActive(activeElement) &&\n      !this.host.contains(activeElement)\n    );\n  }\n\n  private _isEditableElementActive(element: Element | null): boolean {\n    if (!element) return false;\n    return (\n      element instanceof HTMLInputElement ||\n      element instanceof HTMLTextAreaElement ||\n      (element as HTMLElement).isContentEditable\n    );\n  }\n\n  private _setActive(active: boolean) {\n    if (active) {\n      if (UIEventDispatcher._activeDispatcher !== this) {\n        if (UIEventDispatcher._activeDispatcher) {\n          UIEventDispatcher._activeDispatcher._active = false;\n        }\n        UIEventDispatcher._activeDispatcher = this;\n      }\n      this._active = true;\n    } else {\n      if (UIEventDispatcher._activeDispatcher === this) {\n        UIEventDispatcher._activeDispatcher = null;\n      }\n      this._active = false;\n    }\n  }\n\n  add(name: EventName, handler: UIEventHandler, options?: EventOptions) {\n    const runner: EventHandlerRunner = {\n      fn: handler,\n      flavour: options?.flavour,\n      blockId: options?.blockId,\n    };\n    this._handlersMap[name].unshift(runner);\n    return () => {\n      if (this._handlersMap[name].includes(runner)) {\n        this._handlersMap[name] = this._handlersMap[name].filter(\n          x => x !== runner\n        );\n      }\n    };\n  }\n\n  buildEventScope(\n    name: EventName,\n    blocks: string[]\n  ): EventHandlerRunner[] | undefined {\n    const handlers = this._handlersMap[name];\n    if (!handlers) return;\n\n    const globalEvents = handlers.filter(\n      handler => handler.flavour === undefined && handler.blockId === undefined\n    );\n\n    let blockIds: string[] = blocks;\n    const events: EventHandlerRunner[] = [];\n    const flavourSeen: Record<string, boolean> = {};\n    while (blockIds.length > 0) {\n      const idHandlers = handlers.filter(\n        handler => handler.blockId && blockIds.includes(handler.blockId)\n      );\n\n      const flavourHandlers = blockIds\n        .map(blockId => this.std.doc.getBlock(blockId)?.flavour)\n        .filter((flavour): flavour is string => {\n          if (!flavour) return false;\n          if (flavourSeen[flavour]) return false;\n          flavourSeen[flavour] = true;\n          return true;\n        })\n        .flatMap(flavour => {\n          return handlers.filter(handler => handler.flavour === flavour);\n        });\n\n      events.push(...idHandlers, ...flavourHandlers);\n      blockIds = blockIds\n        .map(blockId => {\n          const parent = this.std.doc.getParent(blockId);\n          return parent?.id;\n        })\n        .filter((id): id is string => !!id);\n    }\n\n    return events.concat(globalEvents);\n  }\n\n  override mounted() {\n    if (this.disposables.disposed) {\n      this.disposables = new DisposableGroup();\n    }\n    this._bindEvents();\n  }\n\n  run(\n    name: EventName,\n    context: UIEventStateContext,\n    runners?: EventHandlerRunner[]\n  ) {\n    if (!this.active) return;\n\n    const sourceState = context.get('sourceState');\n    if (!runners) {\n      runners = this._getEventScope(name, sourceState);\n      if (!runners) {\n        return;\n      }\n    }\n    for (const runner of runners) {\n      const { fn } = runner;\n      const result = fn(context);\n      if (result) {\n        context.get('defaultState').event.stopPropagation();\n        return;\n      }\n    }\n  }\n\n  override unmounted() {\n    this.disposables.dispose();\n  }\n}\n"]}