{"version":3,"file":"keymap.js","sourceRoot":"","sources":["../../src/event/keymap.ts"],"names":[],"mappings":"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","sourcesContent":["import { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport { base, keyName } from 'w3c-keyname';\n\nimport type { UIEventHandler } from './base.js';\n\nconst mac =\n  typeof navigator !== 'undefined'\n    ? /Mac|iP(hone|[oa]d)/.test(navigator.platform)\n    : false;\n\nfunction normalizeKeyName(name: string) {\n  const parts = name.split(/-(?!$)/);\n  let result = parts.at(-1);\n  if (result === 'Space') {\n    result = ' ';\n  }\n  let alt, ctrl, shift, meta;\n  parts.slice(0, -1).forEach(mod => {\n    if (/^(cmd|meta|m)$/i.test(mod)) {\n      meta = true;\n      return;\n    }\n    if (/^a(lt)?$/i.test(mod)) {\n      alt = true;\n      return;\n    }\n    if (/^(c|ctrl|control)$/i.test(mod)) {\n      ctrl = true;\n      return;\n    }\n    if (/^s(hift)?$/i.test(mod)) {\n      shift = true;\n      return;\n    }\n    if (/^mod$/i.test(mod)) {\n      if (mac) {\n        meta = true;\n      } else {\n        ctrl = true;\n      }\n      return;\n    }\n\n    throw new BlockSuiteError(\n      ErrorCode.EventDispatcherError,\n      'Unrecognized modifier name: ' + mod\n    );\n  });\n  if (alt) result = 'Alt-' + result;\n  if (ctrl) result = 'Ctrl-' + result;\n  if (meta) result = 'Meta-' + result;\n  if (shift) result = 'Shift-' + result;\n  return result as string;\n}\n\nfunction modifiers(name: string, event: KeyboardEvent, shift = true) {\n  if (event.altKey) name = 'Alt-' + name;\n  if (event.ctrlKey) name = 'Ctrl-' + name;\n  if (event.metaKey) name = 'Meta-' + name;\n  if (shift && event.shiftKey) name = 'Shift-' + name;\n  return name;\n}\n\nfunction normalize(map: Record<string, UIEventHandler>) {\n  const copy: Record<string, UIEventHandler> = Object.create(null);\n  for (const prop in map) copy[normalizeKeyName(prop)] = map[prop];\n  return copy;\n}\n\nexport function bindKeymap(\n  bindings: Record<string, UIEventHandler>\n): UIEventHandler {\n  const map = normalize(bindings);\n  return ctx => {\n    const state = ctx.get('keyboardState');\n    const event = state.raw;\n    const name = keyName(event);\n    const direct = map[modifiers(name, event)];\n    if (direct && direct(ctx)) {\n      return true;\n    }\n    if (name.length !== 1 || name === ' ') {\n      return false;\n    }\n\n    if (event.shiftKey) {\n      const noShift = map[modifiers(name, event, false)];\n      if (noShift && noShift(ctx)) {\n        return true;\n      }\n    }\n\n    // none standard keyboard, fallback to keyCode\n    const special =\n      event.shiftKey ||\n      event.altKey ||\n      event.metaKey ||\n      name.charCodeAt(0) > 127;\n    const baseName = base[event.keyCode];\n    if (special && baseName && baseName !== name) {\n      const fromCode = map[modifiers(baseName, event)];\n      if (fromCode && fromCode(ctx)) {\n        return true;\n      }\n    }\n\n    return false;\n  };\n}\n"]}