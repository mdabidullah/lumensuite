{"version":3,"file":"block-component.js","sourceRoot":"","sources":["../../../src/view/element/block-component.ts"],"names":[],"mappings":"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","sourcesContent":["import { LumenSuiteError, ErrorCode } from '@lumensuite/global/exceptions';\nimport { Doc } from '@lumensuite/store';\nimport { type BlockModel, BlockViewType } from '@lumensuite/store';\nimport { consume, provide } from '@lit/context';\nimport { computed } from '@lit-labs/preact-signals';\nimport { nothing, type PropertyValues, render, type TemplateResult } from 'lit';\nimport { property, state } from 'lit/decorators.js';\nimport { choose } from 'lit/directives/choose.js';\nimport { when } from 'lit/directives/when.js';\nimport { html } from 'lit/static-html.js';\n\nimport type { EventName, UIEventHandler } from '../../event/index.js';\nimport type { BlockService } from '../../extension/index.js';\nimport type { BlockStdScope } from '../../scope/index.js';\nimport type { WidgetComponent } from './widget-component.js';\n\nimport { PropTypes, requiredProperties } from '../decorators/index.js';\nimport { SignalWatcher } from '../signal-watcher.js';\nimport { WithDisposable } from '../utils/with-disposable.js';\nimport {\n  blockComponentSymbol,\n  modelContext,\n  serviceContext,\n} from './consts.js';\nimport { docContext, stdContext } from './lit-host.js';\nimport { ShadowlessElement } from './shadowless-element.js';\n\n@requiredProperties({\n  doc: PropTypes.instanceOf(Doc),\n  std: PropTypes.object,\n  widgets: PropTypes.recordOf(PropTypes.object),\n})\nexport class BlockComponent<\n  Model extends BlockModel = BlockModel,\n  Service extends BlockService = BlockService,\n  WidgetName extends string = string,\n> extends SignalWatcher(WithDisposable(ShadowlessElement)) {\n  private _selected = computed(() => {\n    const selection = this.std.selection.value.find(selection => {\n      return selection.blockId === this.model?.id;\n    });\n\n    if (!selection) {\n      return null;\n    }\n\n    return selection;\n  });\n\n  [blockComponentSymbol] = true;\n\n  handleEvent = (\n    name: EventName,\n    handler: UIEventHandler,\n    options?: { global?: boolean; flavour?: boolean }\n  ) => {\n    this._disposables.add(\n      this.host.event.add(name, handler, {\n        flavour: options?.global\n          ? undefined\n          : options?.flavour\n            ? this.model?.flavour\n            : undefined,\n        blockId: options?.global || options?.flavour ? undefined : this.blockId,\n      })\n    );\n  };\n\n  get blockId() {\n    return this.dataset.blockId as string;\n  }\n\n  get childBlocks() {\n    const childModels = this.model.children;\n    return childModels\n      .map(child => {\n        return this.std.view.getBlock(child.id);\n      })\n      .filter((x): x is BlockComponent => !!x);\n  }\n\n  get flavour(): string {\n    return this.model.flavour;\n  }\n\n  get host() {\n    return this.std.host;\n  }\n\n  get isVersionMismatch() {\n    const schema = this.doc.schema.flavourSchemaMap.get(this.model.flavour);\n    if (!schema) {\n      console.warn(\n        `Schema not found for block ${this.model.id}, flavour ${this.model.flavour}`\n      );\n      return true;\n    }\n    const expectedVersion = schema.version;\n    const actualVersion = this.model.version;\n    if (expectedVersion !== actualVersion) {\n      console.warn(\n        `Version mismatch for block ${this.model.id}, expected ${expectedVersion}, actual ${actualVersion}`\n      );\n      return true;\n    }\n\n    return false;\n  }\n\n  get model() {\n    if (this._model) {\n      return this._model;\n    }\n    const model = this.doc.getBlockById<Model>(this.blockId);\n    if (!model) {\n      throw new LumenSuiteError(\n        ErrorCode.MissingViewModelError,\n        `Cannot find block model for id ${this.blockId}`\n      );\n    }\n    this._model = model;\n    return model;\n  }\n\n  get parentComponent(): BlockComponent | null {\n    const parent = this.model.parent;\n    if (!parent) return null;\n    return this.std.view.getBlock(parent.id);\n  }\n\n  get renderChildren() {\n    return this.host.renderChildren.bind(this);\n  }\n\n  get rootComponent(): BlockComponent | null {\n    const rootId = this.doc.root?.id;\n    if (!rootId) {\n      return null;\n    }\n    const rootComponent = this.host.view.getBlock(rootId);\n    return rootComponent ?? null;\n  }\n\n  get selected() {\n    return this._selected.value;\n  }\n\n  get selection() {\n    return this.host.selection;\n  }\n\n  get service(): Service {\n    if (this._service) {\n      return this._service;\n    }\n    const service = this.std.getService(this.model.flavour) as Service;\n    this._service = service;\n    return service;\n  }\n\n  get topContenteditableElement(): BlockComponent | null {\n    return this.rootComponent;\n  }\n\n  get widgetComponents(): Partial<Record<WidgetName, WidgetComponent>> {\n    return Object.keys(this.widgets).reduce(\n      (mapping, key) => ({\n        ...mapping,\n        [key]: this.host.view.getWidget(key, this.blockId),\n      }),\n      {}\n    );\n  }\n\n  private _renderMismatchBlock(content: unknown) {\n    return when(\n      this.isVersionMismatch,\n      () => {\n        const actualVersion = this.model.version;\n        const schema = this.doc.schema.flavourSchemaMap.get(this.model.flavour);\n        const expectedVersion = schema?.version ?? -1;\n        return this.renderVersionMismatch(expectedVersion, actualVersion);\n      },\n      () => content\n    );\n  }\n\n  private _renderViewType(content: unknown) {\n    return choose(this.viewType, [\n      [BlockViewType.Display, () => content],\n      [BlockViewType.Hidden, () => nothing],\n      [BlockViewType.Bypass, () => this.renderChildren(this.model)],\n    ]);\n  }\n\n  addRenderer(renderer: (content: unknown) => unknown) {\n    this._renderers.push(renderer);\n  }\n\n  bindHotKey(\n    keymap: Record<string, UIEventHandler>,\n    options?: { global?: boolean; flavour?: boolean }\n  ) {\n    const dispose = this.host.event.bindHotkey(keymap, {\n      flavour: options?.global\n        ? undefined\n        : options?.flavour\n          ? this.model.flavour\n          : undefined,\n      blockId: options?.global || options?.flavour ? undefined : this.blockId,\n    });\n    this._disposables.add(dispose);\n    return dispose;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    this.std.view.setBlock(this);\n\n    const disposable = this.std.doc.slots.blockUpdated.on(({ type, id }) => {\n      if (id === this.model.id && type === 'delete') {\n        this.std.view.deleteBlock(this);\n        disposable.dispose();\n      }\n    });\n    this._disposables.add(disposable);\n\n    this._disposables.add(\n      this.model.propsUpdated.on(() => {\n        this.requestUpdate();\n      })\n    );\n\n    this.service.specSlots.viewConnected.emit({\n      service: this.service,\n      component: this,\n    });\n  }\n\n  override disconnectedCallback() {\n    super.disconnectedCallback();\n\n    this.service?.specSlots.viewDisconnected.emit({\n      service: this.service,\n      component: this,\n    });\n  }\n\n  protected override async getUpdateComplete(): Promise<boolean> {\n    const result = await super.getUpdateComplete();\n    await Promise.all(this.childBlocks.map(el => el.updateComplete));\n    return result;\n  }\n\n  override render() {\n    return this._renderers.reduce(\n      (acc, cur) => cur.call(this, acc),\n      nothing as unknown\n    );\n  }\n\n  renderBlock(): unknown {\n    return nothing;\n  }\n\n  /**\n   * Render a warning message when the block version is mismatched.\n   * @param expectedVersion If the schema is not found, the expected version is -1.\n   *        Which means the block is not supported in the current editor.\n   * @param actualVersion The version of the block's crdt data.\n   */\n  renderVersionMismatch(\n    expectedVersion: number,\n    actualVersion: number\n  ): TemplateResult {\n    return html`\n      <dl class=\"version-mismatch-warning\" contenteditable=\"false\">\n        <dt>\n          <h4>Block Version Mismatched</h4>\n        </dt>\n        <dd>\n          <p>\n            We can not render this <var>${this.model.flavour}</var> block\n            because the version is mismatched.\n          </p>\n          <p>Editor version: <var>${expectedVersion}</var></p>\n          <p>Data version: <var>${actualVersion}</var></p>\n        </dd>\n      </dl>\n    `;\n  }\n\n  protected override update(changedProperties: PropertyValues): void {\n    // In some cases, the DOM structure is directly modified, causing Lit to lose synchronization with the DOM structure.\n    // We can restore this state through the `dirty` property.\n    if (this.dirty) {\n      // Here we made some hacks by referring to the source code of Lit.\n      // https://github.com/lit/lit/blob/273ad4e23b8ec97f1a5015dbf398104f535f9c34/packages/lit-element/src/lit-element.ts#L162-L163\n      // https://github.com/lit/lit/blob/273ad4e23b8ec97f1a5015dbf398104f535f9c34/packages/reactive-element/src/reactive-element.ts#L1586-L1589\n      // https://github.com/lit/lit/blob/273ad4e23b8ec97f1a5015dbf398104f535f9c34/packages/reactive-element/src/reactive-element.ts#L1509-L1512\n      //@ts-ignore\n      this.__reflectingProperties &&= this.__reflectingProperties.forEach(p =>\n        //@ts-ignore\n        this.__propertyToAttribute(p, this[p as keyof this])\n      ) as undefined;\n      //@ts-ignore\n      this._$changedProperties = new Map();\n      this.isUpdatePending = false;\n      //@ts-ignore\n      this.__childPart = render(nothing, this.renderRoot);\n\n      this.updateComplete\n        .then(() => {\n          this.dirty = false;\n        })\n        .catch(console.error);\n    } else {\n      super.update(changedProperties);\n    }\n  }\n\n  @provide({ context: modelContext as never })\n  @state()\n  private accessor _model: Model | null = null;\n\n  @state()\n  protected accessor _renderers: Array<(content: unknown) => unknown> = [\n    this.renderBlock,\n    this._renderMismatchBlock,\n    this._renderViewType,\n  ];\n\n  @provide({ context: serviceContext as never })\n  @state()\n  private accessor _service: Service | null = null;\n\n  @property({ attribute: false })\n  accessor dirty = false;\n\n  @consume({ context: docContext })\n  accessor doc!: Doc;\n\n  @consume({ context: stdContext })\n  accessor std!: BlockStdScope;\n\n  @property({ attribute: false })\n  accessor viewType: BlockViewType = BlockViewType.Display;\n\n  @property({\n    attribute: false,\n    hasChanged(value, oldValue) {\n      if (!value || !oldValue) {\n        return value !== oldValue;\n      }\n      // Is empty object\n      if (!Object.keys(value).length && !Object.keys(oldValue).length) {\n        return false;\n      }\n      return value !== oldValue;\n    },\n  })\n  accessor widgets!: Record<WidgetName, TemplateResult>;\n}\n"]}