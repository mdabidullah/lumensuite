{"version":3,"file":"lit-host.js","sourceRoot":"","sources":["../../../src/view/element/lit-host.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable lit/binding-positions, lit/no-invalid-html */\n\nimport {\n  LumenSuiteError,\n  ErrorCode,\n  handleError,\n} from '@lumensuite/global/exceptions';\nimport { Slot } from '@lumensuite/global/utils';\nimport { Doc } from '@lumensuite/store';\nimport { type BlockModel, BlockViewType } from '@lumensuite/store';\nimport { createContext, provide } from '@lit/context';\nimport { css, LitElement, nothing, type TemplateResult } from 'lit';\nimport { customElement, property } from 'lit/decorators.js';\nimport { repeat } from 'lit/directives/repeat.js';\nimport { html, type StaticValue, unsafeStatic } from 'lit/static-html.js';\n\nimport type { CommandManager } from '../../command/index.js';\nimport type { UIEventDispatcher } from '../../event/index.js';\nimport type { RangeManager } from '../../range/index.js';\nimport type { BlockStdScope } from '../../scope/block-std-scope.js';\nimport type { SelectionManager } from '../../selection/index.js';\nimport type { ViewStore } from '../view-store.js';\n\nimport { WidgetViewMapIdentifier } from '../../identifier.js';\nimport { PropTypes, requiredProperties } from '../decorators/index.js';\nimport { SignalWatcher } from '../signal-watcher.js';\nimport { WithDisposable } from '../utils/with-disposable.js';\nimport { BLOCK_ID_ATTR, WIDGET_ID_ATTR } from './consts.js';\nimport { ShadowlessElement } from './shadowless-element.js';\n\nexport const docContext = createContext<Doc>('doc');\nexport const stdContext = createContext<BlockStdScope>('std');\n\n@requiredProperties({\n  doc: PropTypes.instanceOf(Doc),\n  std: PropTypes.object,\n})\n@customElement('editor-host')\nexport class EditorHost extends SignalWatcher(\n  WithDisposable(ShadowlessElement)\n) {\n  static override styles = css`\n    editor-host {\n      outline: none;\n      isolation: isolate;\n      display: block;\n      height: 100%;\n    }\n  `;\n\n  private _renderModel = (model: BlockModel): TemplateResult => {\n    const { flavour } = model;\n    const block = this.doc.getBlock(model.id);\n    if (!block || block.blockViewType === BlockViewType.Hidden) {\n      return html`${nothing}`;\n    }\n    const schema = this.doc.schema.flavourSchemaMap.get(flavour);\n    const view = this.std.getView(flavour);\n    if (!schema || !view) {\n      console.warn(`Cannot find render flavour ${flavour}.`);\n      return html`${nothing}`;\n    }\n    const widgetViewMap = this.std.getOptional(\n      WidgetViewMapIdentifier(flavour)\n    );\n\n    const tag = typeof view === 'function' ? view(model) : view;\n    const widgets: Record<string, TemplateResult> = widgetViewMap\n      ? Object.entries(widgetViewMap).reduce((mapping, [key, tag]) => {\n          const template = html`<${tag} ${unsafeStatic(WIDGET_ID_ATTR)}=${key}></${tag}>`;\n\n          return {\n            ...mapping,\n            [key]: template,\n          };\n        }, {})\n      : {};\n\n    return html`<${tag}\n      ${unsafeStatic(BLOCK_ID_ATTR)}=${model.id}\n      .widgets=${widgets}\n      .viewType=${block.blockViewType}\n    ></${tag}>`;\n  };\n\n  /**\n   * Render a block model manually instead of let lumensuite render it.\n   * If you render the same block model multiple times,\n   * the event flow and data binding will be broken.\n   * Only use this method as a last resort.\n   */\n  dangerouslyRenderModel = (model: BlockModel): TemplateResult => {\n    return this._renderModel(model);\n  };\n\n  renderChildren = (\n    model: BlockModel,\n    filter?: (model: BlockModel) => boolean\n  ): TemplateResult => {\n    return html`${repeat(\n      model.children.filter(filter ?? (() => true)),\n      child => child.id,\n      child => this._renderModel(child)\n    )}`;\n  };\n\n  readonly slots = {\n    unmounted: new Slot(),\n  };\n\n  get command(): CommandManager {\n    return this.std.command;\n  }\n\n  get event(): UIEventDispatcher {\n    return this.std.event;\n  }\n\n  get range(): RangeManager {\n    return this.std.range;\n  }\n\n  get selection(): SelectionManager {\n    return this.std.selection;\n  }\n\n  get view(): ViewStore {\n    return this.std.view;\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    if (!this.doc.root) {\n      throw new LumenSuiteError(\n        ErrorCode.NoRootModelError,\n        'This doc is missing root block. Please initialize the default block structure before connecting the editor to DOM.'\n      );\n    }\n\n    this.std.mount();\n    this.tabIndex = 0;\n  }\n\n  override disconnectedCallback() {\n    super.disconnectedCallback();\n    this.std.unmount();\n    this.slots.unmounted.emit();\n  }\n\n  override async getUpdateComplete(): Promise<boolean> {\n    try {\n      const result = await super.getUpdateComplete();\n      const rootModel = this.doc.root;\n      if (!rootModel) return result;\n\n      const view = this.std.getView(rootModel.flavour);\n      if (!view) return result;\n\n      const widgetViewMap = this.std.getOptional(\n        WidgetViewMapIdentifier(rootModel.flavour)\n      );\n      const widgetTags = Object.values(widgetViewMap ?? {});\n      const elementsTags: StaticValue[] = [\n        typeof view === 'function' ? view(rootModel) : view,\n        ...widgetTags,\n      ];\n      await Promise.all(\n        elementsTags.map(tag => {\n          const element = this.renderRoot.querySelector(tag._$litStatic$);\n          if (element instanceof LitElement) {\n            return element.updateComplete;\n          }\n          return;\n        })\n      );\n      return result;\n    } catch (e) {\n      if (e instanceof Error) {\n        handleError(e);\n      } else {\n        console.error(e);\n      }\n      return true;\n    }\n  }\n\n  override render() {\n    const { root } = this.doc;\n    if (!root) return nothing;\n\n    return this._renderModel(root);\n  }\n\n  @provide({ context: docContext })\n  @property({ attribute: false })\n  accessor doc!: Doc;\n\n  @provide({ context: stdContext })\n  @property({ attribute: false })\n  accessor std!: LumenSuite.Std;\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'editor-host': EditorHost;\n  }\n}\n"]}