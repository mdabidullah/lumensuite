{"version":3,"file":"field.js","sourceRoot":"","sources":["../../../../src/gfx/surface/decorators/field.ts"],"names":[],"mappings":"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","sourcesContent":["import type { GfxPrimitiveElementModel } from '../element-model.js';\n\nimport { getDecoratorState } from './common.js';\nimport { convertProps } from './convert.js';\nimport { getDerivedProps, updateDerivedProps } from './derive.js';\nimport { startObserve } from './observer.js';\n\nconst yPropsSetSymbol = Symbol('yProps');\n\nexport function getFieldPropsSet(target: unknown): Set<string | symbol> {\n  const proto = Object.getPrototypeOf(target);\n  // @ts-ignore\n  if (!Object.hasOwn(proto, yPropsSetSymbol)) {\n    // @ts-ignore\n    proto[yPropsSetSymbol] = new Set();\n  }\n\n  // @ts-ignore\n  return proto[yPropsSetSymbol] as Set<string | symbol>;\n}\n\nexport function field<V, T extends GfxPrimitiveElementModel>(fallback?: V) {\n  return function yDecorator(\n    target: ClassAccessorDecoratorTarget<T, V>,\n    context: ClassAccessorDecoratorContext\n  ) {\n    const prop = context.name;\n\n    return {\n      init(this: GfxPrimitiveElementModel, v: V) {\n        const yProps = getFieldPropsSet(this);\n\n        yProps.add(prop);\n\n        if (\n          getDecoratorState(\n            this.surface ?? Object.getPrototypeOf(this).constructor\n          )?.skipField\n        ) {\n          return;\n        }\n\n        if (this.yMap) {\n          if (this.yMap.doc) {\n            this.surface.doc.transact(() => {\n              this.yMap.set(prop as string, v);\n            });\n          } else {\n            this.yMap.set(prop as string, v);\n            this._preserved.set(prop as string, v);\n          }\n        }\n\n        return v;\n      },\n      get(this: GfxPrimitiveElementModel) {\n        return (\n          this.yMap.get(prop as string) ??\n          this._preserved.get(prop as string) ??\n          fallback\n        );\n      },\n      set(this: T, originalVal: V) {\n        const isCreating = getDecoratorState(this.surface)?.creating;\n\n        if (getDecoratorState(this.surface)?.skipField) {\n          return;\n        }\n\n        const derivedProps = getDerivedProps(prop, originalVal, this);\n        const val = isCreating\n          ? originalVal\n          : convertProps(prop, originalVal, this);\n        const oldValue = target.get.call(this);\n\n        if (this.yMap.doc) {\n          this.surface.doc.transact(() => {\n            this.yMap.set(prop as string, val);\n          });\n        } else {\n          this.yMap.set(prop as string, val);\n          this._preserved.set(prop as string, val);\n        }\n\n        startObserve(prop as string, this);\n\n        if (!isCreating) {\n          updateDerivedProps(derivedProps, this);\n\n          this.surface['hooks'].update.emit({\n            id: this.id,\n            props: {\n              [prop]: val,\n            },\n            oldValues: {\n              [prop]: oldValue,\n            },\n          });\n        }\n      },\n    } as ClassAccessorDecoratorResult<T, V>;\n  };\n}\n"]}