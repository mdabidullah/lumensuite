{"version":3,"file":"utils.js","sourceRoot":"","sources":["../../src/reactive/utils.ts"],"names":[],"mappings":"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","sourcesContent":["import type { Doc as YDoc, YEvent } from 'yjs';\n\nimport { UndoManager, Array as YArray, Map as YMap, Text as YText } from 'yjs';\n\nimport type { ProxyOptions } from './proxy.js';\n\nimport { Boxed } from './boxed.js';\nimport { Text } from './text.js';\n\nexport type Native2Y<T> =\n  T extends Record<string, infer U>\n    ? YMap<U>\n    : T extends Array<infer U>\n      ? YArray<U>\n      : T;\n\nexport function isPureObject(value: unknown): value is object {\n  return (\n    value !== null &&\n    typeof value === 'object' &&\n    Object.prototype.toString.call(value) === '[object Object]' &&\n    [Object, undefined, null].some(x => x === value.constructor)\n  );\n}\n\ntype TransformOptions = {\n  deep?: boolean;\n  transform?: (value: unknown, origin: unknown) => unknown;\n};\n\nexport function native2Y<T>(\n  value: T,\n  { deep = true, transform = x => x }: TransformOptions = {}\n): Native2Y<T> {\n  if (value instanceof Boxed) {\n    return value.yMap as Native2Y<T>;\n  }\n  if (value instanceof Text) {\n    if (value.yText.doc) {\n      return value.yText.clone() as Native2Y<T>;\n    }\n    return value.yText as Native2Y<T>;\n  }\n  if (Array.isArray(value)) {\n    const yArray: YArray<unknown> = new YArray<unknown>();\n    const result = value.map(item => {\n      return deep ? native2Y(item, { deep, transform }) : item;\n    });\n    yArray.insert(0, result);\n\n    return yArray as Native2Y<T>;\n  }\n  if (isPureObject(value)) {\n    const yMap = new YMap<unknown>();\n    Object.entries(value).forEach(([key, value]) => {\n      yMap.set(key, deep ? native2Y(value, { deep, transform }) : value);\n    });\n\n    return yMap as Native2Y<T>;\n  }\n\n  return value as Native2Y<T>;\n}\n\nexport function y2Native(\n  yAbstract: unknown,\n  { deep = true, transform = x => x }: TransformOptions = {}\n) {\n  if (Boxed.is(yAbstract)) {\n    const data = new Boxed(yAbstract);\n    return transform(data, yAbstract);\n  }\n  if (yAbstract instanceof YText) {\n    const data = new Text(yAbstract);\n    return transform(data, yAbstract);\n  }\n  if (yAbstract instanceof YArray) {\n    const data: unknown[] = yAbstract\n      .toArray()\n      .map(item => (deep ? y2Native(item, { deep, transform }) : item));\n\n    return transform(data, yAbstract);\n  }\n  if (yAbstract instanceof YMap) {\n    const data: Record<string, unknown> = Object.fromEntries(\n      Array.from(yAbstract.entries()).map(([key, value]) => {\n        return [key, deep ? y2Native(value, { deep, transform }) : value] as [\n          string,\n          unknown,\n        ];\n      })\n    );\n    return transform(data, yAbstract);\n  }\n\n  return transform(yAbstract, yAbstract);\n}\n\nexport type UnRecord = Record<string, unknown>;\n\nexport abstract class BaseReactiveYData<T, Y> {\n  protected _getOrigin = (\n    doc: YDoc\n  ): {\n    doc: YDoc;\n    proxy: true;\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    target: BaseReactiveYData<any, any>;\n  } => {\n    return {\n      doc,\n      proxy: true,\n      target: this,\n    };\n  };\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  protected _onObserve = (event: YEvent<any>, handler: () => void) => {\n    if (\n      event.transaction.origin?.proxy !== true &&\n      (!event.transaction.local ||\n        event.transaction.origin instanceof UndoManager)\n    ) {\n      handler();\n    }\n\n    this._options.onChange?.(this._proxy);\n  };\n\n  protected abstract readonly _options: ProxyOptions<T>;\n\n  protected abstract readonly _proxy: T;\n\n  protected _skipNext = false;\n\n  protected abstract readonly _source: T;\n\n  protected readonly _stashed = new Set<string | number>();\n\n  protected _transact = (doc: YDoc, fn: () => void) => {\n    doc.transact(fn, this._getOrigin(doc));\n  };\n\n  protected _updateWithSkip = (fn: () => void) => {\n    this._skipNext = true;\n    fn();\n    this._skipNext = false;\n  };\n\n  protected abstract readonly _ySource: Y;\n\n  get proxy() {\n    return this._proxy;\n  }\n\n  protected abstract _getProxy(): T;\n\n  abstract pop(prop: string | number): void;\n  abstract stash(prop: string | number): void;\n}\n"]}