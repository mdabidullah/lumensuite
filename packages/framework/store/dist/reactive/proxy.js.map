{"version":3,"file":"proxy.js","sourceRoot":"","sources":["../../src/reactive/proxy.ts"],"names":[],"mappings":"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","sourcesContent":["import type { YArrayEvent, YMapEvent } from 'yjs';\n\nimport { BlockSuiteError, ErrorCode } from '@blocksuite/global/exceptions';\nimport { Array as YArray, Map as YMap } from 'yjs';\n\nimport type { UnRecord } from './utils.js';\n\nimport { Boxed, type OnBoxedChange } from './boxed.js';\nimport { type OnTextChange, Text } from './text.js';\nimport { BaseReactiveYData, native2Y, y2Native } from './utils.js';\n\nexport type ProxyOptions<T> = {\n  onChange?: (data: T) => void;\n};\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nconst proxies = new WeakMap<any, BaseReactiveYData<any, any>>();\n\nexport class ReactiveYArray extends BaseReactiveYData<\n  unknown[],\n  YArray<unknown>\n> {\n  private _observer = (event: YArrayEvent<unknown>) => {\n    this._onObserve(event, () => {\n      let retain = 0;\n      event.changes.delta.forEach(change => {\n        if (change.retain) {\n          retain += change.retain;\n          return;\n        }\n        if (change.delete) {\n          this._updateWithSkip(() => {\n            this._source.splice(retain, change.delete);\n          });\n          return;\n        }\n        if (change.insert) {\n          const _arr = [change.insert].flat();\n\n          const proxyList = _arr.map(value => createYProxy(value));\n\n          this._updateWithSkip(() => {\n            this._source.splice(retain, 0, ...proxyList);\n          });\n\n          retain += change.insert.length;\n        }\n      });\n    });\n  };\n\n  protected _getProxy = () => {\n    return new Proxy(this._source, {\n      has: (target, p) => {\n        return Reflect.has(target, p);\n      },\n      set: (target, p, value, receiver) => {\n        if (typeof p !== 'string') {\n          throw new BlockSuiteError(\n            ErrorCode.ReactiveProxyError,\n            'key cannot be a symbol'\n          );\n        }\n\n        const index = Number(p);\n        if (this._skipNext || Number.isNaN(index)) {\n          return Reflect.set(target, p, value, receiver);\n        }\n\n        if (this._stashed.has(index)) {\n          const result = Reflect.set(target, p, value, receiver);\n          this._options.onChange?.(this._proxy);\n          return result;\n        }\n\n        const reactive = proxies.get(this._ySource);\n        if (!reactive) {\n          throw new BlockSuiteError(\n            ErrorCode.ReactiveProxyError,\n            'YData is not subscribed before changes'\n          );\n        }\n        const doc = this._ySource.doc;\n        if (!doc) {\n          throw new BlockSuiteError(\n            ErrorCode.ReactiveProxyError,\n            'YData is not bound to a Y.Doc'\n          );\n        }\n\n        const yData = native2Y(value);\n        this._transact(doc, () => {\n          if (index < this._ySource.length) {\n            this._ySource.delete(index, 1);\n          }\n          this._ySource.insert(index, [yData]);\n        });\n        const data = createYProxy(yData, this._options);\n        return Reflect.set(target, p, data, receiver);\n      },\n      get: (target, p, receiver) => {\n        return Reflect.get(target, p, receiver);\n      },\n      deleteProperty: (target, p): boolean => {\n        if (typeof p !== 'string') {\n          throw new BlockSuiteError(\n            ErrorCode.ReactiveProxyError,\n            'key cannot be a symbol'\n          );\n        }\n\n        const proxied = proxies.get(this._ySource);\n        if (!proxied) {\n          throw new BlockSuiteError(\n            ErrorCode.ReactiveProxyError,\n            'YData is not subscribed before changes'\n          );\n        }\n        const doc = this._ySource.doc;\n        if (!doc) {\n          throw new BlockSuiteError(\n            ErrorCode.ReactiveProxyError,\n            'YData is not bound to a Y.Doc'\n          );\n        }\n\n        const index = Number(p);\n        if (this._skipNext || Number.isNaN(index)) {\n          return Reflect.deleteProperty(target, p);\n        }\n\n        this._transact(doc, () => {\n          this._ySource.delete(index, 1);\n        });\n        return Reflect.deleteProperty(target, p);\n      },\n    });\n  };\n\n  protected readonly _proxy: unknown[];\n\n  constructor(\n    protected readonly _source: unknown[],\n    protected readonly _ySource: YArray<unknown>,\n    protected readonly _options: ProxyOptions<unknown[]>\n  ) {\n    super();\n    this._proxy = this._getProxy();\n    proxies.set(_ySource, this);\n    _ySource.observe(this._observer);\n  }\n\n  pop(prop: number) {\n    const value = this._source[prop];\n    this._stashed.delete(prop);\n    this._proxy[prop] = value;\n  }\n\n  stash(prop: number) {\n    this._stashed.add(prop);\n  }\n}\n\nexport class ReactiveYMap extends BaseReactiveYData<UnRecord, YMap<unknown>> {\n  private _observer = (event: YMapEvent<unknown>) => {\n    this._onObserve(event, () => {\n      event.keysChanged.forEach(key => {\n        const type = event.changes.keys.get(key);\n        if (!type) {\n          return;\n        }\n        if (type.action === 'delete') {\n          this._updateWithSkip(() => {\n            delete this._source[key];\n          });\n        } else if (type.action === 'add' || type.action === 'update') {\n          const current = this._ySource.get(key);\n          this._updateWithSkip(() => {\n            this._source[key] = proxies.has(current)\n              ? proxies.get(current)\n              : createYProxy(current, this._options);\n          });\n        }\n      });\n    });\n  };\n\n  protected _getProxy = () => {\n    return new Proxy(this._source, {\n      has: (target, p) => {\n        return Reflect.has(target, p);\n      },\n      set: (target, p, value, receiver) => {\n        if (typeof p !== 'string') {\n          throw new BlockSuiteError(\n            ErrorCode.ReactiveProxyError,\n            'key cannot be a symbol'\n          );\n        }\n        if (this._skipNext) {\n          return Reflect.set(target, p, value, receiver);\n        }\n\n        if (this._stashed.has(p)) {\n          const result = Reflect.set(target, p, value, receiver);\n          this._options.onChange?.(this._proxy);\n          return result;\n        }\n\n        const reactive = proxies.get(this._ySource);\n        if (!reactive) {\n          throw new BlockSuiteError(\n            ErrorCode.ReactiveProxyError,\n            'YData is not subscribed before changes'\n          );\n        }\n        const doc = this._ySource.doc;\n        if (!doc) {\n          throw new BlockSuiteError(\n            ErrorCode.ReactiveProxyError,\n            'YData is not bound to a Y.Doc'\n          );\n        }\n\n        const yData = native2Y(value);\n        this._transact(doc, () => {\n          this._ySource.set(p, yData);\n        });\n        const data = createYProxy(yData, this._options);\n        return Reflect.set(target, p, data, receiver);\n      },\n      get: (target, p, receiver) => {\n        return Reflect.get(target, p, receiver);\n      },\n      deleteProperty: (target, p) => {\n        if (typeof p !== 'string') {\n          throw new BlockSuiteError(\n            ErrorCode.ReactiveProxyError,\n            'key cannot be a symbol'\n          );\n        }\n        if (this._skipNext) {\n          return Reflect.deleteProperty(target, p);\n        }\n\n        const proxied = proxies.get(this._ySource);\n        if (!proxied) {\n          throw new BlockSuiteError(\n            ErrorCode.ReactiveProxyError,\n            'YData is not subscribed before changes'\n          );\n        }\n        const doc = this._ySource.doc;\n        if (!doc) {\n          throw new BlockSuiteError(\n            ErrorCode.ReactiveProxyError,\n            'YData is not bound to a Y.Doc'\n          );\n        }\n\n        this._transact(doc, () => {\n          this._ySource.delete(p);\n        });\n\n        return Reflect.deleteProperty(target, p);\n      },\n    });\n  };\n\n  protected readonly _proxy: UnRecord;\n\n  constructor(\n    protected readonly _source: UnRecord,\n    protected readonly _ySource: YMap<unknown>,\n    protected readonly _options: ProxyOptions<UnRecord>\n  ) {\n    super();\n    this._proxy = this._getProxy();\n    proxies.set(_ySource, this);\n    _ySource.observe(this._observer);\n  }\n\n  pop(prop: string) {\n    const value = this._source[prop];\n    this._stashed.delete(prop);\n    this._proxy[prop] = value;\n  }\n\n  stash(prop: string) {\n    this._stashed.add(prop);\n  }\n}\n\nexport function createYProxy<Data>(\n  yAbstract: unknown,\n  options: ProxyOptions<Data> = {}\n): Data {\n  if (proxies.has(yAbstract)) {\n    return proxies.get(yAbstract)!.proxy as Data;\n  }\n\n  return y2Native(yAbstract, {\n    transform: (value, origin) => {\n      if (value instanceof Text) {\n        value.bind(options.onChange as OnTextChange);\n        return value;\n      }\n      if (Boxed.is(origin)) {\n        (value as Boxed).bind(options.onChange as OnBoxedChange);\n        return value;\n      }\n      if (origin instanceof YArray) {\n        const data = new ReactiveYArray(\n          value as unknown[],\n          origin,\n          options as ProxyOptions<unknown[]>\n        );\n        return data.proxy;\n      }\n      if (origin instanceof YMap) {\n        const data = new ReactiveYMap(\n          value as UnRecord,\n          origin,\n          options as ProxyOptions<UnRecord>\n        );\n        return data.proxy;\n      }\n\n      return value;\n    },\n  }) as Data;\n}\n\nexport function stashProp(yMap: YMap<unknown>, prop: string): void;\nexport function stashProp(yMap: YArray<unknown>, prop: number): void;\nexport function stashProp(yAbstract: unknown, prop: string | number) {\n  const proxy = proxies.get(yAbstract);\n  if (!proxy) {\n    throw new BlockSuiteError(\n      ErrorCode.ReactiveProxyError,\n      'YData is not subscribed before changes'\n    );\n  }\n  proxy.stash(prop);\n}\n\nexport function popProp(yMap: YMap<unknown>, prop: string): void;\nexport function popProp(yMap: YArray<unknown>, prop: number): void;\nexport function popProp(yAbstract: unknown, prop: string | number) {\n  const proxy = proxies.get(yAbstract);\n  if (!proxy) {\n    throw new BlockSuiteError(\n      ErrorCode.ReactiveProxyError,\n      'YData is not subscribed before changes'\n    );\n  }\n  proxy.pop(prop);\n}\n"]}