{"version":3,"file":"yjs.unit.spec.js","sourceRoot":"","sources":["../../src/__tests__/yjs.unit.spec.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, test } from 'vitest';\nimport * as Y from 'yjs';\n\nimport type { Text } from '../reactive/index.js';\n\nimport { Boxed, createYProxy, popProp, stashProp } from '../reactive/index.js';\n\ndescribe('lumensuite yjs', () => {\n  describe('array', () => {\n    test('proxy', () => {\n      const ydoc = new Y.Doc();\n      const arr = ydoc.getArray('arr');\n      arr.push([0]);\n\n      const proxy = createYProxy(arr) as unknown[];\n      expect(arr.get(0)).toBe(0);\n\n      proxy.push(1);\n      expect(arr.get(1)).toBe(1);\n      expect(arr.length).toBe(2);\n\n      proxy.splice(1, 1);\n      expect(arr.length).toBe(1);\n\n      proxy[0] = 2;\n      expect(arr.length).toBe(1);\n    });\n  });\n\n  describe('object', () => {\n    test('deep', () => {\n      const ydoc = new Y.Doc();\n      const map = ydoc.getMap('map');\n      const obj = new Y.Map();\n      obj.set('foo', 1);\n      map.set('obj', obj);\n      map.set('num', 0);\n      const map2 = new Y.Map();\n      obj.set('map', map2);\n      map2.set('foo', 40);\n\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      const proxy = createYProxy<Record<string, any>>(map);\n\n      expect(proxy.num).toBe(0);\n      expect(proxy.obj.foo).toBe(1);\n      expect(proxy.obj.map.foo).toBe(40);\n\n      proxy.obj.bar = 100;\n      expect(obj.get('bar')).toBe(100);\n\n      proxy.obj2 = { foo: 2, bar: { num: 3 } };\n      expect(map.get('obj2')).toBeInstanceOf(Y.Map);\n      // @ts-ignore\n      expect(map.get('obj2').get('bar').get('num')).toBe(3);\n\n      proxy.obj2.bar.str = 'hello';\n      // @ts-ignore\n      expect(map.get('obj2').get('bar').get('str')).toBe('hello');\n\n      proxy.obj3 = {};\n      const { obj3 } = proxy;\n      obj3.id = 'obj3';\n      expect((map.get('obj3') as Y.Map<string>).get('id')).toBe('obj3');\n\n      proxy.arr = [];\n      expect(map.get('arr')).toBeInstanceOf(Y.Array);\n      proxy.arr.push({ counter: 1 });\n      expect((map.get('arr') as Y.Array<Y.Map<number>>).get(0)).toBeInstanceOf(\n        Y.Map\n      );\n      expect(\n        (map.get('arr') as Y.Array<Y.Map<number>>).get(0).get('counter')\n      ).toBe(1);\n    });\n\n    test('with y text', () => {\n      const ydoc = new Y.Doc();\n      const map = ydoc.getMap('map');\n      const inner = new Y.Map();\n      map.set('inner', inner);\n      const text = new Y.Text('hello');\n      inner.set('text', text);\n\n      const proxy = createYProxy<{ inner: { text: Text } }>(map);\n      proxy.inner = { ...proxy.inner };\n      expect(proxy.inner.text.yText).toBeInstanceOf(Y.Text);\n      expect(proxy.inner.text.yText.toJSON()).toBe('hello');\n    });\n\n    test('with native wrapper', () => {\n      const ydoc = new Y.Doc();\n      const map = ydoc.getMap('map');\n      const inner = new Y.Map();\n      map.set('inner', inner);\n      const native = new Boxed(['hello', 'world']);\n      inner.set('native', native.yMap);\n\n      const proxy = createYProxy<{\n        inner: {\n          native: Boxed<string[]>;\n          native2: Boxed<number>;\n        };\n      }>(map);\n\n      expect(proxy.inner.native.getValue()).toEqual(['hello', 'world']);\n\n      proxy.inner.native.setValue(['hello', 'world', 'foo']);\n      expect(native.getValue()).toEqual(['hello', 'world', 'foo']);\n      // @ts-ignore\n      expect(map.get('inner').get('native').get('value')).toEqual([\n        'hello',\n        'world',\n        'foo',\n      ]);\n\n      const native2 = new Boxed(0);\n      proxy.inner.native2 = native2;\n      // @ts-ignore\n      expect(map.get('inner').get('native2').get('value')).toBe(0);\n      native2.setValue(1);\n      // @ts-ignore\n      expect(map.get('inner').get('native2').get('value')).toBe(1);\n    });\n  });\n\n  describe('stash and pop', () => {\n    test('object', () => {\n      const ydoc = new Y.Doc();\n      const map = ydoc.getMap('map');\n      map.set('num', 0);\n\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      const proxy = createYProxy<Record<string, any>>(map);\n\n      expect(proxy.num).toBe(0);\n      stashProp(map, 'num');\n      proxy.num = 1;\n      expect(proxy.num).toBe(1);\n      expect(map.get('num')).toBe(0);\n      proxy.num = 2;\n      popProp(map, 'num');\n      expect(map.get('num')).toBe(2);\n    });\n\n    test('array', () => {\n      const ydoc = new Y.Doc();\n      const arr = ydoc.getArray('arr');\n      arr.push([0]);\n\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      const proxy = createYProxy<Record<string, any>>(arr);\n\n      expect(proxy[0]).toBe(0);\n      stashProp(arr, 0);\n      proxy[0] = 1;\n      expect(proxy[0]).toBe(1);\n      expect(arr.get(0)).toBe(0);\n      popProp(arr, 0);\n      expect(arr.get(0)).toBe(1);\n    });\n\n    test('nested', () => {\n      const ydoc = new Y.Doc();\n      const map = ydoc.getMap('map');\n      const arr = new Y.Array();\n      map.set('arr', arr);\n      arr.push([0]);\n\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      const proxy = createYProxy<Record<string, any>>(map);\n\n      expect(proxy.arr[0]).toBe(0);\n      stashProp(arr, 0);\n      proxy.arr[0] = 1;\n      expect(proxy.arr[0]).toBe(1);\n      expect(arr.get(0)).toBe(0);\n      popProp(arr, 0);\n      expect(arr.get(0)).toBe(1);\n    });\n  });\n});\n"]}