{"version":3,"file":"sync-controller.js","sourceRoot":"","sources":["../../../../src/store/doc/block/sync-controller.ts"],"names":[],"mappings":"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","sourcesContent":["import { LumenSuiteError, ErrorCode } from '@lumensuite/global/exceptions';\nimport { effect, signal } from '@preact/signals-core';\nimport { createMutex } from 'lib0/mutex.js';\nimport * as Y from 'yjs';\n\nimport type { Schema } from '../../../schema/schema.js';\nimport type { Doc } from '../doc.js';\nimport type { YBlock } from './types.js';\n\nimport {\n  Boxed,\n  createYProxy,\n  native2Y,\n  type UnRecord,\n  y2Native,\n} from '../../../reactive/index.js';\nimport { BlockModel, internalPrimitives } from '../../../schema/base.js';\n\n/**\n * @internal\n * SyncController is responsible for syncing the block data with Yjs.\n * It creates a proxy model that syncs with Yjs and provides a reactive interface.\n * It also handles the stashing and popping of props.\n * It will also provide signals for block props.\n *\n */\nexport class SyncController {\n  private _byPassProxy: boolean = false;\n\n  private readonly _byPassUpdate = (fn: () => void) => {\n    this._byPassProxy = true;\n    fn();\n    this._byPassProxy = false;\n  };\n\n  private readonly _mutex = createMutex();\n\n  private readonly _observeYBlockChanges = () => {\n    this.yBlock.observe(event => {\n      event.keysChanged.forEach(key => {\n        const type = event.changes.keys.get(key);\n        if (!type) {\n          return;\n        }\n        if (type.action === 'update' || type.action === 'add') {\n          const value = this.yBlock.get(key);\n          const keyName = key.replace('prop:', '');\n          const proxy = this._getPropsProxy(keyName, value);\n          this._byPassUpdate(() => {\n            // @ts-ignore\n            this.model[keyName] = proxy;\n            const signalKey = `${keyName}$`;\n            this._mutex(() => {\n              // @ts-ignore\n              if (signalKey in this.model) {\n                // @ts-ignore\n                this.model[signalKey].value = y2Native(value);\n              }\n            });\n          });\n          this.onChange?.(keyName, value);\n          return;\n        }\n        if (type.action === 'delete') {\n          const keyName = key.replace('prop:', '');\n          this._byPassUpdate(() => {\n            // @ts-ignore\n            delete this.model[keyName];\n            // @ts-ignore\n            if (`${keyName}$` in this.model) {\n              // @ts-ignore\n              this.model[`${keyName}$`].value = undefined;\n            }\n          });\n          this.onChange?.(keyName, undefined);\n          return;\n        }\n      });\n    });\n  };\n\n  private readonly _stashed = new Set<string | number>();\n\n  readonly flavour: string;\n\n  readonly id: string;\n\n  readonly model: BlockModel;\n\n  readonly pop = (prop: string) => {\n    if (!this._stashed.has(prop)) return;\n    this._popProp(prop);\n  };\n\n  readonly stash = (prop: string) => {\n    if (this._stashed.has(prop)) return;\n\n    this._stashed.add(prop);\n    this._stashProp(prop);\n  };\n\n  readonly version: number;\n\n  readonly yChildren: Y.Array<string[]>;\n\n  constructor(\n    readonly schema: Schema,\n    readonly yBlock: YBlock,\n    readonly doc?: Doc,\n    readonly onChange?: (key: string, value: unknown) => void\n  ) {\n    const { id, flavour, version, yChildren, props } = this._parseYBlock();\n\n    this.id = id;\n    this.flavour = flavour;\n    this.yChildren = yChildren;\n    this.version = version;\n\n    this.model = this._createModel(props);\n\n    this._observeYBlockChanges();\n  }\n\n  private _createModel(props: UnRecord) {\n    const _mutex = this._mutex;\n    const schema = this.schema.flavourSchemaMap.get(this.flavour);\n    if (!schema) {\n      throw new LumenSuiteError(\n        ErrorCode.ModelCRUDError,\n        `schema for flavour: ${this.flavour} not found`\n      );\n    }\n\n    const model = schema.model.toModel?.() ?? new BlockModel<object>();\n    const signalWithProps = Object.entries(props).reduce(\n      (acc, [key, value]) => {\n        const data = signal(value);\n        const dispose = effect(() => {\n          const value = data.value;\n          if (!this.model) return;\n          _mutex(() => {\n            // @ts-ignore\n            this.model[key] = value;\n          });\n        });\n        model.deleted.once(dispose);\n        return {\n          ...acc,\n          [`${key}$`]: data,\n          [key]: value,\n        };\n      },\n      {} as Record<string, unknown>\n    );\n    Object.assign(model, signalWithProps);\n\n    model.id = this.id;\n    model.version = this.version;\n    model.keys = Object.keys(props);\n    model.flavour = schema.model.flavour;\n    model.role = schema.model.role;\n    model.yBlock = this.yBlock;\n    model.stash = this.stash;\n    model.pop = this.pop;\n    if (this.doc) {\n      model.doc = this.doc;\n    }\n\n    const proxy = new Proxy(model, {\n      has: (target, p) => {\n        return Reflect.has(target, p);\n      },\n      set: (target, p, value, receiver) => {\n        if (\n          !this._byPassProxy &&\n          typeof p === 'string' &&\n          model.keys.includes(p)\n        ) {\n          if (this._stashed.has(p)) {\n            setValue(target, p, value);\n            const result = Reflect.set(target, p, value, receiver);\n            this.onChange?.(p, value);\n            return result;\n          }\n\n          const yValue = native2Y(value);\n          this.yBlock.set(`prop:${p}`, yValue);\n          const proxy = this._getPropsProxy(p, yValue);\n          setValue(target, p, value);\n          return Reflect.set(target, p, proxy, receiver);\n        }\n\n        return Reflect.set(target, p, value, receiver);\n      },\n      get: (target, p, receiver) => {\n        return Reflect.get(target, p, receiver);\n      },\n      deleteProperty: (target, p) => {\n        if (\n          !this._byPassProxy &&\n          typeof p === 'string' &&\n          model.keys.includes(p)\n        ) {\n          this.yBlock.delete(`prop:${p}`);\n          setValue(target, p, undefined);\n        }\n\n        return Reflect.deleteProperty(target, p);\n      },\n    });\n\n    function setValue(target: BlockModel, p: string, value: unknown) {\n      _mutex(() => {\n        // @ts-ignore\n        target[`${p}$`].value = value;\n      });\n    }\n    return proxy;\n  }\n\n  private _getPropsProxy(name: string, value: unknown) {\n    return createYProxy(value, {\n      onChange: () => {\n        this.onChange?.(name, value);\n        const signalKey = `${name}$`;\n        if (signalKey in this.model) {\n          this._mutex(() => {\n            // @ts-ignore\n            this.model[signalKey].value = this.model[name];\n          });\n        }\n      },\n    });\n  }\n\n  private _parseYBlock() {\n    let id: string | undefined;\n    let flavour: string | undefined;\n    let version: number | undefined;\n    let yChildren: Y.Array<string[]> | undefined;\n    const props: Record<string, unknown> = {};\n\n    this.yBlock.forEach((value, key) => {\n      if (key.startsWith('prop:')) {\n        const keyName = key.replace('prop:', '');\n        props[keyName] = this._getPropsProxy(keyName, value);\n        return;\n      }\n      if (key === 'sys:id' && typeof value === 'string') {\n        id = value;\n        return;\n      }\n      if (key === 'sys:flavour' && typeof value === 'string') {\n        flavour = value;\n        return;\n      }\n      if (key === 'sys:children' && value instanceof Y.Array) {\n        yChildren = value;\n        return;\n      }\n      if (key === 'sys:version' && typeof value === 'number') {\n        version = value;\n        return;\n      }\n    });\n\n    if (!id) {\n      throw new LumenSuiteError(\n        ErrorCode.ModelCRUDError,\n        'block id is not found when creating model'\n      );\n    }\n    if (!flavour) {\n      throw new LumenSuiteError(\n        ErrorCode.ModelCRUDError,\n        'block flavour is not found when creating model'\n      );\n    }\n    if (!yChildren) {\n      throw new LumenSuiteError(\n        ErrorCode.ModelCRUDError,\n        'block children is not found when creating model'\n      );\n    }\n\n    const schema = this.schema.flavourSchemaMap.get(flavour);\n    if (!schema) {\n      throw new LumenSuiteError(\n        ErrorCode.ModelCRUDError,\n        `schema for flavour: ${flavour} not found`\n      );\n    }\n    const defaultProps = schema.model.props?.(internalPrimitives);\n\n    if (typeof version !== 'number') {\n      // no version found in data, set to schema version\n      version = schema.version;\n    }\n\n    // Set default props if not exists\n    if (defaultProps) {\n      Object.entries(defaultProps).forEach(([key, value]) => {\n        if (key in props) return;\n\n        const yValue = native2Y(value);\n        this.yBlock.set(`prop:${key}`, yValue);\n        props[key] = this._getPropsProxy(key, yValue);\n      });\n    }\n\n    return {\n      id,\n      flavour,\n      version,\n      props,\n      yChildren,\n    };\n  }\n\n  private _popProp(prop: string) {\n    const model = this.model as BlockModel<Record<string, unknown>>;\n\n    const value = model[prop];\n    this._stashed.delete(prop);\n    model[prop] = value;\n  }\n\n  private _stashProp(prop: string) {\n    (this.model as BlockModel<Record<string, unknown>>)[prop] = y2Native(\n      this.yBlock.get(`prop:${prop}`),\n      {\n        transform: (value, origin) => {\n          if (Boxed.is(origin)) {\n            return value;\n          }\n          if (origin instanceof Y.Map) {\n            return new Proxy(value as UnRecord, {\n              get: (target, p, receiver) => {\n                return Reflect.get(target, p, receiver);\n              },\n              set: (target, p, value, receiver) => {\n                const result = Reflect.set(target, p, value, receiver);\n                this.onChange?.(prop, value);\n                return result;\n              },\n              deleteProperty: (target, p) => {\n                const result = Reflect.deleteProperty(target, p);\n                this.onChange?.(prop, undefined);\n                return result;\n              },\n            });\n          }\n          if (origin instanceof Y.Array) {\n            return new Proxy(value as unknown[], {\n              get: (target, p, receiver) => {\n                return Reflect.get(target, p, receiver);\n              },\n              set: (target, p, value, receiver) => {\n                const index = Number(p);\n                if (Number.isNaN(index)) {\n                  return Reflect.set(target, p, value, receiver);\n                }\n                const result = Reflect.set(target, p, value, receiver);\n                this.onChange?.(prop, value);\n                return result;\n              },\n              deleteProperty: (target, p) => {\n                const result = Reflect.deleteProperty(target, p);\n                this.onChange?.(p as string, undefined);\n                return result;\n              },\n            });\n          }\n\n          return value;\n        },\n      }\n    );\n  }\n}\n"]}