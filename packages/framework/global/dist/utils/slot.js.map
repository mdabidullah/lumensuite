{"version":3,"file":"slot.js","sourceRoot":"","sources":["../../src/utils/slot.ts"],"names":[],"mappings":"AAAA,OAAO,EAAmB,kBAAkB,EAAE,MAAM,iBAAiB,CAAC;AAEtE,2BAA2B;AAC3B,gDAAgD;AAChD,MAAM,OAAO,IAAI;IAAjB;QACU,eAAU,GAA0B,EAAE,CAAC;QAEvC,iBAAY,GAAiB,EAAE,CAAC;QAEhC,cAAS,GAAG,KAAK,CAAC;QAE1B,cAAS,GAAG,CACV,QAAyB,EACzB,QAA4B,EAC5B,MAGC,EACD,EAAE;YACF,IAAI,SAAwB,CAAC;YAC7B,MAAM,EAAE,MAAM,EAAE,UAAU,GAAG,MAAM,CAAC,EAAE,EAAE,GAAG,MAAM,IAAI,EAAE,CAAC;YACxD,OAAO,IAAI,CAAC,EAAE,CAAC,KAAK,CAAC,EAAE;gBACrB,IAAI,MAAM,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,EAAE,CAAC;oBAC7B,OAAO;gBACT,CAAC;gBACD,MAAM,SAAS,GAAG,QAAQ,CAAC,KAAK,CAAC,CAAC;gBAClC,IAAI,SAAS,KAAK,SAAS,IAAI,CAAC,UAAU,CAAC,SAAS,EAAE,SAAS,CAAC,EAAE,CAAC;oBACjE,QAAQ,CAAC,SAAS,CAAC,CAAC;oBACpB,SAAS,GAAG,SAAS,CAAC;gBACxB,CAAC;YACH,CAAC,CAAC,CAAC;QACL,CAAC,CAAC;IAuHJ,CAAC;IArHC,OAAO;QACL,kBAAkB,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC,OAAO,EAAE,CAAC;QAChD,IAAI,CAAC,UAAU,GAAG,EAAE,CAAC;QACrB,IAAI,CAAC,YAAY,GAAG,EAAE,CAAC;IACzB,CAAC;IAED,IAAI,CAAC,CAAI;QACP,MAAM,YAAY,GAAG,IAAI,CAAC,SAAS,CAAC;QACpC,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;QACtB,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE;YAC1B,IAAI,CAAC;gBACH,CAAC,CAAC,CAAC,CAAC,CAAC;YACP,CAAC;YAAC,OAAO,GAAG,EAAE,CAAC;gBACb,OAAO,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YACrB,CAAC;QACH,CAAC,CAAC,CAAC;QACH,IAAI,CAAC,SAAS,GAAG,YAAY,CAAC;IAChC,CAAC;IAED,MAAM,CAAC,OAA0B;QAC/B,MAAM,MAAM,GAAG,IAAI,IAAI,EAAK,CAAC;QAC7B,6DAA6D;QAC7D,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC;YACrB,OAAO,EAAE,GAAG,EAAE,CAAC,MAAM,CAAC,OAAO,EAAE;SAChC,CAAC,CAAC;QAEH,IAAI,CAAC,EAAE,CAAC,CAAC,CAAI,EAAE,EAAE;YACf,IAAI,OAAO,CAAC,CAAC,CAAC,EAAE,CAAC;gBACf,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;YACjB,CAAC;QACH,CAAC,CAAC,CAAC;QAEH,OAAO,MAAM,CAAC;IAChB,CAAC;IAED,OAAO,CAAI,MAAyB;QAClC,MAAM,MAAM,GAAG,IAAI,IAAI,EAAK,CAAC;QAC7B,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC;YACrB,OAAO,EAAE,GAAG,EAAE,CAAC,MAAM,CAAC,OAAO,EAAE;SAChC,CAAC,CAAC;QAEH,IAAI,CAAC,EAAE,CAAC,CAAC,CAAI,EAAE,EAAE;YACf,MAAM,IAAI,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC;YACvB,IAAI,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE,CAAC;gBACxB,IAAI,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC;YACpC,CAAC;iBAAM,CAAC;gBACN,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YACpB,CAAC;QACH,CAAC,CAAC,CAAC;QAEH,OAAO,MAAM,CAAC;IAChB,CAAC;IAED,EAAE,CAAC,QAA2B;QAC5B,IAAI,IAAI,CAAC,SAAS,EAAE,CAAC;YACnB,MAAM,WAAW,GAAG,CAAC,GAAG,IAAI,CAAC,UAAU,EAAE,QAAQ,CAAC,CAAC;YACnD,IAAI,CAAC,UAAU,GAAG,WAAW,CAAC;QAChC,CAAC;aAAM,CAAC;YACN,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;QACjC,CAAC;QACD,OAAO;YACL,OAAO,EAAE,GAAG,EAAE;gBACZ,IAAI,IAAI,CAAC,SAAS,EAAE,CAAC;oBACnB,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,KAAK,QAAQ,CAAC,CAAC;gBAChE,CAAC;qBAAM,CAAC;oBACN,MAAM,KAAK,GAAG,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC;oBAChD,IAAI,KAAK,GAAG,CAAC,CAAC,EAAE,CAAC;wBACf,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,KAAK,EAAE,CAAC,CAAC,CAAC,CAAC,uBAAuB;oBAC3D,CAAC;gBACH,CAAC;YACH,CAAC;SACF,CAAC;IACJ,CAAC;IAED,IAAI,CAAC,QAA2B;QAC9B,IAAI,OAAO,GAAsC,SAAS,CAAC;QAC3D,MAAM,OAAO,GAAG,CAAC,CAAI,EAAE,EAAE;YACvB,QAAQ,CAAC,CAAC,CAAC,CAAC;YACZ,IAAI,OAAO,EAAE,CAAC;gBACZ,OAAO,EAAE,CAAC;YACZ,CAAC;QACH,CAAC,CAAC;QACF,MAAM,UAAU,GAAG,IAAI,CAAC,EAAE,CAAC,OAAO,CAAC,CAAC;QACpC,OAAO,GAAG,UAAU,CAAC,OAAO,CAAC;QAC7B,OAAO,UAAU,CAAC;IACpB,CAAC;IAED,IAAI,CAAC,IAAa;QAChB,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC;QACxC,OAAO,IAAI,CAAC;IACd,CAAC;IAED,SAAS,CAAC,WAAyB;QACjC,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QACvB,OAAO,IAAI,CAAC;IACd,CAAC;IAED,OAAO,CAAC,QAA2B;QACjC,IAAI,IAAI,CAAC,SAAS,EAAE,CAAC;YACnB,MAAM,WAAW,GAAG,CAAC,QAAQ,EAAE,GAAG,IAAI,CAAC,UAAU,CAAC,CAAC;YACnD,IAAI,CAAC,UAAU,GAAG,WAAW,CAAC;QAChC,CAAC;aAAM,CAAC;YACN,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC;QACpC,CAAC;QACD,OAAO;YACL,OAAO,EAAE,GAAG,EAAE;gBACZ,IAAI,IAAI,CAAC,SAAS,EAAE,CAAC;oBACnB,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,KAAK,QAAQ,CAAC,CAAC;gBAChE,CAAC;qBAAM,CAAC;oBACN,MAAM,KAAK,GAAG,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC;oBAChD,IAAI,KAAK,GAAG,CAAC,CAAC,EAAE,CAAC;wBACf,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,KAAK,EAAE,CAAC,CAAC,CAAC,CAAC,uBAAuB;oBAC3D,CAAC;gBACH,CAAC;YACH,CAAC;SACF,CAAC;IACJ,CAAC;CACF","sourcesContent":["import { type Disposable, flattenDisposables } from './disposable.js';\n\n// Credits to blocky-editor\n// https://github.com/vincentdchan/blocky-editor\nexport class Slot<T = void> implements Disposable {\n  private _callbacks: ((v: T) => unknown)[] = [];\n\n  private _disposables: Disposable[] = [];\n\n  private _emitting = false;\n\n  subscribe = <U>(\n    selector: (state: T) => U,\n    callback: (value: U) => void,\n    config?: {\n      equalityFn?: (a: U, b: U) => boolean;\n      filter?: (state: T) => boolean;\n    }\n  ) => {\n    let prevState: U | undefined;\n    const { filter, equalityFn = Object.is } = config ?? {};\n    return this.on(state => {\n      if (filter && !filter(state)) {\n        return;\n      }\n      const nextState = selector(state);\n      if (prevState === undefined || !equalityFn(prevState, nextState)) {\n        callback(nextState);\n        prevState = nextState;\n      }\n    });\n  };\n\n  dispose() {\n    flattenDisposables(this._disposables).dispose();\n    this._callbacks = [];\n    this._disposables = [];\n  }\n\n  emit(v: T) {\n    const prevEmitting = this._emitting;\n    this._emitting = true;\n    this._callbacks.forEach(f => {\n      try {\n        f(v);\n      } catch (err) {\n        console.error(err);\n      }\n    });\n    this._emitting = prevEmitting;\n  }\n\n  filter(testFun: (v: T) => boolean): Slot<T> {\n    const result = new Slot<T>();\n    // if the original slot is disposed, dispose the filtered one\n    this._disposables.push({\n      dispose: () => result.dispose(),\n    });\n\n    this.on((v: T) => {\n      if (testFun(v)) {\n        result.emit(v);\n      }\n    });\n\n    return result;\n  }\n\n  flatMap<U>(mapper: (v: T) => U[] | U): Slot<U> {\n    const result = new Slot<U>();\n    this._disposables.push({\n      dispose: () => result.dispose(),\n    });\n\n    this.on((v: T) => {\n      const data = mapper(v);\n      if (Array.isArray(data)) {\n        data.forEach(v => result.emit(v));\n      } else {\n        result.emit(data);\n      }\n    });\n\n    return result;\n  }\n\n  on(callback: (v: T) => unknown): Disposable {\n    if (this._emitting) {\n      const newCallback = [...this._callbacks, callback];\n      this._callbacks = newCallback;\n    } else {\n      this._callbacks.push(callback);\n    }\n    return {\n      dispose: () => {\n        if (this._emitting) {\n          this._callbacks = this._callbacks.filter(v => v !== callback);\n        } else {\n          const index = this._callbacks.indexOf(callback);\n          if (index > -1) {\n            this._callbacks.splice(index, 1); // remove one item only\n          }\n        }\n      },\n    };\n  }\n\n  once(callback: (v: T) => unknown): Disposable {\n    let dispose: Disposable['dispose'] | undefined = undefined;\n    const handler = (v: T) => {\n      callback(v);\n      if (dispose) {\n        dispose();\n      }\n    };\n    const disposable = this.on(handler);\n    dispose = disposable.dispose;\n    return disposable;\n  }\n\n  pipe(that: Slot<T>): Slot<T> {\n    this._callbacks.push(v => that.emit(v));\n    return this;\n  }\n\n  toDispose(disposables: Disposable[]): Slot<T> {\n    disposables.push(this);\n    return this;\n  }\n\n  unshift(callback: (v: T) => unknown): Disposable {\n    if (this._emitting) {\n      const newCallback = [callback, ...this._callbacks];\n      this._callbacks = newCallback;\n    } else {\n      this._callbacks.unshift(callback);\n    }\n    return {\n      dispose: () => {\n        if (this._emitting) {\n          this._callbacks = this._callbacks.filter(v => v !== callback);\n        } else {\n          const index = this._callbacks.indexOf(callback);\n          if (index > -1) {\n            this._callbacks.splice(index, 1); // remove one item only\n          }\n        }\n      },\n    };\n  }\n}\n"]}